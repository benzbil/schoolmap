<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏≠‡∏±‡∏à‡∏â‡∏£‡∏¥‡∏¢‡∏∞ v6 - User Interface</title>
    
    <!-- External Libraries -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        /* =================== CSS Variables =================== */
        :root {
            --primary-color: #667eea;
            --secondary-color: #764ba2;
            --accent-color: #28a745;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --info-color: #17a2b8;
            
            --background-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --card-background: #ffffff;
            --text-primary: #333333;
            --text-secondary: #666666;
            --border-color: #e0e6ff;
            
            --border-radius: 15px;
            --box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            --transition: all 0.3s ease;
            
            --bottom-nav-height: 70px;
            --content-padding-bottom: 85px;
        }

        /* =================== Base Styles =================== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--background-gradient);
            min-height: 100vh;
            color: var(--text-primary);
            overflow-x: hidden;
            transition: var(--transition);
            padding-bottom: var(--content-padding-bottom);
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
            padding: 10px;
        }

        /* =================== Header =================== */
        .header {
			position: relative; /* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ position absolute ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ */
            background: var(--card-background);
            padding: 15px 20px;
            border-radius: 0 0 var(--border-radius) var(--border-radius);
            box-shadow: var(--box-shadow);
            margin-bottom: 15px;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
		.header .status-indicator {
			position: absolute;
			top: 2px;                   /* ‡∏•‡∏î‡∏à‡∏≤‡∏Å 5px */
			right: 10px;               /* ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≤‡∏Å center ‡πÄ‡∏õ‡πá‡∏ô right */
			z-index: 200;
			font-size: 8px;            /* ‡πÄ‡∏•‡πá‡∏Å‡∏•‡∏á‡∏≠‡∏µ‡∏Å */
			padding: 1px 6px;          /* ‡πÄ‡∏•‡πá‡∏Å‡∏•‡∏á‡∏≠‡∏µ‡∏Å */
			border-radius: 8px;
		}
		
        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .school-logo {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--primary-color);
        }

        .header-title {
            flex: 1;
            text-align: center;
        }

        .header h1 {
            color: var(--text-primary);
            margin: 0;
            font-size: 1.4em;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header p {
            color: var(--text-secondary);
            font-size: 0.9em;
            margin-top: 5px;
        }

        .header-btn {
            background: var(--card-background);
            border: 2px solid var(--primary-color);
            border-radius: 12px;
            padding: 8px 12px;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 6px;
            font-weight: 600;
            color: var(--primary-color);
            font-size: 12px;
        }

        .header-btn:hover {
            background: var(--primary-color);
            color: white;
            transform: translateY(-2px);
        }

        .language-btn {
            background: linear-gradient(135deg, var(--info-color), var(--primary-color));
            color: white;
            border: none;
        }

        /* =================== Bottom Navigation =================== */
        .bottom-navigation {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: var(--bottom-nav-height);
            background: var(--card-background);
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: space-around;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            box-shadow: 0 -4px 20px rgba(0,0,0,0.1);
        }

        .nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
            padding: 8px 4px;
            position: relative;
            color: var(--text-secondary);
        }

        .nav-item.active {
            color: var(--primary-color);
        }

        .nav-item:hover {
            color: var(--primary-color);
            transform: translateY(-2px);
        }

        .nav-item i {
            font-size: 20px;
            margin-bottom: 4px;
        }

        .nav-item span {
            font-size: 10px;
            font-weight: 600;
        }

        .nav-item.active::before {
            content: '';
            position: absolute;
            top: -1px;
            left: 50%;
            transform: translateX(-50%);
            width: 30px;
            height: 3px;
            background: var(--primary-color);
            border-radius: 0 0 10px 10px;
        }
		/* =================== Status Indicators =================== */
		/* ======= ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç Version Indicator ‡πÉ‡∏´‡πâ‡πÄ‡∏•‡πá‡∏Å‡∏•‡∏á ======= */
			.status-indicator {
				padding: 2px 8px;           /* ‡∏•‡∏î‡∏à‡∏≤‡∏Å 4px 12px */
				border-radius: 12px;        /* ‡∏•‡∏î‡∏à‡∏≤‡∏Å 20px */
				font-size: 9px;             /* ‡∏•‡∏î‡∏à‡∏≤‡∏Å 11px */
				font-weight: 500;           /* ‡∏•‡∏î‡∏à‡∏≤‡∏Å 600 */
				text-transform: uppercase;
				opacity: 0.8;               /* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡πÇ‡∏õ‡∏£‡πà‡∏á‡πÉ‡∏™ */
				backdrop-filter: blur(10px);
				-webkit-backdrop-filter: blur(10px);
			}

		.status-active {
			background: rgba(40, 167, 69, 0.1);
			color: var(--accent-color);
		}

		.status-inactive {
			background: rgba(108, 117, 125, 0.1);
			color: #6c757d;
		}

		.status-connected {
			background: rgba(23, 162, 184, 0.1);
			color: var(--info-color);
		}

		.status-error {
			background: rgba(220, 53, 69, 0.1);
			color: var(--danger-color);
		}

		/* =================== Loading Overlay =================== */
		.loading-overlay {
			position: fixed;
			top: 0;
			left: 0;
			right: 0;
			bottom: 0;
			background: rgba(0,0,0,0.8);
			z-index: 9999;
			display: none;
			align-items: center;
			justify-content: center;
			backdrop-filter: blur(10px);
			-webkit-backdrop-filter: blur(10px);
		}

		.loading-content {
			background: var(--card-background);
			border-radius: var(--border-radius);
			padding: 40px;
			text-align: center;
			max-width: 400px;
			margin: 20px;
			box-shadow: 0 25px 50px rgba(0,0,0,0.3);
		}

		.loading-spinner {
			width: 50px;
			height: 50px;
			border: 4px solid #f3f3f3;
			border-top: 4px solid var(--primary-color);
			border-radius: 50%;
			animation: spin 1s linear infinite;
			margin: 0 auto 20px;
		}

		@keyframes spin {
			0% { transform: rotate(0deg); }
			100% { transform: rotate(360deg); }
		}

        /* =================== Page Styles =================== */
        .page {
            display: none;
            background: var(--card-background);
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--box-shadow);
            margin-bottom: 15px;
            min-height: calc(100vh - 200px);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .page.active {
            display: block;
            animation: fadeInUp 0.4s ease-out;
        }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* =================== Search Styles =================== */
        .search-container {
            background: linear-gradient(135deg, #f8f9ff, #e6f3ff);
            padding: 20px;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .search-box {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
        }

        .search-input {
            flex: 1;
            padding: 15px 20px;
            border: 2px solid #ddd;
            border-radius: var(--border-radius);
            font-size: 16px;
            transition: var(--transition);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            background: rgba(255,255,255,0.9);
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
            background: white;
        }

        .search-btn {
            padding: 15px 25px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: var(--transition);
            white-space: nowrap;
        }

        .search-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
        }

        .quick-categories {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 20px;
        }

        .category-card {
            background: var(--card-background);
            padding: 20px;
            border-radius: var(--border-radius);
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
            border: 2px solid var(--border-color);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .category-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--box-shadow);
            border-color: var(--primary-color);
        }

        .category-card i {
            font-size: 32px;
            color: var(--primary-color);
            margin-bottom: 12px;
        }

        .category-card h4 {
            color: var(--primary-color);
            margin-bottom: 8px;
            font-size: 16px;
        }

        .category-card p {
            color: var(--text-secondary);
            font-size: 14px;
        }

        /* =================== Map Styles =================== */
        .map-container {
            position: relative;
            margin-top: 20px;
        }

        /* Map controls with toggle functionality */
        .map-controls {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            justify-content: center;
            position: relative;
        }
		
		.map-controls.fullscreen-controls {
			position: fixed;
			top: 20px;
			right: 20px;
			z-index: 2000;
			background: rgba(255,255,255,0.95);
			padding: 8px;
			border-radius: var(--border-radius);
			box-shadow: var(--box-shadow);
			backdrop-filter: blur(10px);
			-webkit-backdrop-filter: blur(10px);
		}
		
		.map-controls.fullscreen-controls .map-control-btn:not(#fullscreenBtn) {
			display: none;
		}
		
        .map-controls.hidden .map-control-btn:not(.toggle-btn) {
            display: none;
        }
		.show-controls-btn {
			position: fixed;
			top: 20px;
			right: 20px;
			padding: 10px 15px;
			background: var(--warning-color);
			color: var(--text-primary);
			border: 2px solid var(--warning-color);
			border-radius: var(--border-radius);
			cursor: pointer;
			font-size: 12px;
			font-weight: 600;
			z-index: 1001;
			box-shadow: var(--box-shadow);
			backdrop-filter: blur(10px);
			-webkit-backdrop-filter: blur(10px);
			transition: var(--transition);
			display: none;
		}

		.show-controls-btn:hover {
			transform: translateY(-2px);
			box-shadow: 0 8px 20px rgba(0,0,0,0.2);
		}

        .map-control-btn {
            padding: 10px 15px;
            background: rgba(255,255,255,0.95);
            border: 2px solid var(--primary-color);
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: var(--transition);
            font-size: 12px;
            font-weight: 600;
            color: var(--primary-color);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .map-control-btn.active {
            background: var(--primary-color);
            color: white;
        }

        .map-control-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.2);
        }

        .toggle-btn {
            background: var(--warning-color);
            color: var(--dark-color);
            border-color: var(--warning-color);
        }

        /* Room selection overlay for choosing action */
         .room-action-overlay {
            position: absolute;
            background: var(--card-background);
            border: 8px solid var(--primary-color);
            border-radius: var(--border-radius);
            padding: 15px;
            box-shadow: var(--box-shadow);
            z-index: 200;
            display: none;
            min-width: 200px;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
			top: 50%;         /* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà */
			left: 50%;        /* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà */
			transform: translate(-50%, -50%); /* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà */
        }
 
        .room-action-header {
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 20px;
            font-size: 14px;
        }

        .room-action-btn {
            width: 100%;
            padding: 12px;
            margin-bottom: 8px;
            background: var(--card-background);
            color: var(--primary-color);
            border: 2px solid var(--primary-color);
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 8px;
            justify-content: center;
        }

        .room-action-btn:hover {
            background: var(--primary-color);
            color: white;
            transform: translateY(-1px);
        }

        .room-action-btn:last-child {
            margin-bottom: 0;
        }

        .map-area {
            background: #f8f9ff;
            border: 3px solid var(--primary-color);
            border-radius: var(--border-radius);
            position: relative;
            height: 400px;
            overflow: hidden;
        }

        .map-area.fullscreen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 1500;
            height: 100vh;
            border-radius: 0;
        }

        .map-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            cursor: crosshair;
            transition: var(--transition);
        }

        .map-image:hover {
            filter: brightness(1.05);
        }

        /* Route Controls - moved outside map */
        .route-controls {
            display: flex;
            gap: 8px;
            margin-top: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .route-control-btn {
            padding: 12px 20px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            transition: var(--transition);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .route-control-btn:hover {
            transform: translateY(-2px);
        }

        .route-control-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }

        .clear-route-btn {
            background: var(--danger-color);
        }

        /* Room Markers */
        .room-marker {
            position: absolute;
            width: 35px;
            height: 35px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 16px;
            transition: var(--transition);
            border: 3px solid white;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            z-index: 30;
            transform: translate(-50%, -50%);
        }

        .room-marker:hover {
            transform: translate(-50%, -50%) scale(1.3);
            z-index: 100;
            box-shadow: 0 8px 25px rgba(0,0,0,0.4);
        }

        .room-marker.highlighted {
            background: var(--danger-color);
            animation: pulse 2s infinite;
            transform: translate(-50%, -50%) scale(1.3);
        }

        .start-point-marker {
            background: var(--accent-color);
            width: 40px;
            height: 40px;
            font-size: 18px;
            animation: startPointPulse 3s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.8; }
            50% { opacity: 1; }
        }

        @keyframes startPointPulse {
            0%, 100% { 
                transform: translate(-50%, -50%) scale(1);
                box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.7);
            }
            50% { 
                transform: translate(-50%, -50%) scale(1.2);
                box-shadow: 0 0 0 15px rgba(40, 167, 69, 0);
            }
        }

        /* Route Path */
        .route-path {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 25;
        }

        .route-line {
            stroke: var(--danger-color);
            stroke-width: 5;
            fill: none;
            stroke-dasharray: 15, 10;
            animation: dash 3s linear infinite;
            filter: drop-shadow(0 0 8px rgba(220, 53, 69, 0.5));
        }

        .route-line-glow {
            stroke: rgba(220, 53, 69, 0.3);
            stroke-width: 12;
            fill: none;
            opacity: 0.6;
        }

        .waypoint-marker {
            fill: var(--warning-color);
            stroke: white;
            stroke-width: 3;
            filter: drop-shadow(0 4px 8px rgba(0,0,0,0.3));
            animation: waypoint-pulse 2s ease-in-out infinite;
        }

        @keyframes dash {
            to {
                stroke-dashoffset: -25;
            }
        }

        @keyframes waypoint-pulse {
            0%, 100% { 
                transform: scale(1);
                opacity: 0.8;
            }
            50% { 
                transform: scale(1.3);
                opacity: 1;
            }
        }

        /* FIX 5: Building Filter */
        .building-filter {
            background: rgba(255,255,255,0.9);
            padding: 15px;
            border-radius: var(--border-radius);
            margin-bottom: 15px;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .building-filter h4 {
            margin-bottom: 10px;
            color: var(--primary-color);
            font-size: 14px;
        }

        .building-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .building-btn {
            padding: 8px 12px;
            background: var(--card-background);
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            color: var(--text-primary);
            transition: var(--transition);
        }

        .building-btn.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .building-btn:hover {
            border-color: var(--primary-color);
            transform: translateY(-1px);
        }

        /* =================== Room Info Overlay =================== */
        .room-info-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.6);
            z-index: 1500;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }

        .room-info-content {
            background: var(--card-background);
            border-radius: var(--border-radius);
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 25px 50px rgba(0,0,0,0.3);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
        }

        .room-info-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 25px;
            border-radius: var(--border-radius) var(--border-radius) 0 0;
            position: relative;
        }

        .room-info-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }

        .room-info-close:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.1);
        }

        .room-info-body {
            padding: 25px;
        }

        .navigation-controls {
            display: flex;
            gap: 10px;
            margin: 20px 0;
        }

        .nav-control-btn {
            flex: 1;
            padding: 15px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: var(--transition);
            text-align: center;
        }

        .nav-control-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
        }

        .nav-control-btn:disabled {
            background: var(--text-secondary);
            cursor: not-allowed;
            transform: none;
        }

        .voice-btn {
            background: var(--accent-color);
        }

        .voice-btn.speaking {
            background: var(--danger-color);
            animation: voice-pulse 1s infinite;
        }

        @keyframes voice-pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Compact Info */
        .compact-info {
			display: flex;
			gap: 10px;
			margin-bottom: 15px;
			flex-wrap: wrap;
			justify-content: space-between;
		}

		.info-item {
			background: rgba(255,255,255,0.8);
			padding: 8px 12px;
			border-radius: 8px;
			text-align: center;
			border-left: 3px solid var(--primary-color);
			backdrop-filter: blur(10px);
			-webkit-backdrop-filter: blur(10px);
			flex: 1;
			min-width: 0;
		}

        .info-label {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 5px;
        }

        .info-value {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
        }

        /* Route Steps */
        .route-steps {
            background: var(--card-background);
            padding: 20px;
            border-radius: var(--border-radius);
            margin-top: 15px;
        }

        .route-step {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .route-step:last-child {
            border-bottom: none;
        }

        .step-number {
            background: var(--primary-color);
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            flex-shrink: 0;
        }

        .step-content {
            flex: 1;
            font-size: 14px;
        }

        .step-distance {
            background: rgba(102, 126, 234, 0.1);
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            color: var(--primary-color);
            font-weight: 600;
        }

        .step-voice-btn {
            background: var(--accent-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            cursor: pointer;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Search Results */
        .live-results {
            margin-top: 15px;
        }

        .search-result-item {
            background: var(--card-background);
            padding: 15px;
            margin-bottom: 10px;
            border-radius: var(--border-radius);
            cursor: pointer;
            border-left: 4px solid var(--primary-color);
            transition: var(--transition);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 2px solid var(--border-color);
        }

        .search-result-item:hover {
            transform: translateY(-2px);
            box-shadow: var(--box-shadow);
            border-color: var(--primary-color);
        }

        .search-result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .search-result-title {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 16px;
        }

        .search-result-code {
            background: var(--primary-color);
            color: white;
            padding: 4px 8px;
            border-radius: 8px;
            font-size: 11px;
            font-weight: 600;
        }

        .search-result-info {
            color: var(--text-secondary);
            font-size: 12px;
        }

        /* =================== Notification =================== */
        .notification {
            position: fixed;
            top: 90px;
            right: 20px;
            padding: 15px 25px;
            background: var(--accent-color);
            color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            opacity: 0;
            transform: translateX(350px);
            transition: var(--transition);
            z-index: 3000;
            max-width: 320px;
            font-size: 14px;
            font-weight: 500;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .notification.show {
            opacity: 1;
            transform: translateX(0);
        }

        .notification.error { background: var(--danger-color); }
        .notification.warning { background: var(--warning-color); color: #333; }
        .notification.info { background: var(--info-color); }

        /* =================== Hidden Elements =================== */
        .hidden {
            display: none !important;
        }

        /* =================== Responsive Design =================== */
        @media (min-width: 768px) {
            .container {
                max-width: 1200px;
                padding: 25px;
            }
            
            .quick-categories {
                grid-template-columns: repeat(4, 1fr);
            }

            .bottom-navigation {
                justify-content: center;
                gap: 40px;
                max-width: 600px;
                left: 50%;
                transform: translateX(-50%);
                border-radius: var(--border-radius) var(--border-radius) 0 0;
            }

            .nav-item {
                flex: none;
                min-width: 80px;
            }
        }
		
		@media (max-width: 480px) {
			.compact-info { gap: 5px; }
			.info-item { padding: 6px 8px; flex: 1; min-width: 0; }
			.info-label { font-size: 9px; margin-bottom: 1px; }
			.info-value { font-size: 11px; }
		}
		
		/* ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç responsive ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö mobile */
		@media (max-width: 768px) {
			.header .status-indicator {
				top: 1px;
				right: 5px;
				font-size: 7px;
				padding: 1px 4px;
			}
		}
		
		/* ‡πÄ‡∏û‡∏¥‡πà‡∏° CSS ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö About Page ‡∏ó‡∏µ‡πà responsive */
		@media (max-width: 768px) {
			#about-page h1 {
				font-size: 1.5em !important;
			}
			
			#about-page .page h2 {
				font-size: 1.3em !important;
			}
			
			#about-page [style*="font-size: 64px"] {
				font-size: 48px !important;
			}
			
			#about-page [style*="font-size: 48px"] {
				font-size: 36px !important;
			}
			
			#about-page [style*="padding: 30px"] {
				padding: 20px !important;
			}
			
			#about-page [style*="padding: 25px"] {
				padding: 20px !important;
			}
			
			#about-page [style*="width: 60px; height: 60px"] {
				width: 50px !important;
				height: 50px !important;
				font-size: 20px !important;
			}
		}

		@media (max-width: 480px) {
			#about-page [style*="grid-template-columns: repeat(auto-fit, minmax(280px, 1fr))"] {
				grid-template-columns: 1fr !important;
			}
			
			#about-page [style*="grid-template-columns: repeat(auto-fit, minmax(250px, 1fr))"] {
				grid-template-columns: 1fr !important;
			}
			
			#about-page [style*="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr))"] {
				grid-template-columns: repeat(2, 1fr) !important;
			}
			
			#about-page [style*="padding: 20px"] {
				padding: 15px !important;
			}
		}
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
		 <div class="header">
			<!-- ‡∏¢‡πâ‡∏≤‡∏¢ Version Indicator ‡πÑ‡∏õ‡∏°‡∏∏‡∏°‡∏Ç‡∏ß‡∏≤‡∏ö‡∏ô -->
			<span id="globalVersionIndicator" class="status-indicator status-connected" 
				  style="position: absolute; top: 2px; right: 10px; z-index: 200; font-size: 8px; padding: 1px 6px;">
				üéÆ
			</span>
			
			<div class="header-top">
				<img class="school-logo" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='50' fill='%23667eea'/%3E%3Ctext x='50' y='60' text-anchor='middle' font-family='Arial' font-size='40' fill='white'%3Eüè´%3C/text%3E%3C/svg%3E" alt="School Logo">
				
				<div class="header-title">
					<h1 id="systemTitle">üè´ ‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏≠‡∏±‡∏à‡∏â‡∏£‡∏¥‡∏¢‡∏∞</h1>
					<p id="systemSubtitle">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡∏∞‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πà‡∏≤‡∏á‡πÜ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏£‡∏∞‡∏ö‡∏ö‡∏ô‡∏≥‡∏ó‡∏≤‡∏á‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏™‡∏µ‡∏¢‡∏á</p>
				</div>
				
				<button class="header-btn language-btn" onclick="toggleLanguage()">
					<i class="fas fa-globe"></i>
					<span id="languageText">TH</span>
				</button>
			</div>
		</div>

        <!-- ======================== Search Page ======================== -->
        <div class="page active" id="search-page">
            <div class="search-container">
                <h2><i class="fas fa-search"></i> <span data-translate="search_title">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡∏∞‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà</span></h2>
                
                <div class="search-box">
                    <input class="search-input" id="searchInput" 
                           onkeypress="handleSearchKeyPress(event)" 
                           oninput="liveSearch()" 
                           placeholder="üîç ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏´‡πâ‡∏≠‡∏á ‡∏£‡∏´‡∏±‡∏™ ‡∏´‡∏£‡∏∑‡∏≠‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á..." 
                           data-placeholder-th="üîç ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏´‡πâ‡∏≠‡∏á ‡∏£‡∏´‡∏±‡∏™ ‡∏´‡∏£‡∏∑‡∏≠‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á..."
                           data-placeholder-en="üîç Search room, code, or location..."
                           type="text">
                    <button class="search-btn" onclick="searchRoom()">
                        <i class="fas fa-search"></i> <span data-translate="search_btn">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</span>
                    </button>
                </div>
                
                <div class="live-results" id="liveResults"></div>
            </div>

            <div class="quick-categories">
                <div class="category-card" onclick="quickSearch('classroom')">
                    <i class="fas fa-graduation-cap"></i>
                    <h4 data-translate="category_classroom">‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h4>
                    <p data-translate="category_classroom_desc">‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏õ‡∏Å‡∏ï‡∏¥‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
                </div>
                <div class="category-card" onclick="quickSearch('special')">
                    <i class="fas fa-flask"></i>
                    <h4 data-translate="category_special">‡∏´‡πâ‡∏≠‡∏á‡∏û‡∏¥‡πÄ‡∏®‡∏©</h4>
                    <p data-translate="category_special_desc">‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£</p>
                </div>
                <div class="category-card" onclick="quickSearch('facilities')">
                    <i class="fas fa-building"></i>
                    <h4 data-translate="category_facilities">‡∏™‡∏¥‡πà‡∏á‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏î‡∏ß‡∏Å</h4>
                    <p data-translate="category_facilities_desc">‡∏´‡πâ‡∏≠‡∏á‡∏™‡∏°‡∏∏‡∏î ‡πÇ‡∏£‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£</p>
                </div>
                <div class="category-card" onclick="quickSearch('office')">
                    <i class="fas fa-briefcase"></i>
                    <h4 data-translate="category_office">‡∏´‡πâ‡∏≠‡∏á‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</h4>
                    <p data-translate="category_office_desc">‡∏´‡πâ‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£</p>
                </div>
            </div>
        </div>

        <!-- ======================== Map Page ======================== -->
        <div class="page" id="map-page">
            <h2><i class="fas fa-map"></i> <span data-translate="map_title">‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</span></h2>
            
			  <!-- ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏ö‡∏ö Toggle -->
			<div id="usageGuideContainer" style="background: linear-gradient(135deg, #f8f9ff, #e6f3ff); border-radius: var(--border-radius); margin-bottom: 20px; overflow: hidden; border: 2px solid var(--border-color);">
				<!-- Toggle Button -->
				<div style="padding: 15px; text-align: center; cursor: pointer; background: rgba(102, 126, 234, 0.1);" onclick="toggleUsageGuide()">
					<i class="fas fa-question-circle" style="color: var(--primary-color); margin-right: 8px;"></i>
					<span style="color: var(--primary-color); font-weight: 600; font-size: 14px;" id="usageGuideToggleText">
						<span data-translate="show_usage_guide">‡πÅ‡∏™‡∏î‡∏á‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</span>
					</span>
					<i class="fas fa-chevron-down" id="usageGuideChevron" style="color: var(--primary-color); margin-left: 8px; transition: transform 0.3s ease;"></i>
				</div>
				
				<!-- Content (Hidden by default) -->
				<div id="usageGuideContent" style="display: none; padding: 20px; border-top: 1px solid var(--border-color);">
					<h4 style="color: var(--primary-color); margin-bottom: 15px; text-align: center;">
						<i class="fas fa-info-circle"></i> <span data-translate="usage_guide_title">‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà</span>
					</h4>
					<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
						<div style="background: rgba(255,255,255,0.7); padding: 15px; border-radius: 8px; border-left: 4px solid var(--primary-color);">
							<div style="color: var(--primary-color); font-weight: 600; margin-bottom: 8px;">
								<i class="fas fa-search"></i> <span data-translate="step1">‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 1: ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏´‡πâ‡∏≠‡∏á</span>
							</div>
							<p style="color: var(--text-secondary); font-size: 13px; line-height: 1.5; margin: 0;">
								<span data-translate="step1_desc">‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ ‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏î‡πà‡∏ß‡∏ô</span>
							</p>
						</div>
						<div style="background: rgba(255,255,255,0.7); padding: 15px; border-radius: 8px; border-left: 4px solid var(--accent-color);">
							<div style="color: var(--accent-color); font-weight: 600; margin-bottom: 8px;">
								<i class="fas fa-map-marker-alt"></i> <span data-translate="step2">‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 2: ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏à‡∏∏‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</span>
							</div>
							<p style="color: var(--text-secondary); font-size: 13px; line-height: 1.5; margin: 0;">
								<span data-translate="step2_desc">‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏¢‡∏π‡πà</span>
							</p>
						</div>
						<div style="background: rgba(255,255,255,0.7); padding: 15px; border-radius: 8px; border-left: 4px solid var(--warning-color);">
							<div style="color: #856404; font-weight: 600; margin-bottom: 8px;">
								<i class="fas fa-route"></i> <span data-translate="step3">‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 3: ‡∏î‡∏π‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á</span>
							</div>
							<p style="color: var(--text-secondary); font-size: 13px; line-height: 1.5; margin: 0;">
								<span data-translate="step3_desc">‡∏Ñ‡∏•‡∏¥‡∏Å "‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡∏ó‡∏≤‡∏á‡πÅ‡∏ö‡∏ö step by step</span>
							</p>
						</div>
					</div>
				</div>
			</div>
					
            <!-- 1.1: Map controls with toggle -->
            <!-- ‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏™‡πà‡∏ß‡∏ô map-controls ‡πÉ‡∏ô index.html -->
			<div class="map-controls" id="mapControls">
				<button class="map-control-btn toggle-btn" onclick="toggleMapControls()" id="toggleControlsBtn">
					<i class="fas fa-eye-slash"></i> <span data-translate="hide_controls">‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏°</span>
				</button>
				<button class="map-control-btn" onclick="setMapLayout('floorplan')" id="floorplanBtn" data-layout="floorplan">
					<i class="fas fa-th-large"></i> <span data-translate="floorplan">‡πÅ‡∏ú‡∏ô‡∏ú‡∏±‡∏á</span>
				</button>
				<button class="map-control-btn" onclick="setMapLayout('photo')" id="photoBtn" data-layout="photo">
					<i class="fas fa-camera"></i> <span data-translate="real_photo">‡∏†‡∏≤‡∏û‡∏à‡∏£‡∏¥‡∏á</span>
				</button>
				<!-- ‚≠ê ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏∏‡πà‡∏° Refresh Map ‡πÉ‡∏´‡∏°‡πà -->
				<button class="map-control-btn" onclick="refreshMapImages()" id="refreshMapBtn" 
						title="‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏≤‡∏Å Google Sheets">
					<i class="fas fa-sync-alt"></i> <span data-translate="refresh_map">‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</span>
				</button>
				<button class="map-control-btn" onclick="toggleFullscreen()" id="fullscreenBtn">
					<i class="fas fa-expand"></i> <span data-translate="fullscreen">‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≠</span>
				</button>
			</div>
            
            <div class="map-container">
                <div class="map-area" id="mapArea">
                    <img id="mapImage" class="map-image" 
                         src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='800' height='600' viewBox='0 0 800 600'%3E%3Crect width='800' height='600' fill='%23f0f8ff'/%3E%3Ctext x='400' y='280' text-anchor='middle' font-family='Arial' font-size='28' fill='%23667eea' font-weight='bold'%3Eüè´ ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏≠‡∏±‡∏à‡∏â‡∏£‡∏¥‡∏¢‡∏∞%3C/text%3E%3Ctext x='400' y='320' text-anchor='middle' font-family='Arial' font-size='16' fill='%23999'%3E(‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏à‡∏∏‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô)%3C/text%3E%3Ctext x='400' y='350' text-anchor='middle' font-family='Arial' font-size='14' fill='%23667eea'%3Eüìç ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏à‡∏∏‡∏î‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡πâ‡∏≠‡∏á%3C/text%3E%3C/svg%3E" 
                         alt="‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô">
                    
                    <!-- Route Path SVG -->
                    <svg class="route-path" id="routePath" style="display: none;" viewBox="0 0 100 100" preserveAspectRatio="none">
                        <!-- Path elements will be created by JavaScript -->
                    </svg>
                    
                    <!-- 1.2: Room action selection overlay -->
                    <div class="room-action-overlay" id="roomActionOverlay">
                        <div class="room-action-header" id="roomActionHeader">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</div>
                        <button class="room-action-btn" onclick="showRoomDetails()">
                            <i class="fas fa-info-circle"></i>
                            <span data-translate="view_details">‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏´‡πâ‡∏≠‡∏á</span>
                        </button>
                        <button class="room-action-btn" onclick="showRouteDirectly()">
                            <i class="fas fa-route"></i>
                            <span data-translate="show_route_direct">‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á</span>
                        </button>
                    </div>
                    
                    <div id="roomMarkers"></div>
                </div>
				<button class="show-controls-btn" id="showControlsBtn" onclick="showAllControls()">
				<i class="fas fa-eye"></i> <span data-translate="show_controls">‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏°</span>
			</button>
            </div>
            
            <!-- Route Controls moved outside map -->
            <div class="route-controls">
			<div id="destinationStatus" style="
				position: fixed; 
				top: 80px; 
				right: 20px; 
				background: rgba(102, 126, 234, 0.95); 
				color: white; 
				padding: 10px 15px; 
				border-radius: 20px; 
				font-size: 14px; 
				display: none;
				z-index: 1000;
				box-shadow: 0 4px 12px rgba(0,0,0,0.15);
			">
				<i class="fas fa-map-marker-alt"></i> 
				<span id="destinationText">-</span>
				<button onclick="clearDestination(); updateDestinationDisplay();" style="
					background: none; 
					border: none; 
					color: white; 
					margin-left: 8px; 
					cursor: pointer;
					opacity: 0.8;
				">
					<i class="fas fa-times"></i>
				</button>
			</div>
                <button class="route-control-btn" onclick="showRouteToSelected()" id="showRouteBtn" disabled>
                    <i class="fas fa-route"></i> <span data-translate="show_route">‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á</span>
                </button>
                <button class="route-control-btn clear-route-btn" onclick="clearRoute()" id="clearRouteBtn" style="display: none;">
                    <i class="fas fa-times"></i> <span data-translate="clear_route">‡∏•‡πâ‡∏≤‡∏á‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á</span>
                </button>
                <button class="route-control-btn voice-btn" onclick="startContinuousVoiceNavigation()" id="voiceNavigationBtn" style="display: none;">
                    <i class="fas fa-volume-up"></i> <span data-translate="voice_nav">‡∏ô‡∏≥‡∏ó‡∏≤‡∏á‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏™‡∏µ‡∏¢‡∏á</span>
                </button>
            </div>
        </div>

        <!-- ======================== About Page ======================== -->
        <div class="page" id="about-page">
			<!-- Header Section -->
			<div style="text-align: center; margin-bottom: 30px;">
				<div style="font-size: 64px; margin-bottom: 20px;">üè´</div>
				<h1 style="color: var(--primary-color); margin-bottom: 10px; font-size: 2em;">
					<span data-translate="system_name">‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏≠‡∏±‡∏à‡∏â‡∏£‡∏¥‡∏¢‡∏∞ v6</span>
				</h1>
				<p style="color: var(--text-secondary); font-size: 1.1em; max-width: 600px; margin: 0 auto; line-height: 1.6;">
					<span data-translate="system_desc">‡∏£‡∏∞‡∏ö‡∏ö‡∏ô‡∏≥‡∏ó‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏±‡∏ô‡∏™‡∏°‡∏±‡∏¢ ‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡∏°‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ö‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏•‡∏±‡∏Å ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏£‡∏∞‡∏ö‡∏ö‡∏ô‡∏≥‡∏ó‡∏≤‡∏á‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô</span>
				</p>
			</div>

			<!-- Features Grid -->
			<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 30px;">
				<!-- Feature 1 -->
				<div style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 25px; border-radius: var(--border-radius); text-align: center; box-shadow: var(--box-shadow);">
					<div style="font-size: 48px; margin-bottom: 15px;">üéØ</div>
					<h3 style="margin-bottom: 10px; font-size: 1.2em;" data-translate="feature1_title">‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡∏ó‡∏≤‡∏á‡∏ó‡∏µ‡πà‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥</h3>
					<p style="opacity: 0.9; font-size: 0.9em; line-height: 1.5;" data-translate="feature1_desc">‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏à‡∏∏‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÑ‡∏î‡πâ‡∏ó‡∏∏‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô</p>
				</div>

				<!-- Feature 2 -->
				<div style="background: linear-gradient(135deg, #28a745, #20c997); color: white; padding: 25px; border-radius: var(--border-radius); text-align: center; box-shadow: var(--box-shadow);">
					<div style="font-size: 48px; margin-bottom: 15px;">üîä</div>
					<h3 style="margin-bottom: 10px; font-size: 1.2em;" data-translate="feature2_title">‡∏ô‡∏≥‡∏ó‡∏≤‡∏á‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏™‡∏µ‡∏¢‡∏á</h3>
					<p style="opacity: 0.9; font-size: 0.9em; line-height: 1.5;" data-translate="feature2_desc">‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á‡πÅ‡∏ö‡∏ö‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©</p>
				</div>

				<!-- Feature 3 -->
				<div style="background: linear-gradient(135deg, #17a2b8, #6f42c1); color: white; padding: 25px; border-radius: var(--border-radius); text-align: center; box-shadow: var(--box-shadow);">
					<div style="font-size: 48px; margin-bottom: 15px;">üì±</div>
					<h3 style="margin-bottom: 10px; font-size: 1.2em;" data-translate="feature3_title">Mobile First</h3>
					<p style="opacity: 0.9; font-size: 0.9em; line-height: 1.5;" data-translate="feature3_desc">‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏•‡∏±‡∏Å ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢ UI ‡∏ó‡∏µ‡πà‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏°‡πÅ‡∏•‡∏∞‡∏ó‡∏±‡∏ô‡∏™‡∏°‡∏±‡∏¢</p>
				</div>
			</div>

			<!-- New Features Section -->
			<div style="background: linear-gradient(135deg, #f8f9ff, #e6f3ff); padding: 30px; border-radius: var(--border-radius); margin-bottom: 25px; border: 2px solid var(--border-color);">
				<h2 style="text-align: center; color: var(--primary-color); margin-bottom: 25px; font-size: 1.5em;">
					<i class="fas fa-sparkles"></i> <span data-translate="whats_new">‡∏°‡∏µ‡∏≠‡∏∞‡πÑ‡∏£‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏ô‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô 6</span>
				</h2>
				
				<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
					<div style="background: rgba(255,255,255,0.8); padding: 20px; border-radius: 12px; border-left: 4px solid var(--primary-color);">
						<div style="display: flex; align-items: center; margin-bottom: 10px;">
							<div style="background: var(--primary-color); color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 12px; font-size: 14px;">üéØ</div>
							<h4 style="color: var(--primary-color); margin: 0;" data-translate="new1_title">‡∏à‡∏∏‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÅ‡∏ö‡∏ö Custom</h4>
						</div>
						<p style="color: var(--text-secondary); font-size: 0.9em; line-height: 1.5; margin: 0;" data-translate="new1_desc">‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏à‡∏∏‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÑ‡∏î‡πâ‡∏ó‡∏∏‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£</p>
					</div>

					<div style="background: rgba(255,255,255,0.8); padding: 20px; border-radius: 12px; border-left: 4px solid var(--accent-color);">
						<div style="display: flex; align-items: center; margin-bottom: 10px;">
							<div style="background: var(--accent-color); color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 12px; font-size: 14px;">üõ£Ô∏è</div>
							<h4 style="color: var(--accent-color); margin: 0;" data-translate="new2_title">‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô</h4>
						</div>
						<p style="color: var(--text-secondary); font-size: 0.9em; line-height: 1.5; margin: 0;" data-translate="new2_desc">‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡πÅ‡∏ö‡∏ö‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏à‡∏∏‡∏î‡∏ï‡πà‡∏≠‡∏à‡∏∏‡∏î‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÅ‡∏≠‡∏ô‡∏¥‡πÄ‡∏°‡∏ä‡∏±‡∏ô</p>
					</div>

					<div style="background: rgba(255,255,255,0.8); padding: 20px; border-radius: 12px; border-left: 4px solid var(--warning-color);">
						<div style="display: flex; align-items: center; margin-bottom: 10px;">
							<div style="background: var(--warning-color); color: black; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 12px; font-size: 14px;">‚ö°</div>
							<h4 style="color: #856404; margin: 0;" data-translate="new3_title">‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û‡∏™‡∏π‡∏á</h4>
						</div>
						<p style="color: var(--text-secondary); font-size: 0.9em; line-height: 1.5; margin: 0;" data-translate="new3_desc">‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏£‡πá‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô ‡πÉ‡∏ä‡πâ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≥‡∏ô‡πâ‡∏≠‡∏¢‡∏•‡∏á ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏°‡∏≤‡∏Å</p>
					</div>
				</div>
			</div>

			<!-- How to Use Section -->
			<div style="background: var(--card-background); padding: 30px; border-radius: var(--border-radius); margin-bottom: 25px; box-shadow: var(--box-shadow);">
				<h2 style="text-align: center; color: var(--primary-color); margin-bottom: 25px; font-size: 1.5em;">
					<i class="fas fa-question-circle"></i> <span data-translate="how_to_use">‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</span>
				</h2>
				
				<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 25px;">
					<!-- Step 1 -->
					<div style="text-align: center;">
						<div style="background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); color: white; width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 15px; font-size: 24px; font-weight: bold;">1</div>
						<h4 style="color: var(--primary-color); margin-bottom: 10px;" data-translate="step1_title">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏´‡πâ‡∏≠‡∏á</h4>
						<p style="color: var(--text-secondary); font-size: 0.9em; line-height: 1.6;" data-translate="step1_desc">‡πÉ‡∏ä‡πâ‡∏ä‡πà‡∏≠‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏î‡πà‡∏ß‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏´‡∏≤‡∏´‡πâ‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£</p>
					</div>

					<!-- Step 2 -->
					<div style="text-align: center;">
						<div style="background: linear-gradient(135deg, var(--accent-color), #20c997); color: white; width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 15px; font-size: 24px; font-weight: bold;">2</div>
						<h4 style="color: var(--accent-color); margin-bottom: 10px;" data-translate="step2_title">‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏à‡∏∏‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</h4>
						<p style="color: var(--text-secondary); font-size: 0.9em; line-height: 1.6;" data-translate="step2_desc">‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏à‡∏∏‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡∏ó‡∏≤‡∏á</p>
					</div>

					<!-- Step 3 -->
					<div style="text-align: center;">
						<div style="background: linear-gradient(135deg, var(--info-color), #6f42c1); color: white; width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 15px; font-size: 24px; font-weight: bold;">3</div>
						<h4 style="color: var(--info-color); margin-bottom: 10px;" data-translate="step3_title">‡∏î‡∏π‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á</h4>
						<p style="color: var(--text-secondary); font-size: 0.9em; line-height: 1.6;" data-translate="step3_desc">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÑ‡∏õ ‡∏Ñ‡∏•‡∏¥‡∏Å "‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥</p>
					</div>
				</div>
			</div>

			<!-- Technical Info -->
			<div style="background: linear-gradient(135deg, #e8f5e8, #d4edda); padding: 25px; border-radius: var(--border-radius); border: 2px solid var(--accent-color);">
				<h3 style="text-align: center; color: var(--accent-color); margin-bottom: 20px;">
					<i class="fas fa-cog"></i> <span data-translate="tech_info">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏≤‡∏á‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ</span>
				</h3>
				
				<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
					<div style="text-align: center; padding: 15px;">
						<div style="color: var(--accent-color); font-size: 32px; margin-bottom: 8px;">üåê</div>
						<div style="font-weight: 600; color: var(--text-primary); font-size: 0.9em;" data-translate="web_tech">‡πÄ‡∏ó‡∏Ñ‡πÇ‡∏ô‡πÇ‡∏•‡∏¢‡∏µ‡πÄ‡∏ß‡πá‡∏ö</div>
						<div style="color: var(--text-secondary); font-size: 0.8em;">HTML5, CSS3, JavaScript</div>
					</div>
					
					<div style="text-align: center; padding: 15px;">
						<div style="color: var(--accent-color); font-size: 32px; margin-bottom: 8px;">üìä</div>
						<div style="font-weight: 600; color: var(--text-primary); font-size: 0.9em;" data-translate="data_source">‡πÅ‡∏´‡∏•‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>
						<div style="color: var(--text-secondary); font-size: 0.8em;">Google Sheets Integration</div>
					</div>
					
					<div style="text-align: center; padding: 15px;">
						<div style="color: var(--accent-color); font-size: 32px; margin-bottom: 8px;">üîä</div>
						<div style="font-weight: 600; color: var(--text-primary); font-size: 0.9em;" data-translate="voice_tech">‡πÄ‡∏ó‡∏Ñ‡πÇ‡∏ô‡πÇ‡∏•‡∏¢‡∏µ‡πÄ‡∏™‡∏µ‡∏¢‡∏á</div>
						<div style="color: var(--text-secondary); font-size: 0.8em;">Web Speech API</div>
					</div>
					
					<div style="text-align: center; padding: 15px;">
						<div style="color: var(--accent-color); font-size: 32px; margin-bottom: 8px;">üì±</div>
						<div style="font-weight: 600; color: var(--text-primary); font-size: 0.9em;" data-translate="responsive">Responsive Design</div>
						<div style="color: var(--text-secondary); font-size: 0.8em;">Mobile First Approach</div>
					</div>
				</div>
			</div>
		</div>
    </div>

    <!-- Admin Link (Hidden) - Removed from bottom left -->

    <!-- Bottom Navigation -->
    <div class="bottom-navigation">
        <div class="nav-item active" onclick="showPage('search')">
            <i class="fas fa-search"></i>
            <span data-translate="nav_search">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</span>
        </div>
        <div class="nav-item" onclick="showPage('map')">
            <i class="fas fa-map"></i>
            <span data-translate="nav_map">‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà</span>
        </div>
        <div class="nav-item" onclick="showPage('about')">
            <i class="fas fa-info-circle"></i>
            <span data-translate="nav_about">‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö</span>
        </div>
        <!-- 1.3: Admin button moved to bottom navigation -->
        <div class="nav-item" onclick="openAdminInterface()" title="Admin Panel">
            <i class="fas fa-cog"></i>
            <span data-translate="nav_admin">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</span>
        </div>
		  <div class="nav-item" onclick="openSystemPresentation()" title="‡∏û‡∏£‡∏µ‡πÄ‡∏ã‡πâ‡∏ô‡∏ó‡πå‡∏£‡∏∞‡∏ö‡∏ö">
            <i class="fas fa-exclamation-triangle"></i>
            <span data-translate="nav_Present">‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏£‡∏∞‡∏ö‡∏ö</span>
        </div>
		
    </div>

    <!-- Room Info Overlay -->
    <div class="room-info-overlay" id="roomInfoOverlay">
        <div class="room-info-content">
            <div class="room-info-header">
                <div class="room-title" id="overlayRoomName"></div>
                <div style="font-size: 16px; opacity: 0.9;" id="overlayRoomLocation"></div>
                <button class="room-info-close" onclick="closeRoomInfoOverlay()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="room-info-body">
                <!-- 1.3: Remove status info, enhanced room information display -->
                <div class="compact-info">
                    <div class="info-item">
                        <div class="info-label" data-translate="info_building">üè¢ ‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£</div>
                        <div class="info-value" id="overlayRoomBuilding"></div>
                    </div>
                    <div class="info-item">
                        <div class="info-label" data-translate="info_floor">üìç ‡∏ä‡∏±‡πâ‡∏ô</div>
                        <div class="info-value" id="overlayRoomFloor"></div>
                    </div>
                    <div class="info-item">
						<div class="info-label" data-translate="info_type">üè∑Ô∏è ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏´‡πâ‡∏≠‡∏á</div>
                        <div class="info-value" id="overlayRoomType"></div>
                    </div>
                </div>
 
                
                <div style="background: rgba(255,255,255,0.7); padding: 20px; border-radius: var(--border-radius); margin-bottom: 20px;">
                    <div style="font-size: 14px; color: var(--text-secondary); margin-bottom: 8px;" data-translate="info_description">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</div>
                    <div style="font-size: 16px;" id="overlayRoomDescription"></div>
                </div>
                
                <div id="overlayRoomGallery" style="display: none;">
                    <h4 style="font-size: 16px; color: var(--primary-color); margin-bottom: 15px;">
                        <i class="fas fa-images"></i> <span data-translate="room_images">‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏´‡πâ‡∏≠‡∏á</span>
                    </h4>
                    <div id="overlayImageGallery" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 20px;"></div>
                </div>
                
                <div class="navigation-controls">
                    <button class="nav-control-btn" onclick="generateCompleteRoute()" id="routeBtn">
                        <i class="fas fa-route"></i> <span data-translate="route_navigation">‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏ô‡∏≥‡∏ó‡∏≤‡∏á</span>
                    </button>
                    <button class="nav-control-btn voice-btn" onclick="toggleVoiceNavigation()" id="overlayVoiceBtn">
                        <i class="fas fa-volume-up"></i> <span data-translate="voice">‡πÄ‡∏™‡∏µ‡∏¢‡∏á</span>
                    </button>
                </div>
                
                <div id="overlayRouteSteps"></div>
            </div>
        </div>
    </div>

    <!-- Notification -->
    <div class="notification" id="notification"></div>
	
	<!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <h3 style="color: var(--primary-color); margin-bottom: 10px;" id="loadingTitle">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h3>
            <p style="color: var(--text-secondary);" id="loadingMessage">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà...</p>
        </div>
    </div>

    <script>
        // =================== Global Variables ===================
       // ======= Enhanced Global Variables =======
		let roomData = {};
		let selectedRoom = null;
		let startPoint = null;
		let voiceNavigationEnabled = false;
		let currentSpeech = null;
		let currentLanguage = 'th';
		let currentMapLayout = 'floorplan';
		let isFullscreen = false;
		let currentVersion = 'demo'; // ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏à‡∏≤‡∏Å Google Sheets
		let buildingsData = {};

		// Enhanced variables
		let systemConfig = {
			version: 'demo',
			maintenance_mode: false,
			maintenance_message: '‡πÄ‡∏ß‡πá‡∏ö‡πÑ‡∏ã‡∏ï‡πå‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á'
		};
		let isMaintenanceMode = false;

		// Route persistence variables
		let currentRoute = null;
		let routeDisplayed = false;

		// Voice navigation queue
		let voiceQueue = [];
		let isVoiceNavigating = false;
		let voiceTimeout = null;

		// Sheets configuration (same as admin)
		 
		let sheetsConfig = {
			url: 'https://script.google.com/macros/s/AKfycbzpCFGZ_7kvyvAqiQGw3y_t6ROwUhh8Csp-I3xOPZZhP_XJ9Yyfyjsrl88s5qg3xx56/exec',
			buildingsSheet: 'Buildings',
			roomsSheet: 'Rooms',
			mapImagesSheet: 'MapImages',
			systemConfigSheet: 'SystemConfig',
			connected: false
		};
	
		// ======= ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏†‡∏≤‡∏û‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà =======
		let mapData = {
			floorplan: null,
			realphoto: null,
			notes: '',
			loaded: false
		};

		 let persistentDestination = {
			roomCode: null,
			roomName: null,
			timestamp: null
		};
				
		// ======= Enhanced Version Management ‡πÅ‡∏ö‡∏ö‡πÄ‡∏•‡πá‡∏Å‡∏Å‡∏∞‡∏ó‡∏±‡∏î‡∏£‡∏±‡∏î =======
		function updateGlobalVersionIndicator(version) {
			const indicator = document.getElementById('globalVersionIndicator');
			if (!indicator) return;
			
			if (version === 'demo') {
				indicator.innerHTML = 'üéÆ';  // ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÅ‡∏Ñ‡πà‡∏™‡∏±‡∏ç‡∏•‡∏±‡∏Å‡∏©‡∏ì‡πå
				indicator.className = 'status-indicator status-connected';
				indicator.title = 'Demo Mode'; // ‡πÉ‡∏ä‡πâ tooltip ‡πÅ‡∏ó‡∏ô
			} else {
				// Live Mode - ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Google Sheets
				if (sheetsConfig.connected) {
					indicator.innerHTML = 'üî¥';
					indicator.className = 'status-indicator status-active';
					indicator.title = 'Live Mode (Connected)';
				} else {
					indicator.innerHTML = '‚ö†Ô∏è';
					indicator.className = 'status-indicator status-error';
					indicator.title = 'Live Mode (Disconnected)';
				}
			}
		}

		// ======= Loading Overlay Functions =======
		function showLoadingOverlay(title, message) {
			const overlay = document.getElementById('loadingOverlay');
			const titleEl = document.getElementById('loadingTitle');
			const messageEl = document.getElementById('loadingMessage');
			
			if (overlay) overlay.style.display = 'flex';
			if (titleEl) titleEl.textContent = title || '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
			if (messageEl) messageEl.textContent = message || '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà...';
		}

		function hideLoadingOverlay() {
			const overlay = document.getElementById('loadingOverlay');
			if (overlay) overlay.style.display = 'none';
		}

		// ======= Data Caching System =======
		function getDataCacheKey(dataType) {
			return `${dataType}_cache_${currentVersion}`;
		}

		function getDataTimestampKey(dataType) {
			return `${dataType}_timestamp_${currentVersion}`;
		}

		function isCacheValid(dataType, maxAge = 30 * 60 * 1000) { // 30 minutes default
			const timestamp = localStorage.getItem(getDataTimestampKey(dataType));
			if (!timestamp) return false;
			
			const cacheAge = Date.now() - parseInt(timestamp);
			return cacheAge < maxAge;
		}

		// ======= ‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô setCachedData ‡πÄ‡∏î‡∏¥‡∏° =======
		function setCachedData(dataType, data) {
			return safeSetCachedData(dataType, data);
		}

		function getCachedData(dataType) {
			const cached = localStorage.getItem(getDataCacheKey(dataType));
			return cached ? JSON.parse(cached) : null;
		}
		
		// =================== System Configuration Functions ===================

		// ======= ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç System Configuration ‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á Loading Overlay ‡∏ó‡∏µ‡πà‡∏ö‡∏î‡∏ö‡∏±‡∏á =======
		async function checkSystemConfiguration() {
			try {
				console.log('üîç Checking system configuration...');
				
				// ‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á loading overlay ‡∏ó‡∏µ‡πà‡∏ö‡∏î‡∏ö‡∏±‡∏á ‡πÅ‡∏ï‡πà‡πÅ‡∏™‡∏î‡∏á status ‡πÄ‡∏•‡πá‡∏Å ‡πÜ ‡πÅ‡∏ó‡∏ô
				const isFirstTime = !localStorage.getItem('hasVisitedBefore');
				if (isFirstTime) {
					showProgressiveStatus('‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å...', 'info');
				}
				
				// ‡∏•‡∏≠‡∏á‡∏≠‡πà‡∏≤‡∏ô‡∏à‡∏≤‡∏Å Google Sheets ‡∏Å‡πà‡∏≠‡∏ô (‡πÅ‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏ö‡∏•‡πá‡∏≠‡∏Å UI)
				loadSystemConfigFromSheets()
					.then(config => {
						if (config) {
							systemConfig = { ...systemConfig, ...config };
							currentVersion = config.version;
							isMaintenanceMode = config.maintenance_mode === true || config.maintenance_mode === 'true';
							
							console.log('‚úÖ Loaded system config from Google Sheets:', systemConfig);
							updateGlobalVersionIndicator(currentVersion);
						}
					})
					.catch(error => {
						console.log('üì± Using local config as fallback');
					});
				
				// ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• local ‡πÄ‡∏õ‡πá‡∏ô default ‡πÑ‡∏°‡πà‡∏£‡∏≠ Google Sheets
				const savedVersion = localStorage.getItem('systemVersion') || 'demo';
				const savedConfig = localStorage.getItem('systemConfig');
				
				currentVersion = savedVersion;
				
				 
				if (savedConfig) {
					const parsed = JSON.parse(savedConfig);
					systemConfig = { ...systemConfig, ...parsed };
					isMaintenanceMode = systemConfig.maintenance_mode === true || systemConfig.maintenance_mode === 'true';
				}
				
				console.log('üì± Using initial system config:', systemConfig);
				
				// ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Maintenance Mode
				if (isMaintenanceMode) {
					showMaintenancePage();
					return false;
				}
				
				// Mark as visited
				localStorage.setItem('hasVisitedBefore', 'true');
				
				return true;
				
			} catch (error) {
				console.error('Error checking system configuration:', error);
				return true; // ‡πÉ‡∏´‡πâ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡πÑ‡∏î‡πâ‡πÅ‡∏°‡πâ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î
			}
		}
		
		
		async function loadSystemConfigFromSheets() {
			try {
				const params = new URLSearchParams();
				params.append('action', 'getData');
				params.append('sheet', sheetsConfig.systemConfigSheet);
				
				const response = await fetch(sheetsConfig.url, {
					method: 'POST',
					headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
					body: params.toString()
				});
				
				if (response.ok) {
					const result = await response.json();
					if (result.success && result.data && result.data.length > 0) {
						const config = result.data.find(item => item.id === 'system') || result.data[0];
						return {
							version: config.version || 'demo',
							maintenance_mode: config.maintenance_mode === 'true' || config.maintenance_mode === true,
							maintenance_message: config.maintenance_message || systemConfig.maintenance_message
						};
					}
				}
				
				return null;
				
			} catch (error) {
				console.error('Failed to load system config from sheets:', error);
				return null;
			}
		}

		// ===================  ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏ô‡πâ‡∏≤ Under Construction  =====
		function showMaintenancePage() {
			console.log('üöß Displaying maintenance page');
			document.body.innerHTML = `
				<div style="
					font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
					background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
					margin: 0;
					padding: 20px;
					display: flex;
					align-items: center;
					justify-content: center;
					min-height: 100vh;
					color: #333;
				">
					<div style="
						background: rgba(255, 255, 255, 0.95);
						backdrop-filter: blur(20px);
						padding: 50px;
						border-radius: 20px;
						text-align: center;
						max-width: 600px;
						box-shadow: 0 25px 50px rgba(0,0,0,0.3);
					">
						<div style="font-size: 80px; margin-bottom: 30px;">üöß</div>
						<h1 style="
							font-size: 2.5em;
							margin-bottom: 20px;
							background: linear-gradient(135deg, #667eea, #764ba2);
							-webkit-background-clip: text;
							-webkit-text-fill-color: transparent;
							background-clip: text;
						">Under Construction</h1>
						<p style="
							font-size: 1.2em;
							line-height: 1.6;
							color: #666;
							margin-bottom: 30px;
						">${systemConfig.maintenance_message}</p>
						<div style="
							background: rgba(102, 126, 234, 0.1);
							padding: 20px;
							border-radius: 15px;
							border-left: 4px solid #667eea;
						">
							<p style="margin: 0; font-size: 0.9em; color: #888;">
								<i class="fas fa-info-circle"></i>
								‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏î‡∏µ‡∏Ç‡∏∂‡πâ‡∏ô
							</p>
							<small style="color: #999; margin-top: 10px; display: block;">
							Version: ${currentVersion} | Mode: ${isMaintenanceMode ? 'Maintenance' : 'Normal'}
						</small>
						</div>
					</div>
				</div>
			`;
		}
        // FIX 1: Language translations
        const translations = {
            th: {
                search_title: "‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡∏∞‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà",
                search_btn: "‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤",
                category_classroom: "‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô",
                category_classroom_desc: "‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏õ‡∏Å‡∏ï‡∏¥‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î",
                category_special: "‡∏´‡πâ‡∏≠‡∏á‡∏û‡∏¥‡πÄ‡∏®‡∏©",
                category_special_desc: "‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£",
                category_facilities: "‡∏™‡∏¥‡πà‡∏á‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏î‡∏ß‡∏Å",
                category_facilities_desc: "‡∏´‡πâ‡∏≠‡∏á‡∏™‡∏°‡∏∏‡∏î ‡πÇ‡∏£‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£",
                category_office: "‡∏´‡πâ‡∏≠‡∏á‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô",
                category_office_desc: "‡∏´‡πâ‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£",
                map_title: "‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô",
                filter_building: "üè¢ ‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£",
                hide_controls: "‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏°",
                show_controls: "‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏°",
                floorplan: "‡πÅ‡∏ú‡∏ô‡∏ú‡∏±‡∏á",
                real_photo: "‡∏†‡∏≤‡∏û‡∏à‡∏£‡∏¥‡∏á",
                fullscreen: "‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≠",
                exit_fullscreen: "‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≠",
                show_route: "‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á",
                clear_route: "‡∏•‡πâ‡∏≤‡∏á‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á",
                voice_nav: "‡∏ô‡∏≥‡∏ó‡∏≤‡∏á‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏™‡∏µ‡∏¢‡∏á",
                about_title: "‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏£‡∏∞‡∏ö‡∏ö",
                system_name: "‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏≠‡∏±‡∏à‡∏â‡∏£‡∏¥‡∏¢‡∏∞ v6",
                system_desc: "‡∏£‡∏∞‡∏ö‡∏ö‡∏ô‡∏≥‡∏ó‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏±‡∏ô‡∏™‡∏°‡∏±‡∏¢ ‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡∏°‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ö‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏•‡∏±‡∏Å ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏£‡∏∞‡∏ö‡∏ö‡∏ô‡∏≥‡∏ó‡∏≤‡∏á‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô",
                features_title: "‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏ô‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô 6",
                usage_title: "‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô",
                step1_title: "1. ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏´‡πâ‡∏≠‡∏á:",
                step1_desc: "‡πÉ‡∏ä‡πâ‡∏ä‡πà‡∏≠‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏î‡πà‡∏ß‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏´‡∏≤‡∏´‡πâ‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£",
                step2_title: "2. ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏à‡∏∏‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô:",
                step2_desc: "‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏à‡∏∏‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡∏ó‡∏≤‡∏á",
                step3_title: "3. ‡∏î‡∏π‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á:",
                step3_desc: "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÑ‡∏õ ‡∏Ñ‡∏•‡∏¥‡∏Å \"‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á\" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥",
                step4_title: "4. ‡∏ô‡∏≥‡∏ó‡∏≤‡∏á‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏™‡∏µ‡∏¢‡∏á:",
                step4_desc: "‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ü‡∏±‡∏á‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á‡πÅ‡∏ö‡∏ö‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô",
                nav_search: "‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤",
                nav_map: "‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà",
                nav_about: "‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö",
                nav_admin: "‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£",
				nav_Present: "‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏£‡∏∞‡∏ö‡∏ö",
                info_building: "‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£",
                info_floor: "‡∏ä‡∏±‡πâ‡∏ô",
                info_type: "‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏´‡πâ‡∏≠‡∏á",
                info_description: "‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î",
                room_images: "‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏´‡πâ‡∏≠‡∏á",
                route_navigation: "‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏ô‡∏≥‡∏ó‡∏≤‡∏á",
                voice: "‡πÄ‡∏™‡∏µ‡∏¢‡∏á",
                view_details: "‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏´‡πâ‡∏≠‡∏á",
                show_route_direct: "‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á",
                select_action: "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£",
				whats_new: "‡∏°‡∏µ‡∏≠‡∏∞‡πÑ‡∏£‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏ô‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô 6",
				feature1_title: "‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡∏ó‡∏≤‡∏á‡∏ó‡∏µ‡πà‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥",
				feature1_desc: "‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏à‡∏∏‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÑ‡∏î‡πâ‡∏ó‡∏∏‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô",
				feature2_title: "‡∏ô‡∏≥‡∏ó‡∏≤‡∏á‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏™‡∏µ‡∏¢‡∏á",
				feature2_desc: "‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á‡πÅ‡∏ö‡∏ö‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©",
				feature3_title: "Mobile First",
				feature3_desc: "‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏•‡∏±‡∏Å ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢ UI ‡∏ó‡∏µ‡πà‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏°‡πÅ‡∏•‡∏∞‡∏ó‡∏±‡∏ô‡∏™‡∏°‡∏±‡∏¢",
				new1_title: "‡∏à‡∏∏‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÅ‡∏ö‡∏ö Custom",
				new1_desc: "‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏à‡∏∏‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÑ‡∏î‡πâ‡∏ó‡∏∏‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£",
				new2_title: "‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô",
				new2_desc: "‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡πÅ‡∏ö‡∏ö‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏à‡∏∏‡∏î‡∏ï‡πà‡∏≠‡∏à‡∏∏‡∏î‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÅ‡∏≠‡∏ô‡∏¥‡πÄ‡∏°‡∏ä‡∏±‡∏ô",
				new3_title: "‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û‡∏™‡∏π‡∏á",
				new3_desc: "‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏£‡πá‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô ‡πÉ‡∏ä‡πâ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≥‡∏ô‡πâ‡∏≠‡∏¢‡∏•‡∏á ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏°‡∏≤‡∏Å",
				how_to_use: "‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô",
				tech_info: "‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏≤‡∏á‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ",
				web_tech: "‡πÄ‡∏ó‡∏Ñ‡πÇ‡∏ô‡πÇ‡∏•‡∏¢‡∏µ‡πÄ‡∏ß‡πá‡∏ö",
				data_source: "‡πÅ‡∏´‡∏•‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•",
				voice_tech: "‡πÄ‡∏ó‡∏Ñ‡πÇ‡∏ô‡πÇ‡∏•‡∏¢‡∏µ‡πÄ‡∏™‡∏µ‡∏¢‡∏á",
				responsive: "Responsive Design", 
				show_usage_guide: "‡πÅ‡∏™‡∏î‡∏á‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô",
				hide_usage_guide: "‡∏ã‡πà‡∏≠‡∏ô‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô",
				usage_guide_title: "‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà",
				step1: "‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 1: ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏´‡πâ‡∏≠‡∏á",
				step1_desc: "‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ ‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏î‡πà‡∏ß‡∏ô",
				step2: "‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 2: ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏à‡∏∏‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô", 
				step2_desc: "‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏¢‡∏π‡πà",
				step3: "‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 3: ‡∏î‡∏π‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á",
				step3_desc: "‡∏Ñ‡∏•‡∏¥‡∏Å \"‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á\" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡∏ó‡∏≤‡∏á‡πÅ‡∏ö‡∏ö step by step"			
				
            },
            en: {
                search_title: "Search Classrooms and Places",
                search_btn: "Search",
                category_classroom: "Classrooms",
                category_classroom_desc: "All regular classrooms",
                category_special: "Special Rooms",
                category_special_desc: "Laboratories",
                category_facilities: "Facilities",
                category_facilities_desc: "Library, Cafeteria",
                category_office: "Offices",
                category_office_desc: "Administrative offices",
                map_title: "School Map",
                filter_building: "üè¢ Filter by Building",
                hide_controls: "Hide Controls",
                show_controls: "Show Controls",
                floorplan: "Floor Plan",
                real_photo: "Real Photo",
                fullscreen: "Fullscreen",
                exit_fullscreen: "Exit Fullscreen",
                show_route: "Show Route",
                clear_route: "Clear Route",
                voice_nav: "Voice Navigation",
                about_title: "About System",
                system_name: "Smart School Map System v6",
                system_desc: "Modern classroom search and navigation system designed primarily for mobile use with voice navigation and clear route display.",
                features_title: "New Features in Version 6",
                usage_title: "How to Use",
                step1_title: "1. Search Rooms:",
                step1_desc: "Use search box or click quick categories to find desired rooms",
                step2_title: "2. Set Starting Point:",
                step2_desc: "Click on the map to set navigation starting point",
                step3_title: "3. View Route:",
                step3_desc: "Select destination room, click \"Show Route\" to see path and directions",
                step4_title: "4. Voice Navigation:",
                step4_desc: "Enable sound to hear step-by-step navigation instructions",
                nav_search: "Search",
                nav_map: "Map",
                nav_about: "About",
                nav_admin: "Admin",
				nav_Present: "‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏£‡∏∞‡∏ö‡∏ö",
                info_building: "Building",
                info_floor: "Floor",
                info_type: "Room Type",
                info_description: "Description",
                room_images: "Room Images",
                route_navigation: "Route Navigation",
                voice: "Voice",
                view_details: "View Room Details",
                show_route_direct: "Show Route",
                select_action: "Select Action",
				whats_new: "What's New in Version 6",
				feature1_title: "Precise Navigation",
				feature1_desc: "Set starting point anywhere on the map with clear route guidance",
				feature2_title: "Voice Navigation",
				feature2_desc: "Step-by-step audio directions supporting Thai and English languages",
				feature3_title: "Mobile First",
				feature3_desc: "Designed for mobile devices with beautiful and modern UI",
				new1_title: "Custom Starting Point",
				new1_desc: "Set starting point anywhere on the map as desired",
				new2_title: "Clear Route Display",
				new2_desc: "Point-to-point route visualization with animations",
				new3_title: "High Performance",
				new3_desc: "Faster loading, lower memory usage, supports large datasets",
				how_to_use: "How to Use",
				tech_info: "Technical Information",
				web_tech: "Web Technology",
				data_source: "Data Source",
				voice_tech: "Voice Technology",
				responsive: "Responsive Design",
				show_usage_guide: "Show Usage Guide",
				hide_usage_guide: "Hide Usage Guide", 
				usage_guide_title: "Map Usage Guide",
				step1: "Step 1: Search Room",
				step1_desc: "Go to search page, select desired room or click quick categories",
				step2: "Step 2: Set Starting Point",
				step2_desc: "Click on map to set your current position",
				step3: "Step 3: View Route", 
				step3_desc: "Click \"Show Route\" to see step-by-step navigation"
            }
        };

        // =================== Sample Data ===================
        const sampleRoomData = {
            'R001': {
                code: 'R001',
                name: '‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ‡∏°.1/1',
                building: 'B001',
                location: '‡∏ä‡∏±‡πâ‡∏ô 1',
                description: '‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏õ‡∏Å‡∏ï‡∏¥‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ä‡∏±‡πâ‡∏ô‡∏°‡∏±‡∏ò‡∏¢‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏õ‡∏µ‡∏ó‡∏µ‡πà 1',
                hours: '08:00 - 16:30',
                status: 'active',
                x: 20, y: 30,
                images: ['https://picsum.photos/400/300?random=1']
            },
            'R002': {
                code: 'R002',
                name: '‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ‡∏°.1/2',
                building: 'B001',
                location: '‡∏ä‡∏±‡πâ‡∏ô 1',
                description: '‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏õ‡∏Å‡∏ï‡∏¥‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ä‡∏±‡πâ‡∏ô‡∏°‡∏±‡∏ò‡∏¢‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏õ‡∏µ‡∏ó‡∏µ‡πà 1',
                hours: '08:00 - 16:30',
                status: 'active',
                x: 45, y: 30,
                images: ['https://picsum.photos/400/300?random=2']
            },
            'C001': {
                code: 'C001',
                name: '‡∏´‡πâ‡∏≠‡∏á‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå 1',
                building: 'B002',
                location: '‡∏ä‡∏±‡πâ‡∏ô 2',
                description: '‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå ‡∏°‡∏µ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå 30 ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á',
                hours: '08:00 - 17:00',
                status: 'active',
                x: 25, y: 65,
                images: ['https://picsum.photos/400/300?random=3']
            },
            'L001': {
                code: 'L001',
                name: '‡∏´‡πâ‡∏≠‡∏á‡∏™‡∏°‡∏∏‡∏î‡∏´‡∏•‡∏±‡∏Å',
                building: 'B003',
                location: '‡∏ä‡∏±‡πâ‡∏ô 1',
                description: '‡∏´‡πâ‡∏≠‡∏á‡∏™‡∏°‡∏∏‡∏î‡∏´‡∏•‡∏±‡∏Å‡∏Ç‡∏≠‡∏á‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ‡∏°‡∏µ‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 15,000 ‡πÄ‡∏•‡πà‡∏°',
                hours: '07:30 - 18:00',
                status: 'active',
                x: 80, y: 70,
                images: ['https://picsum.photos/400/300?random=4']
            },
            'CAFE001': {
                code: 'CAFE001',
                name: '‡πÇ‡∏£‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏´‡∏•‡∏±‡∏Å',
                building: 'B004',
                location: '‡∏ä‡∏±‡πâ‡∏ô 1',
                description: '‡πÇ‡∏£‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏´‡∏•‡∏±‡∏Å‡∏Ç‡∏≠‡∏á‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô 500 ‡∏Ñ‡∏ô',
                hours: '06:30 - 14:00',
                status: 'active',
                x: 85, y: 40,
                images: ['https://picsum.photos/400/300?random=5']
            }
        };

        const sampleBuildingsData = {
            'B001': { code: 'B001', name: '‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô 1' },
            'B002': { code: 'B002', name: '‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô 2' },
            'B003': { code: 'B003', name: '‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô' },
            'B004': { code: 'B004', name: '‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£‡∏™‡∏¥‡πà‡∏á‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏î‡∏ß‡∏Å' }
        };

        // =================== FIX 1: Language System ===================
        
        function toggleLanguage() {
            currentLanguage = currentLanguage === 'th' ? 'en' : 'th';
            localStorage.setItem('preferredLanguage', currentLanguage);
            updateLanguageButton();
            updateAllTranslations();
            updateSearchPlaceholder();
            showNotification(
                currentLanguage === 'th' ? 'üáπüá≠ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢' : 'üá∫üá∏ Changed to English',
                'success'
            );
        }

        function updateLanguageButton() {
            const languageText = document.getElementById('languageText');
            if (languageText) {
                languageText.textContent = currentLanguage === 'th' ? 'TH' : 'EN';
            }
        }

        function updateAllTranslations() {
            const elementsToTranslate = document.querySelectorAll('[data-translate]');
            elementsToTranslate.forEach(element => {
                const key = element.getAttribute('data-translate');
                if (translations[currentLanguage] && translations[currentLanguage][key]) {
                    if (element.tagName === 'UL' && key === 'features_list') {
                        // Special handling for features list
                        if (currentLanguage === 'en') {
                            element.innerHTML = `
                                <li>üéØ Set starting point anywhere on the map</li>
                                <li>üõ£Ô∏è Clear point-to-point route display</li>
                                <li>üì± Mobile-optimized UI</li>
                                <li>üîä Detailed voice navigation system</li>
                                <li>‚ö° Better performance and lower memory usage</li>
                            `;
                        } else {
                            element.innerHTML = `
                                <li>üéØ ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏à‡∏∏‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÑ‡∏î‡πâ‡∏ó‡∏∏‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà</li>
                                <li>üõ£Ô∏è ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡πÅ‡∏ö‡∏ö‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏à‡∏∏‡∏î‡∏ï‡πà‡∏≠‡∏à‡∏∏‡∏î‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô</li>
                                <li>üì± UI ‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏Å‡∏±‡∏ö‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠</li>
                                <li>üîä ‡∏£‡∏∞‡∏ö‡∏ö‡∏ô‡∏≥‡∏ó‡∏≤‡∏á‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏µ‡πà‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</li>
                                <li>‚ö° ‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡πÄ‡∏£‡πá‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô‡πÅ‡∏•‡∏∞‡πÉ‡∏ä‡πâ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≥‡∏ô‡πâ‡∏≠‡∏¢‡∏•‡∏á</li>
                            `;
                        }
                    } else {
                        element.textContent = translations[currentLanguage][key];
                    }
                }
            });
            
            // Update title and subtitle
            const systemTitle = document.getElementById('systemTitle');
            const systemSubtitle = document.getElementById('systemSubtitle');
            
            if (currentLanguage === 'en') {
                if (systemTitle) systemTitle.textContent = 'üè´ Smart School Map System';
                if (systemSubtitle) systemSubtitle.textContent = 'Find classrooms and navigate with voice guidance';
            } else {
                if (systemTitle) systemTitle.textContent = 'üè´ ‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏≠‡∏±‡∏à‡∏â‡∏£‡∏¥‡∏¢‡∏∞';
                if (systemSubtitle) systemSubtitle.textContent = '‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡∏∞‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πà‡∏≤‡∏á‡πÜ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏£‡∏∞‡∏ö‡∏ö‡∏ô‡∏≥‡∏ó‡∏≤‡∏á‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏™‡∏µ‡∏¢‡∏á';
            }
        }

        function updateSearchPlaceholder() {
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                const placeholder = currentLanguage === 'th' 
                    ? searchInput.getAttribute('data-placeholder-th')
                    : searchInput.getAttribute('data-placeholder-en');
                searchInput.placeholder = placeholder;
            }
        }


		// ======= localStorage Quota Management =======
		function getStorageQuota() {
			try {
				// ‡∏ó‡∏î‡∏™‡∏≠‡∏ö localStorage quota
				const testKey = 'storage_test_' + Date.now();
				const testData = 'x'.repeat(1024); // 1KB test
				localStorage.setItem(testKey, testData);
				localStorage.removeItem(testKey);
				return true;
			} catch (e) {
				return false;
			}
		}

		function getStorageSize() {
			let total = 0;
			for (let key in localStorage) {
				if (localStorage.hasOwnProperty(key)) {
					total += localStorage[key].length + key.length;
				}
			}
			return total;
		}

		function freeUpStorage(targetSize = 50000) { // 50KB
			const keys = Object.keys(localStorage);
			const cacheKeys = keys.filter(key => key.includes('_cache_') || key.includes('_timestamp_'));
			
			// ‡∏•‡∏ö cache ‡πÄ‡∏Å‡πà‡∏≤‡∏ï‡∏≤‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤
			cacheKeys.sort((a, b) => {
				const timeA = localStorage.getItem(a.replace('_cache_', '_timestamp_').replace('_timestamp_', '_timestamp_'));
				const timeB = localStorage.getItem(b.replace('_cache_', '_timestamp_').replace('_timestamp_', '_timestamp_'));
				return parseInt(timeA || '0') - parseInt(timeB || '0');
			});
			
			let freed = 0;
			for (const key of cacheKeys) {
				if (freed >= targetSize) break;
				const size = localStorage[key]?.length || 0;
				localStorage.removeItem(key);
				freed += size;
				console.log(`üóëÔ∏è Removed cache: ${key} (${size} bytes)`);
			}
			
			return freed;
		}

		// ======= ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á Cache Management ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏ô‡∏≤‡∏î‡πÉ‡∏´‡∏ç‡πà =======
		function safeSetCachedData(dataType, data) {
			try {
				const dataString = JSON.stringify(data);
				const dataSize = dataString.length;
				
				// ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏µ‡∏î‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ï‡πà‡∏≤‡∏á‡πÜ
				const sizeLimit = {
					'mapImages': 2000000,    // 2MB ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà
					'rooms': 1000000,       // 1MB ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡πâ‡∏≠‡∏á
					'buildings': 500000,    // 500KB ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£
					'default': 500000       // 500KB ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏∑‡πà‡∏ô‡πÜ
				};
				
				const maxSize = sizeLimit[dataType] || sizeLimit['default'];
				
				// ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
				if (dataSize > maxSize) {
					console.warn(`‚ö†Ô∏è Data too large for cache: ${dataType} (${dataSize} bytes) > limit (${maxSize} bytes)`);
					
					// ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö mapImages ‡πÉ‡∏´‡πâ‡∏ö‡∏µ‡∏ö‡∏≠‡∏±‡∏î‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏ö‡πà‡∏á‡πÄ‡∏Å‡πá‡∏ö
					if (dataType === 'mapImages') {
						return compressAndCacheMapImages(data);
					}
					
					return false;
				}
				
				// ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ß‡πà‡∏≤‡∏á
				if (!getStorageQuota()) {
					console.log('üíæ Storage quota low, freeing up space...');
					freeUpStorage(dataSize + 100000); // ‡πÄ‡∏û‡∏¥‡πà‡∏° buffer 100KB
				}
				
				localStorage.setItem(getDataCacheKey(dataType), dataString);
				localStorage.setItem(getDataTimestampKey(dataType), Date.now().toString());
				
				console.log(`‚úÖ Cached ${dataType}: ${(dataSize/1024).toFixed(1)}KB`);
				return true;
				
			} catch (error) {
				if (error.name === 'QuotaExceededError') {
					console.warn('üö® Storage quota exceeded, attempting cleanup...');
					freeUpStorage(200000); // ‡∏•‡πâ‡∏≤‡∏á 200KB
					
					try {
						// ‡∏•‡∏≠‡∏á‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏´‡∏•‡∏±‡∏á‡∏•‡πâ‡∏≤‡∏á
						localStorage.setItem(getDataCacheKey(dataType), JSON.stringify(data));
						localStorage.setItem(getDataTimestampKey(dataType), Date.now().toString());
						console.log(`‚úÖ Cached ${dataType} after cleanup`);
						return true;
					} catch (retryError) {
						console.error(`‚ùå Failed to cache ${dataType} even after cleanup:`, retryError);
						return false;
					}
				} else {
					console.error(`‚ùå Cache error for ${dataType}:`, error);
					return false;
				}
			}
		}
		
		// ======= ‡πÄ‡∏û‡∏¥‡πà‡∏°: ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ö‡∏µ‡∏ö‡∏≠‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà =======
		function compressAndCacheMapImages(mapData) {
			try {
				// ‡∏ö‡∏µ‡∏ö‡∏≠‡∏±‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û base64 ‡πÇ‡∏î‡∏¢‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞ metadata ‡πÅ‡∏•‡∏∞ URL ‡∏™‡∏±‡πâ‡∏ô‡πÜ
				const compressedData = {
					floorplan: mapData.floorplan ? 'compressed_floorplan' : null,
					realphoto: mapData.realphoto ? 'compressed_realphoto' : null,
					notes: mapData.notes || '',
					loaded: mapData.loaded || false,
					compressed: true,
					originalSizes: {
						floorplan: mapData.floorplan ? mapData.floorplan.length : 0,
						realphoto: mapData.realphoto ? mapData.realphoto.length : 0
					}
				};
				
				// ‡πÄ‡∏Å‡πá‡∏ö‡∏£‡∏π‡∏õ‡∏à‡∏£‡∏¥‡∏á‡πÉ‡∏ô session storage ‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß
				if (mapData.floorplan) {
					try {
						sessionStorage.setItem('temp_floorplan', mapData.floorplan);
					} catch (e) {
						console.warn('Cannot store floorplan in session storage');
					}
				}
				
				if (mapData.realphoto) {
					try {
						sessionStorage.setItem('temp_realphoto', mapData.realphoto);
					} catch (e) {
						console.warn('Cannot store realphoto in session storage');
					}
				}
				
				// ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ö‡∏µ‡∏ö‡∏≠‡∏±‡∏î‡πÅ‡∏•‡πâ‡∏ß
				const compressedString = JSON.stringify(compressedData);
				localStorage.setItem(getDataCacheKey('mapImages'), compressedString);
				localStorage.setItem(getDataTimestampKey('mapImages'), Date.now().toString());
				
				console.log(`üóúÔ∏è Map images compressed and cached: ${(compressedString.length/1024).toFixed(1)}KB`);
				return true;
				
			} catch (error) {
				console.error('‚ùå Failed to compress map images:', error);
				return false;
			}
		}

      // ======= Progressive Data Loading ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Live Mode =======
			async function loadRoomDataFromAdmin() {
				try {
					console.log('üîÑ Loading room data for version:', currentVersion);
					
					if (currentVersion === 'demo') {
						// Demo mode - ‡πÉ‡∏ä‡πâ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏î‡∏¥‡∏°
						if (isCacheValid('rooms')) {
							roomData = getCachedData('rooms') || { ...sampleRoomData };
							console.log('üì± Loaded demo rooms from cache:', Object.keys(roomData).length, 'rooms');
						} else {
							const adminRooms = localStorage.getItem('roomsData');
							if (adminRooms) {
								roomData = JSON.parse(adminRooms);
								safeSetCachedData('rooms', roomData);
							} else {
								roomData = { ...sampleRoomData };
								safeSetCachedData('rooms', roomData);
							}
							console.log('üéÆ Using sample demo data:', Object.keys(roomData).length, 'rooms');
						}
					} else if (currentVersion === 'live') {
						// Live mode - Progressive Loading
						await progressiveLoadLiveData();
					}
					
					// ‡πÇ‡∏´‡∏•‡∏î buildings data
					await loadBuildingsData();
					
					updateGlobalVersionIndicator(currentVersion);
					showDataSourceStatus();
					
				} catch (error) {
					console.error('‚ùå Error loading room data:', error);
					// Fallback to cached or sample data
					roomData = getCachedData('rooms') || { ...sampleRoomData };
					showNotification('‚ö†Ô∏è ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏£‡∏≠‡∏á', 'warning');
				}
			}
			

			async function progressiveLoadLiveData() {
				// ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö cache ‡∏Å‡πà‡∏≠‡∏ô
				if (isCacheValid('rooms', 10 * 60 * 1000)) { // 10 ‡∏ô‡∏≤‡∏ó‡∏µ
					roomData = getCachedData('rooms') || {};
					console.log('üíæ Using cached rooms:', Object.keys(roomData).length, 'rooms');
					showProgressiveStatus('üèÉ‚Äç‚ôÇÔ∏è ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Cache', 'success');
					return;
				}
				
				// ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÅ‡∏ó‡∏ô‡∏Å‡∏≤‡∏£ Loading Overlay
				showProgressiveStatus('üåê ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Google Sheets...', 'info');
				
				try {
					// ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Google Sheets
					const sheetsData = await loadRoomsFromSheets();
					
					if (sheetsData && Object.keys(sheetsData).length > 0) {
						roomData = sheetsData;
						
						// ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å cache ‡πÅ‡∏ö‡∏ö‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢
						const cacheSuccess = safeSetCachedData('rooms', roomData);
						
						console.log('‚úÖ Loaded rooms from Google Sheets:', Object.keys(roomData).length, 'rooms');
						showProgressiveStatus(`‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ${Object.keys(roomData).length} ‡∏´‡πâ‡∏≠‡∏á`, 'success');
						
						if (!cacheSuccess) {
							showProgressiveStatus('‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Cache ‡πÑ‡∏î‡πâ', 'warning');
						}
					} else {
						// Fallback to cache or sample
						roomData = getCachedData('rooms') || { ...sampleRoomData };
						console.log('üì± Using fallback data:', Object.keys(roomData).length, 'rooms');
						showProgressiveStatus('üì± ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏£‡∏≠‡∏á', 'warning');
					}
					
				} catch (error) {
					console.error('‚ùå Failed to load from sheets:', error);
					roomData = getCachedData('rooms') || { ...sampleRoomData };
					showProgressiveStatus('‚ùå ‡πÇ‡∏´‡∏•‡∏î‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏£‡∏≠‡∏á', 'error');
				}
			}

			function showProgressiveStatus(message, type = 'info') {
				// ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÅ‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏ö‡∏î‡∏ö‡∏±‡∏á UI
				showNotification(message, type);
				
				// ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï version indicator ‡∏î‡πâ‡∏ß‡∏¢‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
				const indicator = document.getElementById('globalVersionIndicator');
				if (indicator && currentVersion === 'live') {
					if (type === 'info') {
						indicator.innerHTML = '‚è≥ LOADING...';
						indicator.className = 'status-indicator status-error';
					} else if (type === 'success') {
						indicator.innerHTML = 'üî¥ LIVE';
						indicator.className = 'status-indicator status-active';
					} else if (type === 'warning' || type === 'error') {
						indicator.innerHTML = '‚ö†Ô∏è ISSUES';
						indicator.className = 'status-indicator status-error';
					}
				}
			}
			
 
			// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÇ‡∏´‡∏•‡∏î Buildings Data
			 
			async function loadBuildingsData() {
				try {
					if (currentVersion === 'demo') {
						if (isCacheValid('buildings')) {
							buildingsData = getCachedData('buildings') || { ...sampleBuildingsData };
						} else {
							const savedBuildings = localStorage.getItem('buildingsData');
							if (savedBuildings) {
								buildingsData = JSON.parse(savedBuildings);
								setCachedData('buildings', buildingsData);
							} else {
								buildingsData = { ...sampleBuildingsData };
								setCachedData('buildings', buildingsData);
							}
						}
					} else if (currentVersion === 'live') {
						if (isCacheValid('buildings')) {
							buildingsData = getCachedData('buildings') || {};
							console.log('üíæ Loaded buildings from cache:', Object.keys(buildingsData).length, 'buildings');
						} else {
							const sheetsBuildings = await loadBuildingsFromSheets();
							if (sheetsBuildings && Object.keys(sheetsBuildings).length > 0) {
								buildingsData = sheetsBuildings;
								setCachedData('buildings', buildingsData);
								console.log('‚úÖ Loaded buildings from Google Sheets:', Object.keys(buildingsData).length, 'buildings');
							} else {
								buildingsData = getCachedData('buildings') || { ...sampleBuildingsData };
							}
						}
					}
				} catch (error) {
					console.error('‚ùå Error loading buildings data:', error);
					buildingsData = getCachedData('buildings') || { ...sampleBuildingsData };
				}
			}

			
			
			// ======= ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏à‡∏≤‡∏Å Google Sheets =======
			async function loadRoomsFromSheets() {
				try {
					console.log('üîÑ Loading rooms from Google Sheets...');
					
					// ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÄ‡∏û‡∏¥‡πà‡∏° timeout ‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ error
					const controller = new AbortController();
					const timeoutId = setTimeout(() => {
						controller.abort();
						console.log('‚è∞ Request timeout - aborting rooms loading');
					}, 15000); // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏õ‡πá‡∏ô 15 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
					
					const params = new URLSearchParams();
					params.append('action', 'getData');
					params.append('sheet', sheetsConfig.roomsSheet);
					
					const response = await fetch(sheetsConfig.url, {
						method: 'POST',
						headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
						body: params.toString(),
						signal: controller.signal
					});
					
					clearTimeout(timeoutId);
					
					if (!response.ok) {
						throw new Error(`HTTP ${response.status}: ${response.statusText}`);
					}
					
					const result = await response.json();
					console.log('üìä Rooms API response received');
					
					if (result.success && result.data && result.data.length > 0) {
						const rooms = {};
						
						// ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏õ‡∏£‡∏±‡∏ö batch size ‡πÉ‡∏´‡πâ‡πÄ‡∏•‡πá‡∏Å‡∏•‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô blocking
						const batchSize = 5; // ‡∏•‡∏î‡∏à‡∏≤‡∏Å 10 ‡πÄ‡∏õ‡πá‡∏ô 5
						let processedCount = 0;
						
						for (let i = 0; i < result.data.length; i += batchSize) {
							const batch = result.data.slice(i, i + batchSize);
							
							batch.forEach(row => {
								if (row.code && row.name) {
									rooms[row.code] = {
										code: row.code,
										name: row.name,
										building: row.building || '',
										location: row.location || row.floor || '',
										floor: parseInt(row.floor) || 1,
										type: row.type || 'classroom',
										description: row.description || '',
										hours: row.hours || '08:00 - 16:30',
										status: row.status || 'active',
										x: parseFloat(row.x) || 50,
										y: parseFloat(row.y) || 50,
										images: row.images ? (Array.isArray(row.images) ? row.images : [row.images]) : []
									};
									processedCount++;
								}
							});
							
							// ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤
							if (i % (batchSize * 4) === 0) { // ‡∏ó‡∏∏‡∏Å 20 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
								console.log(`üìä Processing rooms: ${processedCount}/${result.data.length}`);
								showProgressiveStatus(`üìä ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡πâ‡∏≠‡∏á: ${processedCount}/${result.data.length}`, 'info');
							}
							
							// ‡πÉ‡∏´‡πâ browser ‡∏°‡∏µ‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏• UI
							if (i + batchSize < result.data.length) {
								await new Promise(resolve => setTimeout(resolve, 20)); // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏õ‡πá‡∏ô 20ms
							}
						}
						
						console.log(`‚úÖ Rooms processed successfully: ${Object.keys(rooms).length} rooms`);
						return rooms;
					}
					
					console.warn('‚ö†Ô∏è No room data received from sheets');
					return null;
					
				} catch (error) {
					if (error.name === 'AbortError') {
						console.error('‚è∞ Request timeout loading rooms from sheets');
						showProgressiveStatus('‚è∞ ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡∏ô‡∏≤‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ', 'warning');
					} else {
						console.error('‚ùå Failed to load rooms from sheets:', error);
						showProgressiveStatus(`‚ùå ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡πâ‡∏≠‡∏á‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ${error.message}`, 'error');
					}
					return null;
				}
			}
			
		 
			async function loadBuildingsFromSheets() {
				try {
					console.log('üîÑ Loading buildings from Google Sheets...');
					
					const controller = new AbortController();
					const timeoutId = setTimeout(() => controller.abort(), 8000); // 8 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ timeout
					
					const params = new URLSearchParams();
					params.append('action', 'getData');
					params.append('sheet', sheetsConfig.buildingsSheet);
					
					const response = await fetch(sheetsConfig.url, {
						method: 'POST',
						headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
						body: params.toString(),
						signal: controller.signal
					});
					
					clearTimeout(timeoutId);
					
					if (!response.ok) {
						throw new Error(`HTTP ${response.status}: ${response.statusText}`);
					}
					
					const result = await response.json();
					console.log('üìä Buildings API response received');
					
					if (result.success && result.data && result.data.length > 0) {
						const buildings = {};
						result.data.forEach(row => {
							if (row.code && row.name) {
								buildings[row.code] = {
									code: row.code,
									name: row.name,
									floors: parseInt(row.floors) || 1,
									year: parseInt(row.year) || new Date().getFullYear(),
									description: row.description || '',
									status: row.status || 'active'
								};
							}
						});
						
						console.log('‚úÖ Buildings loaded successfully:', Object.keys(buildings).length, 'buildings');
						return buildings;
					}
					
					console.warn('‚ö†Ô∏è No building data received from sheets');
					return null;
					
				} catch (error) {
					if (error.name === 'AbortError') {
						console.error('‚è∞ Request timeout loading buildings from sheets');
					} else {
						console.error('‚ùå Failed to load buildings from sheets:', error);
					}
					return null;
				}
			}	

		// ======= Intelligent Cache Management =======
		function intelligentCacheManagement() {
			const maxCacheAge = {
				rooms: 15 * 60 * 1000,     // 15 ‡∏ô‡∏≤‡∏ó‡∏µ
				buildings: 30 * 60 * 1000,  // 30 ‡∏ô‡∏≤‡∏ó‡∏µ
				system: 60 * 60 * 1000      // 1 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á
			};
			
			const now = Date.now();
			const keys = Object.keys(localStorage);
			
			keys.forEach(key => {
				if (key.includes('_timestamp_')) {
					const dataType = key.replace('_timestamp_', '').replace('_live', '').replace('_demo', '');
					const timestamp = localStorage.getItem(key);
					const maxAge = maxCacheAge[dataType] || 15 * 60 * 1000; // default 15 minutes
					
					if (timestamp && (now - parseInt(timestamp)) > maxAge) {
						const cacheKey = key.replace('_timestamp_', '_cache_');
						localStorage.removeItem(key);
						localStorage.removeItem(cacheKey);
						console.log(`üóëÔ∏è Expired cache removed: ${dataType}`);
					}
				}
			});
		}
		
		// ======= Connection Quality Detection =======
		let connectionQuality = 'unknown';
		let lastLatency = 0;

		async function detectConnectionQuality() {
			try {
				const start = performance.now();
				
				// ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß‡∏î‡πâ‡∏ß‡∏¢ HEAD request ‡πÄ‡∏•‡πá‡∏Å ‡πÜ
				const response = await fetch(sheetsConfig.url, {
					method: 'HEAD',
					cache: 'no-cache'
				});
				
				const end = performance.now();
				lastLatency = end - start;
				
				if (lastLatency < 500) {
					connectionQuality = 'fast';
				} else if (lastLatency < 2000) {
					connectionQuality = 'medium';
				} else {
					connectionQuality = 'slow';
				}
				
				console.log(`üì∂ Connection quality: ${connectionQuality} (${Math.round(lastLatency)}ms)`);
				
				// ‡∏õ‡∏£‡∏±‡∏ö cache time ‡∏ï‡∏≤‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß‡πÄ‡∏ô‡πá‡∏ï
				if (connectionQuality === 'slow') {
					// ‡πÄ‡∏ô‡πá‡∏ï‡∏ä‡πâ‡∏≤ = cache ‡∏ô‡∏≤‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô
					maxCacheAge.rooms = 30 * 60 * 1000;    // 30 ‡∏ô‡∏≤‡∏ó‡∏µ
					maxCacheAge.buildings = 60 * 60 * 1000; // 1 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á
				}
				
			} catch (error) {
				connectionQuality = 'offline';
				console.log('üì∂ Connection: offline or error');
			}
		}
		
		// ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö connection quality ‡∏ó‡∏∏‡∏Å 2 ‡∏ô‡∏≤‡∏ó‡∏µ
		setInterval(detectConnectionQuality, 2 * 60 * 1000);


		// ======= ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á Background Sync ‡πÄ‡∏î‡∏¥‡∏°‡πÉ‡∏´‡πâ‡∏£‡∏ß‡∏°‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà =======
		async function backgroundSync() {
			if (currentVersion !== 'live' || connectionQuality === 'offline') {
				return;
			}
			
			console.log('üîÑ Background sync started...');
			
			try {
				// Sync ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡πâ‡∏≠‡∏á
				if (!isCacheValid('rooms')) {
					const rooms = await loadRoomsFromSheets();
					if (rooms) {
						roomData = { ...roomData, ...rooms };
						safeSetCachedData('rooms', roomData);
						console.log('üîÑ Background sync: rooms updated');
					}
				}
				
				// ‡∏£‡∏≠ 2 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ‡∏Å‡πà‡∏≠‡∏ô sync ‡∏ï‡πà‡∏≠
				await new Promise(resolve => setTimeout(resolve, 2000));
				
				// Sync ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£
				if (!isCacheValid('buildings')) {
					const buildings = await loadBuildingsFromSheets();
					if (buildings) {
						buildingsData = { ...buildingsData, ...buildings };
						safeSetCachedData('buildings', buildingsData);
						console.log('üîÑ Background sync: buildings updated');
					}
				}
				
				// ‡∏£‡∏≠ 2 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ‡∏Å‡πà‡∏≠‡∏ô sync ‡∏ï‡πà‡∏≠
				await new Promise(resolve => setTimeout(resolve, 2000));
				
				// ‚≠ê ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ - Sync ‡∏†‡∏≤‡∏û‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà
				await backgroundSyncMapImages();
				
			} catch (error) {
				console.log('üîÑ Background sync encountered issues:', error.message);
			}
		}
		// ======= ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á Debug ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Console =======
		window.refreshMapImages = refreshMapImages;
		window.debugMapImages = debugMapImages;
		window.retryLoadMapImages = retryLoadMapImages;
		


		// ======= ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà =======
		function getMapStatus() {
			return {
				version: currentVersion,
				layout: currentMapLayout,
				hasFloorplan: !!mapData.floorplan,
				hasRealPhoto: !!mapData.realphoto,
				loaded: mapData.loaded,
				cacheValid: isCacheValid('mapImages'),
				sheetsConnected: sheetsConfig.connected
			};
		}

		window.getMapStatus = getMapStatus;

		// ======= ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Map Status ‡πÉ‡∏ô Console =======
		console.log('üó∫Ô∏è Map Images System Ready');
		console.log('üìã Available commands:');
		console.log('  - debugMapImages() - ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• debug');
		console.log('  - refreshMapImages() - ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà');
		console.log('  - getMapStatus() - ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞');
		console.log('  - retryLoadMapImages() - ‡∏•‡∏≠‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏´‡∏°‡πà');
		
		 

		// ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û
		setInterval(intelligentCacheManagement, 5 * 60 * 1000); // ‡∏ó‡∏∏‡∏Å 5 ‡∏ô‡∏≤‡∏ó‡∏µ


		function showDataSourceStatus() {
			const roomCount = Object.keys(roomData).length;
			const buildingCount = Object.keys(buildingsData).length;
			
			let statusMessage = '';
			if (currentVersion === 'demo') {
				statusMessage = `üéÆ Demo Mode: ${roomCount} ‡∏´‡πâ‡∏≠‡∏á, ${buildingCount} ‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£`;
			} else {
				const cacheStatus = isCacheValid('rooms') ? '(‡∏à‡∏≤‡∏Å Cache)' : '(‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà)';
				statusMessage = `üî¥ Live Mode: ${roomCount} ‡∏´‡πâ‡∏≠‡∏á, ${buildingCount} ‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ ${cacheStatus}`;
			}
			
			setTimeout(() => {
				showNotification(statusMessage, 'info');
			}, 1000);
		}

        // =================== FIX 5: Building Filter System ===================
        /* / ======= ‡∏•‡∏ö Building Filter Functions =======
		async function extractBuildingsList() {
				// ‡πÇ‡∏´‡∏•‡∏î buildings data ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô live mode
				if (adminDataVersion === 'live') {
					const sheetsBuildings = await loadBuildingsFromSheets();
					if (sheetsBuildings) {
						console.log('‚úÖ Loaded buildings from Google Sheets:', Object.keys(sheetsBuildings).length, 'buildings');
					}
				}
				
				const buildings = new Set();
				Object.values(roomData).forEach(room => {
					if (room.building) {
						buildings.add(room.building);
					}
				});
				buildingsList = Array.from(buildings).sort();
				updateBuildingFilter();
			}

         function updateBuildingFilter() {
			const container = document.getElementById('buildingButtons');
			if (!container) return;
			
			const allText = currentLanguage === 'th' ? '‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î' : 'All';
			
			container.innerHTML = `
				<button class="building-btn ${currentBuildingFilter === 'all' ? 'active' : ''}" 
						onclick="filterByBuilding('all')">
					${allText}
				</button>
				${buildingsList.map(building => {
					// ‡πÉ‡∏ä‡πâ buildingsData ‡πÅ‡∏ó‡∏ô localStorage
					const buildingName = buildingsData[building]?.name || building;
					
					return `
						<button class="building-btn ${currentBuildingFilter === building ? 'active' : ''}" 
								onclick="filterByBuilding('${building}')">
							${buildingName}
						</button>
					`;
				}).join('')}
			`;
			
			console.log('üè¢ Building filter updated:', buildingsList.length, 'buildings');
		}

        function filterByBuilding(building) {
            currentBuildingFilter = building;
            updateBuildingFilter();
            updateRoomMarkers();
            
            const message = building === 'all' 
                ? (currentLanguage === 'th' ? 'üè¢ ‡πÅ‡∏™‡∏î‡∏á‡∏´‡πâ‡∏≠‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î' : 'üè¢ Showing all rooms')
                : (currentLanguage === 'th' ? `üè¢ ‡∏Å‡∏£‡∏≠‡∏á‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£: ${building}` : `üè¢ Filtered: ${building}`);
            
            showNotification(message, 'info');
        }
		*/

        // =================== Utility Functions ===================
        
        function getRoomIcon(roomName) {
            const lowerName = roomName.toLowerCase();
            if (lowerName.includes('computer') || lowerName.includes('‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå')) return 'üíª';
            if (lowerName.includes('library') || lowerName.includes('‡∏™‡∏°‡∏∏‡∏î')) return 'üìö';
            if (lowerName.includes('cafeteria') || lowerName.includes('‡∏≠‡∏≤‡∏´‡∏≤‡∏£')) return 'üçΩÔ∏è';
            if (lowerName.includes('music') || lowerName.includes('‡∏î‡∏ô‡∏ï‡∏£‡∏µ')) return 'üéµ';
            if (lowerName.includes('art') || lowerName.includes('‡∏®‡∏¥‡∏•‡∏õ‡∏∞')) return 'üé®';
            if (lowerName.includes('gym') || lowerName.includes('‡∏¢‡∏¥‡∏°')) return 'üèÉ';
            if (lowerName.includes('lab') || lowerName.includes('‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£') || lowerName.includes('‡πÄ‡∏Ñ‡∏°‡∏µ') || lowerName.includes('‡∏ü‡∏¥‡∏™‡∏¥‡∏Å‡∏™‡πå')) return 'üß™';
            if (lowerName.includes('office') || lowerName.includes('‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô') || lowerName.includes('‡∏ú‡∏π‡πâ‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Å‡∏≤‡∏£')) return 'üè¢';
            return 'üéì';
        }

        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            if (!notification) return;
            
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        function openAdminInterface() {
            // Update this URL after deployment
            window.open('./admin.html', '_blank');
        }
		function openSystemPresentation() {
            // Update this URL after deployment
            window.open('./SystemPresentation.html', '_blank');
        }


		// ======= ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Refresh ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà =======
		async function refreshMapImages() {
			const refreshBtn = document.getElementById('refreshMapBtn');
			if (refreshBtn) {
				refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> <span>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</span>';
				refreshBtn.disabled = true;
			}
			
			showNotification('üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà...', 'info');
			
			try {
				// ‡∏•‡πâ‡∏≤‡∏á cache ‡πÄ‡∏Å‡πà‡∏≤
				localStorage.removeItem(getDataCacheKey('mapImages'));
				localStorage.removeItem(getDataTimestampKey('mapImages'));
				
				// ‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏´‡∏°‡πà
				await loadMapDataFromSheets();
				
				showNotification('‚úÖ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
				
			} catch (error) {
				console.error('‚ùå Error refreshing map images:', error);
				showNotification('‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ', 'error');
			} finally {
				if (refreshBtn) {
					refreshBtn.innerHTML = '<i class="fas fa-sync-alt"></i> <span>‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà</span>';
					refreshBtn.disabled = false;
				}
			}
		}
		// ===== 2. ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Persistent Destination =====
		// ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏•‡∏±‡∏á‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô updateRouteControls()

		function saveDestination(roomCode) {
			if (roomCode && roomData[roomCode]) {
				persistentDestination = {
					roomCode: roomCode,
					roomName: roomData[roomCode].name,
					timestamp: Date.now()
				};
				localStorage.setItem('persistentDestination', JSON.stringify(persistentDestination));
				console.log('üíæ Saved destination:', persistentDestination);
			}
		}

		function loadDestination() {
			try {
				const saved = localStorage.getItem('persistentDestination');
				if (saved) {
					const data = JSON.parse(saved);
					// ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡πÄ‡∏Å‡πà‡∏≤‡πÄ‡∏Å‡∏¥‡∏ô 1 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á
					if (data.timestamp && (Date.now() - data.timestamp) < 3600000) {
						if (roomData[data.roomCode]) {
							persistentDestination = data;
							selectedRoom = data.roomCode;
							console.log('üéØ Restored destination:', data.roomName);
							return true;
						}
					}
				}
			} catch (error) {
				console.error('Error loading destination:', error);
			}
			return false;
		}

		function clearDestination() {
			persistentDestination = { roomCode: null, roomName: null, timestamp: null };
			localStorage.removeItem('persistentDestination');
			selectedRoom = null;
			console.log('üóëÔ∏è Cleared destination');
		}

		function showDestinationStatus() {
			if (persistentDestination.roomCode && roomData[persistentDestination.roomCode]) {
				const statusMessage = currentLanguage === 'th' 
					? `üéØ ‡∏à‡∏∏‡∏î‡∏´‡∏°‡∏≤‡∏¢: ${persistentDestination.roomName}`
					: `üéØ Destination: ${persistentDestination.roomName}`;
				
				showNotification(statusMessage, 'info');
				
				// ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á
				const showRouteBtn = document.getElementById('showRouteBtn');
				if (showRouteBtn) {
					showRouteBtn.disabled = false;
					showRouteBtn.style.background = 'var(--accent-color)';
				}
			}
		}

		// ===== 3. ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô selectRoom() =====
		// ‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô selectRoom() ‡πÄ‡∏î‡∏¥‡∏°

		function selectRoom(roomCode) {
			if (!roomData[roomCode]) return;
			
			const room = roomData[roomCode];
			selectedRoom = roomCode;
			
			// üÜï ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏à‡∏∏‡∏î‡∏´‡∏°‡∏≤‡∏¢‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á
			saveDestination(roomCode);
			
			showRoomDetails(roomCode);
			highlightRoom(roomCode);
			
			// Switch to map page
			showPage('map');
			
			// ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏õ‡∏∏‡πà‡∏°‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°
			updateRouteControls(true);
			
			// ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô
			const confirmMessage = currentLanguage === 'th' 
				? `‚úÖ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á ${room.name} ‡πÅ‡∏•‡πâ‡∏ß - ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏à‡∏∏‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô`
				: `‚úÖ Selected ${room.name} - Click on map to set starting point`;
			
			setTimeout(() => {
				showNotification(confirmMessage, 'success');
			}, 500);
		}

		// ===== 5. ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô handleMapClick() =====
		// ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô handleMapClick() ‡πÅ‡∏•‡∏∞‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏õ‡πá‡∏ô:
		function handleMapClick(event) {
			const mapContainer = document.getElementById('mapContainer');
			const rect = mapContainer.getBoundingClientRect();
			
			const x = ((event.clientX - rect.left) / rect.width) * 100;
			const y = ((event.clientY - rect.top) / rect.height) * 100;
			
			console.log('üìç Setting new start point:', {x, y});
			
			// ‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö
			const oldStartPoint = startPoint ? { ...startPoint } : null;
			const hasDestination = persistentDestination.roomCode && roomData[persistentDestination.roomCode];
			
			// ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏à‡∏∏‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÉ‡∏´‡∏°‡πà
			startPoint = { x: x, y: y };
			localStorage.setItem('startPoint', JSON.stringify(startPoint));
			
			// ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï start point marker
			updateStartPointMarker();
			
			// ‡∏•‡πâ‡∏≤‡∏á‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
			document.querySelectorAll('.route-line, .route-marker').forEach(el => el.remove());
			const routePath = document.getElementById('routePath');
			if (routePath) {
				routePath.innerHTML = '';
			}
			
			// ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏≤‡∏£‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏à‡∏∏‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
			const startMessage = currentLanguage === 'th' 
				? 'üìç ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏à‡∏∏‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÅ‡∏•‡πâ‡∏ß' 
				: 'üìç Starting point set';
			showNotification(startMessage, 'success');
			
			// ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏à‡∏∏‡∏î‡∏´‡∏°‡∏≤‡∏¢‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á ‡πÉ‡∏´‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
			if (hasDestination) {
				console.log('üéØ Destination exists, creating route immediately...');
				
				// ‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏à‡∏∏‡∏î‡∏´‡∏°‡∏≤‡∏¢‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á
				selectedRoom = persistentDestination.roomCode;
				
				// ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡∏ô‡∏ó‡∏µ (‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ setTimeout)
				showRouteToSelected();
				
				// ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï UI controls
				updateRouteControls(true);
				updateDestinationDisplay();
				
				// ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà
				setTimeout(() => {
					const routeMessage = currentLanguage === 'th' 
						? `üõ£Ô∏è ‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏õ‡∏¢‡∏±‡∏á ${persistentDestination.roomName}`
						: `üõ£Ô∏è New route to ${persistentDestination.roomName}`;
					showNotification(routeMessage, 'info');
				}, 800);
				
			} else {
				console.log('üìç No destination set');
				// ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏à‡∏∏‡∏î‡∏´‡∏°‡∏≤‡∏¢ ‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï controls
				updateRouteControls(false);
				
				// ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á
				setTimeout(() => {
					const selectMessage = currentLanguage === 'th' 
						? 'üè´ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á'
						: 'üè´ Please search and select a destination room';
					showNotification(selectMessage, 'info');
				}, 1000);
			}
		}
		
		// ===== ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏õ‡∏±‡∏ç‡∏´‡∏≤ state =====
		function validateRouteState() {
			console.log('üîç Validating route state...');
			
			// ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö persistent destination
			if (persistentDestination.roomCode && !roomData[persistentDestination.roomCode]) {
				console.warn('‚ö†Ô∏è Persistent destination refers to non-existent room');
				clearDestination();
				return false;
			}
			
			// ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö selectedRoom
			if (selectedRoom && !roomData[selectedRoom]) {
				console.warn('‚ö†Ô∏è Selected room does not exist');
				selectedRoom = null;
				return false;
			}
			
			// ‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á selectedRoom ‡πÅ‡∏•‡∏∞ persistentDestination
			if (persistentDestination.roomCode && selectedRoom !== persistentDestination.roomCode) {
				console.log('üîß Syncing selected room with persistent destination');
				selectedRoom = persistentDestination.roomCode;
			}
			
			return true;
		}

		// ===== ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Debug ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏õ‡∏±‡∏ç‡∏´‡∏≤ =====
		// ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ debug function ‡∏ô‡∏µ‡πâ‡πÉ‡∏ô console ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤: debugRouteProblem()
		function debugRouteProblem() {
			console.group('üêõ Route State Debug');
			console.log('startPoint:', startPoint);
			console.log('selectedRoom:', selectedRoom);
			console.log('persistentDestination:', persistentDestination);
			console.log('Room data exists:', selectedRoom ? !!roomData[selectedRoom] : 'No room selected');
			console.log('Route displayed:', document.querySelector('.route-line') ? 'Yes' : 'No');
			console.log('LocalStorage persistent:', localStorage.getItem('persistentDestination'));
			console.log('LocalStorage startPoint:', localStorage.getItem('startPoint'));
			console.groupEnd();
		}



        // =================== Page Management ===================
		// ======= ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô showPage ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà =======
		function showPage(pageId) {
			document.querySelectorAll('.page').forEach(page => {
				page.classList.remove('active');
			});
			
			document.querySelectorAll('.nav-item').forEach(item => {
				item.classList.remove('active');
			});
			
			const targetPage = document.getElementById(pageId + '-page');
			if (targetPage) {
				targetPage.classList.add('active');
			}
			
			if (pageId === 'search') {
				document.querySelector('.nav-item:nth-child(1)').classList.add('active');
			} else if (pageId === 'map') {
				document.querySelector('.nav-item:nth-child(2)').classList.add('active');
				
				// ‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡∏∞‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö destination state
				setTimeout(() => {
					console.log('üìç Loading map page...');
					
					// ‡πÇ‡∏´‡∏•‡∏î destination ‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ
					const destinationLoaded = loadDestination();
					
					// ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö state consistency
					validateRouteState();
					ensureRouteConsistency();
					
					// ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
					if (destinationLoaded || persistentDestination.roomCode) {
						showDestinationStatus();
						updateDestinationDisplay();
						updateRouteControls(true);
					}
					
					// ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï markers
					updateRoomMarkers();
					
					// ‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà
					if (!mapData.loaded && currentVersion === 'live') {
						initializeMapImages();
					} else if (!mapData.loaded) {
						showFallbackMap();
					} else {
						updateMapDisplay();
					}
					
				}, 150);
				
			} else if (pageId === 'about') {
				document.querySelector('.nav-item:nth-child(3)').classList.add('active');
			}
		}
		function showPage_org(pageId) {
			document.querySelectorAll('.page').forEach(page => {
				page.classList.remove('active');
			});
			
			document.querySelectorAll('.nav-item').forEach(item => {
				item.classList.remove('active');
			});
			
			const targetPage = document.getElementById(pageId + '-page');
			if (targetPage) {
				targetPage.classList.add('active');
			}
			
			if (pageId === 'search') {
				document.querySelector('.nav-item:nth-child(1)').classList.add('active');
			} else if (pageId === 'map') {
				document.querySelector('.nav-item:nth-child(2)').classList.add('active');
				
				// üÜï ‡πÇ‡∏´‡∏•‡∏î‡∏à‡∏∏‡∏î‡∏´‡∏°‡∏≤‡∏¢‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ
				if (loadDestination()) {
					showDestinationStatus();
					updateRouteControls(true);
				}
				
				// üÜï ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≠‡∏î‡∏Ñ‡∏•‡πâ‡∏≠‡∏á‡∏Ç‡∏≠‡∏á route
				setTimeout(() => {
					ensureRouteConsistency();
				}, 200);
				
				// ‚≠ê ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ - ‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà
				setTimeout(() => {
					updateRoomMarkers();
					
					// ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
					if (!mapData.loaded && currentVersion === 'live') {
						initializeMapImages();
					} else if (!mapData.loaded) {
						showFallbackMap();
					} else {
						updateMapDisplay();
					}
				}, 100);
				
			} else if (pageId === 'about') {
				document.querySelector('.nav-item:nth-child(3)').classList.add('active');
			}
		}
		
		// ===== 7. ‡πÄ‡∏û‡∏¥‡πà‡∏° Error Handling ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û =====
		// ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà:

		function handleImageLoadError(imgElement, roomName = '') {
			console.warn('‚ö†Ô∏è Image load failed:', imgElement.src);
			
			imgElement.style.display = 'none';
			
			// ‡∏™‡∏£‡πâ‡∏≤‡∏á placeholder
			const placeholder = document.createElement('div');
			placeholder.style.cssText = `
				text-align: center; 
				padding: 40px; 
				background: #f8f9fa; 
				border-radius: 8px; 
				color: var(--text-secondary);
				border: 2px dashed #dee2e6;
			`;
			placeholder.innerHTML = `
				<i class="fas fa-image" style="font-size: 32px; opacity: 0.3; margin-bottom: 10px;"></i>
				<p>‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÑ‡∏î‡πâ</p>
				${roomName ? `<small>‡∏´‡πâ‡∏≠‡∏á: ${roomName}</small>` : ''}
			`;
			
			imgElement.parentNode.insertBefore(placeholder, imgElement.nextSibling);
		}	
		
		window.debugRouteState = function() {
			console.log('üêõ Route Debug State:');
			console.log('selectedRoom:', selectedRoom);
			console.log('persistentDestination:', persistentDestination);
			console.log('startPoint:', startPoint);
			console.log('Room exists:', selectedRoom ? !!roomData[selectedRoom] : 'N/A');
			console.log('Route lines on page:', document.querySelectorAll('.route-line').length);
			console.log('Route markers on page:', document.querySelectorAll('.route-marker').length);
		};
		
		// ======= ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Error ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏†‡∏≤‡∏û‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà =======
		function handleMapImageError(event) {
			console.error('‚ùå Map image failed to load:', event.target.src);
			
			// ‡∏•‡∏≠‡∏á‡∏™‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏†‡∏≤‡∏û‡∏≠‡∏∑‡πà‡∏ô‡∏Å‡πà‡∏≠‡∏ô
			if (currentMapLayout === 'photo' && mapData.floorplan) {
				console.log('üîÑ Photo failed, trying floorplan...');
				currentMapLayout = 'floorplan';
				updateMapDisplay();
				showNotification('‚ö†Ô∏è ‡∏†‡∏≤‡∏û‡∏à‡∏£‡∏¥‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏ú‡∏ô‡∏ú‡∏±‡∏á', 'warning');
				return;
			} else if (currentMapLayout === 'floorplan' && mapData.realphoto) {
				console.log('üîÑ Floorplan failed, trying photo...');
				currentMapLayout = 'photo';
				updateMapDisplay();
				showNotification('‚ö†Ô∏è ‡πÅ‡∏ú‡∏ô‡∏ú‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏û‡∏à‡∏£‡∏¥‡∏á', 'warning');
				return;
			}
			
			// ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏†‡∏≤‡∏û‡∏≠‡∏∑‡πà‡∏ô‡πÉ‡∏´‡πâ‡∏•‡∏≠‡∏á ‡πÅ‡∏™‡∏î‡∏á fallback
			showFallbackMap();
			showNotification('‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏†‡∏≤‡∏û‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ', 'warning');
		}
		
		// ======= ‡πÄ‡∏û‡∏¥‡πà‡∏° Auto-retry ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà =======
		async function retryLoadMapImages(maxRetries = 3) {
			for (let i = 0; i < maxRetries; i++) {
				try {
					console.log(`üîÑ Retry loading map images: attempt ${i + 1}/${maxRetries}`);
					await loadMapDataFromSheets();
					
					if (mapData.floorplan || mapData.realphoto) {
						console.log('‚úÖ Map images loaded successfully on retry');
						return true;
					}
				} catch (error) {
					console.warn(`‚ö†Ô∏è Retry ${i + 1} failed:`, error.message);
					
					if (i < maxRetries - 1) {
						// ‡∏£‡∏≠ 2 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ‡∏Å‡πà‡∏≠‡∏ô‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà
						await new Promise(resolve => setTimeout(resolve, 2000));
					}
				}
			}
			
			console.error('‚ùå All retry attempts failed');
			return false;
		}
		
		// ======= Background Sync ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà =======
		async function backgroundSyncMapImages() {
			if (currentVersion !== 'live') return;
			
			// ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ cache ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
			if (!isCacheValid('mapImages', 60 * 60 * 1000)) { // 1 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á
				console.log('üîÑ Background sync: Map images cache expired, refreshing...');
				
				try {
					await loadMapDataFromSheets();
					console.log('‚úÖ Background sync: Map images updated');
				} catch (error) {
					console.log('‚ö†Ô∏è Background sync: Map images failed -', error.message);
				}
			}
		}

		// ======= Cache Management Functions =======
		function clearDataCache() {
			// ‡∏•‡∏ö cache ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà
			const keys = Object.keys(localStorage);
			keys.forEach(key => {
				if (key.includes('_cache_') || key.includes('_timestamp_')) {
					localStorage.removeItem(key);
				}
			});
			console.log('üóëÔ∏è Data cache cleared');
		}

		function getCacheInfo() {
			// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö debug - ‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô cache
			const cacheInfo = {
				rooms: {
					cached: !!getCachedData('rooms'),
					timestamp: localStorage.getItem(getDataTimestampKey('rooms')),
					valid: isCacheValid('rooms')
				},
				buildings: {
					cached: !!getCachedData('buildings'),
					timestamp: localStorage.getItem(getDataTimestampKey('buildings')),
					valid: isCacheValid('buildings')
				}
			};
			console.log('üìä Cache Info:', cacheInfo);
			return cacheInfo;
		}

        // =================== Search Functions ===================
        
        function handleSearchKeyPress(event) {
            if (event.key === 'Enter') {
                searchRoom();
            }
        }

        function liveSearch() {
            const searchInput = document.getElementById('searchInput');
            if (!searchInput) return;
            
            const searchTerm = searchInput.value.toLowerCase().trim();
            const resultsContainer = document.getElementById('liveResults');
            
            if (!resultsContainer) return;
            
            if (!searchTerm) {
                resultsContainer.innerHTML = '';
                return;
            }
            
            const results = searchRooms(searchTerm);
            displaySearchResults(results);
        }

        function searchRoom() {
            const searchInput = document.getElementById('searchInput');
            if (!searchInput) return;
            
            const searchTerm = searchInput.value.toLowerCase().trim();
            
            if (!searchTerm) {
                showNotification('‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤', 'error');
                return;
            }
            
            const results = searchRooms(searchTerm);
            displaySearchResults(results);
        }

        function searchRooms(searchTerm) {
            const rooms = Object.values(roomData);
            return rooms.filter(room => {
                if (room.status !== 'active') return false;
                
                const searchFields = [
                    room.name.toLowerCase(),
                    room.code.toLowerCase(),
                    room.location.toLowerCase(),
                    room.building.toLowerCase(),
                    room.description.toLowerCase()
                ];
                return searchFields.some(field => field.includes(searchTerm));
            });
        }

        // ======= Updated Search Results Display =======
		function displaySearchResults(results) {
			const resultsContainer = document.getElementById('liveResults');
			if (!resultsContainer) return;
			
			if (results.length > 0) {
				resultsContainer.innerHTML = results.map(room => {
					// ‡πÉ‡∏ä‡πâ buildingsData ‡πÅ‡∏ó‡∏ô localStorage
					const buildingName = buildingsData[room.building]?.name || room.building;
					
					return `
						<div class="search-result-item" onclick="viewOnMap('${room.code}')">
							<div class="search-result-header">
								<div class="search-result-title">
									${getRoomIcon(room.name)} ${room.name}
								</div>
								<div class="search-result-code">${room.code}</div>
							</div>
							<div class="search-result-info">
								${buildingName} - ${room.location || room.floor || '‡∏ä‡∏±‡πâ‡∏ô ' + (room.floor || 'N/A')}
							</div>
						</div>
					`;
				}).join('');
				
				// ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥
				const hintMessage = currentLanguage === 'th' 
					? 'üí° ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà'
					: 'üí° Click search result to view location on map';
				
				resultsContainer.innerHTML += `
					<div style="text-align: center; padding: 15px; background: rgba(102, 126, 234, 0.1); border-radius: var(--border-radius); margin-top: 10px; color: var(--primary-color); font-size: 12px;">
						${hintMessage}
					</div>
				`;
			} else {
				const noResultsText = currentLanguage === 'th' ? '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤' : 'No results found';
				resultsContainer.innerHTML = `
					<div style="text-align: center; padding: 40px; color: var(--text-secondary);">
						<div style="font-size: 48px; margin-bottom: 15px; opacity: 0.7;">üîç</div>
						<p>${noResultsText}</p>
					</div>
				`;
			}
		}

        function quickSearch(category) {
            let searchResults = [];
            
            switch(category) {
                case 'classroom':
                    searchResults = Object.values(roomData).filter(room => 
                        room.status === 'active' && (
                        room.name.includes('‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô') || room.name.includes('Classroom') || room.name.includes('‡∏°.'))
                    );
                    break;
                case 'special':
                    searchResults = Object.values(roomData).filter(room => 
                        room.status === 'active' && (
                        room.name.includes('‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå') || room.name.includes('Computer') ||
                        room.name.includes('‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£') || room.name.includes('Lab'))
                    );
                    break;
                case 'facilities':
                    searchResults = Object.values(roomData).filter(room => 
                        room.status === 'active' && (
                        room.name.includes('‡∏™‡∏°‡∏∏‡∏î') || room.name.includes('Library') ||
                        room.name.includes('‡∏≠‡∏≤‡∏´‡∏≤‡∏£') || room.name.includes('Cafeteria'))
                    );
                    break;
                case 'office':
                    searchResults = Object.values(roomData).filter(room => 
                        room.status === 'active' && (
                        room.name.includes('‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô') || room.name.includes('Office'))
                    );
                    break;
            }
            
            displaySearchResults(searchResults);
        }

        // =================== Map Functions ===================
		// ======= Updated Search Functions =======
		function viewOnMap(roomCode) {
			showPage('map');
			setTimeout(() => {
				// ‡πÄ‡∏ã‡πá‡∏ï‡∏´‡πâ‡∏≠‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á marker
				selectedRoom = roomCode;
				updateRoomMarkers();
				
				// ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡πâ‡∏≠‡∏á
				showRoomInfoOverlay(roomCode);
				
				// ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÉ‡∏´‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏à‡∏∏‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
				if (!startPoint) {
					const message = currentLanguage === 'th' 
						? 'üí° ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏±‡πâ‡∏á‡∏à‡∏∏‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô ‡∏à‡∏≤‡∏Å‡∏ô‡∏±‡πâ‡∏ô‡∏Ñ‡∏•‡∏¥‡∏Å "‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡∏ó‡∏≤‡∏á'
						: 'üí° Click on map to set starting point, then click "Show Route" for navigation';
					
					setTimeout(() => {
						showNotification(message, 'info');
					}, 1000);
				}
			}, 300);
		}


        function highlightRoom(roomCode) {
            document.querySelectorAll('.room-marker').forEach(marker => {
                marker.classList.remove('highlighted');
            });
            
            const targetMarker = document.querySelector(`[data-room="${roomCode}"]`);
            if (targetMarker) {
                targetMarker.classList.add('highlighted');
                selectedRoom = roomCode;
                
                setTimeout(() => {
                    targetMarker.classList.remove('highlighted');
                }, 3000);
            }
        }

        // 1.1: Toggle map controls visibility
        function toggleMapControls() {
			const mapControls = document.getElementById('mapControls');
			const toggleBtn = document.getElementById('toggleControlsBtn');
			const showControlsBtn = document.getElementById('showControlsBtn');
			
			if (!mapControls || !toggleBtn) return;
			
			const isHidden = mapControls.classList.contains('hidden');
			
			if (isHidden) {
				// Show controls
				mapControls.classList.remove('hidden');
				toggleBtn.innerHTML = `<i class="fas fa-eye-slash"></i> <span data-translate="hide_controls">${currentLanguage === 'th' ? '‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏°' : 'Hide Controls'}</span>`;
				if (showControlsBtn) {
					showControlsBtn.style.display = 'none';
				}
				showNotification(
					currentLanguage === 'th' ? 'üëÅÔ∏è ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏°‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°' : 'üëÅÔ∏è Controls shown',
					'info'
				);
			} else {
				// Hide controls
				mapControls.classList.add('hidden');
				toggleBtn.innerHTML = `<i class="fas fa-eye"></i> <span data-translate="show_controls">${currentLanguage === 'th' ? '‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏°' : 'Show Controls'}</span>`;
				if (showControlsBtn) {
					showControlsBtn.style.display = 'block';
				}
				showNotification(
					currentLanguage === 'th' ? 'üôà ‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏°‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°' : 'üôà Controls hidden',
					'info'
				);
			}
		}
		
		function showAllControls() {
			const mapControls = document.getElementById('mapControls');
			const toggleBtn = document.getElementById('toggleControlsBtn');
			const showControlsBtn = document.getElementById('showControlsBtn');
			
			if (!mapControls || !toggleBtn) return;
			
			mapControls.classList.remove('hidden');
			toggleBtn.innerHTML = `<i class="fas fa-eye-slash"></i> <span data-translate="hide_controls">${currentLanguage === 'th' ? '‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏°' : 'Hide Controls'}</span>`;
			if (showControlsBtn) {
				showControlsBtn.style.display = 'none';
			}
			showNotification(
				currentLanguage === 'th' ? 'üëÅÔ∏è ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏°‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î' : 'üëÅÔ∏è All controls shown',
				'info'
			);
		}



        // 1.1: Set map layout (floorplan/photo)
        function setMapLayout(layout) {
            currentMapLayout = layout;
            
            document.querySelectorAll('.map-control-btn[data-layout]').forEach(btn => {
                btn.classList.remove('active');
            });
            
            const targetBtn = document.querySelector(`[data-layout="${layout}"]`);
            if (targetBtn) {
                targetBtn.classList.add('active');
            }
            
            // In real implementation, would switch between different map images
            const mapImage = document.getElementById('mapImage');
            if (mapImage) {
                if (layout === 'photo') {
                    // Replace with actual photo map
                    showNotification(
                        currentLanguage === 'th' ? 'üì∏ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏û‡∏à‡∏£‡∏¥‡∏á' : 'üì∏ Switched to photo view',
                        'success'
                    );
                } else {
                    // Use floorplan
                    showNotification(
                        currentLanguage === 'th' ? 'üìê ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏ún‡∏ú‡∏±‡∏á' : 'üìê Switched to floor plan',
                        'success'
                    );
                }
            }
        }

        // 1.1: Toggle fullscreen mode
		// ‡∏´‡∏≤‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡∏∞‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
		 function toggleFullscreen() {
			const mapArea = document.getElementById('mapArea');
			const fullscreenBtn = document.getElementById('fullscreenBtn');
			const mapControls = document.getElementById('mapControls');
			const showControlsBtn = document.getElementById('showControlsBtn');
			
			if (!mapArea || !fullscreenBtn) return;
			
			if (isFullscreen) {
				// Exit fullscreen
				mapArea.classList.remove('fullscreen');
				if (mapControls) {
					mapControls.classList.remove('fullscreen-controls');
				}
				if (showControlsBtn) {
					showControlsBtn.style.display = 'none';
				}
				fullscreenBtn.innerHTML = `<i class="fas fa-expand"></i> <span data-translate="fullscreen">${currentLanguage === 'th' ? '‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≠' : 'Fullscreen'}</span>`;
				isFullscreen = false;
				showNotification(
					currentLanguage === 'th' ? 'üì± ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≠' : 'üì± Exited fullscreen mode',
					'info'
				);
			} else {
				// Enter fullscreen
				mapArea.classList.add('fullscreen');
				if (mapControls) {
					mapControls.classList.add('fullscreen-controls');
					mapControls.classList.remove('hidden');
				}
				if (showControlsBtn) {
					showControlsBtn.style.display = 'none';
				}
				fullscreenBtn.innerHTML = `<i class="fas fa-compress"></i> <span data-translate="exit_fullscreen">${currentLanguage === 'th' ? '‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≠' : 'Exit Fullscreen'}</span>`;
				isFullscreen = true;
				showNotification(
					currentLanguage === 'th' ? 'üñ•Ô∏è ‡πÄ‡∏Ç‡πâ‡∏≤‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≠' : 'üñ•Ô∏è Entered fullscreen mode',
					'info'
				);
			}
		}
        // =================== FIX 2: Route Persistence Functions ===================
        
      // ===== 4. ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô showRouteToSelected() ‡πÉ‡∏´‡πâ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡πÄ‡∏£‡πá‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô =====
		function showRouteToSelected() {
			console.log('üõ£Ô∏è Showing route to selected room...');
			
			// ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏à‡∏∏‡∏î‡∏´‡∏°‡∏≤‡∏¢‡∏à‡∏≤‡∏Å persistent storage ‡∏Å‡πà‡∏≠‡∏ô
			if (!selectedRoom && persistentDestination.roomCode) {
				selectedRoom = persistentDestination.roomCode;
				console.log('üéØ Using persistent destination:', persistentDestination.roomName);
			}
			
			if (!selectedRoom || !roomData[selectedRoom]) {
				const selectMessage = currentLanguage === 'th' 
					? '‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á‡∏Å‡πà‡∏≠‡∏ô'
					: '‚ùå Please select a destination room first';
				showNotification(selectMessage, 'error');
				return;
			}
			
			if (!startPoint || startPoint.x === null || startPoint.y === null) {
				const startMessage = currentLanguage === 'th' 
					? '‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏à‡∏∏‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô'
					: '‚ùå Please click on map to set starting point';
				showNotification(startMessage, 'error');
				return;
			}
			
			// ‡∏•‡πâ‡∏≤‡∏á‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡πÄ‡∏î‡∏¥‡∏°‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå
			document.querySelectorAll('.route-line, .route-marker').forEach(el => el.remove());
			const routePath = document.getElementById('routePath');
			if (routePath) {
				routePath.innerHTML = '';
			}
			
			// ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï persistent destination ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÅ‡∏ô‡πà‡πÉ‡∏à
			if (selectedRoom !== persistentDestination.roomCode) {
				saveDestination(selectedRoom);
			}
			
			const room = roomData[selectedRoom];
			currentRoute = { start: startPoint, destination: room };
			
			console.log('üìç Creating route from:', startPoint, 'to:', room);
			
			// ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà
			showStraightRoutePath(startPoint, room);
			routeDisplayed = true;
			
			// ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï controls ‡πÅ‡∏•‡∏∞ markers
			updateRouteControls(true);
			updateRoomMarkers();
			
			// ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô
			const message = currentLanguage === 'th' 
				? `üß≠ ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡πÑ‡∏õ‡∏¢‡∏±‡∏á ${room.name}` 
				: `üß≠ Route to ${room.name}`;
			showNotification(message, 'success');
			
			// ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏°‡∏ô‡∏≥‡∏ó‡∏≤‡∏á‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏™‡∏µ‡∏¢‡∏á
			const voiceBtn = document.getElementById('voiceNavigationBtn');
			if (voiceBtn) {
				voiceBtn.style.display = 'block';
			}
			
			console.log('‚úÖ Route created successfully');
		}

        // 1.1: Fix route display - create straight path and ensure it shows
        function showStraightRoutePath(start, destination) {
            const routePath = document.getElementById('routePath');
            if (!routePath) {
                console.error('Route path element not found');
                return;
            }
            
            // Clear any existing path
            routePath.innerHTML = '';
            
            // 1.1: Create straight line path connecting center points
            const startX = parseFloat(start.x);
            const startY = parseFloat(start.y);
            const endX = parseFloat(destination.x);
            const endY = parseFloat(destination.y);
            
            const path = `M ${startX} ${startY} L ${endX} ${endY}`;
            
            console.log('Creating route path:', path, 'from', {startX, startY}, 'to', {endX, endY});
            
            // Create glow effect (background line)
            const glowLine = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            glowLine.setAttribute('d', path);
            glowLine.setAttribute('stroke', 'rgba(220, 53, 69, 0.3)');
            glowLine.setAttribute('stroke-width', '12');
            glowLine.setAttribute('fill', 'none');
            glowLine.setAttribute('opacity', '0.6');
            routePath.appendChild(glowLine);
            
            // Create main line
            const mainLine = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            mainLine.setAttribute('d', path);
            mainLine.setAttribute('stroke', '#dc3545');
            mainLine.setAttribute('stroke-width', '5');
            mainLine.setAttribute('fill', 'none');
            mainLine.setAttribute('stroke-dasharray', '15, 10');
            mainLine.style.filter = 'drop-shadow(0 0 8px rgba(220, 53, 69, 0.5))';
            mainLine.style.animation = 'dash 3s linear infinite';
            routePath.appendChild(mainLine);
            
            // Set viewBox to match the map coordinates
            routePath.setAttribute('viewBox', '0 0 100 100');
            routePath.style.display = 'block';
            
            console.log('Route path created and displayed');
            
            // Animate path drawing
            try {
                const pathLength = mainLine.getTotalLength();
                mainLine.style.strokeDasharray = pathLength + ' ' + pathLength;
                mainLine.style.strokeDashoffset = pathLength;
                
                setTimeout(() => {
                    mainLine.style.transition = 'stroke-dashoffset 1.5s ease-in-out';
                    mainLine.style.strokeDashoffset = '0';
                    
                    setTimeout(() => {
                        mainLine.style.transition = '';
                        mainLine.style.strokeDasharray = '15, 10';
                        mainLine.style.strokeDashoffset = '0';
                        mainLine.style.animation = 'dash 3s linear infinite';
                    }, 1500);
                }, 100);
            } catch (error) {
                console.warn('Path animation failed:', error);
                // Continue without animation
            }
        }
		
		// ===== 7. ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏à‡∏∏‡∏î‡∏´‡∏°‡∏≤‡∏¢ =====
		function updateDestinationDisplay() {
			const statusElement = document.getElementById('destinationStatus');
			const textElement = document.getElementById('destinationText');
			
			if (!statusElement || !textElement) return;
			
			if (persistentDestination.roomCode && roomData[persistentDestination.roomCode]) {
				const displayText = currentLanguage === 'th' 
					? `‡∏à‡∏∏‡∏î‡∏´‡∏°‡∏≤‡∏¢: ${persistentDestination.roomName}`
					: `Destination: ${persistentDestination.roomName}`;
				
				textElement.textContent = displayText;
				statusElement.style.display = 'block';
			} else {
				statusElement.style.display = 'none';
			}
		}

       // ===== 5. ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç clearRoute() ‡πÉ‡∏´‡πâ‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô =====
		function clearRoute() {
			// ‡∏•‡πâ‡∏≤‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á ‡πÑ‡∏°‡πà‡∏•‡πâ‡∏≤‡∏á‡∏à‡∏∏‡∏î‡∏´‡∏°‡∏≤‡∏¢
			document.querySelectorAll('.route-line, .route-marker').forEach(el => el.remove());
			
			const clearRouteBtn = document.getElementById('clearRouteBtn');
			const voiceBtn = document.getElementById('voiceNavigationBtn');
			
			if (clearRouteBtn) clearRouteBtn.style.display = 'none';
			if (voiceBtn) voiceBtn.style.display = 'none';
			
			// üÜù ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ consistency check
			setTimeout(() => {
				ensureRouteConsistency();
			}, 100);
			
			const clearMessage = currentLanguage === 'th' 
				? 'üóëÔ∏è ‡∏•‡πâ‡∏≤‡∏á‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡πÅ‡∏•‡πâ‡∏ß (‡∏à‡∏∏‡∏î‡∏´‡∏°‡∏≤‡∏¢‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡∏≠‡∏¢‡∏π‡πà)'
				: 'üóëÔ∏è Route cleared (destination preserved)';
			showNotification(clearMessage, 'info');
		}
		// ===== 5. ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô updateRouteControls() =====
        function updateRouteControls(showRoute) {
			const showRouteBtn = document.getElementById('showRouteBtn');
			const clearRouteBtn = document.getElementById('clearRouteBtn');
			
			console.log('üéÆ Updating route controls:', { showRoute, hasStartPoint: !!startPoint, hasSelectedRoom: !!selectedRoom });
			
			if (showRouteBtn) {
				const canShowRoute = startPoint && selectedRoom;
				showRouteBtn.disabled = !canShowRoute;
				showRouteBtn.style.background = canShowRoute ? 'var(--accent-color)' : '#ccc';
				showRouteBtn.style.opacity = canShowRoute ? '1' : '0.6';
			}
			
			if (clearRouteBtn) {
				clearRouteBtn.style.display = showRoute ? 'block' : 'none';
				if (showRoute) {
					clearRouteBtn.style.background = '#dc3545';
					clearRouteBtn.style.opacity = '1';
				}
			}
		}
		
		
		
		// ===== 6. ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç state =====
		function validateAndFixRouteState() {
			console.log('üîç Validating route state...');
			
			// ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö localStorage
			try {
				const savedDestination = localStorage.getItem('persistentDestination');
				const savedStartPoint = localStorage.getItem('startPoint');
				
				if (savedDestination) {
					const parsed = JSON.parse(savedDestination);
					if (parsed.roomCode && roomData[parsed.roomCode]) {
						persistentDestination = parsed;
						selectedRoom = parsed.roomCode;
						console.log('‚úÖ Restored destination from localStorage:', parsed.roomName);
					} else {
						// ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢ ‡∏•‡πâ‡∏≤‡∏á‡∏≠‡∏≠‡∏Å
						localStorage.removeItem('persistentDestination');
						clearDestination();
					}
				}
				
				if (savedStartPoint) {
					const parsed = JSON.parse(savedStartPoint);
					if (parsed.x !== null && parsed.y !== null) {
						startPoint = parsed;
						console.log('‚úÖ Restored start point from localStorage:', parsed);
					}
				}
				
			} catch (error) {
				console.error('‚ùå Error validating state:', error);
				// ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢
				localStorage.removeItem('persistentDestination');
				localStorage.removeItem('startPoint');
				clearDestination();
				startPoint = null;
			}
			
			// ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï UI
			updateDestinationDisplay();
			updateRouteControls(routeDisplayed);
			
			console.log('üéØ Final state:', {
				selectedRoom,
				persistentDestination: persistentDestination.roomCode,
				startPoint: startPoint ? `(${Math.round(startPoint.x)}, ${Math.round(startPoint.y)})` : null
			});
		}

        function generateCompleteRoute() {
            showRouteToSelected();
        }

        // Remove old curved path and replace with simple straight line
        function showModernRoutePath(start, destination) {
            // Use the new straight path function
            showStraightRoutePath(start, destination);
        }

        function hideRoutePath() {
            const routePath = document.getElementById('routePath');
            if (routePath) {
                routePath.style.display = 'none';
                routePath.innerHTML = '';
            }
        }

        // =================== FIX 3: Continuous Voice Navigation ===================
        
        function startContinuousVoiceNavigation() {
            if (!currentRoute) {
                const message = currentLanguage === 'th' 
                    ? '‚ùå ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡∏ó‡∏≤‡∏á' 
                    : '‚ùå No route available for navigation';
                showNotification(message, 'error');
                return;
            }
            
            if (isVoiceNavigating) {
                stopVoiceNavigation();
                return;
            }
            
            if (!('speechSynthesis' in window)) {
                const message = currentLanguage === 'th' 
                    ? '‚ùå ‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á' 
                    : '‚ùå Browser does not support speech synthesis';
                showNotification(message, 'error');
                return;
            }
            
            generateVoiceQueue();
            startVoiceSequence();
        }

        function generateVoiceQueue() {
            voiceQueue = [];
            
            if (!currentRoute) return;
            
            const { start, destination } = currentRoute;
            const deltaX = destination.x - start.x;
            const deltaY = destination.y - start.y;
            const distance = Math.round(Math.sqrt(deltaX * deltaX + deltaY * deltaY) * 2);
            
            let direction = '';
            if (Math.abs(deltaX) > Math.abs(deltaY)) {
                direction = deltaX > 0 
                    ? (currentLanguage === 'th' ? '‡∏ó‡∏≤‡∏á‡∏Ç‡∏ß‡∏≤' : 'to the right')
                    : (currentLanguage === 'th' ? '‡∏ó‡∏≤‡∏á‡∏ã‡πâ‡∏≤‡∏¢' : 'to the left');
            } else {
                direction = deltaY > 0 
                    ? (currentLanguage === 'th' ? '‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á' : 'downward')
                    : (currentLanguage === 'th' ? '‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô' : 'upward');
            }
            
            if (currentLanguage === 'th') {
                voiceQueue = [
                    '‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡∏ó‡∏≤‡∏á',
                    `‡πÄ‡∏î‡∏¥‡∏ô‡πÑ‡∏õ${direction} ‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì ${distance} ‡πÄ‡∏°‡∏ï‡∏£`,
                    `‡∏°‡∏≠‡∏á‡∏´‡∏≤‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ ${destination.building}`,
                    `‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà ${destination.name}`,
                    '‡∏ñ‡∏∂‡∏á‡∏à‡∏∏‡∏î‡∏´‡∏°‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡∏ó‡∏≤‡∏á‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô'
                ];
            } else {
                voiceQueue = [
                    'Starting navigation',
                    `Walk ${direction} approximately ${distance} meters`,
                    `Look for building ${destination.building}`,
                    `Enter ${destination.name}`,
                    'Destination reached. Navigation complete'
                ];
            }
        }

        function startVoiceSequence() {
            if (voiceQueue.length === 0) return;
            
            isVoiceNavigating = true;
            updateVoiceButton(true);
            
            const message = currentLanguage === 'th' 
                ? 'üîä ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡∏ó‡∏≤‡∏á‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏™‡∏µ‡∏¢‡∏á' 
                : 'üîä Starting voice navigation';
            showNotification(message, 'success');
            
            speakNextInQueue();
        }

        function speakNextInQueue() {
            if (voiceQueue.length === 0 || !isVoiceNavigating) {
                finishVoiceNavigation();
                return;
            }
            
            const text = voiceQueue.shift();
            
            if (currentSpeech) {
                speechSynthesis.cancel();
            }
            
            currentSpeech = new SpeechSynthesisUtterance(text);
            currentSpeech.lang = currentLanguage === 'th' ? 'th-TH' : 'en-US';
            currentSpeech.rate = 0.8;
            currentSpeech.pitch = 1.0;
            
            currentSpeech.onend = () => {
                if (isVoiceNavigating) {
                    // Wait 2 seconds before next instruction
                    voiceTimeout = setTimeout(() => {
                        speakNextInQueue();
                    }, 2000);
                }
            };
            
            currentSpeech.onerror = () => {
                finishVoiceNavigation();
            };
            
            speechSynthesis.speak(currentSpeech);
        }

        function stopVoiceNavigation() {
            isVoiceNavigating = false;
            voiceQueue = [];
            
            if (voiceTimeout) {
                clearTimeout(voiceTimeout);
                voiceTimeout = null;
            }
            
            if (currentSpeech) {
                speechSynthesis.cancel();
                currentSpeech = null;
            }
            
            updateVoiceButton(false);
            
            const message = currentLanguage === 'th' 
                ? 'üîá ‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡∏ó‡∏≤‡∏á‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏™‡∏µ‡∏¢‡∏á' 
                : 'üîá Voice navigation stopped';
            showNotification(message, 'warning');
        }

        function finishVoiceNavigation() {
            isVoiceNavigating = false;
            updateVoiceButton(false);
            
            const message = currentLanguage === 'th' 
                ? '‚úÖ ‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡∏ó‡∏≤‡∏á‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô' 
                : '‚úÖ Voice navigation completed';
            showNotification(message, 'success');
        }

        function updateVoiceButton(isActive) {
            const voiceBtn = document.getElementById('voiceNavigationBtn');
            if (!voiceBtn) return;
            
            if (isActive) {
                voiceBtn.classList.add('speaking');
                voiceBtn.innerHTML = `
                    <i class="fas fa-stop"></i> 
                    <span>${currentLanguage === 'th' ? '‡∏´‡∏¢‡∏∏‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á' : 'Stop Voice'}</span>
                `;
            } else {
                voiceBtn.classList.remove('speaking');
                voiceBtn.innerHTML = `
                    <i class="fas fa-volume-up"></i> 
                    <span data-translate="voice_nav">${currentLanguage === 'th' ? '‡∏ô‡∏≥‡∏ó‡∏≤‡∏á‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏™‡∏µ‡∏¢‡∏á' : 'Voice Navigation'}</span>
                `;
            }
        }

        // Legacy voice functions for compatibility
        function toggleVoiceNavigation() {
            if (isVoiceNavigating) {
                stopVoiceNavigation();
            } else {
                startContinuousVoiceNavigation();
            }
        }

        function speakStep(text) {
            if (!('speechSynthesis' in window)) {
                const message = currentLanguage === 'th' 
                    ? '‚ùå ‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á' 
                    : '‚ùå Browser does not support speech synthesis';
                showNotification(message, 'error');
                return;
            }
            
            if (currentSpeech) {
                speechSynthesis.cancel();
            }
            
            currentSpeech = new SpeechSynthesisUtterance(text);
            currentSpeech.lang = currentLanguage === 'th' ? 'th-TH' : 'en-US';
            currentSpeech.rate = 0.8;
            currentSpeech.pitch = 1.0;
            
            speechSynthesis.speak(currentSpeech);
        }

        function speakText(text) {
            speakStep(text);
        }

        // =================== Room Markers ===================
        
        let selectedRoomForAction = null;
		// ======= Updated Room Markers - ‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á Pin ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î =======
		function updateRoomMarkers() {
			const markersContainer = document.getElementById('roomMarkers');
			if (!markersContainer) return;
			
			// ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏à‡∏∏‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÅ‡∏•‡∏∞‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
			let markersHTML = '';
			
			// ‡πÅ‡∏™‡∏î‡∏á‡∏à‡∏∏‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
			if (startPoint) {
				markersHTML += `
					<div class="room-marker start-point-marker" 
						 style="top: ${startPoint.y}%; left: ${startPoint.x}%;"
						 title="${currentLanguage === 'th' ? '‡∏à‡∏∏‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô' : 'Starting Point'}"
						 onclick="showStartPointInfo()">
						üö©
					</div>
				`;
			}
			
			// ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
			if (selectedRoom && roomData[selectedRoom]) {
				const room = roomData[selectedRoom];
				markersHTML += `
					<div class="room-marker highlighted" 
						 data-room="${room.code}" 
						 style="top: ${room.y}%; left: ${room.x}%;"
						 title="${room.name}"
						 onclick="showRoomActionOverlay('${room.code}', event)">
						üéØ
					</div>
				`;
			}
			
			markersContainer.innerHTML = markersHTML;
		}
        // ======= Updated Room Markers - version ‡πÄ‡∏Å‡πà‡∏≤‡πÅ‡∏™‡∏î‡∏á Pin ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î =======
        function updateRoomMarkers_Old_ShowAllPinPoint() {
            const markersContainer = document.getElementById('roomMarkers');
            if (!markersContainer) return;
            
            let activeRooms = Object.values(roomData).filter(room => room.status === 'active');
            
            // FIX 5: Apply building filter
            if (currentBuildingFilter !== 'all') {
                activeRooms = activeRooms.filter(room => room.building === currentBuildingFilter);
            }
            
            markersContainer.innerHTML = activeRooms.map(room => {
                return `
                    <div class="room-marker" 
                         data-room="${room.code}" 
                         onclick="showRoomActionOverlay('${room.code}', event)" 
                         style="top: ${room.y}%; left: ${room.x}%;"
                         title="${room.name}">
                        ${getRoomIcon(room.name)}
                    </div>
                `;
            }).join('') + (startPoint ? `
                <div class="room-marker start-point-marker" 
                     style="top: ${startPoint.y}%; left: ${startPoint.x}%;"
                     title="${currentLanguage === 'th' ? '‡∏à‡∏∏‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô' : 'Starting Point'}"
                     onclick="showStartPointInfo()">
                    üö©
                </div>
            ` : '');
        }

        // 1.2: Show action overlay when clicking room marker
        // ======= Room Action Overlay Functions - ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÉ‡∏´‡πâ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Å‡∏±‡∏ö‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà =======
		function showRoomActionOverlay(roomCode, event) {
			const room = roomData[roomCode];
			if (!room) return;
			
			selectedRoom = roomCode;
			
			const overlay = document.getElementById('roomActionOverlay');
			const header = document.getElementById('roomActionHeader');
			
			if (!overlay || !header) return;
			
			// ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï header ‡∏î‡πâ‡∏ß‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏´‡πâ‡∏≠‡∏á
			header.textContent = `${room.name} - ${currentLanguage === 'th' ? '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£' : 'Select Action'}`;
			
			overlay.style.display = 'block';
			
			// ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Å‡∏≤‡∏£‡πÅ‡∏õ‡∏•‡∏†‡∏≤‡∏©‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏ô overlay
			updateActionOverlayTranslations();
			
			// ‡∏ã‡πà‡∏≠‡∏ô overlay ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡∏Ç‡πâ‡∏≤‡∏á‡∏ô‡∏≠‡∏Å
			setTimeout(() => {
				document.addEventListener('click', hideRoomActionOverlayOnClickOutside, { once: true });
			}, 100);
		}

        function hideRoomActionOverlayOnClickOutside(event) {
            const overlay = document.getElementById('roomActionOverlay');
            if (overlay && !overlay.contains(event.target) && !event.target.classList.contains('room-marker')) {
                overlay.style.display = 'none';
            }
        }

        function updateActionOverlayTranslations() {
            const buttons = document.querySelectorAll('#roomActionOverlay [data-translate]');
            buttons.forEach(button => {
                const key = button.getAttribute('data-translate');
                if (translations[currentLanguage] && translations[currentLanguage][key]) {
                    button.textContent = translations[currentLanguage][key];
                }
            });
        }

        // 1.2: Action functions
        function showRoomDetails() {
            if (!selectedRoomForAction) return;
            
            // Hide action overlay
            const overlay = document.getElementById('roomActionOverlay');
            if (overlay) overlay.style.display = 'none';
            
            // Show room info overlay
            showRoomInfoOverlay(selectedRoomForAction);
        }

       function showRouteDirectly() {
			if (!selectedRoom) return;
			
			// ‡∏ã‡πà‡∏≠‡∏ô action overlay
			const overlay = document.getElementById('roomActionOverlay');
			if (overlay) overlay.style.display = 'none';
			
			if (!startPoint) {
				const message = currentLanguage === 'th' 
					? 'üí° ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏±‡πâ‡∏á‡∏à‡∏∏‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏Å‡πà‡∏≠‡∏ô' 
					: 'üí° Click on map to set starting point first';
				showNotification(message, 'info');
				return;
			}
			
			// ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á
			showRouteToSelected();
		}

        function showStartPointInfo() {
            if (!startPoint) return;
            const message = currentLanguage === 'th' 
                ? `üö© ‡∏à‡∏∏‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡∏ó‡∏≤‡∏á` 
                : `üö© Navigation starting point`;
            showNotification(message, 'info');
        }

        // =================== Room Info Functions ===================
        
        function getRoomTypeText(type) {
            const types = {
                'classroom': currentLanguage === 'th' ? '‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô' : 'Classroom',
                'computer': currentLanguage === 'th' ? '‡∏´‡πâ‡∏≠‡∏á‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå' : 'Computer Lab',
                'lab': currentLanguage === 'th' ? '‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£' : 'Laboratory',
                'library': currentLanguage === 'th' ? '‡∏´‡πâ‡∏≠‡∏á‡∏™‡∏°‡∏∏‡∏î' : 'Library',
                'office': currentLanguage === 'th' ? '‡∏´‡πâ‡∏≠‡∏á‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô' : 'Office',
                'facility': currentLanguage === 'th' ? '‡∏™‡∏¥‡πà‡∏á‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏î‡∏ß‡∏Å' : 'Facility',
                'special': currentLanguage === 'th' ? '‡∏´‡πâ‡∏≠‡∏á‡∏û‡∏¥‡πÄ‡∏®‡∏©' : 'Special Room'
            };
            return types[type] || type;
        }
        
        function showRoomInfoOverlay(roomCode) {
            const room = roomData[roomCode];
            if (!room) return;

            selectedRoom = roomCode;
            updateRouteControls(false);
            
            const overlay = document.getElementById('roomInfoOverlay');
            if (!overlay) return;
            
            const roomName = document.getElementById('overlayRoomName');
            const roomLocation = document.getElementById('overlayRoomLocation');
            const roomBuilding = document.getElementById('overlayRoomBuilding');
            const roomFloor = document.getElementById('overlayRoomFloor');
            const roomType = document.getElementById('overlayRoomType');
            const roomDescription = document.getElementById('overlayRoomDescription');
            const routeBtn = document.getElementById('routeBtn');
            
            if (roomName) roomName.innerHTML = `${getRoomIcon(room.name)} ${room.name}`;
            if (roomLocation) roomLocation.textContent = room.location || room.floor || 'N/A';
            
            // 1.3: Enhanced room information display (removed status)
            // Get building name from admin data
            const buildingData = JSON.parse(localStorage.getItem('buildingsData') || '{}');
            const buildingName = buildingData[room.building]?.name || room.building;
            if (roomBuilding) roomBuilding.textContent = buildingName;
            
            // Display floor information
            if (roomFloor) {
                const floorText = room.floor 
                    ? (currentLanguage === 'th' ? `‡∏ä‡∏±‡πâ‡∏ô ${room.floor}` : `Floor ${room.floor}`)
                    : (currentLanguage === 'th' ? '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏' : 'Not specified');
                roomFloor.textContent = floorText;
            }
            
            // Display room type
            if (roomType) roomType.textContent = getRoomTypeText(room.type || 'classroom');
            
            // 1.3: Remove status display - no longer shown
            
            if (roomDescription) roomDescription.textContent = room.description || (currentLanguage === 'th' ? '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î' : 'No description available');
            
            // Update route button state
            if (routeBtn) {
                if (!startPoint) {
                    routeBtn.disabled = true;
                    routeBtn.innerHTML = `<i class="fas fa-exclamation-triangle"></i> <span>${currentLanguage === 'th' ? '‡∏ï‡∏±‡πâ‡∏á‡∏à‡∏∏‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏Å‡πà‡∏≠‡∏ô' : 'Set start point first'}</span>`;
                } else {
                    routeBtn.disabled = false;
                    routeBtn.innerHTML = `<i class="fas fa-route"></i> <span data-translate="route_navigation">${currentLanguage === 'th' ? '‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏ô‡∏≥‡∏ó‡∏≤‡∏á' : 'Route Navigation'}</span>`;
                }
            }
            
            // Display all images
            updateOverlayImageGallery(room.images);
            generateOverlayNavigationSteps(room);
            
            overlay.style.display = 'flex';
        }

        function closeRoomInfoOverlay() {
            const overlay = document.getElementById('roomInfoOverlay');
            if (overlay) {
                overlay.style.display = 'none';
            }
            selectedRoom = null;
            updateRouteControls(false);
        }

        function generateOverlayNavigationSteps(room) {
            const routeSteps = document.getElementById('overlayRouteSteps');
            if (!routeSteps) return;
            
            if (!startPoint) {
                const noStartText = currentLanguage === 'th' 
                    ? '‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏±‡πâ‡∏á‡∏à‡∏∏‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏Å‡πà‡∏≠‡∏ô'
                    : 'Click on map to set starting point first';
                    
                routeSteps.innerHTML = `
                    <div style="text-align: center; padding: 20px; background: #fff3cd; border-radius: var(--border-radius); color: #856404;">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p style="margin: 8px 0 0 0; font-size: 14px;">
                            ${noStartText}
                        </p>
                    </div>
                `;
                return;
            }
            
            const deltaX = room.x - startPoint.x;
            const deltaY = room.y - startPoint.y;
            const distance = Math.round(Math.sqrt(deltaX * deltaX + deltaY * deltaY) * 2);
            
            let direction = '';
            if (Math.abs(deltaX) > Math.abs(deltaY)) {
                direction = deltaX > 0 
                    ? (currentLanguage === 'th' ? '‡∏ó‡∏≤‡∏á‡∏Ç‡∏ß‡∏≤' : 'to the right')
                    : (currentLanguage === 'th' ? '‡∏ó‡∏≤‡∏á‡∏ã‡πâ‡∏≤‡∏¢' : 'to the left');
            } else {
                direction = deltaY > 0 
                    ? (currentLanguage === 'th' ? '‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á' : 'downward')
                    : (currentLanguage === 'th' ? '‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô' : 'upward');
            }
            
            const steps = currentLanguage === 'th' ? [
                {
                    step: 1,
                    text: '‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏à‡∏≤‡∏Å‡∏à‡∏∏‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô',
                    distance: '0m'
                },
                {
                    step: 2,
                    text: `‡πÄ‡∏î‡∏¥‡∏ô‡πÑ‡∏õ${direction} ‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì ${distance} ‡πÄ‡∏°‡∏ï‡∏£`,
                    distance: `${distance}m`
                },
                {
                    step: 3,
                    text: `‡∏°‡∏≠‡∏á‡∏´‡∏≤ ${room.building}`,
                    distance: '10m'
                },
                {
                    step: 4,
                    text: `‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà ${room.name}`,
                    distance: '0m'
                }
            ] : [
                {
                    step: 1,
                    text: 'Start from starting point',
                    distance: '0m'
                },
                {
                    step: 2,
                    text: `Walk ${direction} approximately ${distance} meters`,
                    distance: `${distance}m`
                },
                {
                    step: 3,
                    text: `Look for ${room.building}`,
                    distance: '10m'
                },
                {
                    step: 4,
                    text: `Enter ${room.name}`,
                    distance: '0m'
                }
            ];
            
            const stepsTitle = currentLanguage === 'th' ? '‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á' : 'Navigation Steps';
            
            routeSteps.innerHTML = `
                <div class="route-steps">
                    <h4 style="margin: 0 0 15px 0; font-size: 16px; color: var(--primary-color);">
                        <i class="fas fa-route"></i> ${stepsTitle}
                    </h4>
                    ${steps.map(step => `
                        <div class="route-step">
                            <div class="step-number">${step.step}</div>
                            <div class="step-content">${step.text}</div>
                            <div class="step-distance">${step.distance}</div>
                            <button class="step-voice-btn" onclick="speakStep('${step.text}')">
                                <i class="fas fa-volume-up"></i>
                            </button>
                        </div>
                    `).join('')}
                </div>
            `;
        }

       // ===== 3. ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏õ‡∏±‡∏ç‡∏´‡∏≤ Error ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÉ‡∏ô updateOverlayImageGallery =====
		function updateOverlayImageGallery(room) {
			const gallery = document.getElementById('roomImageGallery');
			if (!gallery) return;

			if (!room.images || room.images.length === 0) {
				gallery.innerHTML = `
					<div style="text-align: center; padding: 40px; color: var(--text-secondary);">
						<i class="fas fa-image" style="font-size: 48px; opacity: 0.3; margin-bottom: 15px;"></i>
						<p>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</p>
					</div>
				`;
				return;
			}

			// üÜï ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏Å‡∏£‡∏≠‡∏á‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà valid ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
			const validImages = room.images.filter(img => {
				if (!img || typeof img !== 'string') return false;
				
				// ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô URL ‡∏ó‡∏µ‡πà valid ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
				try {
					// ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô data URL ‡∏´‡∏£‡∏∑‡∏≠ http/https URL ‡πÉ‡∏´‡πâ‡∏ú‡πà‡∏≤‡∏ô
					if (img.startsWith('data:') || img.startsWith('http://') || img.startsWith('https://')) {
						return true;
					}
					// ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô relative path ‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°
					if (img.startsWith('./') || img.startsWith('../') || !img.includes('://')) {
						console.warn('‚ö†Ô∏è Skipping local file path:', img);
						return false;
					}
					return true;
				} catch (error) {
					console.error('‚ùå Invalid image URL:', img, error);
					return false;
				}
			});

			if (validImages.length === 0) {
				gallery.innerHTML = `
					<div style="text-align: center; padding: 40px; color: var(--text-secondary);">
						<i class="fas fa-exclamation-triangle" style="font-size: 48px; opacity: 0.3; margin-bottom: 15px; color: orange;"></i>
						<p>‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏î‡πâ</p>
						<small>‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö URL ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÉ‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</small>
					</div>
				`;
				return;
			}

			gallery.innerHTML = validImages.map((image, index) => `
				<div class="gallery-item" style="position: relative; margin-bottom: 15px;">
					<img src="${image}" 
						 alt="Room image ${index + 1}" 
						 style="width: 100%; border-radius: 8px; cursor: pointer;"
						 onclick="openImageModal('${image.replace(/'/g, "\\'")}', '${room.name.replace(/'/g, "\\'")}')"
						 onerror="this.style.display='none'; this.nextElementSibling.style.display='block';"
						 loading="lazy">
					<div style="display: none; text-align: center; padding: 20px; background: #f8f9fa; border-radius: 8px; color: var(--text-secondary);">
						<i class="fas fa-broken-image"></i>
						<p>‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÑ‡∏î‡πâ</p>
					</div>
				</div>
			`).join('');
		}
		
		// ===== 7. ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô ensureRouteConsistency() =====
		function ensureRouteConsistency() {
			console.log('üîß Ensuring route consistency...');
			
			// ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ validate ‡∏Å‡πà‡∏≠‡∏ô
			validateAndFixRouteState();
			
			// ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≠‡∏î‡∏Ñ‡∏•‡πâ‡∏≠‡∏á
			if (persistentDestination.roomCode && roomData[persistentDestination.roomCode]) {
				if (selectedRoom !== persistentDestination.roomCode) {
					console.log('üîß Syncing selectedRoom with persistentDestination');
					selectedRoom = persistentDestination.roomCode;
				}
				
				// ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï UI
				updateDestinationDisplay();
				updateRouteControls(true);
				showDestinationStatus();
				
			} else if (selectedRoom && roomData[selectedRoom]) {
				// ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ selectedRoom ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ persistent ‡πÉ‡∏´‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
				console.log('üîß Saving selectedRoom as persistent destination');
				saveDestination(selectedRoom);
				updateDestinationDisplay();
			}
		}

        function openImageModal(imageUrl) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.9);
                z-index: 3000;
                display: flex;
                align-items: center;
                justify-content: center;
                backdrop-filter: blur(5px);
                -webkit-backdrop-filter: blur(5px);
            `;
            modal.innerHTML = `
                <img src="${imageUrl}" alt="Room Image" style="max-width: 90%; max-height: 90%; border-radius: var(--border-radius); box-shadow: 0 25px 50px rgba(0,0,0,0.5);">
                <button onclick="this.parentElement.remove()" style="position: absolute; top: 30px; right: 30px; background: white; color: black; border: none; border-radius: 50%; width: 50px; height: 50px; cursor: pointer; font-size: 20px; display: flex; align-items: center; justify-content: center; box-shadow: 0 8px 20px rgba(0,0,0,0.3);">√ó</button>
            `;
            modal.onclick = (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            };
            document.body.appendChild(modal);
        }

        // =================== Event Setup ===================
        
       // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô setupMapEvents ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏à‡∏∏‡∏î‡∏´‡∏°‡∏≤‡∏¢‡πÑ‡∏ß‡πâ
		function setupMapEvents() {
			const mapArea = document.getElementById('mapArea');
			if (!mapArea) return;
			
			mapArea.addEventListener('click', function(event) {
				// ‡πÑ‡∏°‡πà‡∏ï‡∏±‡πâ‡∏á‡∏à‡∏∏‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà room markers ‡∏´‡∏£‡∏∑‡∏≠ action overlay
				if (event.target.classList.contains('room-marker') || 
					event.target.closest('.room-action-overlay')) {
					return;
				}
				
				// ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà
				const rect = mapArea.getBoundingClientRect();
				const x = ((event.clientX - rect.left) / rect.width) * 100;
				const y = ((event.clientY - rect.top) / rect.height) * 100;
				
				// ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏Ç‡∏≠‡∏ö‡πÄ‡∏Ç‡∏ï
				if (x >= 0 && x <= 100 && y >= 0 && y <= 100) {
					// ‡∏•‡πâ‡∏≤‡∏á‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡πÄ‡∏î‡∏¥‡∏°‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏∏‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
					if (routeDisplayed) {
						clearRoute();
					}
					
					// ‡∏ï‡∏±‡πâ‡∏á‡∏à‡∏∏‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô (‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô selectedRoom)
					const oldStartPoint = startPoint;
					startPoint = {
						name: currentLanguage === 'th' ? '‡∏à‡∏∏‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô' : 'Starting Point',
						x: x,
						y: y
					};
					
					localStorage.setItem('startPoint', JSON.stringify(startPoint));
					
					// ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï markers ‡πÇ‡∏î‡∏¢‡∏£‡∏±‡∏Å‡∏©‡∏≤ selectedRoom ‡πÑ‡∏ß‡πâ
					updateRoomMarkers(); 
					updateRouteControls(false);
					
					const message = currentLanguage === 'th' 
						? `üéØ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏∏‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÉ‡∏´‡∏°‡πà (${Math.round(x)}, ${Math.round(y)})`
						: `üéØ Start point updated (${Math.round(x)}, ${Math.round(y)})`;
					showNotification(message, 'success');
					
					// ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏´‡πâ‡∏≠‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß
					if (selectedRoom && roomData[selectedRoom]) {
						setTimeout(() => {
							showRouteToSelected();
							
							// ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ß‡πà‡∏≤‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏π‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏î‡πâ‡πÅ‡∏•‡πâ‡∏ß
							const routeMessage = currentLanguage === 'th' 
								? `üõ£Ô∏è ‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏õ‡∏¢‡∏±‡∏á ${roomData[selectedRoom].name}`
								: `üõ£Ô∏è New route to ${roomData[selectedRoom].name}`;
							setTimeout(() => {
								showNotification(routeMessage, 'info');
							}, 1000);
						}, 500);
					} else {
						// ‡πÅ‡∏à‡πâ‡∏á‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏´‡πâ‡∏≠‡∏á‡∏Å‡πà‡∏≠‡∏ô
						setTimeout(() => {
							const searchMessage = currentLanguage === 'th' 
								? 'üí° ‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á ‡∏à‡∏≤‡∏Å‡∏ô‡∏±‡πâ‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏î‡∏π‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á'
								: 'üí° Go to search page to select destination room, then return to view route';
							showNotification(searchMessage, 'info');
						}, 1000);
					}
				}
			});
		}
		
		
		

        function setupWindowEvents() {
            window.addEventListener('orientationchange', function() {
                setTimeout(() => {
                    updateRoomMarkers();
                }, 500);
            });

            let resizeTimeout;
            window.addEventListener('resize', function() {
                clearTimeout(resizeTimeout);
                resizeTimeout = setTimeout(() => {
                    updateRoomMarkers();
                }, 250);
            });

            window.addEventListener('beforeunload', function(e) {
                if (startPoint) {
                    localStorage.setItem('startPoint', JSON.stringify(startPoint));
                }
            });

            document.addEventListener('keydown', function(e) {
                if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                    e.preventDefault();
                    const searchInput = document.getElementById('searchInput');
                    if (searchInput) {
                        searchInput.focus();
                    }
                }
                
                if (e.key === 'Escape') {
                    closeRoomInfoOverlay();
                    
                    const imageModal = document.querySelector('div[style*="position: fixed"][style*="background: rgba(0,0,0,0.9)"]');
                    if (imageModal) {
                        imageModal.remove();
                    }
                    
                    if (isVoiceNavigating) {
                        stopVoiceNavigation();
                    }
                }
                
                if (e.key === ' ' && isVoiceNavigating) {
                    e.preventDefault();
                    stopVoiceNavigation();
                }
            });
        }


		// ======= ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏†‡∏≤‡∏û‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà =======
		async function loadMapDataFromSheets() {
			if (currentVersion !== 'live' || !sheetsConfig.url) {
				console.log('üó∫Ô∏è Not loading map images (Demo mode or no sheets URL)');
				return;
			}
			
			try {
				console.log('üó∫Ô∏è Loading map images from Google Sheets...');
				showProgressiveStatus('üó∫Ô∏è ‡πÇ‡∏´‡∏•‡∏î‡∏†‡∏≤‡∏û‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà...', 'info');
				
				// ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÄ‡∏û‡∏¥‡πà‡∏° timeout ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö map images
				const controller = new AbortController();
				const timeoutId = setTimeout(() => {
					controller.abort();
					console.log('‚è∞ Map images request timeout');
				}, 20000); // 20 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
				
				const params = new URLSearchParams();
				params.append('action', 'getData');
				params.append('sheet', sheetsConfig.mapImagesSheet);
				
				const response = await fetch(sheetsConfig.url, {
					method: 'POST',
					headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
					body: params.toString(),
					signal: controller.signal
				});
				
				clearTimeout(timeoutId);
				
				if (response.ok) {
					const result = await response.json();
					console.log('üó∫Ô∏è Map images response received');
					
					if (result.success && result.data && result.data.length > 0) {
						let sheetMapData = result.data.find(item => 
							item.id === 'main_map' || item.id === 'maps'
						);
						
						if (!sheetMapData && result.data.length > 0) {
							sheetMapData = result.data[0];
						}
						
						if (sheetMapData) {
							// ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ó‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà
							if (sheetMapData.floorplan) {
								mapData.floorplan = sheetMapData.floorplan;
								console.log('‚úÖ Floorplan loaded from sheets');
							}
							if (sheetMapData.realphoto) {
								mapData.realphoto = sheetMapData.realphoto;
								console.log('‚úÖ Real photo loaded from sheets');
							}
							if (sheetMapData.notes) {
								mapData.notes = sheetMapData.notes;
							}
							
							mapData.loaded = true;
							
							// ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ö‡∏µ‡∏ö‡∏≠‡∏±‡∏î‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏ô‡∏≤‡∏î‡πÉ‡∏´‡∏ç‡πà
							const cacheSuccess = safeSetCachedData('mapImages', mapData);
							if (!cacheSuccess) {
								console.warn('‚ö†Ô∏è Map images too large to cache, using session storage');
							}
							
							updateMapDisplay();
							showProgressiveStatus('‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡∏†‡∏≤‡∏û‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
							
							console.log('‚úÖ Map images loaded successfully');
						} else {
							console.log('‚ö†Ô∏è No map data found in sheets');
							showProgressiveStatus('‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏†‡∏≤‡∏û‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà', 'warning');
						}
					} else {
						console.log('‚ö†Ô∏è No map images data in response');
						showProgressiveStatus('‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏†‡∏≤‡∏û‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà', 'warning');
					}
				} else {
					console.error('‚ùå Failed to fetch map images:', response.status);
					showProgressiveStatus('‚ùå ‡πÇ‡∏´‡∏•‡∏î‡∏†‡∏≤‡∏û‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß', 'error');
				}
			} catch (error) {
				if (error.name === 'AbortError') {
					console.error('‚è∞ Map images request timeout');
					showProgressiveStatus('‚è∞ ‡πÇ‡∏´‡∏•‡∏î‡∏†‡∏≤‡∏û‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡∏ô‡∏≤‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ', 'warning');
				} else {
					console.error('‚ùå Error loading map images:', error);
					showProgressiveStatus('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏†‡∏≤‡∏û‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà', 'error');
				}
			}
		}

		// ======= ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà =======
		function updateMapDisplay() {
			const mapImage = document.getElementById('mapImage');
			if (!mapImage) return;
			
			let imageToShow = null;
			
			// ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏†‡∏≤‡∏û‡∏ï‡∏≤‡∏° layout ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
			if (currentMapLayout === 'photo' && mapData.realphoto) {
				imageToShow = mapData.realphoto;
				console.log('üó∫Ô∏è Displaying real photo');
			} else if (currentMapLayout === 'floorplan' && mapData.floorplan) {
				imageToShow = mapData.floorplan;
				console.log('üó∫Ô∏è Displaying floorplan');
			}
			
			if (imageToShow) {
				mapImage.src = imageToShow;
				mapImage.onerror = function() {
					console.error('‚ùå Failed to load map image:', imageToShow);
					showFallbackMap();
				};
				mapImage.onload = function() {
					console.log('‚úÖ Map image loaded successfully');
				};
			} else {
				// ‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà default ‡∏´‡∏£‡∏∑‡∏≠‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
				showFallbackMap();
			}
		}

		// ======= ‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà default ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏†‡∏≤‡∏û =======
		function showFallbackMap() {
			const mapImage = document.getElementById('mapImage');
			if (!mapImage) return;
			
			const fallbackText = currentMapLayout === 'photo' ? '‡∏†‡∏≤‡∏û‡∏à‡∏£‡∏¥‡∏á' : '‡πÅ‡∏ú‡∏ô‡∏ú‡∏±‡∏á';
			const missingText = currentLanguage === 'th' 
				? `‡πÑ‡∏°‡πà‡∏°‡∏µ${fallbackText}` 
				: `No ${currentMapLayout} available`;
			
			mapImage.src = `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='800' height='600' viewBox='0 0 800 600'%3E%3Crect width='800' height='600' fill='%23f0f8ff'/%3E%3Ctext x='400' y='280' text-anchor='middle' font-family='Arial' font-size='28' fill='%23667eea' font-weight='bold'%3Eüè´ ${encodeURIComponent('‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏≠‡∏±‡∏à‡∏â‡∏£‡∏¥‡∏¢‡∏∞')}%3C/text%3E%3Ctext x='400' y='320' text-anchor='middle' font-family='Arial' font-size='16' fill='%23999'%3E${encodeURIComponent(missingText)}%3C/text%3E%3Ctext x='400' y='350' text-anchor='middle' font-family='Arial' font-size='14' fill='%23667eea'%3Eüìç ${encodeURIComponent('‡∏Ñ‡∏•‡∏¥‡∏Å‡∏à‡∏∏‡∏î‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡πâ‡∏≠‡∏á')}%3C/text%3E%3C/svg%3E`;
		}

		// ======= ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô setMapLayout ‡πÄ‡∏î‡∏¥‡∏° =======
		function setMapLayout(layout) {
			currentMapLayout = layout;
			
			// ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï UI ‡∏õ‡∏∏‡πà‡∏°
			document.querySelectorAll('.map-control-btn[data-layout]').forEach(btn => {
				btn.classList.remove('active');
			});
			
			const targetBtn = document.querySelector(`[data-layout="${layout}"]`);
			if (targetBtn) {
				targetBtn.classList.add('active');
			}
			
			// ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà
			updateMapDisplay();
			
			// ‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
			const layoutName = layout === 'photo' 
				? (currentLanguage === 'th' ? '‡∏†‡∏≤‡∏û‡∏à‡∏£‡∏¥‡∏á' : 'Real Photo')
				: (currentLanguage === 'th' ? '‡πÅ‡∏ú‡∏ô‡∏ú‡∏±‡∏á' : 'Floor Plan');
			
			showNotification(
				currentLanguage === 'th' ? `üó∫Ô∏è ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô${layoutName}` : `üó∫Ô∏è Switched to ${layoutName}`,
				'info'
			);
		}
		
		// ======= ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Session Storage ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Map Images =======
		function loadMapFromSessionStorage() {
			try {
				const floorplan = sessionStorage.getItem('temp_floorplan');
				const realphoto = sessionStorage.getItem('temp_realphoto');
				
				if (floorplan) {
					mapData.floorplan = floorplan;
				}
				if (realphoto) {
					mapData.realphoto = realphoto;
				}
				
				if (floorplan || realphoto) {
					mapData.loaded = true;
					updateMapDisplay();
					console.log('üó∫Ô∏è Map images loaded from session storage');
				}
			} catch (error) {
				console.warn('‚ö†Ô∏è Could not load map images from session storage:', error);
			}
		}

		// ======= ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ session storage ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏∞‡∏ö‡∏ö =======
		async function initializeMapImages() {
			console.log('üó∫Ô∏è Initializing map images...');
			
			// ‡∏•‡∏≠‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏à‡∏≤‡∏Å session storage ‡∏Å‡πà‡∏≠‡∏ô
			loadMapFromSessionStorage();
			
			// ‡∏ñ‡πâ‡∏≤ session storage ‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏à‡∏≤‡∏Å cache/sheets
			if (mapData.loaded && (mapData.floorplan || mapData.realphoto)) {
				console.log('üíæ Map images available from session storage');
				return;
			}
			
			// ‡∏•‡∏≠‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏à‡∏≤‡∏Å cache
			if (isCacheValid('mapImages', 60 * 60 * 1000)) { // 1 hour cache
				const cachedMapData = getCachedData('mapImages');
				if (cachedMapData && !cachedMapData.compressed) {
					mapData = { ...mapData, ...cachedMapData };
					updateMapDisplay();
					console.log('üíæ Map images loaded from cache');
					return;
				} else if (cachedMapData && cachedMapData.compressed) {
					console.log('üóúÔ∏è Found compressed cache, loading from session storage');
					loadMapFromSessionStorage();
					return;
				}
			}
			
			// ‡πÇ‡∏´‡∏•‡∏î‡∏à‡∏≤‡∏Å Google Sheets (Live mode ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ‡πÅ‡∏•‡∏∞‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß)
			if (currentVersion === 'live') {
				await loadMapDataFromSheets();
			} else {
				console.log('üéÆ Demo mode: Using default map images');
				showFallbackMap();
			}
		}

		// ======= ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£ Debug ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà =======
		function debugMapImages() {
			console.log('üîç === MAP IMAGES DEBUG ===');
			console.log('Current version:', currentVersion);
			console.log('Current layout:', currentMapLayout);
			console.log('Map data:', {
				hasFloorplan: !!mapData.floorplan,
				hasRealPhoto: !!mapData.realphoto,
				loaded: mapData.loaded,
				floorplanLength: mapData.floorplan ? mapData.floorplan.length : 0,
				realPhotoLength: mapData.realphoto ? mapData.realphoto.length : 0
			});
			console.log('Sheets config:', {
				url: sheetsConfig.url ? 'SET' : 'NOT SET',
				mapImagesSheet: sheetsConfig.mapImagesSheet
			});
			
			const mapImage = document.getElementById('mapImage');
			if (mapImage) {
				console.log('Map image element:', {
					src: mapImage.src.substring(0, 100) + '...',
					naturalWidth: mapImage.naturalWidth,
					naturalHeight: mapImage.naturalHeight
				});
			}
		}
		// ===== 8. ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô debug ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏õ‡∏±‡∏ç‡∏´‡∏≤ =====
		// ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡πâ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡πÉ‡∏ô console: debugCurrentState()
			function debugCurrentState() {
				console.group('üêõ Current Route State Debug');
				console.log('üìç startPoint:', startPoint);
				console.log('üéØ selectedRoom:', selectedRoom);
				console.log('üíæ persistentDestination:', persistentDestination);
				console.log('üõ£Ô∏è routeDisplayed:', routeDisplayed);
				console.log('üì± currentRoute:', currentRoute);
				console.log('üóÉÔ∏è localStorage destination:', localStorage.getItem('persistentDestination'));
				console.log('üóÉÔ∏è localStorage startPoint:', localStorage.getItem('startPoint'));
				console.log('üîç Route elements on page:', document.querySelectorAll('.route-line, .route-marker').length);
				
				// ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏õ‡∏∏‡πà‡∏°‡∏ï‡πà‡∏≤‡∏á‡πÜ
				const showBtn = document.getElementById('showRouteBtn');
				const clearBtn = document.getElementById('clearRouteBtn');
				console.log('üéÆ Show button:', showBtn ? { disabled: showBtn.disabled, display: showBtn.style.display } : 'Not found');
				console.log('üéÆ Clear button:', clearBtn ? { display: clearBtn.style.display } : 'Not found');
				
				console.groupEnd();
			}



		// ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Toggle Usage Guide
		function toggleUsageGuide() {
			const content = document.getElementById('usageGuideContent');
			const toggleText = document.getElementById('usageGuideToggleText');
			const chevron = document.getElementById('usageGuideChevron');
			
			if (!content || !toggleText || !chevron) return;
			
			const isHidden = content.style.display === 'none';
			
			if (isHidden) {
				// Show content
				content.style.display = 'block';
				toggleText.innerHTML = `<span data-translate="hide_usage_guide">‡∏ã‡πà‡∏≠‡∏ô‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</span>`;
				chevron.style.transform = 'rotate(180deg)';
				
				// Update translation
				const hideText = currentLanguage === 'th' ? '‡∏ã‡πà‡∏≠‡∏ô‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô' : 'Hide Usage Guide';
				toggleText.textContent = hideText;
				
				showNotification(
					currentLanguage === 'th' ? 'üìñ ‡πÅ‡∏™‡∏î‡∏á‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô' : 'üìñ Usage guide shown',
					'info'
				);
			} else {
				// Hide content
				content.style.display = 'none';
				toggleText.innerHTML = `<span data-translate="show_usage_guide">‡πÅ‡∏™‡∏î‡∏á‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</span>`;
				chevron.style.transform = 'rotate(0deg)';
				
				// Update translation
				const showText = currentLanguage === 'th' ? '‡πÅ‡∏™‡∏î‡∏á‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô' : 'Show Usage Guide';
				toggleText.textContent = showText;
				
				showNotification(
					currentLanguage === 'th' ? 'üìñ ‡∏ã‡πà‡∏≠‡∏ô‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô' : 'üìñ Usage guide hidden',
					'info'
				);
			}
		}

        // =================== Initialization ===================
        
			 // ======= ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô - Sync ‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß =======
		async function loadInitialData() {
			const savedLang = localStorage.getItem('preferredLanguage') || 'th';
			currentLanguage = savedLang;
			updateLanguageButton();
			
			// ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ‡∏£‡∏∞‡∏ö‡∏ö caching ‡πÉ‡∏´‡∏°‡πà (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏∞‡∏ö‡∏ö)
			console.log('üöÄ Starting one-time data sync...');
			await loadRoomDataFromAdmin();
			
			// ‡πÇ‡∏´‡∏•‡∏î‡∏†‡∏≤‡∏û‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß)
			await initializeMapImages();
			
			const savedStartPoint = localStorage.getItem('startPoint');
			if (savedStartPoint) {
				try {
					startPoint = JSON.parse(savedStartPoint);
				} catch (error) {
					console.error('Error loading start point:', error);
				}
			}
			
			// ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï UI
			updateRoomMarkers();
			updateRouteControls(false);
			updateAllTranslations();
			updateSearchPlaceholder();
			updateGlobalVersionIndicator(currentVersion);
			loadDestination();
			updateDestinationDisplay();
			
			console.log('‚úÖ One-time sync completed');
			showProgressiveStatus('‚úÖ ‡∏Å‡∏≤‡∏£‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô', 'success');
		}

		// ======= ‡πÄ‡∏û‡∏¥‡πà‡∏° Debug Command ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Console =======
		window.debugMapImages = debugMapImages;

       // ======= ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç initializeSystem ‡πÉ‡∏´‡πâ‡πÑ‡∏°‡πà‡∏°‡∏µ Loading Overlay ‡∏ö‡∏î‡∏ö‡∏±‡∏á =======
		async function initializeSystem() {
			try {
				// ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö System Configuration (‡πÑ‡∏°‡πà‡∏ö‡∏•‡πá‡∏≠‡∏Å UI)
				const canProceed = await checkSystemConfiguration();
				
				if (!canProceed) {
					// ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô Maintenance Mode - ‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î
					return;
				}
				
				// ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
				showProgressiveStatus('üöÄ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö...', 'info');
				
				// ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏∞‡∏ö‡∏ö‡∏õ‡∏Å‡∏ï‡∏¥‡∏ï‡πà‡∏≠‡πÑ‡∏õ (‡πÅ‡∏ö‡∏ö async ‡πÑ‡∏°‡πà‡∏ö‡∏•‡πá‡∏≠‡∏Å UI)
				loadInitialData()
					.then(() => {
						setupMapEvents();
						setupWindowEvents();
						
						// Initialize map controls
						setMapLayout('floorplan');
						
						// ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö
						setTimeout(() => {
							const welcomeMessage = currentLanguage === 'th' 
								? 'üéâ ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏≠‡∏±‡∏à‡∏â‡∏£‡∏¥‡∏¢‡∏∞ v6!' 
								: 'üéâ Welcome to Smart School Map System v6!';
							showNotification(welcomeMessage, 'info');
						}, 1000);
						
						console.log('üè´ School Map System v6 Ready');
						console.log(`üìä Current Version: ${currentVersion}`);
						console.log(`üè¢ Total Buildings: ${Object.keys(buildingsData).length}`);
						console.log(`üö™ Total Rooms: ${Object.keys(roomData).length}`);
					})
					.catch(error => {
						console.error('Background loading error:', error);
						showProgressiveStatus('‚ö†Ô∏è ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏´‡∏•‡∏±‡∏á‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß', 'warning');
					});
				
				// ‡πÉ‡∏´‡πâ UI ‡πÅ‡∏™‡∏î‡∏á‡πÑ‡∏î‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à
				showProgressiveStatus('‚úÖ ‡∏£‡∏∞‡∏ö‡∏ö‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô', 'success');
				
			} catch (error) {
				console.error('Initialization error:', error);
				const errorMessage = currentLanguage === 'th' 
					? '‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏î‡πâ' 
					: '‚ùå System initialization failed';
				showProgressiveStatus(errorMessage, 'error');
				
				// ‡πÅ‡∏°‡πâ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏Å‡πá‡∏¢‡∏±‡∏á‡πÉ‡∏´‡πâ‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ
				roomData = { ...sampleRoomData };
				buildingsData = { ...sampleBuildingsData };
				setupMapEvents();
				setupWindowEvents();
			}
		}
		
				// ======= ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Performance =======
		function optimizePerformance() {
			// ‡∏•‡πâ‡∏≤‡∏á cache ‡πÄ‡∏Å‡πà‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏ô 24 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á
			const keys = Object.keys(localStorage);
			const now = Date.now();
			const maxAge = 24 * 60 * 60 * 1000; // 24 hours
			
			keys.forEach(key => {
				if (key.includes('_timestamp_')) {
					const timestamp = localStorage.getItem(key);
					if (timestamp && (now - parseInt(timestamp)) > maxAge) {
						const cacheKey = key.replace('_timestamp_', '_cache_');
						localStorage.removeItem(key);
						localStorage.removeItem(cacheKey);
						console.log(`üóëÔ∏è Removed expired cache: ${cacheKey}`);
					}
				}
			});
			
			// ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ memory
			if (performance.memory) {
				const used = Math.round(performance.memory.usedJSHeapSize / 1024 / 1024);
				console.log(`üìä Memory usage: ${used}MB`);
			}
		}

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            initializeSystem();
			
			 // ‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏à‡∏∏‡∏î‡∏´‡∏°‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ
			setTimeout(() => {
				loadDestination();
				updateDestinationDisplay();
			}, 1000);
        });
		

        // Performance monitoring
        function getMemoryUsage() {
            if (performance.memory) {
                const used = Math.round(performance.memory.usedJSHeapSize / 1024 / 1024);
                const limit = Math.round(performance.memory.jsHeapSizeLimit / 1024 / 1024);
                console.log(`Memory: ${used}MB / ${limit}MB`);
                
                if (used > limit * 0.8) {
                    console.warn('‚ö†Ô∏è Memory usage high, consider optimization');
                }
            }
        }

        // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û‡∏ó‡∏∏‡∏Å 5 ‡∏ô‡∏≤‡∏ó‡∏µ
		setInterval(optimizePerformance, 5 * 60 * 1000);

        console.log('üéâ ‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏≠‡∏±‡∏à‡∏â‡∏£‡∏¥‡∏¢‡∏∞ v6 - User Interface LATEST UPDATE!');
        console.log('‚úÖ Original 5 fixes + Previous modifications + NEW fixes completed:');
        console.log('‚úÖ FIX 1: Language toggle system implemented');
        console.log('‚úÖ FIX 2: Route persistence - routes stay until cleared');
        console.log('‚úÖ FIX 3: Continuous voice navigation with queue system');
        console.log('‚úÖ FIX 4: Map controls moved outside map area');
        console.log('‚úÖ FIX 5: Building filter for pin clustering/filtering');
        console.log('‚úÖ MOD 1.1: Map view controls (floorplan/photo/fullscreen) with toggle');
        console.log('‚úÖ MOD 1.2: Help and center buttons removed');
        console.log('‚úÖ MOD 1.3: Admin button moved to bottom navigation');
        console.log('‚úÖ MOD 1.4: Enhanced room information (no hours)');
        console.log('‚úÖ MOD 1.5: Straight line route paths');
        console.log('‚úÖ NEW 1.1: Fixed route display with proper straight lines');
        console.log('‚úÖ NEW 1.2: Room action overlay (choose details or show route)');
        console.log('‚úÖ NEW 1.3: Removed status info from room details');
        console.log('üîó Fully compatible with Admin Interface v6.1');
        console.log('üöÄ Ready for production deployment!');
        console.log('üìù Remember to update cross-reference URLs after deployment!');
    </script>
</body>
</html>