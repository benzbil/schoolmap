<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบแผนที่โรงเรียนอัจฉริยะ v6 - User Interface</title>
    
    <!-- External Libraries -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        /* =================== CSS Variables =================== */
        :root {
            --primary-color: #667eea;
            --secondary-color: #764ba2;
            --accent-color: #28a745;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --info-color: #17a2b8;
            
            --background-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --card-background: #ffffff;
            --text-primary: #333333;
            --text-secondary: #666666;
            --border-color: #e0e6ff;
            
            --border-radius: 15px;
            --box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            --transition: all 0.3s ease;
            
            --bottom-nav-height: 70px;
            --content-padding-bottom: 85px;
        }

        /* =================== Base Styles =================== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--background-gradient);
            min-height: 100vh;
            color: var(--text-primary);
            overflow-x: hidden;
            transition: var(--transition);
            padding-bottom: var(--content-padding-bottom);
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
            padding: 10px;
        }

        /* =================== Header =================== */
        .header {
			position: relative; /* เพิ่มเพื่อให้ position absolute ทำงานได้ */
            background: var(--card-background);
            padding: 15px 20px;
            border-radius: 0 0 var(--border-radius) var(--border-radius);
            box-shadow: var(--box-shadow);
            margin-bottom: 15px;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
		.header .status-indicator {
			position: absolute;
			top: 2px;                   /* ลดจาก 5px */
			right: 10px;               /* เปลี่ยนจาก center เป็น right */
			z-index: 200;
			font-size: 8px;            /* เล็กลงอีก */
			padding: 1px 6px;          /* เล็กลงอีก */
			border-radius: 8px;
		}
		
        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .school-logo {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--primary-color);
        }

        .header-title {
            flex: 1;
            text-align: center;
        }

        .header h1 {
            color: var(--text-primary);
            margin: 0;
            font-size: 1.4em;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header p {
            color: var(--text-secondary);
            font-size: 0.9em;
            margin-top: 5px;
        }

        .header-btn {
            background: var(--card-background);
            border: 2px solid var(--primary-color);
            border-radius: 12px;
            padding: 8px 12px;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 6px;
            font-weight: 600;
            color: var(--primary-color);
            font-size: 12px;
        }

        .header-btn:hover {
            background: var(--primary-color);
            color: white;
            transform: translateY(-2px);
        }

        .language-btn {
            background: linear-gradient(135deg, var(--info-color), var(--primary-color));
            color: white;
            border: none;
        }

        /* =================== Bottom Navigation =================== */
        .bottom-navigation {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: var(--bottom-nav-height);
            background: var(--card-background);
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: space-around;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            box-shadow: 0 -4px 20px rgba(0,0,0,0.1);
        }

        .nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
            padding: 8px 4px;
            position: relative;
            color: var(--text-secondary);
        }

        .nav-item.active {
            color: var(--primary-color);
        }

        .nav-item:hover {
            color: var(--primary-color);
            transform: translateY(-2px);
        }

        .nav-item i {
            font-size: 20px;
            margin-bottom: 4px;
        }

        .nav-item span {
            font-size: 10px;
            font-weight: 600;
        }

        .nav-item.active::before {
            content: '';
            position: absolute;
            top: -1px;
            left: 50%;
            transform: translateX(-50%);
            width: 30px;
            height: 3px;
            background: var(--primary-color);
            border-radius: 0 0 10px 10px;
        }
		/* =================== Status Indicators =================== */
		/* ======= แก้ไข Version Indicator ให้เล็กลง ======= */
			.status-indicator {
				padding: 2px 8px;           /* ลดจาก 4px 12px */
				border-radius: 12px;        /* ลดจาก 20px */
				font-size: 9px;             /* ลดจาก 11px */
				font-weight: 500;           /* ลดจาก 600 */
				text-transform: uppercase;
				opacity: 0.8;               /* เพิ่มความโปร่งใส */
				backdrop-filter: blur(10px);
				-webkit-backdrop-filter: blur(10px);
			}

		.status-active {
			background: rgba(40, 167, 69, 0.1);
			color: var(--accent-color);
		}

		.status-inactive {
			background: rgba(108, 117, 125, 0.1);
			color: #6c757d;
		}

		.status-connected {
			background: rgba(23, 162, 184, 0.1);
			color: var(--info-color);
		}

		.status-error {
			background: rgba(220, 53, 69, 0.1);
			color: var(--danger-color);
		}

		/* =================== Loading Overlay =================== */
		.loading-overlay {
			position: fixed;
			top: 0;
			left: 0;
			right: 0;
			bottom: 0;
			background: rgba(0,0,0,0.8);
			z-index: 9999;
			display: none;
			align-items: center;
			justify-content: center;
			backdrop-filter: blur(10px);
			-webkit-backdrop-filter: blur(10px);
		}

		.loading-content {
			background: var(--card-background);
			border-radius: var(--border-radius);
			padding: 40px;
			text-align: center;
			max-width: 400px;
			margin: 20px;
			box-shadow: 0 25px 50px rgba(0,0,0,0.3);
		}

		.loading-spinner {
			width: 50px;
			height: 50px;
			border: 4px solid #f3f3f3;
			border-top: 4px solid var(--primary-color);
			border-radius: 50%;
			animation: spin 1s linear infinite;
			margin: 0 auto 20px;
		}

		@keyframes spin {
			0% { transform: rotate(0deg); }
			100% { transform: rotate(360deg); }
		}

        /* =================== Page Styles =================== */
        .page {
            display: none;
            background: var(--card-background);
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--box-shadow);
            margin-bottom: 15px;
            min-height: calc(100vh - 200px);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .page.active {
            display: block;
            animation: fadeInUp 0.4s ease-out;
        }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* =================== Search Styles =================== */
        .search-container {
            background: linear-gradient(135deg, #f8f9ff, #e6f3ff);
            padding: 20px;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .search-box {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
        }

        .search-input {
            flex: 1;
            padding: 15px 20px;
            border: 2px solid #ddd;
            border-radius: var(--border-radius);
            font-size: 16px;
            transition: var(--transition);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            background: rgba(255,255,255,0.9);
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
            background: white;
        }

        .search-btn {
            padding: 15px 25px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: var(--transition);
            white-space: nowrap;
        }

        .search-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
        }

        .quick-categories {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 20px;
        }

        .category-card {
            background: var(--card-background);
            padding: 20px;
            border-radius: var(--border-radius);
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
            border: 2px solid var(--border-color);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .category-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--box-shadow);
            border-color: var(--primary-color);
        }

        .category-card i {
            font-size: 32px;
            color: var(--primary-color);
            margin-bottom: 12px;
        }

        .category-card h4 {
            color: var(--primary-color);
            margin-bottom: 8px;
            font-size: 16px;
        }

        .category-card p {
            color: var(--text-secondary);
            font-size: 14px;
        }

        /* =================== Map Styles =================== */
        .map-container {
            position: relative;
            margin-top: 20px;
        }

        /* Map controls with toggle functionality */
        .map-controls {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            justify-content: center;
            position: relative;
        }
		
		.map-controls.fullscreen-controls {
			position: fixed;
			top: 20px;
			right: 20px;
			z-index: 2000;
			background: rgba(255,255,255,0.95);
			padding: 8px;
			border-radius: var(--border-radius);
			box-shadow: var(--box-shadow);
			backdrop-filter: blur(10px);
			-webkit-backdrop-filter: blur(10px);
		}
		
		.map-controls.fullscreen-controls .map-control-btn:not(#fullscreenBtn) {
			display: none;
		}
		
        .map-controls.hidden .map-control-btn:not(.toggle-btn) {
            display: none;
        }
		.show-controls-btn {
			position: fixed;
			top: 20px;
			right: 20px;
			padding: 10px 15px;
			background: var(--warning-color);
			color: var(--text-primary);
			border: 2px solid var(--warning-color);
			border-radius: var(--border-radius);
			cursor: pointer;
			font-size: 12px;
			font-weight: 600;
			z-index: 1001;
			box-shadow: var(--box-shadow);
			backdrop-filter: blur(10px);
			-webkit-backdrop-filter: blur(10px);
			transition: var(--transition);
			display: none;
		}

		.show-controls-btn:hover {
			transform: translateY(-2px);
			box-shadow: 0 8px 20px rgba(0,0,0,0.2);
		}

        .map-control-btn {
            padding: 10px 15px;
            background: rgba(255,255,255,0.95);
            border: 2px solid var(--primary-color);
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: var(--transition);
            font-size: 12px;
            font-weight: 600;
            color: var(--primary-color);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .map-control-btn.active {
            background: var(--primary-color);
            color: white;
        }

        .map-control-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.2);
        }

        .toggle-btn {
            background: var(--warning-color);
            color: var(--dark-color);
            border-color: var(--warning-color);
        }

        /* Room selection overlay for choosing action */
         .room-action-overlay {
            position: absolute;
            background: var(--card-background);
            border: 8px solid var(--primary-color);
            border-radius: var(--border-radius);
            padding: 15px;
            box-shadow: var(--box-shadow);
            z-index: 200;
            display: none;
            min-width: 200px;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
			top: 50%;         /* เพิ่มใหม่ */
			left: 50%;        /* เพิ่มใหม่ */
			transform: translate(-50%, -50%); /* เพิ่มใหม่ */
        }
 
        .room-action-header {
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 20px;
            font-size: 14px;
        }

        .room-action-btn {
            width: 100%;
            padding: 12px;
            margin-bottom: 8px;
            background: var(--card-background);
            color: var(--primary-color);
            border: 2px solid var(--primary-color);
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 8px;
            justify-content: center;
        }

        .room-action-btn:hover {
            background: var(--primary-color);
            color: white;
            transform: translateY(-1px);
        }

        .room-action-btn:last-child {
            margin-bottom: 0;
        }

        .map-area {
            background: #f8f9ff;
            border: 3px solid var(--primary-color);
            border-radius: var(--border-radius);
            position: relative;
            height: 400px;
            overflow: hidden;
        }

        .map-area.fullscreen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 1500;
            height: 100vh;
            border-radius: 0;
        }

        .map-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            cursor: crosshair;
            transition: var(--transition);
        }

        .map-image:hover {
            filter: brightness(1.05);
        }

        /* Route Controls - moved outside map */
        .route-controls {
            display: flex;
            gap: 8px;
            margin-top: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .route-control-btn {
            padding: 12px 20px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            transition: var(--transition);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .route-control-btn:hover {
            transform: translateY(-2px);
        }

        .route-control-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }

        .clear-route-btn {
            background: var(--danger-color);
        }

        /* Room Markers */
        .room-marker {
            position: absolute;
            width: 35px;
            height: 35px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 16px;
            transition: var(--transition);
            border: 3px solid white;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            z-index: 30;
            transform: translate(-50%, -50%);
        }

        .room-marker:hover {
            transform: translate(-50%, -50%) scale(1.3);
            z-index: 100;
            box-shadow: 0 8px 25px rgba(0,0,0,0.4);
        }

        .room-marker.highlighted {
            background: var(--danger-color);
            animation: pulse 2s infinite;
            transform: translate(-50%, -50%) scale(1.3);
        }

        .start-point-marker {
            background: var(--accent-color);
            width: 40px;
            height: 40px;
            font-size: 18px;
            animation: startPointPulse 3s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.8; }
            50% { opacity: 1; }
        }

        @keyframes startPointPulse {
            0%, 100% { 
                transform: translate(-50%, -50%) scale(1);
                box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.7);
            }
            50% { 
                transform: translate(-50%, -50%) scale(1.2);
                box-shadow: 0 0 0 15px rgba(40, 167, 69, 0);
            }
        }

        /* Route Path */
        .route-path {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 25;
        }

        .route-line {
            stroke: var(--danger-color);
            stroke-width: 5;
            fill: none;
            stroke-dasharray: 15, 10;
            animation: dash 3s linear infinite;
            filter: drop-shadow(0 0 8px rgba(220, 53, 69, 0.5));
        }

        .route-line-glow {
            stroke: rgba(220, 53, 69, 0.3);
            stroke-width: 12;
            fill: none;
            opacity: 0.6;
        }

        .waypoint-marker {
            fill: var(--warning-color);
            stroke: white;
            stroke-width: 3;
            filter: drop-shadow(0 4px 8px rgba(0,0,0,0.3));
            animation: waypoint-pulse 2s ease-in-out infinite;
        }

        @keyframes dash {
            to {
                stroke-dashoffset: -25;
            }
        }

        @keyframes waypoint-pulse {
            0%, 100% { 
                transform: scale(1);
                opacity: 0.8;
            }
            50% { 
                transform: scale(1.3);
                opacity: 1;
            }
        }

        /* FIX 5: Building Filter */
        .building-filter {
            background: rgba(255,255,255,0.9);
            padding: 15px;
            border-radius: var(--border-radius);
            margin-bottom: 15px;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .building-filter h4 {
            margin-bottom: 10px;
            color: var(--primary-color);
            font-size: 14px;
        }

        .building-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .building-btn {
            padding: 8px 12px;
            background: var(--card-background);
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            color: var(--text-primary);
            transition: var(--transition);
        }

        .building-btn.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .building-btn:hover {
            border-color: var(--primary-color);
            transform: translateY(-1px);
        }

        /* =================== Room Info Overlay =================== */
        .room-info-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.6);
            z-index: 1500;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }

        .room-info-content {
            background: var(--card-background);
            border-radius: var(--border-radius);
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 25px 50px rgba(0,0,0,0.3);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
        }

        .room-info-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 25px;
            border-radius: var(--border-radius) var(--border-radius) 0 0;
            position: relative;
        }

        .room-info-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }

        .room-info-close:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.1);
        }

        .room-info-body {
            padding: 25px;
        }

        .navigation-controls {
            display: flex;
            gap: 10px;
            margin: 20px 0;
        }

        .nav-control-btn {
            flex: 1;
            padding: 15px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: var(--transition);
            text-align: center;
        }

        .nav-control-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
        }

        .nav-control-btn:disabled {
            background: var(--text-secondary);
            cursor: not-allowed;
            transform: none;
        }

        .voice-btn {
            background: var(--accent-color);
        }

        .voice-btn.speaking {
            background: var(--danger-color);
            animation: voice-pulse 1s infinite;
        }

        @keyframes voice-pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Compact Info */
        .compact-info {
			display: flex;
			gap: 10px;
			margin-bottom: 15px;
			flex-wrap: wrap;
			justify-content: space-between;
		}

		.info-item {
			background: rgba(255,255,255,0.8);
			padding: 8px 12px;
			border-radius: 8px;
			text-align: center;
			border-left: 3px solid var(--primary-color);
			backdrop-filter: blur(10px);
			-webkit-backdrop-filter: blur(10px);
			flex: 1;
			min-width: 0;
		}

        .info-label {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 5px;
        }

        .info-value {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
        }

        /* Route Steps */
        .route-steps {
            background: var(--card-background);
            padding: 20px;
            border-radius: var(--border-radius);
            margin-top: 15px;
        }

        .route-step {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .route-step:last-child {
            border-bottom: none;
        }

        .step-number {
            background: var(--primary-color);
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            flex-shrink: 0;
        }

        .step-content {
            flex: 1;
            font-size: 14px;
        }

        .step-distance {
            background: rgba(102, 126, 234, 0.1);
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            color: var(--primary-color);
            font-weight: 600;
        }

        .step-voice-btn {
            background: var(--accent-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            cursor: pointer;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Search Results */
        .live-results {
            margin-top: 15px;
        }

        .search-result-item {
            background: var(--card-background);
            padding: 15px;
            margin-bottom: 10px;
            border-radius: var(--border-radius);
            cursor: pointer;
            border-left: 4px solid var(--primary-color);
            transition: var(--transition);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 2px solid var(--border-color);
        }

        .search-result-item:hover {
            transform: translateY(-2px);
            box-shadow: var(--box-shadow);
            border-color: var(--primary-color);
        }

        .search-result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .search-result-title {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 16px;
        }

        .search-result-code {
            background: var(--primary-color);
            color: white;
            padding: 4px 8px;
            border-radius: 8px;
            font-size: 11px;
            font-weight: 600;
        }

        .search-result-info {
            color: var(--text-secondary);
            font-size: 12px;
        }

        /* =================== Notification =================== */
        .notification {
            position: fixed;
            top: 90px;
            right: 20px;
            padding: 15px 25px;
            background: var(--accent-color);
            color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            opacity: 0;
            transform: translateX(350px);
            transition: var(--transition);
            z-index: 3000;
            max-width: 320px;
            font-size: 14px;
            font-weight: 500;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .notification.show {
            opacity: 1;
            transform: translateX(0);
        }

        .notification.error { background: var(--danger-color); }
        .notification.warning { background: var(--warning-color); color: #333; }
        .notification.info { background: var(--info-color); }

        /* =================== Hidden Elements =================== */
        .hidden {
            display: none !important;
        }

        /* =================== Responsive Design =================== */
        @media (min-width: 768px) {
            .container {
                max-width: 1200px;
                padding: 25px;
            }
            
            .quick-categories {
                grid-template-columns: repeat(4, 1fr);
            }

            .bottom-navigation {
                justify-content: center;
                gap: 40px;
                max-width: 600px;
                left: 50%;
                transform: translateX(-50%);
                border-radius: var(--border-radius) var(--border-radius) 0 0;
            }

            .nav-item {
                flex: none;
                min-width: 80px;
            }
        }
		
		@media (max-width: 480px) {
			.compact-info { gap: 5px; }
			.info-item { padding: 6px 8px; flex: 1; min-width: 0; }
			.info-label { font-size: 9px; margin-bottom: 1px; }
			.info-value { font-size: 11px; }
		}
		
		/* แก้ไข responsive สำหรับ mobile */
		@media (max-width: 768px) {
			.header .status-indicator {
				top: 1px;
				right: 5px;
				font-size: 7px;
				padding: 1px 4px;
			}
		}
		
		/* เพิ่ม CSS สำหรับ About Page ที่ responsive */
		@media (max-width: 768px) {
			#about-page h1 {
				font-size: 1.5em !important;
			}
			
			#about-page .page h2 {
				font-size: 1.3em !important;
			}
			
			#about-page [style*="font-size: 64px"] {
				font-size: 48px !important;
			}
			
			#about-page [style*="font-size: 48px"] {
				font-size: 36px !important;
			}
			
			#about-page [style*="padding: 30px"] {
				padding: 20px !important;
			}
			
			#about-page [style*="padding: 25px"] {
				padding: 20px !important;
			}
			
			#about-page [style*="width: 60px; height: 60px"] {
				width: 50px !important;
				height: 50px !important;
				font-size: 20px !important;
			}
		}

		@media (max-width: 480px) {
			#about-page [style*="grid-template-columns: repeat(auto-fit, minmax(280px, 1fr))"] {
				grid-template-columns: 1fr !important;
			}
			
			#about-page [style*="grid-template-columns: repeat(auto-fit, minmax(250px, 1fr))"] {
				grid-template-columns: 1fr !important;
			}
			
			#about-page [style*="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr))"] {
				grid-template-columns: repeat(2, 1fr) !important;
			}
			
			#about-page [style*="padding: 20px"] {
				padding: 15px !important;
			}
		}
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
		 <div class="header">
			<!-- ย้าย Version Indicator ไปมุมขวาบน -->
			<span id="globalVersionIndicator" class="status-indicator status-connected" 
				  style="position: absolute; top: 2px; right: 10px; z-index: 200; font-size: 8px; padding: 1px 6px;">
				🎮
			</span>
			
			<div class="header-top">
				<img class="school-logo" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='50' fill='%23667eea'/%3E%3Ctext x='50' y='60' text-anchor='middle' font-family='Arial' font-size='40' fill='white'%3E🏫%3C/text%3E%3C/svg%3E" alt="School Logo">
				
				<div class="header-title">
					<h1 id="systemTitle">🏫 ระบบแผนที่โรงเรียนอัจฉริยะ</h1>
					<p id="systemSubtitle">ค้นหาห้องเรียนและสถานที่ต่างๆ พร้อมระบบนำทางด้วยเสียง</p>
				</div>
				
				<button class="header-btn language-btn" onclick="toggleLanguage()">
					<i class="fas fa-globe"></i>
					<span id="languageText">TH</span>
				</button>
			</div>
		</div>

        <!-- ======================== Search Page ======================== -->
        <div class="page active" id="search-page">
            <div class="search-container">
                <h2><i class="fas fa-search"></i> <span data-translate="search_title">ค้นหาห้องเรียนและสถานที่</span></h2>
                
                <div class="search-box">
                    <input class="search-input" id="searchInput" 
                           onkeypress="handleSearchKeyPress(event)" 
                           oninput="liveSearch()" 
                           placeholder="🔍 พิมพ์ชื่อห้อง รหัส หรือตำแหน่ง..." 
                           data-placeholder-th="🔍 พิมพ์ชื่อห้อง รหัส หรือตำแหน่ง..."
                           data-placeholder-en="🔍 Search room, code, or location..."
                           type="text">
                    <button class="search-btn" onclick="searchRoom()">
                        <i class="fas fa-search"></i> <span data-translate="search_btn">ค้นหา</span>
                    </button>
                </div>
                
                <div class="live-results" id="liveResults"></div>
            </div>

            <div class="quick-categories">
                <div class="category-card" onclick="quickSearch('classroom')">
                    <i class="fas fa-graduation-cap"></i>
                    <h4 data-translate="category_classroom">ห้องเรียน</h4>
                    <p data-translate="category_classroom_desc">ห้องเรียนปกติทั้งหมด</p>
                </div>
                <div class="category-card" onclick="quickSearch('special')">
                    <i class="fas fa-flask"></i>
                    <h4 data-translate="category_special">ห้องพิเศษ</h4>
                    <p data-translate="category_special_desc">ห้องปฏิบัติการ</p>
                </div>
                <div class="category-card" onclick="quickSearch('facilities')">
                    <i class="fas fa-building"></i>
                    <h4 data-translate="category_facilities">สิ่งอำนวยความสะดวก</h4>
                    <p data-translate="category_facilities_desc">ห้องสมุด โรงอาหาร</p>
                </div>
                <div class="category-card" onclick="quickSearch('office')">
                    <i class="fas fa-briefcase"></i>
                    <h4 data-translate="category_office">ห้องสำนักงาน</h4>
                    <p data-translate="category_office_desc">ห้องผู้บริหาร</p>
                </div>
            </div>
        </div>

        <!-- ======================== Map Page ======================== -->
        <div class="page" id="map-page">
            <h2><i class="fas fa-map"></i> <span data-translate="map_title">แผนที่โรงเรียน</span></h2>
            
			  <!-- แก้ไข: กล่องวิธีการใช้งานแบบ Toggle -->
			<div id="usageGuideContainer" style="background: linear-gradient(135deg, #f8f9ff, #e6f3ff); border-radius: var(--border-radius); margin-bottom: 20px; overflow: hidden; border: 2px solid var(--border-color);">
				<!-- Toggle Button -->
				<div style="padding: 15px; text-align: center; cursor: pointer; background: rgba(102, 126, 234, 0.1);" onclick="toggleUsageGuide()">
					<i class="fas fa-question-circle" style="color: var(--primary-color); margin-right: 8px;"></i>
					<span style="color: var(--primary-color); font-weight: 600; font-size: 14px;" id="usageGuideToggleText">
						<span data-translate="show_usage_guide">แสดงวิธีการใช้งาน</span>
					</span>
					<i class="fas fa-chevron-down" id="usageGuideChevron" style="color: var(--primary-color); margin-left: 8px; transition: transform 0.3s ease;"></i>
				</div>
				
				<!-- Content (Hidden by default) -->
				<div id="usageGuideContent" style="display: none; padding: 20px; border-top: 1px solid var(--border-color);">
					<h4 style="color: var(--primary-color); margin-bottom: 15px; text-align: center;">
						<i class="fas fa-info-circle"></i> <span data-translate="usage_guide_title">วิธีการใช้งานแผนที่</span>
					</h4>
					<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
						<div style="background: rgba(255,255,255,0.7); padding: 15px; border-radius: 8px; border-left: 4px solid var(--primary-color);">
							<div style="color: var(--primary-color); font-weight: 600; margin-bottom: 8px;">
								<i class="fas fa-search"></i> <span data-translate="step1">ขั้นตอนที่ 1: ค้นหาห้อง</span>
							</div>
							<p style="color: var(--text-secondary); font-size: 13px; line-height: 1.5; margin: 0;">
								<span data-translate="step1_desc">ไปหน้าค้นหา เลือกห้องที่ต้องการ หรือคลิกหมวดหมู่ด่วน</span>
							</p>
						</div>
						<div style="background: rgba(255,255,255,0.7); padding: 15px; border-radius: 8px; border-left: 4px solid var(--accent-color);">
							<div style="color: var(--accent-color); font-weight: 600; margin-bottom: 8px;">
								<i class="fas fa-map-marker-alt"></i> <span data-translate="step2">ขั้นตอนที่ 2: กำหนดจุดเริ่มต้น</span>
							</div>
							<p style="color: var(--text-secondary); font-size: 13px; line-height: 1.5; margin: 0;">
								<span data-translate="step2_desc">คลิกที่แผนที่เพื่อกำหนดตำแหน่งที่คุณอยู่</span>
							</p>
						</div>
						<div style="background: rgba(255,255,255,0.7); padding: 15px; border-radius: 8px; border-left: 4px solid var(--warning-color);">
							<div style="color: #856404; font-weight: 600; margin-bottom: 8px;">
								<i class="fas fa-route"></i> <span data-translate="step3">ขั้นตอนที่ 3: ดูเส้นทาง</span>
							</div>
							<p style="color: var(--text-secondary); font-size: 13px; line-height: 1.5; margin: 0;">
								<span data-translate="step3_desc">คลิก "แสดงเส้นทาง" เพื่อดูการนำทางแบบ step by step</span>
							</p>
						</div>
					</div>
				</div>
			</div>
					
            <!-- 1.1: Map controls with toggle -->
            <!-- แทนที่ส่วน map-controls ใน index.html -->
			<div class="map-controls" id="mapControls">
				<button class="map-control-btn toggle-btn" onclick="toggleMapControls()" id="toggleControlsBtn">
					<i class="fas fa-eye-slash"></i> <span data-translate="hide_controls">ซ่อนปุ่ม</span>
				</button>
				<button class="map-control-btn" onclick="setMapLayout('floorplan')" id="floorplanBtn" data-layout="floorplan">
					<i class="fas fa-th-large"></i> <span data-translate="floorplan">แผนผัง</span>
				</button>
				<button class="map-control-btn" onclick="setMapLayout('photo')" id="photoBtn" data-layout="photo">
					<i class="fas fa-camera"></i> <span data-translate="real_photo">ภาพจริง</span>
				</button>
				<!-- ⭐ เพิ่มปุ่ม Refresh Map ใหม่ -->
				<button class="map-control-btn" onclick="refreshMapImages()" id="refreshMapBtn" 
						title="รีเฟรชแผนที่จาก Google Sheets">
					<i class="fas fa-sync-alt"></i> <span data-translate="refresh_map">รีเฟรช</span>
				</button>
				<button class="map-control-btn" onclick="toggleFullscreen()" id="fullscreenBtn">
					<i class="fas fa-expand"></i> <span data-translate="fullscreen">เต็มจอ</span>
				</button>
			</div>
            
            <div class="map-container">
                <div class="map-area" id="mapArea">
                    <img id="mapImage" class="map-image" 
                         src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='800' height='600' viewBox='0 0 800 600'%3E%3Crect width='800' height='600' fill='%23f0f8ff'/%3E%3Ctext x='400' y='280' text-anchor='middle' font-family='Arial' font-size='28' fill='%23667eea' font-weight='bold'%3E🏫 แผนที่โรงเรียนอัจฉริยะ%3C/text%3E%3Ctext x='400' y='320' text-anchor='middle' font-family='Arial' font-size='16' fill='%23999'%3E(คลิกเพื่อกำหนดจุดเริ่มต้น)%3C/text%3E%3Ctext x='400' y='350' text-anchor='middle' font-family='Arial' font-size='14' fill='%23667eea'%3E📍 คลิกจุดบนแผนที่เพื่อดูข้อมูลห้อง%3C/text%3E%3C/svg%3E" 
                         alt="แผนที่โรงเรียน">
                    
                    <!-- Route Path SVG -->
                    <svg class="route-path" id="routePath" style="display: none;" viewBox="0 0 100 100" preserveAspectRatio="none">
                        <!-- Path elements will be created by JavaScript -->
                    </svg>
                    
                    <!-- 1.2: Room action selection overlay -->
                    <div class="room-action-overlay" id="roomActionOverlay">
                        <div class="room-action-header" id="roomActionHeader">เลือกการดำเนินการ</div>
                        <button class="room-action-btn" onclick="showRoomDetails()">
                            <i class="fas fa-info-circle"></i>
                            <span data-translate="view_details">ดูรายละเอียดห้อง</span>
                        </button>
                        <button class="room-action-btn" onclick="showRouteDirectly()">
                            <i class="fas fa-route"></i>
                            <span data-translate="show_route_direct">แสดงเส้นทาง</span>
                        </button>
                    </div>
                    
                    <div id="roomMarkers"></div>
                </div>
				<button class="show-controls-btn" id="showControlsBtn" onclick="showAllControls()">
				<i class="fas fa-eye"></i> <span data-translate="show_controls">แสดงปุ่ม</span>
			</button>
            </div>
            
            <!-- Route Controls moved outside map -->
            <div class="route-controls">
			<div id="destinationStatus" style="
				position: fixed; 
				top: 80px; 
				right: 20px; 
				background: rgba(102, 126, 234, 0.95); 
				color: white; 
				padding: 10px 15px; 
				border-radius: 20px; 
				font-size: 14px; 
				display: none;
				z-index: 1000;
				box-shadow: 0 4px 12px rgba(0,0,0,0.15);
			">
				<i class="fas fa-map-marker-alt"></i> 
				<span id="destinationText">-</span>
				<button onclick="clearDestination(); updateDestinationDisplay();" style="
					background: none; 
					border: none; 
					color: white; 
					margin-left: 8px; 
					cursor: pointer;
					opacity: 0.8;
				">
					<i class="fas fa-times"></i>
				</button>
			</div>
                <button class="route-control-btn" onclick="showRouteToSelected()" id="showRouteBtn" disabled>
                    <i class="fas fa-route"></i> <span data-translate="show_route">แสดงเส้นทาง</span>
                </button>
                <button class="route-control-btn clear-route-btn" onclick="clearRoute()" id="clearRouteBtn" style="display: none;">
                    <i class="fas fa-times"></i> <span data-translate="clear_route">ล้างเส้นทาง</span>
                </button>
                <button class="route-control-btn voice-btn" onclick="startContinuousVoiceNavigation()" id="voiceNavigationBtn" style="display: none;">
                    <i class="fas fa-volume-up"></i> <span data-translate="voice_nav">นำทางด้วยเสียง</span>
                </button>
            </div>
        </div>

        <!-- ======================== About Page ======================== -->
        <div class="page" id="about-page">
			<!-- Header Section -->
			<div style="text-align: center; margin-bottom: 30px;">
				<div style="font-size: 64px; margin-bottom: 20px;">🏫</div>
				<h1 style="color: var(--primary-color); margin-bottom: 10px; font-size: 2em;">
					<span data-translate="system_name">ระบบแผนที่โรงเรียนอัจฉริยะ v6</span>
				</h1>
				<p style="color: var(--text-secondary); font-size: 1.1em; max-width: 600px; margin: 0 auto; line-height: 1.6;">
					<span data-translate="system_desc">ระบบนำทางและค้นหาห้องเรียนที่ทันสมัย ออกแบบมาสำหรับการใช้งานบนมือถือเป็นหลัก พร้อมระบบนำทางด้วยเสียงและการแสดงเส้นทางอย่างชัดเจน</span>
				</p>
			</div>

			<!-- Features Grid -->
			<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 30px;">
				<!-- Feature 1 -->
				<div style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 25px; border-radius: var(--border-radius); text-align: center; box-shadow: var(--box-shadow);">
					<div style="font-size: 48px; margin-bottom: 15px;">🎯</div>
					<h3 style="margin-bottom: 10px; font-size: 1.2em;" data-translate="feature1_title">การนำทางที่แม่นยำ</h3>
					<p style="opacity: 0.9; font-size: 0.9em; line-height: 1.5;" data-translate="feature1_desc">กำหนดจุดเริ่มต้นได้ทุกตำแหน่งบนแผนที่ พร้อมเส้นทางที่ชัดเจน</p>
				</div>

				<!-- Feature 2 -->
				<div style="background: linear-gradient(135deg, #28a745, #20c997); color: white; padding: 25px; border-radius: var(--border-radius); text-align: center; box-shadow: var(--box-shadow);">
					<div style="font-size: 48px; margin-bottom: 15px;">🔊</div>
					<h3 style="margin-bottom: 10px; font-size: 1.2em;" data-translate="feature2_title">นำทางด้วยเสียง</h3>
					<p style="opacity: 0.9; font-size: 0.9em; line-height: 1.5;" data-translate="feature2_desc">ระบบอ่านคำแนะนำการเดินทางแบบขั้นตอน รองรับภาษาไทยและอังกฤษ</p>
				</div>

				<!-- Feature 3 -->
				<div style="background: linear-gradient(135deg, #17a2b8, #6f42c1); color: white; padding: 25px; border-radius: var(--border-radius); text-align: center; box-shadow: var(--box-shadow);">
					<div style="font-size: 48px; margin-bottom: 15px;">📱</div>
					<h3 style="margin-bottom: 10px; font-size: 1.2em;" data-translate="feature3_title">Mobile First</h3>
					<p style="opacity: 0.9; font-size: 0.9em; line-height: 1.5;" data-translate="feature3_desc">ออกแบบเพื่อมือถือเป็นหลัก ใช้งานง่าย UI ที่สวยงามและทันสมัย</p>
				</div>
			</div>

			<!-- New Features Section -->
			<div style="background: linear-gradient(135deg, #f8f9ff, #e6f3ff); padding: 30px; border-radius: var(--border-radius); margin-bottom: 25px; border: 2px solid var(--border-color);">
				<h2 style="text-align: center; color: var(--primary-color); margin-bottom: 25px; font-size: 1.5em;">
					<i class="fas fa-sparkles"></i> <span data-translate="whats_new">มีอะไรใหม่ในเวอร์ชัน 6</span>
				</h2>
				
				<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
					<div style="background: rgba(255,255,255,0.8); padding: 20px; border-radius: 12px; border-left: 4px solid var(--primary-color);">
						<div style="display: flex; align-items: center; margin-bottom: 10px;">
							<div style="background: var(--primary-color); color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 12px; font-size: 14px;">🎯</div>
							<h4 style="color: var(--primary-color); margin: 0;" data-translate="new1_title">จุดเริ่มต้นแบบ Custom</h4>
						</div>
						<p style="color: var(--text-secondary); font-size: 0.9em; line-height: 1.5; margin: 0;" data-translate="new1_desc">กำหนดจุดเริ่มต้นได้ทุกตำแหน่งบนแผนที่ตามต้องการ</p>
					</div>

					<div style="background: rgba(255,255,255,0.8); padding: 20px; border-radius: 12px; border-left: 4px solid var(--accent-color);">
						<div style="display: flex; align-items: center; margin-bottom: 10px;">
							<div style="background: var(--accent-color); color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 12px; font-size: 14px;">🛣️</div>
							<h4 style="color: var(--accent-color); margin: 0;" data-translate="new2_title">เส้นทางที่ชัดเจน</h4>
						</div>
						<p style="color: var(--text-secondary); font-size: 0.9em; line-height: 1.5; margin: 0;" data-translate="new2_desc">แสดงเส้นทางแบบเชื่อมจุดต่อจุดพร้อมแอนิเมชัน</p>
					</div>

					<div style="background: rgba(255,255,255,0.8); padding: 20px; border-radius: 12px; border-left: 4px solid var(--warning-color);">
						<div style="display: flex; align-items: center; margin-bottom: 10px;">
							<div style="background: var(--warning-color); color: black; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 12px; font-size: 14px;">⚡</div>
							<h4 style="color: #856404; margin: 0;" data-translate="new3_title">ประสิทธิภาพสูง</h4>
						</div>
						<p style="color: var(--text-secondary); font-size: 0.9em; line-height: 1.5; margin: 0;" data-translate="new3_desc">โหลดเร็วขึ้น ใช้หน่วยความจำน้อยลง รองรับข้อมูลจำนวนมาก</p>
					</div>
				</div>
			</div>

			<!-- How to Use Section -->
			<div style="background: var(--card-background); padding: 30px; border-radius: var(--border-radius); margin-bottom: 25px; box-shadow: var(--box-shadow);">
				<h2 style="text-align: center; color: var(--primary-color); margin-bottom: 25px; font-size: 1.5em;">
					<i class="fas fa-question-circle"></i> <span data-translate="how_to_use">วิธีการใช้งาน</span>
				</h2>
				
				<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 25px;">
					<!-- Step 1 -->
					<div style="text-align: center;">
						<div style="background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); color: white; width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 15px; font-size: 24px; font-weight: bold;">1</div>
						<h4 style="color: var(--primary-color); margin-bottom: 10px;" data-translate="step1_title">ค้นหาห้อง</h4>
						<p style="color: var(--text-secondary); font-size: 0.9em; line-height: 1.6;" data-translate="step1_desc">ใช้ช่องค้นหาหรือคลิกหมวดหมู่ด่วนเพื่อหาห้องที่ต้องการ</p>
					</div>

					<!-- Step 2 -->
					<div style="text-align: center;">
						<div style="background: linear-gradient(135deg, var(--accent-color), #20c997); color: white; width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 15px; font-size: 24px; font-weight: bold;">2</div>
						<h4 style="color: var(--accent-color); margin-bottom: 10px;" data-translate="step2_title">กำหนดจุดเริ่มต้น</h4>
						<p style="color: var(--text-secondary); font-size: 0.9em; line-height: 1.6;" data-translate="step2_desc">คลิกที่แผนที่เพื่อกำหนดจุดเริ่มต้นการนำทาง</p>
					</div>

					<!-- Step 3 -->
					<div style="text-align: center;">
						<div style="background: linear-gradient(135deg, var(--info-color), #6f42c1); color: white; width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 15px; font-size: 24px; font-weight: bold;">3</div>
						<h4 style="color: var(--info-color); margin-bottom: 10px;" data-translate="step3_title">ดูเส้นทาง</h4>
						<p style="color: var(--text-secondary); font-size: 0.9em; line-height: 1.6;" data-translate="step3_desc">เลือกห้องที่ต้องการไป คลิก "แสดงเส้นทาง" เพื่อดูเส้นทางและคำแนะนำ</p>
					</div>
				</div>
			</div>

			<!-- Technical Info -->
			<div style="background: linear-gradient(135deg, #e8f5e8, #d4edda); padding: 25px; border-radius: var(--border-radius); border: 2px solid var(--accent-color);">
				<h3 style="text-align: center; color: var(--accent-color); margin-bottom: 20px;">
					<i class="fas fa-cog"></i> <span data-translate="tech_info">ข้อมูลทางเทคนิค</span>
				</h3>
				
				<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
					<div style="text-align: center; padding: 15px;">
						<div style="color: var(--accent-color); font-size: 32px; margin-bottom: 8px;">🌐</div>
						<div style="font-weight: 600; color: var(--text-primary); font-size: 0.9em;" data-translate="web_tech">เทคโนโลยีเว็บ</div>
						<div style="color: var(--text-secondary); font-size: 0.8em;">HTML5, CSS3, JavaScript</div>
					</div>
					
					<div style="text-align: center; padding: 15px;">
						<div style="color: var(--accent-color); font-size: 32px; margin-bottom: 8px;">📊</div>
						<div style="font-weight: 600; color: var(--text-primary); font-size: 0.9em;" data-translate="data_source">แหล่งข้อมูล</div>
						<div style="color: var(--text-secondary); font-size: 0.8em;">Google Sheets Integration</div>
					</div>
					
					<div style="text-align: center; padding: 15px;">
						<div style="color: var(--accent-color); font-size: 32px; margin-bottom: 8px;">🔊</div>
						<div style="font-weight: 600; color: var(--text-primary); font-size: 0.9em;" data-translate="voice_tech">เทคโนโลยีเสียง</div>
						<div style="color: var(--text-secondary); font-size: 0.8em;">Web Speech API</div>
					</div>
					
					<div style="text-align: center; padding: 15px;">
						<div style="color: var(--accent-color); font-size: 32px; margin-bottom: 8px;">📱</div>
						<div style="font-weight: 600; color: var(--text-primary); font-size: 0.9em;" data-translate="responsive">Responsive Design</div>
						<div style="color: var(--text-secondary); font-size: 0.8em;">Mobile First Approach</div>
					</div>
				</div>
			</div>
		</div>
    </div>

    <!-- Admin Link (Hidden) - Removed from bottom left -->

    <!-- Bottom Navigation -->
    <div class="bottom-navigation">
        <div class="nav-item active" onclick="showPage('search')">
            <i class="fas fa-search"></i>
            <span data-translate="nav_search">ค้นหา</span>
        </div>
        <div class="nav-item" onclick="showPage('map')">
            <i class="fas fa-map"></i>
            <span data-translate="nav_map">แผนที่</span>
        </div>
        <div class="nav-item" onclick="showPage('about')">
            <i class="fas fa-info-circle"></i>
            <span data-translate="nav_about">เกี่ยวกับ</span>
        </div>
        <!-- 1.3: Admin button moved to bottom navigation -->
        <div class="nav-item" onclick="openAdminInterface()" title="Admin Panel">
            <i class="fas fa-cog"></i>
            <span data-translate="nav_admin">จัดการ</span>
        </div>
		  <div class="nav-item" onclick="openSystemPresentation()" title="พรีเซ้นท์ระบบ">
            <i class="fas fa-exclamation-triangle"></i>
            <span data-translate="nav_Present">อธิบายระบบ</span>
        </div>
		
    </div>

    <!-- Room Info Overlay -->
    <div class="room-info-overlay" id="roomInfoOverlay">
        <div class="room-info-content">
            <div class="room-info-header">
                <div class="room-title" id="overlayRoomName"></div>
                <div style="font-size: 16px; opacity: 0.9;" id="overlayRoomLocation"></div>
                <button class="room-info-close" onclick="closeRoomInfoOverlay()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="room-info-body">
                <!-- 1.3: Remove status info, enhanced room information display -->
                <div class="compact-info">
                    <div class="info-item">
                        <div class="info-label" data-translate="info_building">🏢 อาคาร</div>
                        <div class="info-value" id="overlayRoomBuilding"></div>
                    </div>
                    <div class="info-item">
                        <div class="info-label" data-translate="info_floor">📍 ชั้น</div>
                        <div class="info-value" id="overlayRoomFloor"></div>
                    </div>
                    <div class="info-item">
						<div class="info-label" data-translate="info_type">🏷️ ประเภทห้อง</div>
                        <div class="info-value" id="overlayRoomType"></div>
                    </div>
                </div>
 
                
                <div style="background: rgba(255,255,255,0.7); padding: 20px; border-radius: var(--border-radius); margin-bottom: 20px;">
                    <div style="font-size: 14px; color: var(--text-secondary); margin-bottom: 8px;" data-translate="info_description">รายละเอียด</div>
                    <div style="font-size: 16px;" id="overlayRoomDescription"></div>
                </div>
                
                <div id="overlayRoomGallery" style="display: none;">
                    <h4 style="font-size: 16px; color: var(--primary-color); margin-bottom: 15px;">
                        <i class="fas fa-images"></i> <span data-translate="room_images">รูปภาพห้อง</span>
                    </h4>
                    <div id="overlayImageGallery" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 20px;"></div>
                </div>
                
                <div class="navigation-controls">
                    <button class="nav-control-btn" onclick="generateCompleteRoute()" id="routeBtn">
                        <i class="fas fa-route"></i> <span data-translate="route_navigation">เส้นทางนำทาง</span>
                    </button>
                    <button class="nav-control-btn voice-btn" onclick="toggleVoiceNavigation()" id="overlayVoiceBtn">
                        <i class="fas fa-volume-up"></i> <span data-translate="voice">เสียง</span>
                    </button>
                </div>
                
                <div id="overlayRouteSteps"></div>
            </div>
        </div>
    </div>

    <!-- Notification -->
    <div class="notification" id="notification"></div>
	
	<!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <h3 style="color: var(--primary-color); margin-bottom: 10px;" id="loadingTitle">กำลังโหลดข้อมูล</h3>
            <p style="color: var(--text-secondary);" id="loadingMessage">กรุณารอสักครู่...</p>
        </div>
    </div>

    <script>
        // =================== Global Variables ===================
       // ======= Enhanced Global Variables =======
		let roomData = {};
		let selectedRoom = null;
		let startPoint = null;
		let voiceNavigationEnabled = false;
		let currentSpeech = null;
		let currentLanguage = 'th';
		let currentMapLayout = 'floorplan';
		let isFullscreen = false;
		let currentVersion = 'demo'; // จะถูกอัปเดตจาก Google Sheets
		let buildingsData = {};

		// Enhanced variables
		let systemConfig = {
			version: 'demo',
			maintenance_mode: false,
			maintenance_message: 'เว็บไซต์อยู่ระหว่างการปรับปรุง'
		};
		let isMaintenanceMode = false;

		// Route persistence variables
		let currentRoute = null;
		let routeDisplayed = false;

		// Voice navigation queue
		let voiceQueue = [];
		let isVoiceNavigating = false;
		let voiceTimeout = null;

		// Sheets configuration (same as admin)
		 
		let sheetsConfig = {
			url: 'https://script.google.com/macros/s/AKfycbzpCFGZ_7kvyvAqiQGw3y_t6ROwUhh8Csp-I3xOPZZhP_XJ9Yyfyjsrl88s5qg3xx56/exec',
			buildingsSheet: 'Buildings',
			roomsSheet: 'Rooms',
			mapImagesSheet: 'MapImages',
			systemConfigSheet: 'SystemConfig',
			connected: false
		};
	
		// ======= ตัวแปรสำหรับจัดการภาพแผนที่ =======
		let mapData = {
			floorplan: null,
			realphoto: null,
			notes: '',
			loaded: false
		};

		 let persistentDestination = {
			roomCode: null,
			roomName: null,
			timestamp: null
		};
				
		// ======= Enhanced Version Management แบบเล็กกะทัดรัด =======
		function updateGlobalVersionIndicator(version) {
			const indicator = document.getElementById('globalVersionIndicator');
			if (!indicator) return;
			
			if (version === 'demo') {
				indicator.innerHTML = '🎮';  // เหลือแค่สัญลักษณ์
				indicator.className = 'status-indicator status-connected';
				indicator.title = 'Demo Mode'; // ใช้ tooltip แทน
			} else {
				// Live Mode - ตรวจสอบสถานะการเชื่อมต่อ Google Sheets
				if (sheetsConfig.connected) {
					indicator.innerHTML = '🔴';
					indicator.className = 'status-indicator status-active';
					indicator.title = 'Live Mode (Connected)';
				} else {
					indicator.innerHTML = '⚠️';
					indicator.className = 'status-indicator status-error';
					indicator.title = 'Live Mode (Disconnected)';
				}
			}
		}

		// ======= Loading Overlay Functions =======
		function showLoadingOverlay(title, message) {
			const overlay = document.getElementById('loadingOverlay');
			const titleEl = document.getElementById('loadingTitle');
			const messageEl = document.getElementById('loadingMessage');
			
			if (overlay) overlay.style.display = 'flex';
			if (titleEl) titleEl.textContent = title || 'กำลังโหลดข้อมูล';
			if (messageEl) messageEl.textContent = message || 'กรุณารอสักครู่...';
		}

		function hideLoadingOverlay() {
			const overlay = document.getElementById('loadingOverlay');
			if (overlay) overlay.style.display = 'none';
		}

		// ======= Data Caching System =======
		function getDataCacheKey(dataType) {
			return `${dataType}_cache_${currentVersion}`;
		}

		function getDataTimestampKey(dataType) {
			return `${dataType}_timestamp_${currentVersion}`;
		}

		function isCacheValid(dataType, maxAge = 30 * 60 * 1000) { // 30 minutes default
			const timestamp = localStorage.getItem(getDataTimestampKey(dataType));
			if (!timestamp) return false;
			
			const cacheAge = Date.now() - parseInt(timestamp);
			return cacheAge < maxAge;
		}

		// ======= แทนที่ฟังก์ชัน setCachedData เดิม =======
		function setCachedData(dataType, data) {
			return safeSetCachedData(dataType, data);
		}

		function getCachedData(dataType) {
			const cached = localStorage.getItem(getDataCacheKey(dataType));
			return cached ? JSON.parse(cached) : null;
		}
		
		// =================== System Configuration Functions ===================

		// ======= แก้ไข System Configuration ไม่ให้แสดง Loading Overlay ที่บดบัง =======
		async function checkSystemConfiguration() {
			try {
				console.log('🔍 Checking system configuration...');
				
				// ไม่แสดง loading overlay ที่บดบัง แต่แสดง status เล็ก ๆ แทน
				const isFirstTime = !localStorage.getItem('hasVisitedBefore');
				if (isFirstTime) {
					showProgressiveStatus('⚙️ ตั้งค่าระบบครั้งแรก...', 'info');
				}
				
				// ลองอ่านจาก Google Sheets ก่อน (แบบไม่บล็อก UI)
				loadSystemConfigFromSheets()
					.then(config => {
						if (config) {
							systemConfig = { ...systemConfig, ...config };
							currentVersion = config.version;
							isMaintenanceMode = config.maintenance_mode === true || config.maintenance_mode === 'true';
							
							console.log('✅ Loaded system config from Google Sheets:', systemConfig);
							updateGlobalVersionIndicator(currentVersion);
						}
					})
					.catch(error => {
						console.log('📱 Using local config as fallback');
					});
				
				// ใช้ข้อมูล local เป็น default ไม่รอ Google Sheets
				const savedVersion = localStorage.getItem('systemVersion') || 'demo';
				const savedConfig = localStorage.getItem('systemConfig');
				
				currentVersion = savedVersion;
				
				 
				if (savedConfig) {
					const parsed = JSON.parse(savedConfig);
					systemConfig = { ...systemConfig, ...parsed };
					isMaintenanceMode = systemConfig.maintenance_mode === true || systemConfig.maintenance_mode === 'true';
				}
				
				console.log('📱 Using initial system config:', systemConfig);
				
				// ตรวจสอบ Maintenance Mode
				if (isMaintenanceMode) {
					showMaintenancePage();
					return false;
				}
				
				// Mark as visited
				localStorage.setItem('hasVisitedBefore', 'true');
				
				return true;
				
			} catch (error) {
				console.error('Error checking system configuration:', error);
				return true; // ให้ทำงานต่อไปได้แม้เกิดข้อผิดพลาด
			}
		}
		
		
		async function loadSystemConfigFromSheets() {
			try {
				const params = new URLSearchParams();
				params.append('action', 'getData');
				params.append('sheet', sheetsConfig.systemConfigSheet);
				
				const response = await fetch(sheetsConfig.url, {
					method: 'POST',
					headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
					body: params.toString()
				});
				
				if (response.ok) {
					const result = await response.json();
					if (result.success && result.data && result.data.length > 0) {
						const config = result.data.find(item => item.id === 'system') || result.data[0];
						return {
							version: config.version || 'demo',
							maintenance_mode: config.maintenance_mode === 'true' || config.maintenance_mode === true,
							maintenance_message: config.maintenance_message || systemConfig.maintenance_message
						};
					}
				}
				
				return null;
				
			} catch (error) {
				console.error('Failed to load system config from sheets:', error);
				return null;
			}
		}

		// ===================  เพิ่มหน้า Under Construction  =====
		function showMaintenancePage() {
			console.log('🚧 Displaying maintenance page');
			document.body.innerHTML = `
				<div style="
					font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
					background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
					margin: 0;
					padding: 20px;
					display: flex;
					align-items: center;
					justify-content: center;
					min-height: 100vh;
					color: #333;
				">
					<div style="
						background: rgba(255, 255, 255, 0.95);
						backdrop-filter: blur(20px);
						padding: 50px;
						border-radius: 20px;
						text-align: center;
						max-width: 600px;
						box-shadow: 0 25px 50px rgba(0,0,0,0.3);
					">
						<div style="font-size: 80px; margin-bottom: 30px;">🚧</div>
						<h1 style="
							font-size: 2.5em;
							margin-bottom: 20px;
							background: linear-gradient(135deg, #667eea, #764ba2);
							-webkit-background-clip: text;
							-webkit-text-fill-color: transparent;
							background-clip: text;
						">Under Construction</h1>
						<p style="
							font-size: 1.2em;
							line-height: 1.6;
							color: #666;
							margin-bottom: 30px;
						">${systemConfig.maintenance_message}</p>
						<div style="
							background: rgba(102, 126, 234, 0.1);
							padding: 20px;
							border-radius: 15px;
							border-left: 4px solid #667eea;
						">
							<p style="margin: 0; font-size: 0.9em; color: #888;">
								<i class="fas fa-info-circle"></i>
								ระบบอยู่ระหว่างการปรับปรุงเพื่อให้บริการที่ดีขึ้น
							</p>
							<small style="color: #999; margin-top: 10px; display: block;">
							Version: ${currentVersion} | Mode: ${isMaintenanceMode ? 'Maintenance' : 'Normal'}
						</small>
						</div>
					</div>
				</div>
			`;
		}
        // FIX 1: Language translations
        const translations = {
            th: {
                search_title: "ค้นหาห้องเรียนและสถานที่",
                search_btn: "ค้นหา",
                category_classroom: "ห้องเรียน",
                category_classroom_desc: "ห้องเรียนปกติทั้งหมด",
                category_special: "ห้องพิเศษ",
                category_special_desc: "ห้องปฏิบัติการ",
                category_facilities: "สิ่งอำนวยความสะดวก",
                category_facilities_desc: "ห้องสมุด โรงอาหาร",
                category_office: "ห้องสำนักงาน",
                category_office_desc: "ห้องผู้บริหาร",
                map_title: "แผนที่โรงเรียน",
                filter_building: "🏢 กรองตามอาคาร",
                hide_controls: "ซ่อนปุ่ม",
                show_controls: "แสดงปุ่ม",
                floorplan: "แผนผัง",
                real_photo: "ภาพจริง",
                fullscreen: "เต็มจอ",
                exit_fullscreen: "ออกจากเต็มจอ",
                show_route: "แสดงเส้นทาง",
                clear_route: "ล้างเส้นทาง",
                voice_nav: "นำทางด้วยเสียง",
                about_title: "เกี่ยวกับระบบ",
                system_name: "ระบบแผนที่โรงเรียนอัจฉริยะ v6",
                system_desc: "ระบบนำทางและค้นหาห้องเรียนที่ทันสมัย ออกแบบมาสำหรับการใช้งานบนมือถือเป็นหลัก พร้อมระบบนำทางด้วยเสียงและการแสดงเส้นทางอย่างชัดเจน",
                features_title: "ฟีเจอร์ใหม่ในเวอร์ชัน 6",
                usage_title: "วิธีการใช้งาน",
                step1_title: "1. ค้นหาห้อง:",
                step1_desc: "ใช้ช่องค้นหาหรือคลิกหมวดหมู่ด่วนเพื่อหาห้องที่ต้องการ",
                step2_title: "2. กำหนดจุดเริ่มต้น:",
                step2_desc: "คลิกที่แผนที่เพื่อกำหนดจุดเริ่มต้นการนำทาง",
                step3_title: "3. ดูเส้นทาง:",
                step3_desc: "เลือกห้องที่ต้องการไป คลิก \"แสดงเส้นทาง\" เพื่อดูเส้นทางและคำแนะนำ",
                step4_title: "4. นำทางด้วยเสียง:",
                step4_desc: "เปิดเสียงเพื่อฟังคำแนะนำการเดินทางแบบขั้นตอน",
                nav_search: "ค้นหา",
                nav_map: "แผนที่",
                nav_about: "เกี่ยวกับ",
                nav_admin: "จัดการ",
				nav_Present: "อธิบายระบบ",
                info_building: "อาคาร",
                info_floor: "ชั้น",
                info_type: "ประเภทห้อง",
                info_description: "รายละเอียด",
                room_images: "รูปภาพห้อง",
                route_navigation: "เส้นทางนำทาง",
                voice: "เสียง",
                view_details: "ดูรายละเอียดห้อง",
                show_route_direct: "แสดงเส้นทาง",
                select_action: "เลือกการดำเนินการ",
				whats_new: "มีอะไรใหม่ในเวอร์ชัน 6",
				feature1_title: "การนำทางที่แม่นยำ",
				feature1_desc: "กำหนดจุดเริ่มต้นได้ทุกตำแหน่งบนแผนที่ พร้อมเส้นทางที่ชัดเจน",
				feature2_title: "นำทางด้วยเสียง",
				feature2_desc: "ระบบอ่านคำแนะนำการเดินทางแบบขั้นตอน รองรับภาษาไทยและอังกฤษ",
				feature3_title: "Mobile First",
				feature3_desc: "ออกแบบเพื่อมือถือเป็นหลัก ใช้งานง่าย UI ที่สวยงามและทันสมัย",
				new1_title: "จุดเริ่มต้นแบบ Custom",
				new1_desc: "กำหนดจุดเริ่มต้นได้ทุกตำแหน่งบนแผนที่ตามต้องการ",
				new2_title: "เส้นทางที่ชัดเจน",
				new2_desc: "แสดงเส้นทางแบบเชื่อมจุดต่อจุดพร้อมแอนิเมชัน",
				new3_title: "ประสิทธิภาพสูง",
				new3_desc: "โหลดเร็วขึ้น ใช้หน่วยความจำน้อยลง รองรับข้อมูลจำนวนมาก",
				how_to_use: "วิธีการใช้งาน",
				tech_info: "ข้อมูลทางเทคนิค",
				web_tech: "เทคโนโลยีเว็บ",
				data_source: "แหล่งข้อมูล",
				voice_tech: "เทคโนโลยีเสียง",
				responsive: "Responsive Design", 
				show_usage_guide: "แสดงวิธีการใช้งาน",
				hide_usage_guide: "ซ่อนวิธีการใช้งาน",
				usage_guide_title: "วิธีการใช้งานแผนที่",
				step1: "ขั้นตอนที่ 1: ค้นหาห้อง",
				step1_desc: "ไปหน้าค้นหา เลือกห้องที่ต้องการ หรือคลิกหมวดหมู่ด่วน",
				step2: "ขั้นตอนที่ 2: กำหนดจุดเริ่มต้น", 
				step2_desc: "คลิกที่แผนที่เพื่อกำหนดตำแหน่งที่คุณอยู่",
				step3: "ขั้นตอนที่ 3: ดูเส้นทาง",
				step3_desc: "คลิก \"แสดงเส้นทาง\" เพื่อดูการนำทางแบบ step by step"			
				
            },
            en: {
                search_title: "Search Classrooms and Places",
                search_btn: "Search",
                category_classroom: "Classrooms",
                category_classroom_desc: "All regular classrooms",
                category_special: "Special Rooms",
                category_special_desc: "Laboratories",
                category_facilities: "Facilities",
                category_facilities_desc: "Library, Cafeteria",
                category_office: "Offices",
                category_office_desc: "Administrative offices",
                map_title: "School Map",
                filter_building: "🏢 Filter by Building",
                hide_controls: "Hide Controls",
                show_controls: "Show Controls",
                floorplan: "Floor Plan",
                real_photo: "Real Photo",
                fullscreen: "Fullscreen",
                exit_fullscreen: "Exit Fullscreen",
                show_route: "Show Route",
                clear_route: "Clear Route",
                voice_nav: "Voice Navigation",
                about_title: "About System",
                system_name: "Smart School Map System v6",
                system_desc: "Modern classroom search and navigation system designed primarily for mobile use with voice navigation and clear route display.",
                features_title: "New Features in Version 6",
                usage_title: "How to Use",
                step1_title: "1. Search Rooms:",
                step1_desc: "Use search box or click quick categories to find desired rooms",
                step2_title: "2. Set Starting Point:",
                step2_desc: "Click on the map to set navigation starting point",
                step3_title: "3. View Route:",
                step3_desc: "Select destination room, click \"Show Route\" to see path and directions",
                step4_title: "4. Voice Navigation:",
                step4_desc: "Enable sound to hear step-by-step navigation instructions",
                nav_search: "Search",
                nav_map: "Map",
                nav_about: "About",
                nav_admin: "Admin",
				nav_Present: "อธิบายระบบ",
                info_building: "Building",
                info_floor: "Floor",
                info_type: "Room Type",
                info_description: "Description",
                room_images: "Room Images",
                route_navigation: "Route Navigation",
                voice: "Voice",
                view_details: "View Room Details",
                show_route_direct: "Show Route",
                select_action: "Select Action",
				whats_new: "What's New in Version 6",
				feature1_title: "Precise Navigation",
				feature1_desc: "Set starting point anywhere on the map with clear route guidance",
				feature2_title: "Voice Navigation",
				feature2_desc: "Step-by-step audio directions supporting Thai and English languages",
				feature3_title: "Mobile First",
				feature3_desc: "Designed for mobile devices with beautiful and modern UI",
				new1_title: "Custom Starting Point",
				new1_desc: "Set starting point anywhere on the map as desired",
				new2_title: "Clear Route Display",
				new2_desc: "Point-to-point route visualization with animations",
				new3_title: "High Performance",
				new3_desc: "Faster loading, lower memory usage, supports large datasets",
				how_to_use: "How to Use",
				tech_info: "Technical Information",
				web_tech: "Web Technology",
				data_source: "Data Source",
				voice_tech: "Voice Technology",
				responsive: "Responsive Design",
				show_usage_guide: "Show Usage Guide",
				hide_usage_guide: "Hide Usage Guide", 
				usage_guide_title: "Map Usage Guide",
				step1: "Step 1: Search Room",
				step1_desc: "Go to search page, select desired room or click quick categories",
				step2: "Step 2: Set Starting Point",
				step2_desc: "Click on map to set your current position",
				step3: "Step 3: View Route", 
				step3_desc: "Click \"Show Route\" to see step-by-step navigation"
            }
        };

        // =================== Sample Data ===================
        const sampleRoomData = {
            'R001': {
                code: 'R001',
                name: 'ห้องเรียน ม.1/1',
                building: 'B001',
                location: 'ชั้น 1',
                description: 'ห้องเรียนปกติสำหรับนักเรียนชั้นมัธยมศึกษาปีที่ 1',
                hours: '08:00 - 16:30',
                status: 'active',
                x: 20, y: 30,
                images: ['https://picsum.photos/400/300?random=1']
            },
            'R002': {
                code: 'R002',
                name: 'ห้องเรียน ม.1/2',
                building: 'B001',
                location: 'ชั้น 1',
                description: 'ห้องเรียนปกติสำหรับนักเรียนชั้นมัธยมศึกษาปีที่ 1',
                hours: '08:00 - 16:30',
                status: 'active',
                x: 45, y: 30,
                images: ['https://picsum.photos/400/300?random=2']
            },
            'C001': {
                code: 'C001',
                name: 'ห้องคอมพิวเตอร์ 1',
                building: 'B002',
                location: 'ชั้น 2',
                description: 'ห้องปฏิบัติการคอมพิวเตอร์ มีเครื่องคอมพิวเตอร์ 30 เครื่อง',
                hours: '08:00 - 17:00',
                status: 'active',
                x: 25, y: 65,
                images: ['https://picsum.photos/400/300?random=3']
            },
            'L001': {
                code: 'L001',
                name: 'ห้องสมุดหลัก',
                building: 'B003',
                location: 'ชั้น 1',
                description: 'ห้องสมุดหลักของโรงเรียน มีหนังสือมากกว่า 15,000 เล่ม',
                hours: '07:30 - 18:00',
                status: 'active',
                x: 80, y: 70,
                images: ['https://picsum.photos/400/300?random=4']
            },
            'CAFE001': {
                code: 'CAFE001',
                name: 'โรงอาหารหลัก',
                building: 'B004',
                location: 'ชั้น 1',
                description: 'โรงอาหารหลักของโรงเรียน รองรับนักเรียน 500 คน',
                hours: '06:30 - 14:00',
                status: 'active',
                x: 85, y: 40,
                images: ['https://picsum.photos/400/300?random=5']
            }
        };

        const sampleBuildingsData = {
            'B001': { code: 'B001', name: 'อาคารเรียน 1' },
            'B002': { code: 'B002', name: 'อาคารเรียน 2' },
            'B003': { code: 'B003', name: 'อาคารสำนักงาน' },
            'B004': { code: 'B004', name: 'อาคารสิ่งอำนวยความสะดวก' }
        };

        // =================== FIX 1: Language System ===================
        
        function toggleLanguage() {
            currentLanguage = currentLanguage === 'th' ? 'en' : 'th';
            localStorage.setItem('preferredLanguage', currentLanguage);
            updateLanguageButton();
            updateAllTranslations();
            updateSearchPlaceholder();
            showNotification(
                currentLanguage === 'th' ? '🇹🇭 เปลี่ยนเป็นภาษาไทย' : '🇺🇸 Changed to English',
                'success'
            );
        }

        function updateLanguageButton() {
            const languageText = document.getElementById('languageText');
            if (languageText) {
                languageText.textContent = currentLanguage === 'th' ? 'TH' : 'EN';
            }
        }

        function updateAllTranslations() {
            const elementsToTranslate = document.querySelectorAll('[data-translate]');
            elementsToTranslate.forEach(element => {
                const key = element.getAttribute('data-translate');
                if (translations[currentLanguage] && translations[currentLanguage][key]) {
                    if (element.tagName === 'UL' && key === 'features_list') {
                        // Special handling for features list
                        if (currentLanguage === 'en') {
                            element.innerHTML = `
                                <li>🎯 Set starting point anywhere on the map</li>
                                <li>🛣️ Clear point-to-point route display</li>
                                <li>📱 Mobile-optimized UI</li>
                                <li>🔊 Detailed voice navigation system</li>
                                <li>⚡ Better performance and lower memory usage</li>
                            `;
                        } else {
                            element.innerHTML = `
                                <li>🎯 กำหนดจุดเริ่มต้นได้ทุกตำแหน่งบนแผนที่</li>
                                <li>🛣️ แสดงเส้นทางแบบเชื่อมจุดต่อจุดอย่างชัดเจน</li>
                                <li>📱 UI ที่ปรับปรุงใหม่เหมาะกับมือถือ</li>
                                <li>🔊 ระบบนำทางด้วยเสียงที่ละเอียด</li>
                                <li>⚡ ประสิทธิภาพที่เร็วขึ้นและใช้หน่วยความจำน้อยลง</li>
                            `;
                        }
                    } else {
                        element.textContent = translations[currentLanguage][key];
                    }
                }
            });
            
            // Update title and subtitle
            const systemTitle = document.getElementById('systemTitle');
            const systemSubtitle = document.getElementById('systemSubtitle');
            
            if (currentLanguage === 'en') {
                if (systemTitle) systemTitle.textContent = '🏫 Smart School Map System';
                if (systemSubtitle) systemSubtitle.textContent = 'Find classrooms and navigate with voice guidance';
            } else {
                if (systemTitle) systemTitle.textContent = '🏫 ระบบแผนที่โรงเรียนอัจฉริยะ';
                if (systemSubtitle) systemSubtitle.textContent = 'ค้นหาห้องเรียนและสถานที่ต่างๆ พร้อมระบบนำทางด้วยเสียง';
            }
        }

        function updateSearchPlaceholder() {
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                const placeholder = currentLanguage === 'th' 
                    ? searchInput.getAttribute('data-placeholder-th')
                    : searchInput.getAttribute('data-placeholder-en');
                searchInput.placeholder = placeholder;
            }
        }


		// ======= localStorage Quota Management =======
		function getStorageQuota() {
			try {
				// ทดสอบ localStorage quota
				const testKey = 'storage_test_' + Date.now();
				const testData = 'x'.repeat(1024); // 1KB test
				localStorage.setItem(testKey, testData);
				localStorage.removeItem(testKey);
				return true;
			} catch (e) {
				return false;
			}
		}

		function getStorageSize() {
			let total = 0;
			for (let key in localStorage) {
				if (localStorage.hasOwnProperty(key)) {
					total += localStorage[key].length + key.length;
				}
			}
			return total;
		}

		function freeUpStorage(targetSize = 50000) { // 50KB
			const keys = Object.keys(localStorage);
			const cacheKeys = keys.filter(key => key.includes('_cache_') || key.includes('_timestamp_'));
			
			// ลบ cache เก่าตามลำดับเวลา
			cacheKeys.sort((a, b) => {
				const timeA = localStorage.getItem(a.replace('_cache_', '_timestamp_').replace('_timestamp_', '_timestamp_'));
				const timeB = localStorage.getItem(b.replace('_cache_', '_timestamp_').replace('_timestamp_', '_timestamp_'));
				return parseInt(timeA || '0') - parseInt(timeB || '0');
			});
			
			let freed = 0;
			for (const key of cacheKeys) {
				if (freed >= targetSize) break;
				const size = localStorage[key]?.length || 0;
				localStorage.removeItem(key);
				freed += size;
				console.log(`🗑️ Removed cache: ${key} (${size} bytes)`);
			}
			
			return freed;
		}

		// ======= แก้ไข: ปรับปรุง Cache Management สำหรับข้อมูลขนาดใหญ่ =======
		function safeSetCachedData(dataType, data) {
			try {
				const dataString = JSON.stringify(data);
				const dataSize = dataString.length;
				
				// แก้ไข: เพิ่มขีดจำกัดสำหรับข้อมูลประเภทต่างๆ
				const sizeLimit = {
					'mapImages': 2000000,    // 2MB สำหรับรูปภาพแผนที่
					'rooms': 1000000,       // 1MB สำหรับข้อมูลห้อง
					'buildings': 500000,    // 500KB สำหรับข้อมูลอาคาร
					'default': 500000       // 500KB สำหรับข้อมูลอื่นๆ
				};
				
				const maxSize = sizeLimit[dataType] || sizeLimit['default'];
				
				// ตรวจสอบขนาดข้อมูล
				if (dataSize > maxSize) {
					console.warn(`⚠️ Data too large for cache: ${dataType} (${dataSize} bytes) > limit (${maxSize} bytes)`);
					
					// แก้ไข: สำหรับ mapImages ให้บีบอัดหรือแบ่งเก็บ
					if (dataType === 'mapImages') {
						return compressAndCacheMapImages(data);
					}
					
					return false;
				}
				
				// ทดสอบพื้นที่ว่าง
				if (!getStorageQuota()) {
					console.log('💾 Storage quota low, freeing up space...');
					freeUpStorage(dataSize + 100000); // เพิ่ม buffer 100KB
				}
				
				localStorage.setItem(getDataCacheKey(dataType), dataString);
				localStorage.setItem(getDataTimestampKey(dataType), Date.now().toString());
				
				console.log(`✅ Cached ${dataType}: ${(dataSize/1024).toFixed(1)}KB`);
				return true;
				
			} catch (error) {
				if (error.name === 'QuotaExceededError') {
					console.warn('🚨 Storage quota exceeded, attempting cleanup...');
					freeUpStorage(200000); // ล้าง 200KB
					
					try {
						// ลองอีกครั้งหลังล้าง
						localStorage.setItem(getDataCacheKey(dataType), JSON.stringify(data));
						localStorage.setItem(getDataTimestampKey(dataType), Date.now().toString());
						console.log(`✅ Cached ${dataType} after cleanup`);
						return true;
					} catch (retryError) {
						console.error(`❌ Failed to cache ${dataType} even after cleanup:`, retryError);
						return false;
					}
				} else {
					console.error(`❌ Cache error for ${dataType}:`, error);
					return false;
				}
			}
		}
		
		// ======= เพิ่ม: ฟังก์ชันบีบอัดข้อมูลแผนที่ =======
		function compressAndCacheMapImages(mapData) {
			try {
				// บีบอัดรูปภาพ base64 โดยเก็บเฉพาะ metadata และ URL สั้นๆ
				const compressedData = {
					floorplan: mapData.floorplan ? 'compressed_floorplan' : null,
					realphoto: mapData.realphoto ? 'compressed_realphoto' : null,
					notes: mapData.notes || '',
					loaded: mapData.loaded || false,
					compressed: true,
					originalSizes: {
						floorplan: mapData.floorplan ? mapData.floorplan.length : 0,
						realphoto: mapData.realphoto ? mapData.realphoto.length : 0
					}
				};
				
				// เก็บรูปจริงใน session storage ชั่วคราว
				if (mapData.floorplan) {
					try {
						sessionStorage.setItem('temp_floorplan', mapData.floorplan);
					} catch (e) {
						console.warn('Cannot store floorplan in session storage');
					}
				}
				
				if (mapData.realphoto) {
					try {
						sessionStorage.setItem('temp_realphoto', mapData.realphoto);
					} catch (e) {
						console.warn('Cannot store realphoto in session storage');
					}
				}
				
				// เก็บข้อมูลที่บีบอัดแล้ว
				const compressedString = JSON.stringify(compressedData);
				localStorage.setItem(getDataCacheKey('mapImages'), compressedString);
				localStorage.setItem(getDataTimestampKey('mapImages'), Date.now().toString());
				
				console.log(`🗜️ Map images compressed and cached: ${(compressedString.length/1024).toFixed(1)}KB`);
				return true;
				
			} catch (error) {
				console.error('❌ Failed to compress map images:', error);
				return false;
			}
		}

      // ======= Progressive Data Loading สำหรับ Live Mode =======
			async function loadRoomDataFromAdmin() {
				try {
					console.log('🔄 Loading room data for version:', currentVersion);
					
					if (currentVersion === 'demo') {
						// Demo mode - ใช้ระบบเดิม
						if (isCacheValid('rooms')) {
							roomData = getCachedData('rooms') || { ...sampleRoomData };
							console.log('📱 Loaded demo rooms from cache:', Object.keys(roomData).length, 'rooms');
						} else {
							const adminRooms = localStorage.getItem('roomsData');
							if (adminRooms) {
								roomData = JSON.parse(adminRooms);
								safeSetCachedData('rooms', roomData);
							} else {
								roomData = { ...sampleRoomData };
								safeSetCachedData('rooms', roomData);
							}
							console.log('🎮 Using sample demo data:', Object.keys(roomData).length, 'rooms');
						}
					} else if (currentVersion === 'live') {
						// Live mode - Progressive Loading
						await progressiveLoadLiveData();
					}
					
					// โหลด buildings data
					await loadBuildingsData();
					
					updateGlobalVersionIndicator(currentVersion);
					showDataSourceStatus();
					
				} catch (error) {
					console.error('❌ Error loading room data:', error);
					// Fallback to cached or sample data
					roomData = getCachedData('rooms') || { ...sampleRoomData };
					showNotification('⚠️ ใช้ข้อมูลสำรอง', 'warning');
				}
			}
			

			async function progressiveLoadLiveData() {
				// ตรวจสอบ cache ก่อน
				if (isCacheValid('rooms', 10 * 60 * 1000)) { // 10 นาที
					roomData = getCachedData('rooms') || {};
					console.log('💾 Using cached rooms:', Object.keys(roomData).length, 'rooms');
					showProgressiveStatus('🏃‍♂️ ใช้ข้อมูลจาก Cache', 'success');
					return;
				}
				
				// แสดงสถานะแทนการ Loading Overlay
				showProgressiveStatus('🌐 กำลังโหลดข้อมูลจาก Google Sheets...', 'info');
				
				try {
					// โหลดข้อมูลจาก Google Sheets
					const sheetsData = await loadRoomsFromSheets();
					
					if (sheetsData && Object.keys(sheetsData).length > 0) {
						roomData = sheetsData;
						
						// บันทึก cache แบบปลอดภัย
						const cacheSuccess = safeSetCachedData('rooms', roomData);
						
						console.log('✅ Loaded rooms from Google Sheets:', Object.keys(roomData).length, 'rooms');
						showProgressiveStatus(`✅ โหลดข้อมูลสำเร็จ ${Object.keys(roomData).length} ห้อง`, 'success');
						
						if (!cacheSuccess) {
							showProgressiveStatus('⚠️ ไม่สามารถบันทึก Cache ได้', 'warning');
						}
					} else {
						// Fallback to cache or sample
						roomData = getCachedData('rooms') || { ...sampleRoomData };
						console.log('📱 Using fallback data:', Object.keys(roomData).length, 'rooms');
						showProgressiveStatus('📱 ใช้ข้อมูลสำรอง', 'warning');
					}
					
				} catch (error) {
					console.error('❌ Failed to load from sheets:', error);
					roomData = getCachedData('rooms') || { ...sampleRoomData };
					showProgressiveStatus('❌ โหลดล้มเหลว ใช้ข้อมูลสำรอง', 'error');
				}
			}

			function showProgressiveStatus(message, type = 'info') {
				// แสดงสถานะแบบไม่บดบัง UI
				showNotification(message, type);
				
				// อัปเดต version indicator ด้วยสถานะ
				const indicator = document.getElementById('globalVersionIndicator');
				if (indicator && currentVersion === 'live') {
					if (type === 'info') {
						indicator.innerHTML = '⏳ LOADING...';
						indicator.className = 'status-indicator status-error';
					} else if (type === 'success') {
						indicator.innerHTML = '🔴 LIVE';
						indicator.className = 'status-indicator status-active';
					} else if (type === 'warning' || type === 'error') {
						indicator.innerHTML = '⚠️ ISSUES';
						indicator.className = 'status-indicator status-error';
					}
				}
			}
			
 
			// ฟังก์ชันโหลด Buildings Data
			 
			async function loadBuildingsData() {
				try {
					if (currentVersion === 'demo') {
						if (isCacheValid('buildings')) {
							buildingsData = getCachedData('buildings') || { ...sampleBuildingsData };
						} else {
							const savedBuildings = localStorage.getItem('buildingsData');
							if (savedBuildings) {
								buildingsData = JSON.parse(savedBuildings);
								setCachedData('buildings', buildingsData);
							} else {
								buildingsData = { ...sampleBuildingsData };
								setCachedData('buildings', buildingsData);
							}
						}
					} else if (currentVersion === 'live') {
						if (isCacheValid('buildings')) {
							buildingsData = getCachedData('buildings') || {};
							console.log('💾 Loaded buildings from cache:', Object.keys(buildingsData).length, 'buildings');
						} else {
							const sheetsBuildings = await loadBuildingsFromSheets();
							if (sheetsBuildings && Object.keys(sheetsBuildings).length > 0) {
								buildingsData = sheetsBuildings;
								setCachedData('buildings', buildingsData);
								console.log('✅ Loaded buildings from Google Sheets:', Object.keys(buildingsData).length, 'buildings');
							} else {
								buildingsData = getCachedData('buildings') || { ...sampleBuildingsData };
							}
						}
					}
				} catch (error) {
					console.error('❌ Error loading buildings data:', error);
					buildingsData = getCachedData('buildings') || { ...sampleBuildingsData };
				}
			}

			
			
			// ======= แก้ไข: ปรับปรุงการโหลดจาก Google Sheets =======
			async function loadRoomsFromSheets() {
				try {
					console.log('🔄 Loading rooms from Google Sheets...');
					
					// แก้ไข: เพิ่ม timeout และปรับการจัดการ error
					const controller = new AbortController();
					const timeoutId = setTimeout(() => {
						controller.abort();
						console.log('⏰ Request timeout - aborting rooms loading');
					}, 15000); // เพิ่มเป็น 15 วินาที
					
					const params = new URLSearchParams();
					params.append('action', 'getData');
					params.append('sheet', sheetsConfig.roomsSheet);
					
					const response = await fetch(sheetsConfig.url, {
						method: 'POST',
						headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
						body: params.toString(),
						signal: controller.signal
					});
					
					clearTimeout(timeoutId);
					
					if (!response.ok) {
						throw new Error(`HTTP ${response.status}: ${response.statusText}`);
					}
					
					const result = await response.json();
					console.log('📊 Rooms API response received');
					
					if (result.success && result.data && result.data.length > 0) {
						const rooms = {};
						
						// แก้ไข: ปรับ batch size ให้เล็กลงเพื่อป้องกัน blocking
						const batchSize = 5; // ลดจาก 10 เป็น 5
						let processedCount = 0;
						
						for (let i = 0; i < result.data.length; i += batchSize) {
							const batch = result.data.slice(i, i + batchSize);
							
							batch.forEach(row => {
								if (row.code && row.name) {
									rooms[row.code] = {
										code: row.code,
										name: row.name,
										building: row.building || '',
										location: row.location || row.floor || '',
										floor: parseInt(row.floor) || 1,
										type: row.type || 'classroom',
										description: row.description || '',
										hours: row.hours || '08:00 - 16:30',
										status: row.status || 'active',
										x: parseFloat(row.x) || 50,
										y: parseFloat(row.y) || 50,
										images: row.images ? (Array.isArray(row.images) ? row.images : [row.images]) : []
									};
									processedCount++;
								}
							});
							
							// แก้ไข: แสดงความคืบหน้า
							if (i % (batchSize * 4) === 0) { // ทุก 20 รายการ
								console.log(`📊 Processing rooms: ${processedCount}/${result.data.length}`);
								showProgressiveStatus(`📊 โหลดข้อมูลห้อง: ${processedCount}/${result.data.length}`, 'info');
							}
							
							// ให้ browser มีเวลาประมวลผล UI
							if (i + batchSize < result.data.length) {
								await new Promise(resolve => setTimeout(resolve, 20)); // เพิ่มเป็น 20ms
							}
						}
						
						console.log(`✅ Rooms processed successfully: ${Object.keys(rooms).length} rooms`);
						return rooms;
					}
					
					console.warn('⚠️ No room data received from sheets');
					return null;
					
				} catch (error) {
					if (error.name === 'AbortError') {
						console.error('⏰ Request timeout loading rooms from sheets');
						showProgressiveStatus('⏰ โหลดข้อมูลห้องใช้เวลานานเกินไป', 'warning');
					} else {
						console.error('❌ Failed to load rooms from sheets:', error);
						showProgressiveStatus(`❌ โหลดข้อมูลห้องล้มเหลว: ${error.message}`, 'error');
					}
					return null;
				}
			}
			
		 
			async function loadBuildingsFromSheets() {
				try {
					console.log('🔄 Loading buildings from Google Sheets...');
					
					const controller = new AbortController();
					const timeoutId = setTimeout(() => controller.abort(), 8000); // 8 วินาที timeout
					
					const params = new URLSearchParams();
					params.append('action', 'getData');
					params.append('sheet', sheetsConfig.buildingsSheet);
					
					const response = await fetch(sheetsConfig.url, {
						method: 'POST',
						headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
						body: params.toString(),
						signal: controller.signal
					});
					
					clearTimeout(timeoutId);
					
					if (!response.ok) {
						throw new Error(`HTTP ${response.status}: ${response.statusText}`);
					}
					
					const result = await response.json();
					console.log('📊 Buildings API response received');
					
					if (result.success && result.data && result.data.length > 0) {
						const buildings = {};
						result.data.forEach(row => {
							if (row.code && row.name) {
								buildings[row.code] = {
									code: row.code,
									name: row.name,
									floors: parseInt(row.floors) || 1,
									year: parseInt(row.year) || new Date().getFullYear(),
									description: row.description || '',
									status: row.status || 'active'
								};
							}
						});
						
						console.log('✅ Buildings loaded successfully:', Object.keys(buildings).length, 'buildings');
						return buildings;
					}
					
					console.warn('⚠️ No building data received from sheets');
					return null;
					
				} catch (error) {
					if (error.name === 'AbortError') {
						console.error('⏰ Request timeout loading buildings from sheets');
					} else {
						console.error('❌ Failed to load buildings from sheets:', error);
					}
					return null;
				}
			}	

		// ======= Intelligent Cache Management =======
		function intelligentCacheManagement() {
			const maxCacheAge = {
				rooms: 15 * 60 * 1000,     // 15 นาที
				buildings: 30 * 60 * 1000,  // 30 นาที
				system: 60 * 60 * 1000      // 1 ชั่วโมง
			};
			
			const now = Date.now();
			const keys = Object.keys(localStorage);
			
			keys.forEach(key => {
				if (key.includes('_timestamp_')) {
					const dataType = key.replace('_timestamp_', '').replace('_live', '').replace('_demo', '');
					const timestamp = localStorage.getItem(key);
					const maxAge = maxCacheAge[dataType] || 15 * 60 * 1000; // default 15 minutes
					
					if (timestamp && (now - parseInt(timestamp)) > maxAge) {
						const cacheKey = key.replace('_timestamp_', '_cache_');
						localStorage.removeItem(key);
						localStorage.removeItem(cacheKey);
						console.log(`🗑️ Expired cache removed: ${dataType}`);
					}
				}
			});
		}
		
		// ======= Connection Quality Detection =======
		let connectionQuality = 'unknown';
		let lastLatency = 0;

		async function detectConnectionQuality() {
			try {
				const start = performance.now();
				
				// ทดสอบความเร็วด้วย HEAD request เล็ก ๆ
				const response = await fetch(sheetsConfig.url, {
					method: 'HEAD',
					cache: 'no-cache'
				});
				
				const end = performance.now();
				lastLatency = end - start;
				
				if (lastLatency < 500) {
					connectionQuality = 'fast';
				} else if (lastLatency < 2000) {
					connectionQuality = 'medium';
				} else {
					connectionQuality = 'slow';
				}
				
				console.log(`📶 Connection quality: ${connectionQuality} (${Math.round(lastLatency)}ms)`);
				
				// ปรับ cache time ตามความเร็วเน็ต
				if (connectionQuality === 'slow') {
					// เน็ตช้า = cache นานขึ้น
					maxCacheAge.rooms = 30 * 60 * 1000;    // 30 นาที
					maxCacheAge.buildings = 60 * 60 * 1000; // 1 ชั่วโมง
				}
				
			} catch (error) {
				connectionQuality = 'offline';
				console.log('📶 Connection: offline or error');
			}
		}
		
		// ตรวจสอบ connection quality ทุก 2 นาที
		setInterval(detectConnectionQuality, 2 * 60 * 1000);


		// ======= ปรับปรุง Background Sync เดิมให้รวมแผนที่ =======
		async function backgroundSync() {
			if (currentVersion !== 'live' || connectionQuality === 'offline') {
				return;
			}
			
			console.log('🔄 Background sync started...');
			
			try {
				// Sync ข้อมูลห้อง
				if (!isCacheValid('rooms')) {
					const rooms = await loadRoomsFromSheets();
					if (rooms) {
						roomData = { ...roomData, ...rooms };
						safeSetCachedData('rooms', roomData);
						console.log('🔄 Background sync: rooms updated');
					}
				}
				
				// รอ 2 วินาทีก่อน sync ต่อ
				await new Promise(resolve => setTimeout(resolve, 2000));
				
				// Sync ข้อมูลอาคาร
				if (!isCacheValid('buildings')) {
					const buildings = await loadBuildingsFromSheets();
					if (buildings) {
						buildingsData = { ...buildingsData, ...buildings };
						safeSetCachedData('buildings', buildingsData);
						console.log('🔄 Background sync: buildings updated');
					}
				}
				
				// รอ 2 วินาทีก่อน sync ต่อ
				await new Promise(resolve => setTimeout(resolve, 2000));
				
				// ⭐ เพิ่มส่วนนี้ - Sync ภาพแผนที่
				await backgroundSyncMapImages();
				
			} catch (error) {
				console.log('🔄 Background sync encountered issues:', error.message);
			}
		}
		// ======= เพิ่มคำสั่ง Debug สำหรับ Console =======
		window.refreshMapImages = refreshMapImages;
		window.debugMapImages = debugMapImages;
		window.retryLoadMapImages = retryLoadMapImages;
		


		// ======= เพิ่มการตรวจสอบสถานะแผนที่ =======
		function getMapStatus() {
			return {
				version: currentVersion,
				layout: currentMapLayout,
				hasFloorplan: !!mapData.floorplan,
				hasRealPhoto: !!mapData.realphoto,
				loaded: mapData.loaded,
				cacheValid: isCacheValid('mapImages'),
				sheetsConnected: sheetsConfig.connected
			};
		}

		window.getMapStatus = getMapStatus;

		// ======= แสดงข้อมูล Map Status ใน Console =======
		console.log('🗺️ Map Images System Ready');
		console.log('📋 Available commands:');
		console.log('  - debugMapImages() - แสดงข้อมูล debug');
		console.log('  - refreshMapImages() - รีเฟรชแผนที่');
		console.log('  - getMapStatus() - ตรวจสอบสถานะ');
		console.log('  - retryLoadMapImages() - ลองโหลดใหม่');
		
		 

		// ความสะอาดและประสิทธิภาพ
		setInterval(intelligentCacheManagement, 5 * 60 * 1000); // ทุก 5 นาที


		function showDataSourceStatus() {
			const roomCount = Object.keys(roomData).length;
			const buildingCount = Object.keys(buildingsData).length;
			
			let statusMessage = '';
			if (currentVersion === 'demo') {
				statusMessage = `🎮 Demo Mode: ${roomCount} ห้อง, ${buildingCount} อาคาร`;
			} else {
				const cacheStatus = isCacheValid('rooms') ? '(จาก Cache)' : '(ข้อมูลใหม่)';
				statusMessage = `🔴 Live Mode: ${roomCount} ห้อง, ${buildingCount} อาคาร ${cacheStatus}`;
			}
			
			setTimeout(() => {
				showNotification(statusMessage, 'info');
			}, 1000);
		}

        // =================== FIX 5: Building Filter System ===================
        /* / ======= ลบ Building Filter Functions =======
		async function extractBuildingsList() {
				// โหลด buildings data ถ้าเป็น live mode
				if (adminDataVersion === 'live') {
					const sheetsBuildings = await loadBuildingsFromSheets();
					if (sheetsBuildings) {
						console.log('✅ Loaded buildings from Google Sheets:', Object.keys(sheetsBuildings).length, 'buildings');
					}
				}
				
				const buildings = new Set();
				Object.values(roomData).forEach(room => {
					if (room.building) {
						buildings.add(room.building);
					}
				});
				buildingsList = Array.from(buildings).sort();
				updateBuildingFilter();
			}

         function updateBuildingFilter() {
			const container = document.getElementById('buildingButtons');
			if (!container) return;
			
			const allText = currentLanguage === 'th' ? 'ทั้งหมด' : 'All';
			
			container.innerHTML = `
				<button class="building-btn ${currentBuildingFilter === 'all' ? 'active' : ''}" 
						onclick="filterByBuilding('all')">
					${allText}
				</button>
				${buildingsList.map(building => {
					// ใช้ buildingsData แทน localStorage
					const buildingName = buildingsData[building]?.name || building;
					
					return `
						<button class="building-btn ${currentBuildingFilter === building ? 'active' : ''}" 
								onclick="filterByBuilding('${building}')">
							${buildingName}
						</button>
					`;
				}).join('')}
			`;
			
			console.log('🏢 Building filter updated:', buildingsList.length, 'buildings');
		}

        function filterByBuilding(building) {
            currentBuildingFilter = building;
            updateBuildingFilter();
            updateRoomMarkers();
            
            const message = building === 'all' 
                ? (currentLanguage === 'th' ? '🏢 แสดงห้องทั้งหมด' : '🏢 Showing all rooms')
                : (currentLanguage === 'th' ? `🏢 กรองอาคาร: ${building}` : `🏢 Filtered: ${building}`);
            
            showNotification(message, 'info');
        }
		*/

        // =================== Utility Functions ===================
        
        function getRoomIcon(roomName) {
            const lowerName = roomName.toLowerCase();
            if (lowerName.includes('computer') || lowerName.includes('คอมพิวเตอร์')) return '💻';
            if (lowerName.includes('library') || lowerName.includes('สมุด')) return '📚';
            if (lowerName.includes('cafeteria') || lowerName.includes('อาหาร')) return '🍽️';
            if (lowerName.includes('music') || lowerName.includes('ดนตรี')) return '🎵';
            if (lowerName.includes('art') || lowerName.includes('ศิลปะ')) return '🎨';
            if (lowerName.includes('gym') || lowerName.includes('ยิม')) return '🏃';
            if (lowerName.includes('lab') || lowerName.includes('ปฏิบัติการ') || lowerName.includes('เคมี') || lowerName.includes('ฟิสิกส์')) return '🧪';
            if (lowerName.includes('office') || lowerName.includes('สำนักงาน') || lowerName.includes('ผู้อำนวยการ')) return '🏢';
            return '🎓';
        }

        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            if (!notification) return;
            
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        function openAdminInterface() {
            // Update this URL after deployment
            window.open('./admin.html', '_blank');
        }
		function openSystemPresentation() {
            // Update this URL after deployment
            window.open('./SystemPresentation.html', '_blank');
        }


		// ======= ฟังก์ชัน Refresh แผนที่ =======
		async function refreshMapImages() {
			const refreshBtn = document.getElementById('refreshMapBtn');
			if (refreshBtn) {
				refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> <span>กำลังโหลด...</span>';
				refreshBtn.disabled = true;
			}
			
			showNotification('🔄 กำลังรีเฟรชแผนที่...', 'info');
			
			try {
				// ล้าง cache เก่า
				localStorage.removeItem(getDataCacheKey('mapImages'));
				localStorage.removeItem(getDataTimestampKey('mapImages'));
				
				// โหลดใหม่
				await loadMapDataFromSheets();
				
				showNotification('✅ รีเฟรชแผนที่สำเร็จ', 'success');
				
			} catch (error) {
				console.error('❌ Error refreshing map images:', error);
				showNotification('❌ ไม่สามารถรีเฟรชแผนที่ได้', 'error');
			} finally {
				if (refreshBtn) {
					refreshBtn.innerHTML = '<i class="fas fa-sync-alt"></i> <span>รีเฟรชแผนที่</span>';
					refreshBtn.disabled = false;
				}
			}
		}
		// ===== 2. เพิ่มฟังก์ชันจัดการ Persistent Destination =====
		// เพิ่มหลังฟังก์ชัน updateRouteControls()

		function saveDestination(roomCode) {
			if (roomCode && roomData[roomCode]) {
				persistentDestination = {
					roomCode: roomCode,
					roomName: roomData[roomCode].name,
					timestamp: Date.now()
				};
				localStorage.setItem('persistentDestination', JSON.stringify(persistentDestination));
				console.log('💾 Saved destination:', persistentDestination);
			}
		}

		function loadDestination() {
			try {
				const saved = localStorage.getItem('persistentDestination');
				if (saved) {
					const data = JSON.parse(saved);
					// ตรวจสอบว่าข้อมูลไม่เก่าเกิน 1 ชั่วโมง
					if (data.timestamp && (Date.now() - data.timestamp) < 3600000) {
						if (roomData[data.roomCode]) {
							persistentDestination = data;
							selectedRoom = data.roomCode;
							console.log('🎯 Restored destination:', data.roomName);
							return true;
						}
					}
				}
			} catch (error) {
				console.error('Error loading destination:', error);
			}
			return false;
		}

		function clearDestination() {
			persistentDestination = { roomCode: null, roomName: null, timestamp: null };
			localStorage.removeItem('persistentDestination');
			selectedRoom = null;
			console.log('🗑️ Cleared destination');
		}

		function showDestinationStatus() {
			if (persistentDestination.roomCode && roomData[persistentDestination.roomCode]) {
				const statusMessage = currentLanguage === 'th' 
					? `🎯 จุดหมาย: ${persistentDestination.roomName}`
					: `🎯 Destination: ${persistentDestination.roomName}`;
				
				showNotification(statusMessage, 'info');
				
				// อัปเดตปุ่มแสดงเส้นทาง
				const showRouteBtn = document.getElementById('showRouteBtn');
				if (showRouteBtn) {
					showRouteBtn.disabled = false;
					showRouteBtn.style.background = 'var(--accent-color)';
				}
			}
		}

		// ===== 3. แก้ไขฟังก์ชัน selectRoom() =====
		// แทนที่ฟังก์ชัน selectRoom() เดิม

		function selectRoom(roomCode) {
			if (!roomData[roomCode]) return;
			
			const room = roomData[roomCode];
			selectedRoom = roomCode;
			
			// 🆕 บันทึกจุดหมายปลายทาง
			saveDestination(roomCode);
			
			showRoomDetails(roomCode);
			highlightRoom(roomCode);
			
			// Switch to map page
			showPage('map');
			
			// อัปเดตปุ่มควบคุม
			updateRouteControls(true);
			
			// แสดงข้อความยืนยัน
			const confirmMessage = currentLanguage === 'th' 
				? `✅ เลือกห้อง ${room.name} แล้ว - คลิกที่แผนที่เพื่อกำหนดจุดเริ่มต้น`
				: `✅ Selected ${room.name} - Click on map to set starting point`;
			
			setTimeout(() => {
				showNotification(confirmMessage, 'success');
			}, 500);
		}

		// ===== 5. แก้ไขฟังก์ชัน handleMapClick() =====
		// ค้นหาฟังก์ชัน handleMapClick() และแก้ไขเป็น:
		function handleMapClick(event) {
			const mapContainer = document.getElementById('mapContainer');
			const rect = mapContainer.getBoundingClientRect();
			
			const x = ((event.clientX - rect.left) / rect.width) * 100;
			const y = ((event.clientY - rect.top) / rect.height) * 100;
			
			console.log('📍 Setting new start point:', {x, y});
			
			// เก็บค่าเดิมเพื่อเปรียบเทียบ
			const oldStartPoint = startPoint ? { ...startPoint } : null;
			const hasDestination = persistentDestination.roomCode && roomData[persistentDestination.roomCode];
			
			// กำหนดจุดเริ่มต้นใหม่
			startPoint = { x: x, y: y };
			localStorage.setItem('startPoint', JSON.stringify(startPoint));
			
			// อัปเดต start point marker
			updateStartPointMarker();
			
			// ล้างเส้นทางเดิมทั้งหมด
			document.querySelectorAll('.route-line, .route-marker').forEach(el => el.remove());
			const routePath = document.getElementById('routePath');
			if (routePath) {
				routePath.innerHTML = '';
			}
			
			// แสดงข้อความการกำหนดจุดเริ่มต้น
			const startMessage = currentLanguage === 'th' 
				? '📍 กำหนดจุดเริ่มต้นแล้ว' 
				: '📍 Starting point set';
			showNotification(startMessage, 'success');
			
			// ถ้ามีจุดหมายปลายทาง ให้สร้างเส้นทางใหม่ทันที
			if (hasDestination) {
				console.log('🎯 Destination exists, creating route immediately...');
				
				// รักษาจุดหมายปลายทาง
				selectedRoom = persistentDestination.roomCode;
				
				// สร้างเส้นทางใหม่ทันที (ไม่ใช้ setTimeout)
				showRouteToSelected();
				
				// อัปเดต UI controls
				updateRouteControls(true);
				updateDestinationDisplay();
				
				// แสดงข้อความเส้นทางใหม่
				setTimeout(() => {
					const routeMessage = currentLanguage === 'th' 
						? `🛣️ เส้นทางใหม่ไปยัง ${persistentDestination.roomName}`
						: `🛣️ New route to ${persistentDestination.roomName}`;
					showNotification(routeMessage, 'info');
				}, 800);
				
			} else {
				console.log('📍 No destination set');
				// ไม่มีจุดหมาย ให้อัปเดต controls
				updateRouteControls(false);
				
				// แสดงข้อความให้เลือกห้อง
				setTimeout(() => {
					const selectMessage = currentLanguage === 'th' 
						? '🏫 กรุณาค้นหาและเลือกห้องปลายทาง'
						: '🏫 Please search and select a destination room';
					showNotification(selectMessage, 'info');
				}, 1000);
			}
		}
		
		// ===== เพิ่มฟังก์ชันตรวจสอบและแก้ไขปัญหา state =====
		function validateRouteState() {
			console.log('🔍 Validating route state...');
			
			// ตรวจสอบ persistent destination
			if (persistentDestination.roomCode && !roomData[persistentDestination.roomCode]) {
				console.warn('⚠️ Persistent destination refers to non-existent room');
				clearDestination();
				return false;
			}
			
			// ตรวจสอบ selectedRoom
			if (selectedRoom && !roomData[selectedRoom]) {
				console.warn('⚠️ Selected room does not exist');
				selectedRoom = null;
				return false;
			}
			
			// ซิงค์ระหว่าง selectedRoom และ persistentDestination
			if (persistentDestination.roomCode && selectedRoom !== persistentDestination.roomCode) {
				console.log('🔧 Syncing selected room with persistent destination');
				selectedRoom = persistentDestination.roomCode;
			}
			
			return true;
		}

		// ===== เพิ่มฟังก์ชัน Debug สำหรับตรวจสอบปัญหา =====
		// เรียกใช้ debug function นี้ใน console เมื่อมีปัญหา: debugRouteProblem()
		function debugRouteProblem() {
			console.group('🐛 Route State Debug');
			console.log('startPoint:', startPoint);
			console.log('selectedRoom:', selectedRoom);
			console.log('persistentDestination:', persistentDestination);
			console.log('Room data exists:', selectedRoom ? !!roomData[selectedRoom] : 'No room selected');
			console.log('Route displayed:', document.querySelector('.route-line') ? 'Yes' : 'No');
			console.log('LocalStorage persistent:', localStorage.getItem('persistentDestination'));
			console.log('LocalStorage startPoint:', localStorage.getItem('startPoint'));
			console.groupEnd();
		}



        // =================== Page Management ===================
		// ======= ปรับปรุงฟังก์ชัน showPage สำหรับแผนที่ =======
		function showPage(pageId) {
			document.querySelectorAll('.page').forEach(page => {
				page.classList.remove('active');
			});
			
			document.querySelectorAll('.nav-item').forEach(item => {
				item.classList.remove('active');
			});
			
			const targetPage = document.getElementById(pageId + '-page');
			if (targetPage) {
				targetPage.classList.add('active');
			}
			
			if (pageId === 'search') {
				document.querySelector('.nav-item:nth-child(1)').classList.add('active');
			} else if (pageId === 'map') {
				document.querySelector('.nav-item:nth-child(2)').classList.add('active');
				
				// โหลดและตรวจสอบ destination state
				setTimeout(() => {
					console.log('📍 Loading map page...');
					
					// โหลด destination ที่บันทึกไว้
					const destinationLoaded = loadDestination();
					
					// ตรวจสอบ state consistency
					validateRouteState();
					ensureRouteConsistency();
					
					// อัปเดตการแสดงผล
					if (destinationLoaded || persistentDestination.roomCode) {
						showDestinationStatus();
						updateDestinationDisplay();
						updateRouteControls(true);
					}
					
					// อัปเดต markers
					updateRoomMarkers();
					
					// โหลดแผนที่
					if (!mapData.loaded && currentVersion === 'live') {
						initializeMapImages();
					} else if (!mapData.loaded) {
						showFallbackMap();
					} else {
						updateMapDisplay();
					}
					
				}, 150);
				
			} else if (pageId === 'about') {
				document.querySelector('.nav-item:nth-child(3)').classList.add('active');
			}
		}
		function showPage_org(pageId) {
			document.querySelectorAll('.page').forEach(page => {
				page.classList.remove('active');
			});
			
			document.querySelectorAll('.nav-item').forEach(item => {
				item.classList.remove('active');
			});
			
			const targetPage = document.getElementById(pageId + '-page');
			if (targetPage) {
				targetPage.classList.add('active');
			}
			
			if (pageId === 'search') {
				document.querySelector('.nav-item:nth-child(1)').classList.add('active');
			} else if (pageId === 'map') {
				document.querySelector('.nav-item:nth-child(2)').classList.add('active');
				
				// 🆕 โหลดจุดหมายปลายทางที่บันทึกไว้
				if (loadDestination()) {
					showDestinationStatus();
					updateRouteControls(true);
				}
				
				// 🆕 ตรวจสอบความสอดคล้องของ route
				setTimeout(() => {
					ensureRouteConsistency();
				}, 200);
				
				// ⭐ เพิ่มส่วนนี้ - โหลดแผนที่เมื่อเปิดหน้าแผนที่
				setTimeout(() => {
					updateRoomMarkers();
					
					// ตรวจสอบว่าต้องโหลดแผนที่หรือไม่
					if (!mapData.loaded && currentVersion === 'live') {
						initializeMapImages();
					} else if (!mapData.loaded) {
						showFallbackMap();
					} else {
						updateMapDisplay();
					}
				}, 100);
				
			} else if (pageId === 'about') {
				document.querySelector('.nav-item:nth-child(3)').classList.add('active');
			}
		}
		
		// ===== 7. เพิ่ม Error Handling สำหรับรูปภาพ =====
		// เพิ่มฟังก์ชันใหม่:

		function handleImageLoadError(imgElement, roomName = '') {
			console.warn('⚠️ Image load failed:', imgElement.src);
			
			imgElement.style.display = 'none';
			
			// สร้าง placeholder
			const placeholder = document.createElement('div');
			placeholder.style.cssText = `
				text-align: center; 
				padding: 40px; 
				background: #f8f9fa; 
				border-radius: 8px; 
				color: var(--text-secondary);
				border: 2px dashed #dee2e6;
			`;
			placeholder.innerHTML = `
				<i class="fas fa-image" style="font-size: 32px; opacity: 0.3; margin-bottom: 10px;"></i>
				<p>ไม่สามารถโหลดรูปภาพได้</p>
				${roomName ? `<small>ห้อง: ${roomName}</small>` : ''}
			`;
			
			imgElement.parentNode.insertBefore(placeholder, imgElement.nextSibling);
		}	
		
		window.debugRouteState = function() {
			console.log('🐛 Route Debug State:');
			console.log('selectedRoom:', selectedRoom);
			console.log('persistentDestination:', persistentDestination);
			console.log('startPoint:', startPoint);
			console.log('Room exists:', selectedRoom ? !!roomData[selectedRoom] : 'N/A');
			console.log('Route lines on page:', document.querySelectorAll('.route-line').length);
			console.log('Route markers on page:', document.querySelectorAll('.route-marker').length);
		};
		
		// ======= เพิ่มการจัดการ Error สำหรับภาพแผนที่ =======
		function handleMapImageError(event) {
			console.error('❌ Map image failed to load:', event.target.src);
			
			// ลองสลับไปภาพอื่นก่อน
			if (currentMapLayout === 'photo' && mapData.floorplan) {
				console.log('🔄 Photo failed, trying floorplan...');
				currentMapLayout = 'floorplan';
				updateMapDisplay();
				showNotification('⚠️ ภาพจริงโหลดไม่ได้ เปลี่ยนเป็นแผนผัง', 'warning');
				return;
			} else if (currentMapLayout === 'floorplan' && mapData.realphoto) {
				console.log('🔄 Floorplan failed, trying photo...');
				currentMapLayout = 'photo';
				updateMapDisplay();
				showNotification('⚠️ แผนผังโหลดไม่ได้ เปลี่ยนเป็นภาพจริง', 'warning');
				return;
			}
			
			// ถ้าไม่มีภาพอื่นให้ลอง แสดง fallback
			showFallbackMap();
			showNotification('⚠️ ไม่สามารถโหลดภาพแผนที่ได้', 'warning');
		}
		
		// ======= เพิ่ม Auto-retry สำหรับการโหลดแผนที่ =======
		async function retryLoadMapImages(maxRetries = 3) {
			for (let i = 0; i < maxRetries; i++) {
				try {
					console.log(`🔄 Retry loading map images: attempt ${i + 1}/${maxRetries}`);
					await loadMapDataFromSheets();
					
					if (mapData.floorplan || mapData.realphoto) {
						console.log('✅ Map images loaded successfully on retry');
						return true;
					}
				} catch (error) {
					console.warn(`⚠️ Retry ${i + 1} failed:`, error.message);
					
					if (i < maxRetries - 1) {
						// รอ 2 วินาทีก่อนลองใหม่
						await new Promise(resolve => setTimeout(resolve, 2000));
					}
				}
			}
			
			console.error('❌ All retry attempts failed');
			return false;
		}
		
		// ======= Background Sync สำหรับแผนที่ =======
		async function backgroundSyncMapImages() {
			if (currentVersion !== 'live') return;
			
			// ตรวจสอบว่า cache หมดอายุหรือไม่
			if (!isCacheValid('mapImages', 60 * 60 * 1000)) { // 1 ชั่วโมง
				console.log('🔄 Background sync: Map images cache expired, refreshing...');
				
				try {
					await loadMapDataFromSheets();
					console.log('✅ Background sync: Map images updated');
				} catch (error) {
					console.log('⚠️ Background sync: Map images failed -', error.message);
				}
			}
		}

		// ======= Cache Management Functions =======
		function clearDataCache() {
			// ลบ cache ทั้งหมดเมื่อต้องการให้โหลดข้อมูลใหม่
			const keys = Object.keys(localStorage);
			keys.forEach(key => {
				if (key.includes('_cache_') || key.includes('_timestamp_')) {
					localStorage.removeItem(key);
				}
			});
			console.log('🗑️ Data cache cleared');
		}

		function getCacheInfo() {
			// ฟังก์ชันสำหรับ debug - ดูข้อมูลใน cache
			const cacheInfo = {
				rooms: {
					cached: !!getCachedData('rooms'),
					timestamp: localStorage.getItem(getDataTimestampKey('rooms')),
					valid: isCacheValid('rooms')
				},
				buildings: {
					cached: !!getCachedData('buildings'),
					timestamp: localStorage.getItem(getDataTimestampKey('buildings')),
					valid: isCacheValid('buildings')
				}
			};
			console.log('📊 Cache Info:', cacheInfo);
			return cacheInfo;
		}

        // =================== Search Functions ===================
        
        function handleSearchKeyPress(event) {
            if (event.key === 'Enter') {
                searchRoom();
            }
        }

        function liveSearch() {
            const searchInput = document.getElementById('searchInput');
            if (!searchInput) return;
            
            const searchTerm = searchInput.value.toLowerCase().trim();
            const resultsContainer = document.getElementById('liveResults');
            
            if (!resultsContainer) return;
            
            if (!searchTerm) {
                resultsContainer.innerHTML = '';
                return;
            }
            
            const results = searchRooms(searchTerm);
            displaySearchResults(results);
        }

        function searchRoom() {
            const searchInput = document.getElementById('searchInput');
            if (!searchInput) return;
            
            const searchTerm = searchInput.value.toLowerCase().trim();
            
            if (!searchTerm) {
                showNotification('❌ กรุณาใส่คำค้นหา', 'error');
                return;
            }
            
            const results = searchRooms(searchTerm);
            displaySearchResults(results);
        }

        function searchRooms(searchTerm) {
            const rooms = Object.values(roomData);
            return rooms.filter(room => {
                if (room.status !== 'active') return false;
                
                const searchFields = [
                    room.name.toLowerCase(),
                    room.code.toLowerCase(),
                    room.location.toLowerCase(),
                    room.building.toLowerCase(),
                    room.description.toLowerCase()
                ];
                return searchFields.some(field => field.includes(searchTerm));
            });
        }

        // ======= Updated Search Results Display =======
		function displaySearchResults(results) {
			const resultsContainer = document.getElementById('liveResults');
			if (!resultsContainer) return;
			
			if (results.length > 0) {
				resultsContainer.innerHTML = results.map(room => {
					// ใช้ buildingsData แทน localStorage
					const buildingName = buildingsData[room.building]?.name || room.building;
					
					return `
						<div class="search-result-item" onclick="viewOnMap('${room.code}')">
							<div class="search-result-header">
								<div class="search-result-title">
									${getRoomIcon(room.name)} ${room.name}
								</div>
								<div class="search-result-code">${room.code}</div>
							</div>
							<div class="search-result-info">
								${buildingName} - ${room.location || room.floor || 'ชั้น ' + (room.floor || 'N/A')}
							</div>
						</div>
					`;
				}).join('');
				
				// แสดงคำแนะนำ
				const hintMessage = currentLanguage === 'th' 
					? '💡 คลิกที่ผลการค้นหาเพื่อดูตำแหน่งบนแผนที่'
					: '💡 Click search result to view location on map';
				
				resultsContainer.innerHTML += `
					<div style="text-align: center; padding: 15px; background: rgba(102, 126, 234, 0.1); border-radius: var(--border-radius); margin-top: 10px; color: var(--primary-color); font-size: 12px;">
						${hintMessage}
					</div>
				`;
			} else {
				const noResultsText = currentLanguage === 'th' ? 'ไม่พบผลการค้นหา' : 'No results found';
				resultsContainer.innerHTML = `
					<div style="text-align: center; padding: 40px; color: var(--text-secondary);">
						<div style="font-size: 48px; margin-bottom: 15px; opacity: 0.7;">🔍</div>
						<p>${noResultsText}</p>
					</div>
				`;
			}
		}

        function quickSearch(category) {
            let searchResults = [];
            
            switch(category) {
                case 'classroom':
                    searchResults = Object.values(roomData).filter(room => 
                        room.status === 'active' && (
                        room.name.includes('ห้องเรียน') || room.name.includes('Classroom') || room.name.includes('ม.'))
                    );
                    break;
                case 'special':
                    searchResults = Object.values(roomData).filter(room => 
                        room.status === 'active' && (
                        room.name.includes('คอมพิวเตอร์') || room.name.includes('Computer') ||
                        room.name.includes('ปฏิบัติการ') || room.name.includes('Lab'))
                    );
                    break;
                case 'facilities':
                    searchResults = Object.values(roomData).filter(room => 
                        room.status === 'active' && (
                        room.name.includes('สมุด') || room.name.includes('Library') ||
                        room.name.includes('อาหาร') || room.name.includes('Cafeteria'))
                    );
                    break;
                case 'office':
                    searchResults = Object.values(roomData).filter(room => 
                        room.status === 'active' && (
                        room.name.includes('สำนักงาน') || room.name.includes('Office'))
                    );
                    break;
            }
            
            displaySearchResults(searchResults);
        }

        // =================== Map Functions ===================
		// ======= Updated Search Functions =======
		function viewOnMap(roomCode) {
			showPage('map');
			setTimeout(() => {
				// เซ็ตห้องที่เลือกและแสดง marker
				selectedRoom = roomCode;
				updateRoomMarkers();
				
				// แสดงข้อมูลห้อง
				showRoomInfoOverlay(roomCode);
				
				// แจ้งเตือนให้ตั้งจุดเริ่มต้น
				if (!startPoint) {
					const message = currentLanguage === 'th' 
						? '💡 คลิกที่แผนที่เพื่อตั้งจุดเริ่มต้น จากนั้นคลิก "แสดงเส้นทาง" เพื่อดูการนำทาง'
						: '💡 Click on map to set starting point, then click "Show Route" for navigation';
					
					setTimeout(() => {
						showNotification(message, 'info');
					}, 1000);
				}
			}, 300);
		}


        function highlightRoom(roomCode) {
            document.querySelectorAll('.room-marker').forEach(marker => {
                marker.classList.remove('highlighted');
            });
            
            const targetMarker = document.querySelector(`[data-room="${roomCode}"]`);
            if (targetMarker) {
                targetMarker.classList.add('highlighted');
                selectedRoom = roomCode;
                
                setTimeout(() => {
                    targetMarker.classList.remove('highlighted');
                }, 3000);
            }
        }

        // 1.1: Toggle map controls visibility
        function toggleMapControls() {
			const mapControls = document.getElementById('mapControls');
			const toggleBtn = document.getElementById('toggleControlsBtn');
			const showControlsBtn = document.getElementById('showControlsBtn');
			
			if (!mapControls || !toggleBtn) return;
			
			const isHidden = mapControls.classList.contains('hidden');
			
			if (isHidden) {
				// Show controls
				mapControls.classList.remove('hidden');
				toggleBtn.innerHTML = `<i class="fas fa-eye-slash"></i> <span data-translate="hide_controls">${currentLanguage === 'th' ? 'ซ่อนปุ่ม' : 'Hide Controls'}</span>`;
				if (showControlsBtn) {
					showControlsBtn.style.display = 'none';
				}
				showNotification(
					currentLanguage === 'th' ? '👁️ แสดงปุ่มควบคุม' : '👁️ Controls shown',
					'info'
				);
			} else {
				// Hide controls
				mapControls.classList.add('hidden');
				toggleBtn.innerHTML = `<i class="fas fa-eye"></i> <span data-translate="show_controls">${currentLanguage === 'th' ? 'แสดงปุ่ม' : 'Show Controls'}</span>`;
				if (showControlsBtn) {
					showControlsBtn.style.display = 'block';
				}
				showNotification(
					currentLanguage === 'th' ? '🙈 ซ่อนปุ่มควบคุม' : '🙈 Controls hidden',
					'info'
				);
			}
		}
		
		function showAllControls() {
			const mapControls = document.getElementById('mapControls');
			const toggleBtn = document.getElementById('toggleControlsBtn');
			const showControlsBtn = document.getElementById('showControlsBtn');
			
			if (!mapControls || !toggleBtn) return;
			
			mapControls.classList.remove('hidden');
			toggleBtn.innerHTML = `<i class="fas fa-eye-slash"></i> <span data-translate="hide_controls">${currentLanguage === 'th' ? 'ซ่อนปุ่ม' : 'Hide Controls'}</span>`;
			if (showControlsBtn) {
				showControlsBtn.style.display = 'none';
			}
			showNotification(
				currentLanguage === 'th' ? '👁️ แสดงปุ่มควบคุมทั้งหมด' : '👁️ All controls shown',
				'info'
			);
		}



        // 1.1: Set map layout (floorplan/photo)
        function setMapLayout(layout) {
            currentMapLayout = layout;
            
            document.querySelectorAll('.map-control-btn[data-layout]').forEach(btn => {
                btn.classList.remove('active');
            });
            
            const targetBtn = document.querySelector(`[data-layout="${layout}"]`);
            if (targetBtn) {
                targetBtn.classList.add('active');
            }
            
            // In real implementation, would switch between different map images
            const mapImage = document.getElementById('mapImage');
            if (mapImage) {
                if (layout === 'photo') {
                    // Replace with actual photo map
                    showNotification(
                        currentLanguage === 'th' ? '📸 เปลี่ยนเป็นภาพจริง' : '📸 Switched to photo view',
                        'success'
                    );
                } else {
                    // Use floorplan
                    showNotification(
                        currentLanguage === 'th' ? '📐 เปลี่ยนเป็นแผnผัง' : '📐 Switched to floor plan',
                        'success'
                    );
                }
            }
        }

        // 1.1: Toggle fullscreen mode
		// หาฟังก์ชันนี้และแทนที่ทั้งหมด
		 function toggleFullscreen() {
			const mapArea = document.getElementById('mapArea');
			const fullscreenBtn = document.getElementById('fullscreenBtn');
			const mapControls = document.getElementById('mapControls');
			const showControlsBtn = document.getElementById('showControlsBtn');
			
			if (!mapArea || !fullscreenBtn) return;
			
			if (isFullscreen) {
				// Exit fullscreen
				mapArea.classList.remove('fullscreen');
				if (mapControls) {
					mapControls.classList.remove('fullscreen-controls');
				}
				if (showControlsBtn) {
					showControlsBtn.style.display = 'none';
				}
				fullscreenBtn.innerHTML = `<i class="fas fa-expand"></i> <span data-translate="fullscreen">${currentLanguage === 'th' ? 'เต็มจอ' : 'Fullscreen'}</span>`;
				isFullscreen = false;
				showNotification(
					currentLanguage === 'th' ? '📱 ออกจากโหมดเต็มจอ' : '📱 Exited fullscreen mode',
					'info'
				);
			} else {
				// Enter fullscreen
				mapArea.classList.add('fullscreen');
				if (mapControls) {
					mapControls.classList.add('fullscreen-controls');
					mapControls.classList.remove('hidden');
				}
				if (showControlsBtn) {
					showControlsBtn.style.display = 'none';
				}
				fullscreenBtn.innerHTML = `<i class="fas fa-compress"></i> <span data-translate="exit_fullscreen">${currentLanguage === 'th' ? 'ออกจากเต็มจอ' : 'Exit Fullscreen'}</span>`;
				isFullscreen = true;
				showNotification(
					currentLanguage === 'th' ? '🖥️ เข้าโหมดเต็มจอ' : '🖥️ Entered fullscreen mode',
					'info'
				);
			}
		}
        // =================== FIX 2: Route Persistence Functions ===================
        
      // ===== 4. ปรับปรุงฟังก์ชัน showRouteToSelected() ให้ทำงานได้เร็วขึ้น =====
		function showRouteToSelected() {
			console.log('🛣️ Showing route to selected room...');
			
			// ตรวจสอบจุดหมายจาก persistent storage ก่อน
			if (!selectedRoom && persistentDestination.roomCode) {
				selectedRoom = persistentDestination.roomCode;
				console.log('🎯 Using persistent destination:', persistentDestination.roomName);
			}
			
			if (!selectedRoom || !roomData[selectedRoom]) {
				const selectMessage = currentLanguage === 'th' 
					? '❌ กรุณาเลือกห้องปลายทางก่อน'
					: '❌ Please select a destination room first';
				showNotification(selectMessage, 'error');
				return;
			}
			
			if (!startPoint || startPoint.x === null || startPoint.y === null) {
				const startMessage = currentLanguage === 'th' 
					? '❌ กรุณาคลิกที่แผนที่เพื่อกำหนดจุดเริ่มต้น'
					: '❌ Please click on map to set starting point';
				showNotification(startMessage, 'error');
				return;
			}
			
			// ล้างเส้นทางเดิมอย่างสมบูรณ์
			document.querySelectorAll('.route-line, .route-marker').forEach(el => el.remove());
			const routePath = document.getElementById('routePath');
			if (routePath) {
				routePath.innerHTML = '';
			}
			
			// อัปเดต persistent destination เพื่อให้แน่ใจ
			if (selectedRoom !== persistentDestination.roomCode) {
				saveDestination(selectedRoom);
			}
			
			const room = roomData[selectedRoom];
			currentRoute = { start: startPoint, destination: room };
			
			console.log('📍 Creating route from:', startPoint, 'to:', room);
			
			// แสดงเส้นทางใหม่
			showStraightRoutePath(startPoint, room);
			routeDisplayed = true;
			
			// อัปเดต controls และ markers
			updateRouteControls(true);
			updateRoomMarkers();
			
			// แสดงข้อความยืนยัน
			const message = currentLanguage === 'th' 
				? `🧭 แสดงเส้นทางไปยัง ${room.name}` 
				: `🧭 Route to ${room.name}`;
			showNotification(message, 'success');
			
			// แสดงปุ่มนำทางด้วยเสียง
			const voiceBtn = document.getElementById('voiceNavigationBtn');
			if (voiceBtn) {
				voiceBtn.style.display = 'block';
			}
			
			console.log('✅ Route created successfully');
		}

        // 1.1: Fix route display - create straight path and ensure it shows
        function showStraightRoutePath(start, destination) {
            const routePath = document.getElementById('routePath');
            if (!routePath) {
                console.error('Route path element not found');
                return;
            }
            
            // Clear any existing path
            routePath.innerHTML = '';
            
            // 1.1: Create straight line path connecting center points
            const startX = parseFloat(start.x);
            const startY = parseFloat(start.y);
            const endX = parseFloat(destination.x);
            const endY = parseFloat(destination.y);
            
            const path = `M ${startX} ${startY} L ${endX} ${endY}`;
            
            console.log('Creating route path:', path, 'from', {startX, startY}, 'to', {endX, endY});
            
            // Create glow effect (background line)
            const glowLine = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            glowLine.setAttribute('d', path);
            glowLine.setAttribute('stroke', 'rgba(220, 53, 69, 0.3)');
            glowLine.setAttribute('stroke-width', '12');
            glowLine.setAttribute('fill', 'none');
            glowLine.setAttribute('opacity', '0.6');
            routePath.appendChild(glowLine);
            
            // Create main line
            const mainLine = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            mainLine.setAttribute('d', path);
            mainLine.setAttribute('stroke', '#dc3545');
            mainLine.setAttribute('stroke-width', '5');
            mainLine.setAttribute('fill', 'none');
            mainLine.setAttribute('stroke-dasharray', '15, 10');
            mainLine.style.filter = 'drop-shadow(0 0 8px rgba(220, 53, 69, 0.5))';
            mainLine.style.animation = 'dash 3s linear infinite';
            routePath.appendChild(mainLine);
            
            // Set viewBox to match the map coordinates
            routePath.setAttribute('viewBox', '0 0 100 100');
            routePath.style.display = 'block';
            
            console.log('Route path created and displayed');
            
            // Animate path drawing
            try {
                const pathLength = mainLine.getTotalLength();
                mainLine.style.strokeDasharray = pathLength + ' ' + pathLength;
                mainLine.style.strokeDashoffset = pathLength;
                
                setTimeout(() => {
                    mainLine.style.transition = 'stroke-dashoffset 1.5s ease-in-out';
                    mainLine.style.strokeDashoffset = '0';
                    
                    setTimeout(() => {
                        mainLine.style.transition = '';
                        mainLine.style.strokeDasharray = '15, 10';
                        mainLine.style.strokeDashoffset = '0';
                        mainLine.style.animation = 'dash 3s linear infinite';
                    }, 1500);
                }, 100);
            } catch (error) {
                console.warn('Path animation failed:', error);
                // Continue without animation
            }
        }
		
		// ===== 7. เพิ่มฟังก์ชันอัปเดตการแสดงผลจุดหมาย =====
		function updateDestinationDisplay() {
			const statusElement = document.getElementById('destinationStatus');
			const textElement = document.getElementById('destinationText');
			
			if (!statusElement || !textElement) return;
			
			if (persistentDestination.roomCode && roomData[persistentDestination.roomCode]) {
				const displayText = currentLanguage === 'th' 
					? `จุดหมาย: ${persistentDestination.roomName}`
					: `Destination: ${persistentDestination.roomName}`;
				
				textElement.textContent = displayText;
				statusElement.style.display = 'block';
			} else {
				statusElement.style.display = 'none';
			}
		}

       // ===== 5. แก้ไข clearRoute() ให้ชัดเจนขึ้น =====
		function clearRoute() {
			// ล้างเฉพาะเส้นทาง ไม่ล้างจุดหมาย
			document.querySelectorAll('.route-line, .route-marker').forEach(el => el.remove());
			
			const clearRouteBtn = document.getElementById('clearRouteBtn');
			const voiceBtn = document.getElementById('voiceNavigationBtn');
			
			if (clearRouteBtn) clearRouteBtn.style.display = 'none';
			if (voiceBtn) voiceBtn.style.display = 'none';
			
			// 🆝 เรียกใช้ consistency check
			setTimeout(() => {
				ensureRouteConsistency();
			}, 100);
			
			const clearMessage = currentLanguage === 'th' 
				? '🗑️ ล้างเส้นทางแล้ว (จุดหมายยังคงอยู่)'
				: '🗑️ Route cleared (destination preserved)';
			showNotification(clearMessage, 'info');
		}
		// ===== 5. ปรับปรุงฟังก์ชัน updateRouteControls() =====
        function updateRouteControls(showRoute) {
			const showRouteBtn = document.getElementById('showRouteBtn');
			const clearRouteBtn = document.getElementById('clearRouteBtn');
			
			console.log('🎮 Updating route controls:', { showRoute, hasStartPoint: !!startPoint, hasSelectedRoom: !!selectedRoom });
			
			if (showRouteBtn) {
				const canShowRoute = startPoint && selectedRoom;
				showRouteBtn.disabled = !canShowRoute;
				showRouteBtn.style.background = canShowRoute ? 'var(--accent-color)' : '#ccc';
				showRouteBtn.style.opacity = canShowRoute ? '1' : '0.6';
			}
			
			if (clearRouteBtn) {
				clearRouteBtn.style.display = showRoute ? 'block' : 'none';
				if (showRoute) {
					clearRouteBtn.style.background = '#dc3545';
					clearRouteBtn.style.opacity = '1';
				}
			}
		}
		
		
		
		// ===== 6. เพิ่มฟังก์ชันตรวจสอบและแก้ไข state =====
		function validateAndFixRouteState() {
			console.log('🔍 Validating route state...');
			
			// ตรวจสอบ localStorage
			try {
				const savedDestination = localStorage.getItem('persistentDestination');
				const savedStartPoint = localStorage.getItem('startPoint');
				
				if (savedDestination) {
					const parsed = JSON.parse(savedDestination);
					if (parsed.roomCode && roomData[parsed.roomCode]) {
						persistentDestination = parsed;
						selectedRoom = parsed.roomCode;
						console.log('✅ Restored destination from localStorage:', parsed.roomName);
					} else {
						// ข้อมูลเสียหาย ล้างออก
						localStorage.removeItem('persistentDestination');
						clearDestination();
					}
				}
				
				if (savedStartPoint) {
					const parsed = JSON.parse(savedStartPoint);
					if (parsed.x !== null && parsed.y !== null) {
						startPoint = parsed;
						console.log('✅ Restored start point from localStorage:', parsed);
					}
				}
				
			} catch (error) {
				console.error('❌ Error validating state:', error);
				// ล้างข้อมูลที่เสียหาย
				localStorage.removeItem('persistentDestination');
				localStorage.removeItem('startPoint');
				clearDestination();
				startPoint = null;
			}
			
			// อัปเดต UI
			updateDestinationDisplay();
			updateRouteControls(routeDisplayed);
			
			console.log('🎯 Final state:', {
				selectedRoom,
				persistentDestination: persistentDestination.roomCode,
				startPoint: startPoint ? `(${Math.round(startPoint.x)}, ${Math.round(startPoint.y)})` : null
			});
		}

        function generateCompleteRoute() {
            showRouteToSelected();
        }

        // Remove old curved path and replace with simple straight line
        function showModernRoutePath(start, destination) {
            // Use the new straight path function
            showStraightRoutePath(start, destination);
        }

        function hideRoutePath() {
            const routePath = document.getElementById('routePath');
            if (routePath) {
                routePath.style.display = 'none';
                routePath.innerHTML = '';
            }
        }

        // =================== FIX 3: Continuous Voice Navigation ===================
        
        function startContinuousVoiceNavigation() {
            if (!currentRoute) {
                const message = currentLanguage === 'th' 
                    ? '❌ ยังไม่มีเส้นทางสำหรับการนำทาง' 
                    : '❌ No route available for navigation';
                showNotification(message, 'error');
                return;
            }
            
            if (isVoiceNavigating) {
                stopVoiceNavigation();
                return;
            }
            
            if (!('speechSynthesis' in window)) {
                const message = currentLanguage === 'th' 
                    ? '❌ เบราว์เซอร์ไม่รองรับการอ่านเสียง' 
                    : '❌ Browser does not support speech synthesis';
                showNotification(message, 'error');
                return;
            }
            
            generateVoiceQueue();
            startVoiceSequence();
        }

        function generateVoiceQueue() {
            voiceQueue = [];
            
            if (!currentRoute) return;
            
            const { start, destination } = currentRoute;
            const deltaX = destination.x - start.x;
            const deltaY = destination.y - start.y;
            const distance = Math.round(Math.sqrt(deltaX * deltaX + deltaY * deltaY) * 2);
            
            let direction = '';
            if (Math.abs(deltaX) > Math.abs(deltaY)) {
                direction = deltaX > 0 
                    ? (currentLanguage === 'th' ? 'ทางขวา' : 'to the right')
                    : (currentLanguage === 'th' ? 'ทางซ้าย' : 'to the left');
            } else {
                direction = deltaY > 0 
                    ? (currentLanguage === 'th' ? 'ด้านล่าง' : 'downward')
                    : (currentLanguage === 'th' ? 'ด้านบน' : 'upward');
            }
            
            if (currentLanguage === 'th') {
                voiceQueue = [
                    'เริ่มต้นการนำทาง',
                    `เดินไป${direction} ประมาณ ${distance} เมตร`,
                    `มองหาอาคาร ${destination.building}`,
                    `เข้าสู่ ${destination.name}`,
                    'ถึงจุดหมายแล้ว การนำทางเสร็จสิ้น'
                ];
            } else {
                voiceQueue = [
                    'Starting navigation',
                    `Walk ${direction} approximately ${distance} meters`,
                    `Look for building ${destination.building}`,
                    `Enter ${destination.name}`,
                    'Destination reached. Navigation complete'
                ];
            }
        }

        function startVoiceSequence() {
            if (voiceQueue.length === 0) return;
            
            isVoiceNavigating = true;
            updateVoiceButton(true);
            
            const message = currentLanguage === 'th' 
                ? '🔊 เริ่มการนำทางด้วยเสียง' 
                : '🔊 Starting voice navigation';
            showNotification(message, 'success');
            
            speakNextInQueue();
        }

        function speakNextInQueue() {
            if (voiceQueue.length === 0 || !isVoiceNavigating) {
                finishVoiceNavigation();
                return;
            }
            
            const text = voiceQueue.shift();
            
            if (currentSpeech) {
                speechSynthesis.cancel();
            }
            
            currentSpeech = new SpeechSynthesisUtterance(text);
            currentSpeech.lang = currentLanguage === 'th' ? 'th-TH' : 'en-US';
            currentSpeech.rate = 0.8;
            currentSpeech.pitch = 1.0;
            
            currentSpeech.onend = () => {
                if (isVoiceNavigating) {
                    // Wait 2 seconds before next instruction
                    voiceTimeout = setTimeout(() => {
                        speakNextInQueue();
                    }, 2000);
                }
            };
            
            currentSpeech.onerror = () => {
                finishVoiceNavigation();
            };
            
            speechSynthesis.speak(currentSpeech);
        }

        function stopVoiceNavigation() {
            isVoiceNavigating = false;
            voiceQueue = [];
            
            if (voiceTimeout) {
                clearTimeout(voiceTimeout);
                voiceTimeout = null;
            }
            
            if (currentSpeech) {
                speechSynthesis.cancel();
                currentSpeech = null;
            }
            
            updateVoiceButton(false);
            
            const message = currentLanguage === 'th' 
                ? '🔇 หยุดการนำทางด้วยเสียง' 
                : '🔇 Voice navigation stopped';
            showNotification(message, 'warning');
        }

        function finishVoiceNavigation() {
            isVoiceNavigating = false;
            updateVoiceButton(false);
            
            const message = currentLanguage === 'th' 
                ? '✅ การนำทางด้วยเสียงเสร็จสิ้น' 
                : '✅ Voice navigation completed';
            showNotification(message, 'success');
        }

        function updateVoiceButton(isActive) {
            const voiceBtn = document.getElementById('voiceNavigationBtn');
            if (!voiceBtn) return;
            
            if (isActive) {
                voiceBtn.classList.add('speaking');
                voiceBtn.innerHTML = `
                    <i class="fas fa-stop"></i> 
                    <span>${currentLanguage === 'th' ? 'หยุดเสียง' : 'Stop Voice'}</span>
                `;
            } else {
                voiceBtn.classList.remove('speaking');
                voiceBtn.innerHTML = `
                    <i class="fas fa-volume-up"></i> 
                    <span data-translate="voice_nav">${currentLanguage === 'th' ? 'นำทางด้วยเสียง' : 'Voice Navigation'}</span>
                `;
            }
        }

        // Legacy voice functions for compatibility
        function toggleVoiceNavigation() {
            if (isVoiceNavigating) {
                stopVoiceNavigation();
            } else {
                startContinuousVoiceNavigation();
            }
        }

        function speakStep(text) {
            if (!('speechSynthesis' in window)) {
                const message = currentLanguage === 'th' 
                    ? '❌ เบราว์เซอร์ไม่รองรับการอ่านเสียง' 
                    : '❌ Browser does not support speech synthesis';
                showNotification(message, 'error');
                return;
            }
            
            if (currentSpeech) {
                speechSynthesis.cancel();
            }
            
            currentSpeech = new SpeechSynthesisUtterance(text);
            currentSpeech.lang = currentLanguage === 'th' ? 'th-TH' : 'en-US';
            currentSpeech.rate = 0.8;
            currentSpeech.pitch = 1.0;
            
            speechSynthesis.speak(currentSpeech);
        }

        function speakText(text) {
            speakStep(text);
        }

        // =================== Room Markers ===================
        
        let selectedRoomForAction = null;
		// ======= Updated Room Markers - ไม่แสดง Pin ทั้งหมด =======
		function updateRoomMarkers() {
			const markersContainer = document.getElementById('roomMarkers');
			if (!markersContainer) return;
			
			// แสดงเฉพาะจุดเริ่มต้นและปลายทางที่เลือก
			let markersHTML = '';
			
			// แสดงจุดเริ่มต้น
			if (startPoint) {
				markersHTML += `
					<div class="room-marker start-point-marker" 
						 style="top: ${startPoint.y}%; left: ${startPoint.x}%;"
						 title="${currentLanguage === 'th' ? 'จุดเริ่มต้น' : 'Starting Point'}"
						 onclick="showStartPointInfo()">
						🚩
					</div>
				`;
			}
			
			// แสดงปลายทางที่เลือกจากการค้นหา
			if (selectedRoom && roomData[selectedRoom]) {
				const room = roomData[selectedRoom];
				markersHTML += `
					<div class="room-marker highlighted" 
						 data-room="${room.code}" 
						 style="top: ${room.y}%; left: ${room.x}%;"
						 title="${room.name}"
						 onclick="showRoomActionOverlay('${room.code}', event)">
						🎯
					</div>
				`;
			}
			
			markersContainer.innerHTML = markersHTML;
		}
        // ======= Updated Room Markers - version เก่าแสดง Pin ทั้งหมด =======
        function updateRoomMarkers_Old_ShowAllPinPoint() {
            const markersContainer = document.getElementById('roomMarkers');
            if (!markersContainer) return;
            
            let activeRooms = Object.values(roomData).filter(room => room.status === 'active');
            
            // FIX 5: Apply building filter
            if (currentBuildingFilter !== 'all') {
                activeRooms = activeRooms.filter(room => room.building === currentBuildingFilter);
            }
            
            markersContainer.innerHTML = activeRooms.map(room => {
                return `
                    <div class="room-marker" 
                         data-room="${room.code}" 
                         onclick="showRoomActionOverlay('${room.code}', event)" 
                         style="top: ${room.y}%; left: ${room.x}%;"
                         title="${room.name}">
                        ${getRoomIcon(room.name)}
                    </div>
                `;
            }).join('') + (startPoint ? `
                <div class="room-marker start-point-marker" 
                     style="top: ${startPoint.y}%; left: ${startPoint.x}%;"
                     title="${currentLanguage === 'th' ? 'จุดเริ่มต้น' : 'Starting Point'}"
                     onclick="showStartPointInfo()">
                    🚩
                </div>
            ` : '');
        }

        // 1.2: Show action overlay when clicking room marker
        // ======= Room Action Overlay Functions - ปรับปรุงให้ทำงานกับระบบใหม่ =======
		function showRoomActionOverlay(roomCode, event) {
			const room = roomData[roomCode];
			if (!room) return;
			
			selectedRoom = roomCode;
			
			const overlay = document.getElementById('roomActionOverlay');
			const header = document.getElementById('roomActionHeader');
			
			if (!overlay || !header) return;
			
			// อัปเดต header ด้วยชื่อห้อง
			header.textContent = `${room.name} - ${currentLanguage === 'th' ? 'เลือกการดำเนินการ' : 'Select Action'}`;
			
			overlay.style.display = 'block';
			
			// อัปเดตการแปลภาษาสำหรับปุ่มใน overlay
			updateActionOverlayTranslations();
			
			// ซ่อน overlay เมื่อคลิกข้างนอก
			setTimeout(() => {
				document.addEventListener('click', hideRoomActionOverlayOnClickOutside, { once: true });
			}, 100);
		}

        function hideRoomActionOverlayOnClickOutside(event) {
            const overlay = document.getElementById('roomActionOverlay');
            if (overlay && !overlay.contains(event.target) && !event.target.classList.contains('room-marker')) {
                overlay.style.display = 'none';
            }
        }

        function updateActionOverlayTranslations() {
            const buttons = document.querySelectorAll('#roomActionOverlay [data-translate]');
            buttons.forEach(button => {
                const key = button.getAttribute('data-translate');
                if (translations[currentLanguage] && translations[currentLanguage][key]) {
                    button.textContent = translations[currentLanguage][key];
                }
            });
        }

        // 1.2: Action functions
        function showRoomDetails() {
            if (!selectedRoomForAction) return;
            
            // Hide action overlay
            const overlay = document.getElementById('roomActionOverlay');
            if (overlay) overlay.style.display = 'none';
            
            // Show room info overlay
            showRoomInfoOverlay(selectedRoomForAction);
        }

       function showRouteDirectly() {
			if (!selectedRoom) return;
			
			// ซ่อน action overlay
			const overlay = document.getElementById('roomActionOverlay');
			if (overlay) overlay.style.display = 'none';
			
			if (!startPoint) {
				const message = currentLanguage === 'th' 
					? '💡 คลิกที่แผนที่เพื่อตั้งจุดเริ่มต้นก่อน' 
					: '💡 Click on map to set starting point first';
				showNotification(message, 'info');
				return;
			}
			
			// แสดงเส้นทางโดยตรง
			showRouteToSelected();
		}

        function showStartPointInfo() {
            if (!startPoint) return;
            const message = currentLanguage === 'th' 
                ? `🚩 จุดเริ่มต้นการนำทาง` 
                : `🚩 Navigation starting point`;
            showNotification(message, 'info');
        }

        // =================== Room Info Functions ===================
        
        function getRoomTypeText(type) {
            const types = {
                'classroom': currentLanguage === 'th' ? 'ห้องเรียน' : 'Classroom',
                'computer': currentLanguage === 'th' ? 'ห้องคอมพิวเตอร์' : 'Computer Lab',
                'lab': currentLanguage === 'th' ? 'ห้องปฏิบัติการ' : 'Laboratory',
                'library': currentLanguage === 'th' ? 'ห้องสมุด' : 'Library',
                'office': currentLanguage === 'th' ? 'ห้องสำนักงาน' : 'Office',
                'facility': currentLanguage === 'th' ? 'สิ่งอำนวยความสะดวก' : 'Facility',
                'special': currentLanguage === 'th' ? 'ห้องพิเศษ' : 'Special Room'
            };
            return types[type] || type;
        }
        
        function showRoomInfoOverlay(roomCode) {
            const room = roomData[roomCode];
            if (!room) return;

            selectedRoom = roomCode;
            updateRouteControls(false);
            
            const overlay = document.getElementById('roomInfoOverlay');
            if (!overlay) return;
            
            const roomName = document.getElementById('overlayRoomName');
            const roomLocation = document.getElementById('overlayRoomLocation');
            const roomBuilding = document.getElementById('overlayRoomBuilding');
            const roomFloor = document.getElementById('overlayRoomFloor');
            const roomType = document.getElementById('overlayRoomType');
            const roomDescription = document.getElementById('overlayRoomDescription');
            const routeBtn = document.getElementById('routeBtn');
            
            if (roomName) roomName.innerHTML = `${getRoomIcon(room.name)} ${room.name}`;
            if (roomLocation) roomLocation.textContent = room.location || room.floor || 'N/A';
            
            // 1.3: Enhanced room information display (removed status)
            // Get building name from admin data
            const buildingData = JSON.parse(localStorage.getItem('buildingsData') || '{}');
            const buildingName = buildingData[room.building]?.name || room.building;
            if (roomBuilding) roomBuilding.textContent = buildingName;
            
            // Display floor information
            if (roomFloor) {
                const floorText = room.floor 
                    ? (currentLanguage === 'th' ? `ชั้น ${room.floor}` : `Floor ${room.floor}`)
                    : (currentLanguage === 'th' ? 'ไม่ระบุ' : 'Not specified');
                roomFloor.textContent = floorText;
            }
            
            // Display room type
            if (roomType) roomType.textContent = getRoomTypeText(room.type || 'classroom');
            
            // 1.3: Remove status display - no longer shown
            
            if (roomDescription) roomDescription.textContent = room.description || (currentLanguage === 'th' ? 'ไม่มีรายละเอียด' : 'No description available');
            
            // Update route button state
            if (routeBtn) {
                if (!startPoint) {
                    routeBtn.disabled = true;
                    routeBtn.innerHTML = `<i class="fas fa-exclamation-triangle"></i> <span>${currentLanguage === 'th' ? 'ตั้งจุดเริ่มต้นก่อน' : 'Set start point first'}</span>`;
                } else {
                    routeBtn.disabled = false;
                    routeBtn.innerHTML = `<i class="fas fa-route"></i> <span data-translate="route_navigation">${currentLanguage === 'th' ? 'เส้นทางนำทาง' : 'Route Navigation'}</span>`;
                }
            }
            
            // Display all images
            updateOverlayImageGallery(room.images);
            generateOverlayNavigationSteps(room);
            
            overlay.style.display = 'flex';
        }

        function closeRoomInfoOverlay() {
            const overlay = document.getElementById('roomInfoOverlay');
            if (overlay) {
                overlay.style.display = 'none';
            }
            selectedRoom = null;
            updateRouteControls(false);
        }

        function generateOverlayNavigationSteps(room) {
            const routeSteps = document.getElementById('overlayRouteSteps');
            if (!routeSteps) return;
            
            if (!startPoint) {
                const noStartText = currentLanguage === 'th' 
                    ? 'คลิกที่แผนที่เพื่อตั้งจุดเริ่มต้นก่อน'
                    : 'Click on map to set starting point first';
                    
                routeSteps.innerHTML = `
                    <div style="text-align: center; padding: 20px; background: #fff3cd; border-radius: var(--border-radius); color: #856404;">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p style="margin: 8px 0 0 0; font-size: 14px;">
                            ${noStartText}
                        </p>
                    </div>
                `;
                return;
            }
            
            const deltaX = room.x - startPoint.x;
            const deltaY = room.y - startPoint.y;
            const distance = Math.round(Math.sqrt(deltaX * deltaX + deltaY * deltaY) * 2);
            
            let direction = '';
            if (Math.abs(deltaX) > Math.abs(deltaY)) {
                direction = deltaX > 0 
                    ? (currentLanguage === 'th' ? 'ทางขวา' : 'to the right')
                    : (currentLanguage === 'th' ? 'ทางซ้าย' : 'to the left');
            } else {
                direction = deltaY > 0 
                    ? (currentLanguage === 'th' ? 'ด้านล่าง' : 'downward')
                    : (currentLanguage === 'th' ? 'ด้านบน' : 'upward');
            }
            
            const steps = currentLanguage === 'th' ? [
                {
                    step: 1,
                    text: 'เริ่มต้นจากจุดเริ่มต้น',
                    distance: '0m'
                },
                {
                    step: 2,
                    text: `เดินไป${direction} ประมาณ ${distance} เมตร`,
                    distance: `${distance}m`
                },
                {
                    step: 3,
                    text: `มองหา ${room.building}`,
                    distance: '10m'
                },
                {
                    step: 4,
                    text: `เข้าสู่ ${room.name}`,
                    distance: '0m'
                }
            ] : [
                {
                    step: 1,
                    text: 'Start from starting point',
                    distance: '0m'
                },
                {
                    step: 2,
                    text: `Walk ${direction} approximately ${distance} meters`,
                    distance: `${distance}m`
                },
                {
                    step: 3,
                    text: `Look for ${room.building}`,
                    distance: '10m'
                },
                {
                    step: 4,
                    text: `Enter ${room.name}`,
                    distance: '0m'
                }
            ];
            
            const stepsTitle = currentLanguage === 'th' ? 'ขั้นตอนการเดินทาง' : 'Navigation Steps';
            
            routeSteps.innerHTML = `
                <div class="route-steps">
                    <h4 style="margin: 0 0 15px 0; font-size: 16px; color: var(--primary-color);">
                        <i class="fas fa-route"></i> ${stepsTitle}
                    </h4>
                    ${steps.map(step => `
                        <div class="route-step">
                            <div class="step-number">${step.step}</div>
                            <div class="step-content">${step.text}</div>
                            <div class="step-distance">${step.distance}</div>
                            <button class="step-voice-btn" onclick="speakStep('${step.text}')">
                                <i class="fas fa-volume-up"></i>
                            </button>
                        </div>
                    `).join('')}
                </div>
            `;
        }

       // ===== 3. แก้ไขปัญหา Error รูปภาพใน updateOverlayImageGallery =====
		function updateOverlayImageGallery(room) {
			const gallery = document.getElementById('roomImageGallery');
			if (!gallery) return;

			if (!room.images || room.images.length === 0) {
				gallery.innerHTML = `
					<div style="text-align: center; padding: 40px; color: var(--text-secondary);">
						<i class="fas fa-image" style="font-size: 48px; opacity: 0.3; margin-bottom: 15px;"></i>
						<p>ไม่มีรูปภาพ</p>
					</div>
				`;
				return;
			}

			// 🆕 ตรวจสอบและกรองรูปภาพที่ valid เท่านั้น
			const validImages = room.images.filter(img => {
				if (!img || typeof img !== 'string') return false;
				
				// ตรวจสอบว่าเป็น URL ที่ valid หรือไม่
				try {
					// ถ้าเป็น data URL หรือ http/https URL ให้ผ่าน
					if (img.startsWith('data:') || img.startsWith('http://') || img.startsWith('https://')) {
						return true;
					}
					// ถ้าเป็น relative path ต้องตรวจสอบเพิ่มเติม
					if (img.startsWith('./') || img.startsWith('../') || !img.includes('://')) {
						console.warn('⚠️ Skipping local file path:', img);
						return false;
					}
					return true;
				} catch (error) {
					console.error('❌ Invalid image URL:', img, error);
					return false;
				}
			});

			if (validImages.length === 0) {
				gallery.innerHTML = `
					<div style="text-align: center; padding: 40px; color: var(--text-secondary);">
						<i class="fas fa-exclamation-triangle" style="font-size: 48px; opacity: 0.3; margin-bottom: 15px; color: orange;"></i>
						<p>รูปภาพไม่สามารถโหลดได้</p>
						<small>ตรวจสอบ URL รูปภาพในข้อมูล</small>
					</div>
				`;
				return;
			}

			gallery.innerHTML = validImages.map((image, index) => `
				<div class="gallery-item" style="position: relative; margin-bottom: 15px;">
					<img src="${image}" 
						 alt="Room image ${index + 1}" 
						 style="width: 100%; border-radius: 8px; cursor: pointer;"
						 onclick="openImageModal('${image.replace(/'/g, "\\'")}', '${room.name.replace(/'/g, "\\'")}')"
						 onerror="this.style.display='none'; this.nextElementSibling.style.display='block';"
						 loading="lazy">
					<div style="display: none; text-align: center; padding: 20px; background: #f8f9fa; border-radius: 8px; color: var(--text-secondary);">
						<i class="fas fa-broken-image"></i>
						<p>ไม่สามารถโหลดรูปภาพได้</p>
					</div>
				</div>
			`).join('');
		}
		
		// ===== 7. ปรับปรุงฟังก์ชัน ensureRouteConsistency() =====
		function ensureRouteConsistency() {
			console.log('🔧 Ensuring route consistency...');
			
			// เรียกใช้ validate ก่อน
			validateAndFixRouteState();
			
			// ตรวจสอบความสอดคล้อง
			if (persistentDestination.roomCode && roomData[persistentDestination.roomCode]) {
				if (selectedRoom !== persistentDestination.roomCode) {
					console.log('🔧 Syncing selectedRoom with persistentDestination');
					selectedRoom = persistentDestination.roomCode;
				}
				
				// อัปเดต UI
				updateDestinationDisplay();
				updateRouteControls(true);
				showDestinationStatus();
				
			} else if (selectedRoom && roomData[selectedRoom]) {
				// ถ้ามี selectedRoom แต่ไม่มี persistent ให้บันทึก
				console.log('🔧 Saving selectedRoom as persistent destination');
				saveDestination(selectedRoom);
				updateDestinationDisplay();
			}
		}

        function openImageModal(imageUrl) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.9);
                z-index: 3000;
                display: flex;
                align-items: center;
                justify-content: center;
                backdrop-filter: blur(5px);
                -webkit-backdrop-filter: blur(5px);
            `;
            modal.innerHTML = `
                <img src="${imageUrl}" alt="Room Image" style="max-width: 90%; max-height: 90%; border-radius: var(--border-radius); box-shadow: 0 25px 50px rgba(0,0,0,0.5);">
                <button onclick="this.parentElement.remove()" style="position: absolute; top: 30px; right: 30px; background: white; color: black; border: none; border-radius: 50%; width: 50px; height: 50px; cursor: pointer; font-size: 20px; display: flex; align-items: center; justify-content: center; box-shadow: 0 8px 20px rgba(0,0,0,0.3);">×</button>
            `;
            modal.onclick = (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            };
            document.body.appendChild(modal);
        }

        // =================== Event Setup ===================
        
       // แก้ไข: ปรับปรุงฟังก์ชัน setupMapEvents เพื่อรักษาจุดหมายไว้
		function setupMapEvents() {
			const mapArea = document.getElementById('mapArea');
			if (!mapArea) return;
			
			mapArea.addEventListener('click', function(event) {
				// ไม่ตั้งจุดเริ่มต้นเมื่อคลิกที่ room markers หรือ action overlay
				if (event.target.classList.contains('room-marker') || 
					event.target.closest('.room-action-overlay')) {
					return;
				}
				
				// คำนวณตำแหน่งบนแผนที่
				const rect = mapArea.getBoundingClientRect();
				const x = ((event.clientX - rect.left) / rect.width) * 100;
				const y = ((event.clientY - rect.top) / rect.height) * 100;
				
				// ตรวจสอบว่าตำแหน่งอยู่ในขอบเขต
				if (x >= 0 && x <= 100 && y >= 0 && y <= 100) {
					// ล้างเส้นทางเดิมถ้ามีการเปลี่ยนจุดเริ่มต้น
					if (routeDisplayed) {
						clearRoute();
					}
					
					// ตั้งจุดเริ่มต้น (แต่ไม่เปลี่ยน selectedRoom)
					const oldStartPoint = startPoint;
					startPoint = {
						name: currentLanguage === 'th' ? 'จุดเริ่มต้น' : 'Starting Point',
						x: x,
						y: y
					};
					
					localStorage.setItem('startPoint', JSON.stringify(startPoint));
					
					// อัปเดต markers โดยรักษา selectedRoom ไว้
					updateRoomMarkers(); 
					updateRouteControls(false);
					
					const message = currentLanguage === 'th' 
						? `🎯 เปลี่ยนจุดเริ่มต้นใหม่ (${Math.round(x)}, ${Math.round(y)})`
						: `🎯 Start point updated (${Math.round(x)}, ${Math.round(y)})`;
					showNotification(message, 'success');
					
					// แสดงเส้นทางอัตโนมัติถ้ามีห้องที่เลือกแล้ว
					if (selectedRoom && roomData[selectedRoom]) {
						setTimeout(() => {
							showRouteToSelected();
							
							// แจ้งเตือนว่าสามารถดูเส้นทางใหม่ได้แล้ว
							const routeMessage = currentLanguage === 'th' 
								? `🛣️ เส้นทางใหม่ไปยัง ${roomData[selectedRoom].name}`
								: `🛣️ New route to ${roomData[selectedRoom].name}`;
							setTimeout(() => {
								showNotification(routeMessage, 'info');
							}, 1000);
						}, 500);
					} else {
						// แจ้งให้ผู้ใช้ค้นหาห้องก่อน
						setTimeout(() => {
							const searchMessage = currentLanguage === 'th' 
								? '💡 ไปหน้าค้นหาเพื่อเลือกห้องปลายทาง จากนั้นกลับมาดูเส้นทาง'
								: '💡 Go to search page to select destination room, then return to view route';
							showNotification(searchMessage, 'info');
						}, 1000);
					}
				}
			});
		}
		
		
		

        function setupWindowEvents() {
            window.addEventListener('orientationchange', function() {
                setTimeout(() => {
                    updateRoomMarkers();
                }, 500);
            });

            let resizeTimeout;
            window.addEventListener('resize', function() {
                clearTimeout(resizeTimeout);
                resizeTimeout = setTimeout(() => {
                    updateRoomMarkers();
                }, 250);
            });

            window.addEventListener('beforeunload', function(e) {
                if (startPoint) {
                    localStorage.setItem('startPoint', JSON.stringify(startPoint));
                }
            });

            document.addEventListener('keydown', function(e) {
                if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                    e.preventDefault();
                    const searchInput = document.getElementById('searchInput');
                    if (searchInput) {
                        searchInput.focus();
                    }
                }
                
                if (e.key === 'Escape') {
                    closeRoomInfoOverlay();
                    
                    const imageModal = document.querySelector('div[style*="position: fixed"][style*="background: rgba(0,0,0,0.9)"]');
                    if (imageModal) {
                        imageModal.remove();
                    }
                    
                    if (isVoiceNavigating) {
                        stopVoiceNavigation();
                    }
                }
                
                if (e.key === ' ' && isVoiceNavigating) {
                    e.preventDefault();
                    stopVoiceNavigation();
                }
            });
        }


		// ======= แก้ไข: ปรับปรุงการโหลดภาพแผนที่ =======
		async function loadMapDataFromSheets() {
			if (currentVersion !== 'live' || !sheetsConfig.url) {
				console.log('🗺️ Not loading map images (Demo mode or no sheets URL)');
				return;
			}
			
			try {
				console.log('🗺️ Loading map images from Google Sheets...');
				showProgressiveStatus('🗺️ โหลดภาพแผนที่...', 'info');
				
				// แก้ไข: เพิ่ม timeout สำหรับ map images
				const controller = new AbortController();
				const timeoutId = setTimeout(() => {
					controller.abort();
					console.log('⏰ Map images request timeout');
				}, 20000); // 20 วินาที สำหรับรูปภาพ
				
				const params = new URLSearchParams();
				params.append('action', 'getData');
				params.append('sheet', sheetsConfig.mapImagesSheet);
				
				const response = await fetch(sheetsConfig.url, {
					method: 'POST',
					headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
					body: params.toString(),
					signal: controller.signal
				});
				
				clearTimeout(timeoutId);
				
				if (response.ok) {
					const result = await response.json();
					console.log('🗺️ Map images response received');
					
					if (result.success && result.data && result.data.length > 0) {
						let sheetMapData = result.data.find(item => 
							item.id === 'main_map' || item.id === 'maps'
						);
						
						if (!sheetMapData && result.data.length > 0) {
							sheetMapData = result.data[0];
						}
						
						if (sheetMapData) {
							// อัปเดทข้อมูลแผนที่
							if (sheetMapData.floorplan) {
								mapData.floorplan = sheetMapData.floorplan;
								console.log('✅ Floorplan loaded from sheets');
							}
							if (sheetMapData.realphoto) {
								mapData.realphoto = sheetMapData.realphoto;
								console.log('✅ Real photo loaded from sheets');
							}
							if (sheetMapData.notes) {
								mapData.notes = sheetMapData.notes;
							}
							
							mapData.loaded = true;
							
							// แก้ไข: ใช้ฟังก์ชันบีบอัดสำหรับข้อมูลขนาดใหญ่
							const cacheSuccess = safeSetCachedData('mapImages', mapData);
							if (!cacheSuccess) {
								console.warn('⚠️ Map images too large to cache, using session storage');
							}
							
							updateMapDisplay();
							showProgressiveStatus('✅ โหลดภาพแผนที่สำเร็จ', 'success');
							
							console.log('✅ Map images loaded successfully');
						} else {
							console.log('⚠️ No map data found in sheets');
							showProgressiveStatus('⚠️ ไม่พบข้อมูลภาพแผนที่', 'warning');
						}
					} else {
						console.log('⚠️ No map images data in response');
						showProgressiveStatus('⚠️ ไม่มีข้อมูลภาพแผนที่', 'warning');
					}
				} else {
					console.error('❌ Failed to fetch map images:', response.status);
					showProgressiveStatus('❌ โหลดภาพแผนที่ล้มเหลว', 'error');
				}
			} catch (error) {
				if (error.name === 'AbortError') {
					console.error('⏰ Map images request timeout');
					showProgressiveStatus('⏰ โหลดภาพแผนที่ใช้เวลานานเกินไป', 'warning');
				} else {
					console.error('❌ Error loading map images:', error);
					showProgressiveStatus('❌ เกิดข้อผิดพลาดในการโหลดภาพแผนที่', 'error');
				}
			}
		}

		// ======= อัปเดตการแสดงผลแผนที่ =======
		function updateMapDisplay() {
			const mapImage = document.getElementById('mapImage');
			if (!mapImage) return;
			
			let imageToShow = null;
			
			// เลือกภาพตาม layout ปัจจุบัน
			if (currentMapLayout === 'photo' && mapData.realphoto) {
				imageToShow = mapData.realphoto;
				console.log('🗺️ Displaying real photo');
			} else if (currentMapLayout === 'floorplan' && mapData.floorplan) {
				imageToShow = mapData.floorplan;
				console.log('🗺️ Displaying floorplan');
			}
			
			if (imageToShow) {
				mapImage.src = imageToShow;
				mapImage.onerror = function() {
					console.error('❌ Failed to load map image:', imageToShow);
					showFallbackMap();
				};
				mapImage.onload = function() {
					console.log('✅ Map image loaded successfully');
				};
			} else {
				// แสดงแผนที่ default หรือข้อความแจ้งเตือน
				showFallbackMap();
			}
		}

		// ======= แสดงแผนที่ default เมื่อไม่มีภาพ =======
		function showFallbackMap() {
			const mapImage = document.getElementById('mapImage');
			if (!mapImage) return;
			
			const fallbackText = currentMapLayout === 'photo' ? 'ภาพจริง' : 'แผนผัง';
			const missingText = currentLanguage === 'th' 
				? `ไม่มี${fallbackText}` 
				: `No ${currentMapLayout} available`;
			
			mapImage.src = `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='800' height='600' viewBox='0 0 800 600'%3E%3Crect width='800' height='600' fill='%23f0f8ff'/%3E%3Ctext x='400' y='280' text-anchor='middle' font-family='Arial' font-size='28' fill='%23667eea' font-weight='bold'%3E🏫 ${encodeURIComponent('แผนที่โรงเรียนอัจฉริยะ')}%3C/text%3E%3Ctext x='400' y='320' text-anchor='middle' font-family='Arial' font-size='16' fill='%23999'%3E${encodeURIComponent(missingText)}%3C/text%3E%3Ctext x='400' y='350' text-anchor='middle' font-family='Arial' font-size='14' fill='%23667eea'%3E📍 ${encodeURIComponent('คลิกจุดบนแผนที่เพื่อดูข้อมูลห้อง')}%3C/text%3E%3C/svg%3E`;
		}

		// ======= แก้ไขฟังก์ชัน setMapLayout เดิม =======
		function setMapLayout(layout) {
			currentMapLayout = layout;
			
			// อัปเดต UI ปุ่ม
			document.querySelectorAll('.map-control-btn[data-layout]').forEach(btn => {
				btn.classList.remove('active');
			});
			
			const targetBtn = document.querySelector(`[data-layout="${layout}"]`);
			if (targetBtn) {
				targetBtn.classList.add('active');
			}
			
			// อัปเดตแผนที่
			updateMapDisplay();
			
			// แสดงการแจ้งเตือน
			const layoutName = layout === 'photo' 
				? (currentLanguage === 'th' ? 'ภาพจริง' : 'Real Photo')
				: (currentLanguage === 'th' ? 'แผนผัง' : 'Floor Plan');
			
			showNotification(
				currentLanguage === 'th' ? `🗺️ เปลี่ยนเป็น${layoutName}` : `🗺️ Switched to ${layoutName}`,
				'info'
			);
		}
		
		// ======= แก้ไข: ปรับปรุงการจัดการ Session Storage สำหรับ Map Images =======
		function loadMapFromSessionStorage() {
			try {
				const floorplan = sessionStorage.getItem('temp_floorplan');
				const realphoto = sessionStorage.getItem('temp_realphoto');
				
				if (floorplan) {
					mapData.floorplan = floorplan;
				}
				if (realphoto) {
					mapData.realphoto = realphoto;
				}
				
				if (floorplan || realphoto) {
					mapData.loaded = true;
					updateMapDisplay();
					console.log('🗺️ Map images loaded from session storage');
				}
			} catch (error) {
				console.warn('⚠️ Could not load map images from session storage:', error);
			}
		}

		// ======= แก้ไข: เรียกใช้ session storage เมื่อโหลดระบบ =======
		async function initializeMapImages() {
			console.log('🗺️ Initializing map images...');
			
			// ลองโหลดจาก session storage ก่อน
			loadMapFromSessionStorage();
			
			// ถ้า session storage มีข้อมูลแล้ว ไม่ต้องโหลดจาก cache/sheets
			if (mapData.loaded && (mapData.floorplan || mapData.realphoto)) {
				console.log('💾 Map images available from session storage');
				return;
			}
			
			// ลองโหลดจาก cache
			if (isCacheValid('mapImages', 60 * 60 * 1000)) { // 1 hour cache
				const cachedMapData = getCachedData('mapImages');
				if (cachedMapData && !cachedMapData.compressed) {
					mapData = { ...mapData, ...cachedMapData };
					updateMapDisplay();
					console.log('💾 Map images loaded from cache');
					return;
				} else if (cachedMapData && cachedMapData.compressed) {
					console.log('🗜️ Found compressed cache, loading from session storage');
					loadMapFromSessionStorage();
					return;
				}
			}
			
			// โหลดจาก Google Sheets (Live mode เท่านั้น และเพียงครั้งเดียว)
			if (currentVersion === 'live') {
				await loadMapDataFromSheets();
			} else {
				console.log('🎮 Demo mode: Using default map images');
				showFallbackMap();
			}
		}

		// ======= เพิ่มการ Debug สำหรับแผนที่ =======
		function debugMapImages() {
			console.log('🔍 === MAP IMAGES DEBUG ===');
			console.log('Current version:', currentVersion);
			console.log('Current layout:', currentMapLayout);
			console.log('Map data:', {
				hasFloorplan: !!mapData.floorplan,
				hasRealPhoto: !!mapData.realphoto,
				loaded: mapData.loaded,
				floorplanLength: mapData.floorplan ? mapData.floorplan.length : 0,
				realPhotoLength: mapData.realphoto ? mapData.realphoto.length : 0
			});
			console.log('Sheets config:', {
				url: sheetsConfig.url ? 'SET' : 'NOT SET',
				mapImagesSheet: sheetsConfig.mapImagesSheet
			});
			
			const mapImage = document.getElementById('mapImage');
			if (mapImage) {
				console.log('Map image element:', {
					src: mapImage.src.substring(0, 100) + '...',
					naturalWidth: mapImage.naturalWidth,
					naturalHeight: mapImage.naturalHeight
				});
			}
		}
		// ===== 8. เพิ่มฟังก์ชัน debug เพื่อตรวจสอบปัญหา =====
		// เพิ่มให้สามารถเรียกใช้ใน console: debugCurrentState()
			function debugCurrentState() {
				console.group('🐛 Current Route State Debug');
				console.log('📍 startPoint:', startPoint);
				console.log('🎯 selectedRoom:', selectedRoom);
				console.log('💾 persistentDestination:', persistentDestination);
				console.log('🛣️ routeDisplayed:', routeDisplayed);
				console.log('📱 currentRoute:', currentRoute);
				console.log('🗃️ localStorage destination:', localStorage.getItem('persistentDestination'));
				console.log('🗃️ localStorage startPoint:', localStorage.getItem('startPoint'));
				console.log('🔍 Route elements on page:', document.querySelectorAll('.route-line, .route-marker').length);
				
				// ตรวจสอบปุ่มต่างๆ
				const showBtn = document.getElementById('showRouteBtn');
				const clearBtn = document.getElementById('clearRouteBtn');
				console.log('🎮 Show button:', showBtn ? { disabled: showBtn.disabled, display: showBtn.style.display } : 'Not found');
				console.log('🎮 Clear button:', clearBtn ? { display: clearBtn.style.display } : 'Not found');
				
				console.groupEnd();
			}



		// แก้ไข: ฟังก์ชัน Toggle Usage Guide
		function toggleUsageGuide() {
			const content = document.getElementById('usageGuideContent');
			const toggleText = document.getElementById('usageGuideToggleText');
			const chevron = document.getElementById('usageGuideChevron');
			
			if (!content || !toggleText || !chevron) return;
			
			const isHidden = content.style.display === 'none';
			
			if (isHidden) {
				// Show content
				content.style.display = 'block';
				toggleText.innerHTML = `<span data-translate="hide_usage_guide">ซ่อนวิธีการใช้งาน</span>`;
				chevron.style.transform = 'rotate(180deg)';
				
				// Update translation
				const hideText = currentLanguage === 'th' ? 'ซ่อนวิธีการใช้งาน' : 'Hide Usage Guide';
				toggleText.textContent = hideText;
				
				showNotification(
					currentLanguage === 'th' ? '📖 แสดงวิธีการใช้งาน' : '📖 Usage guide shown',
					'info'
				);
			} else {
				// Hide content
				content.style.display = 'none';
				toggleText.innerHTML = `<span data-translate="show_usage_guide">แสดงวิธีการใช้งาน</span>`;
				chevron.style.transform = 'rotate(0deg)';
				
				// Update translation
				const showText = currentLanguage === 'th' ? 'แสดงวิธีการใช้งาน' : 'Show Usage Guide';
				toggleText.textContent = showText;
				
				showNotification(
					currentLanguage === 'th' ? '📖 ซ่อนวิธีการใช้งาน' : '📖 Usage guide hidden',
					'info'
				);
			}
		}

        // =================== Initialization ===================
        
			 // ======= แก้ไข: ปรับปรุงการโหลดข้อมูลเริ่มต้น - Sync เพียงครั้งเดียว =======
		async function loadInitialData() {
			const savedLang = localStorage.getItem('preferredLanguage') || 'th';
			currentLanguage = savedLang;
			updateLanguageButton();
			
			// โหลดข้อมูลโดยใช้ระบบ caching ใหม่ (เฉพาะครั้งเดียวเมื่อเข้าระบบ)
			console.log('🚀 Starting one-time data sync...');
			await loadRoomDataFromAdmin();
			
			// โหลดภาพแผนที่ (เฉพาะครั้งเดียว)
			await initializeMapImages();
			
			const savedStartPoint = localStorage.getItem('startPoint');
			if (savedStartPoint) {
				try {
					startPoint = JSON.parse(savedStartPoint);
				} catch (error) {
					console.error('Error loading start point:', error);
				}
			}
			
			// อัปเดต UI
			updateRoomMarkers();
			updateRouteControls(false);
			updateAllTranslations();
			updateSearchPlaceholder();
			updateGlobalVersionIndicator(currentVersion);
			loadDestination();
			updateDestinationDisplay();
			
			console.log('✅ One-time sync completed');
			showProgressiveStatus('✅ การซิงค์ข้อมูลเสร็จสิ้น', 'success');
		}

		// ======= เพิ่ม Debug Command สำหรับ Console =======
		window.debugMapImages = debugMapImages;

       // ======= แก้ไข initializeSystem ให้ไม่มี Loading Overlay บดบัง =======
		async function initializeSystem() {
			try {
				// ตรวจสอบ System Configuration (ไม่บล็อก UI)
				const canProceed = await checkSystemConfiguration();
				
				if (!canProceed) {
					// อยู่ใน Maintenance Mode - หยุดการโหลด
					return;
				}
				
				// แสดงสถานะเริ่มต้น
				showProgressiveStatus('🚀 เริ่มต้นระบบ...', 'info');
				
				// โหลดระบบปกติต่อไป (แบบ async ไม่บล็อก UI)
				loadInitialData()
					.then(() => {
						setupMapEvents();
						setupWindowEvents();
						
						// Initialize map controls
						setMapLayout('floorplan');
						
						// แสดงข้อความต้อนรับ
						setTimeout(() => {
							const welcomeMessage = currentLanguage === 'th' 
								? '🎉 ยินดีต้อนรับสู่ระบบแผนที่โรงเรียนอัจฉริยะ v6!' 
								: '🎉 Welcome to Smart School Map System v6!';
							showNotification(welcomeMessage, 'info');
						}, 1000);
						
						console.log('🏫 School Map System v6 Ready');
						console.log(`📊 Current Version: ${currentVersion}`);
						console.log(`🏢 Total Buildings: ${Object.keys(buildingsData).length}`);
						console.log(`🚪 Total Rooms: ${Object.keys(roomData).length}`);
					})
					.catch(error => {
						console.error('Background loading error:', error);
						showProgressiveStatus('⚠️ โหลดเบื้องหลังล้มเหลว', 'warning');
					});
				
				// ให้ UI แสดงได้ทันที ไม่รอการโหลดเสร็จ
				showProgressiveStatus('✅ ระบบพร้อมใช้งาน', 'success');
				
			} catch (error) {
				console.error('Initialization error:', error);
				const errorMessage = currentLanguage === 'th' 
					? '❌ ไม่สามารถเริ่มต้นระบบได้' 
					: '❌ System initialization failed';
				showProgressiveStatus(errorMessage, 'error');
				
				// แม้เกิดข้อผิดพลาดก็ยังให้ระบบทำงานได้
				roomData = { ...sampleRoomData };
				buildingsData = { ...sampleBuildingsData };
				setupMapEvents();
				setupWindowEvents();
			}
		}
		
				// ======= เพิ่มฟังก์ชันจัดการ Performance =======
		function optimizePerformance() {
			// ล้าง cache เก่าที่เกิน 24 ชั่วโมง
			const keys = Object.keys(localStorage);
			const now = Date.now();
			const maxAge = 24 * 60 * 60 * 1000; // 24 hours
			
			keys.forEach(key => {
				if (key.includes('_timestamp_')) {
					const timestamp = localStorage.getItem(key);
					if (timestamp && (now - parseInt(timestamp)) > maxAge) {
						const cacheKey = key.replace('_timestamp_', '_cache_');
						localStorage.removeItem(key);
						localStorage.removeItem(cacheKey);
						console.log(`🗑️ Removed expired cache: ${cacheKey}`);
					}
				}
			});
			
			// รายงานการใช้ memory
			if (performance.memory) {
				const used = Math.round(performance.memory.usedJSHeapSize / 1024 / 1024);
				console.log(`📊 Memory usage: ${used}MB`);
			}
		}

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            initializeSystem();
			
			 // โหลดและแสดงจุดหมายที่บันทึกไว้
			setTimeout(() => {
				loadDestination();
				updateDestinationDisplay();
			}, 1000);
        });
		

        // Performance monitoring
        function getMemoryUsage() {
            if (performance.memory) {
                const used = Math.round(performance.memory.usedJSHeapSize / 1024 / 1024);
                const limit = Math.round(performance.memory.jsHeapSizeLimit / 1024 / 1024);
                console.log(`Memory: ${used}MB / ${limit}MB`);
                
                if (used > limit * 0.8) {
                    console.warn('⚠️ Memory usage high, consider optimization');
                }
            }
        }

        // เรียกใช้การปรับปรุงประสิทธิภาพทุก 5 นาที
		setInterval(optimizePerformance, 5 * 60 * 1000);

        console.log('🎉 ระบบแผนที่โรงเรียนอัจฉริยะ v6 - User Interface LATEST UPDATE!');
        console.log('✅ Original 5 fixes + Previous modifications + NEW fixes completed:');
        console.log('✅ FIX 1: Language toggle system implemented');
        console.log('✅ FIX 2: Route persistence - routes stay until cleared');
        console.log('✅ FIX 3: Continuous voice navigation with queue system');
        console.log('✅ FIX 4: Map controls moved outside map area');
        console.log('✅ FIX 5: Building filter for pin clustering/filtering');
        console.log('✅ MOD 1.1: Map view controls (floorplan/photo/fullscreen) with toggle');
        console.log('✅ MOD 1.2: Help and center buttons removed');
        console.log('✅ MOD 1.3: Admin button moved to bottom navigation');
        console.log('✅ MOD 1.4: Enhanced room information (no hours)');
        console.log('✅ MOD 1.5: Straight line route paths');
        console.log('✅ NEW 1.1: Fixed route display with proper straight lines');
        console.log('✅ NEW 1.2: Room action overlay (choose details or show route)');
        console.log('✅ NEW 1.3: Removed status info from room details');
        console.log('🔗 Fully compatible with Admin Interface v6.1');
        console.log('🚀 Ready for production deployment!');
        console.log('📝 Remember to update cross-reference URLs after deployment!');
    </script>
</body>
</html>