<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบแผนที่โรงเรียนอัจฉริยะ v6 - User Interface</title>
    
    <!-- External Libraries -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        /* =================== CSS Variables =================== */
        :root {
            --primary-color: #667eea;
            --secondary-color: #764ba2;
            --accent-color: #28a745;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --info-color: #17a2b8;
            
            --background-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --card-background: #ffffff;
            --text-primary: #333333;
            --text-secondary: #666666;
            --border-color: #e0e6ff;
            
            --border-radius: 15px;
            --box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            --transition: all 0.3s ease;
            
            --bottom-nav-height: 70px;
            --content-padding-bottom: 85px;
        }

        /* =================== Base Styles =================== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--background-gradient);
            min-height: 100vh;
            color: var(--text-primary);
            overflow-x: hidden;
            transition: var(--transition);
            padding-bottom: var(--content-padding-bottom);
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
            padding: 10px;
        }

        /* =================== Header =================== */
        .header {
            background: var(--card-background);
            padding: 15px 20px;
            border-radius: 0 0 var(--border-radius) var(--border-radius);
            box-shadow: var(--box-shadow);
            margin-bottom: 15px;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .school-logo {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--primary-color);
        }

        .header-title {
            flex: 1;
            text-align: center;
        }

        .header h1 {
            color: var(--text-primary);
            margin: 0;
            font-size: 1.4em;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header p {
            color: var(--text-secondary);
            font-size: 0.9em;
            margin-top: 5px;
        }

        .header-btn {
            background: var(--card-background);
            border: 2px solid var(--primary-color);
            border-radius: 12px;
            padding: 8px 12px;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 6px;
            font-weight: 600;
            color: var(--primary-color);
            font-size: 12px;
        }

        .header-btn:hover {
            background: var(--primary-color);
            color: white;
            transform: translateY(-2px);
        }

        .language-btn {
            background: linear-gradient(135deg, var(--info-color), var(--primary-color));
            color: white;
            border: none;
        }

        /* =================== Bottom Navigation =================== */
        .bottom-navigation {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: var(--bottom-nav-height);
            background: var(--card-background);
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: space-around;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            box-shadow: 0 -4px 20px rgba(0,0,0,0.1);
        }

        .nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
            padding: 8px 4px;
            position: relative;
            color: var(--text-secondary);
        }

        .nav-item.active {
            color: var(--primary-color);
        }

        .nav-item:hover {
            color: var(--primary-color);
            transform: translateY(-2px);
        }

        .nav-item i {
            font-size: 20px;
            margin-bottom: 4px;
        }

        .nav-item span {
            font-size: 10px;
            font-weight: 600;
        }

        .nav-item.active::before {
            content: '';
            position: absolute;
            top: -1px;
            left: 50%;
            transform: translateX(-50%);
            width: 30px;
            height: 3px;
            background: var(--primary-color);
            border-radius: 0 0 10px 10px;
        }

        /* =================== Page Styles =================== */
        .page {
            display: none;
            background: var(--card-background);
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--box-shadow);
            margin-bottom: 15px;
            min-height: calc(100vh - 200px);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .page.active {
            display: block;
            animation: fadeInUp 0.4s ease-out;
        }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* =================== Search Styles =================== */
        .search-container {
            background: linear-gradient(135deg, #f8f9ff, #e6f3ff);
            padding: 20px;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .search-box {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
        }

        .search-input {
            flex: 1;
            padding: 15px 20px;
            border: 2px solid #ddd;
            border-radius: var(--border-radius);
            font-size: 16px;
            transition: var(--transition);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            background: rgba(255,255,255,0.9);
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
            background: white;
        }

        .search-btn {
            padding: 15px 25px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: var(--transition);
            white-space: nowrap;
        }

        .search-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
        }

        .quick-categories {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 20px;
        }

        .category-card {
            background: var(--card-background);
            padding: 20px;
            border-radius: var(--border-radius);
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
            border: 2px solid var(--border-color);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .category-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--box-shadow);
            border-color: var(--primary-color);
        }

        .category-card i {
            font-size: 32px;
            color: var(--primary-color);
            margin-bottom: 12px;
        }

        .category-card h4 {
            color: var(--primary-color);
            margin-bottom: 8px;
            font-size: 16px;
        }

        .category-card p {
            color: var(--text-secondary);
            font-size: 14px;
        }

        /* =================== Map Styles =================== */
        .map-container {
            position: relative;
            margin-top: 20px;
        }

        /* Map controls with toggle functionality */
        .map-controls {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            justify-content: center;
            position: relative;
        }
		
		.map-controls.fullscreen-controls {
			position: fixed;
			top: 20px;
			right: 20px;
			z-index: 2000;
			background: rgba(255,255,255,0.95);
			padding: 8px;
			border-radius: var(--border-radius);
			box-shadow: var(--box-shadow);
			backdrop-filter: blur(10px);
			-webkit-backdrop-filter: blur(10px);
		}
		
		.map-controls.fullscreen-controls .map-control-btn:not(#fullscreenBtn) {
			display: none;
		}
		
        .map-controls.hidden .map-control-btn:not(.toggle-btn) {
            display: none;
        }
		.show-controls-btn {
			position: fixed;
			top: 20px;
			right: 20px;
			padding: 10px 15px;
			background: var(--warning-color);
			color: var(--text-primary);
			border: 2px solid var(--warning-color);
			border-radius: var(--border-radius);
			cursor: pointer;
			font-size: 12px;
			font-weight: 600;
			z-index: 1001;
			box-shadow: var(--box-shadow);
			backdrop-filter: blur(10px);
			-webkit-backdrop-filter: blur(10px);
			transition: var(--transition);
			display: none;
		}

		.show-controls-btn:hover {
			transform: translateY(-2px);
			box-shadow: 0 8px 20px rgba(0,0,0,0.2);
		}

        .map-control-btn {
            padding: 10px 15px;
            background: rgba(255,255,255,0.95);
            border: 2px solid var(--primary-color);
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: var(--transition);
            font-size: 12px;
            font-weight: 600;
            color: var(--primary-color);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .map-control-btn.active {
            background: var(--primary-color);
            color: white;
        }

        .map-control-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.2);
        }

        .toggle-btn {
            background: var(--warning-color);
            color: var(--dark-color);
            border-color: var(--warning-color);
        }

        /* Room selection overlay for choosing action */
         .room-action-overlay {
            position: absolute;
            background: var(--card-background);
            border: 8px solid var(--primary-color);
            border-radius: var(--border-radius);
            padding: 15px;
            box-shadow: var(--box-shadow);
            z-index: 200;
            display: none;
            min-width: 200px;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
			top: 50%;         /* เพิ่มใหม่ */
			left: 50%;        /* เพิ่มใหม่ */
			transform: translate(-50%, -50%); /* เพิ่มใหม่ */
        }
 
        .room-action-header {
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 20px;
            font-size: 14px;
        }

        .room-action-btn {
            width: 100%;
            padding: 12px;
            margin-bottom: 8px;
            background: var(--card-background);
            color: var(--primary-color);
            border: 2px solid var(--primary-color);
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 8px;
            justify-content: center;
        }

        .room-action-btn:hover {
            background: var(--primary-color);
            color: white;
            transform: translateY(-1px);
        }

        .room-action-btn:last-child {
            margin-bottom: 0;
        }

        .map-area {
            background: #f8f9ff;
            border: 3px solid var(--primary-color);
            border-radius: var(--border-radius);
            position: relative;
            height: 400px;
            overflow: hidden;
        }

        .map-area.fullscreen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 1500;
            height: 100vh;
            border-radius: 0;
        }

        .map-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            cursor: crosshair;
            transition: var(--transition);
        }

        .map-image:hover {
            filter: brightness(1.05);
        }

        /* Route Controls - moved outside map */
        .route-controls {
            display: flex;
            gap: 8px;
            margin-top: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .route-control-btn {
            padding: 12px 20px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            transition: var(--transition);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .route-control-btn:hover {
            transform: translateY(-2px);
        }

        .route-control-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }

        .clear-route-btn {
            background: var(--danger-color);
        }

        /* Room Markers */
        .room-marker {
            position: absolute;
            width: 35px;
            height: 35px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 16px;
            transition: var(--transition);
            border: 3px solid white;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            z-index: 30;
            transform: translate(-50%, -50%);
        }

        .room-marker:hover {
            transform: translate(-50%, -50%) scale(1.3);
            z-index: 100;
            box-shadow: 0 8px 25px rgba(0,0,0,0.4);
        }

        .room-marker.highlighted {
            background: var(--danger-color);
            animation: pulse 2s infinite;
            transform: translate(-50%, -50%) scale(1.3);
        }

        .start-point-marker {
            background: var(--accent-color);
            width: 40px;
            height: 40px;
            font-size: 18px;
            animation: startPointPulse 3s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.8; }
            50% { opacity: 1; }
        }

        @keyframes startPointPulse {
            0%, 100% { 
                transform: translate(-50%, -50%) scale(1);
                box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.7);
            }
            50% { 
                transform: translate(-50%, -50%) scale(1.2);
                box-shadow: 0 0 0 15px rgba(40, 167, 69, 0);
            }
        }

        /* Route Path */
        .route-path {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 25;
        }

        .route-line {
            stroke: var(--danger-color);
            stroke-width: 5;
            fill: none;
            stroke-dasharray: 15, 10;
            animation: dash 3s linear infinite;
            filter: drop-shadow(0 0 8px rgba(220, 53, 69, 0.5));
        }

        .route-line-glow {
            stroke: rgba(220, 53, 69, 0.3);
            stroke-width: 12;
            fill: none;
            opacity: 0.6;
        }

        .waypoint-marker {
            fill: var(--warning-color);
            stroke: white;
            stroke-width: 3;
            filter: drop-shadow(0 4px 8px rgba(0,0,0,0.3));
            animation: waypoint-pulse 2s ease-in-out infinite;
        }

        @keyframes dash {
            to {
                stroke-dashoffset: -25;
            }
        }

        @keyframes waypoint-pulse {
            0%, 100% { 
                transform: scale(1);
                opacity: 0.8;
            }
            50% { 
                transform: scale(1.3);
                opacity: 1;
            }
        }

        /* FIX 5: Building Filter */
        .building-filter {
            background: rgba(255,255,255,0.9);
            padding: 15px;
            border-radius: var(--border-radius);
            margin-bottom: 15px;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .building-filter h4 {
            margin-bottom: 10px;
            color: var(--primary-color);
            font-size: 14px;
        }

        .building-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .building-btn {
            padding: 8px 12px;
            background: var(--card-background);
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            color: var(--text-primary);
            transition: var(--transition);
        }

        .building-btn.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .building-btn:hover {
            border-color: var(--primary-color);
            transform: translateY(-1px);
        }

        /* =================== Room Info Overlay =================== */
        .room-info-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.6);
            z-index: 1500;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }

        .room-info-content {
            background: var(--card-background);
            border-radius: var(--border-radius);
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 25px 50px rgba(0,0,0,0.3);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
        }

        .room-info-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 25px;
            border-radius: var(--border-radius) var(--border-radius) 0 0;
            position: relative;
        }

        .room-info-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }

        .room-info-close:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.1);
        }

        .room-info-body {
            padding: 25px;
        }

        .navigation-controls {
            display: flex;
            gap: 10px;
            margin: 20px 0;
        }

        .nav-control-btn {
            flex: 1;
            padding: 15px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: var(--transition);
            text-align: center;
        }

        .nav-control-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
        }

        .nav-control-btn:disabled {
            background: var(--text-secondary);
            cursor: not-allowed;
            transform: none;
        }

        .voice-btn {
            background: var(--accent-color);
        }

        .voice-btn.speaking {
            background: var(--danger-color);
            animation: voice-pulse 1s infinite;
        }

        @keyframes voice-pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Compact Info */
        .compact-info {
			display: flex;
			gap: 10px;
			margin-bottom: 15px;
			flex-wrap: wrap;
			justify-content: space-between;
		}

		.info-item {
			background: rgba(255,255,255,0.8);
			padding: 8px 12px;
			border-radius: 8px;
			text-align: center;
			border-left: 3px solid var(--primary-color);
			backdrop-filter: blur(10px);
			-webkit-backdrop-filter: blur(10px);
			flex: 1;
			min-width: 0;
		}

        .info-label {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 5px;
        }

        .info-value {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
        }

        /* Route Steps */
        .route-steps {
            background: var(--card-background);
            padding: 20px;
            border-radius: var(--border-radius);
            margin-top: 15px;
        }

        .route-step {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .route-step:last-child {
            border-bottom: none;
        }

        .step-number {
            background: var(--primary-color);
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            flex-shrink: 0;
        }

        .step-content {
            flex: 1;
            font-size: 14px;
        }

        .step-distance {
            background: rgba(102, 126, 234, 0.1);
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            color: var(--primary-color);
            font-weight: 600;
        }

        .step-voice-btn {
            background: var(--accent-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            cursor: pointer;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Search Results */
        .live-results {
            margin-top: 15px;
        }

        .search-result-item {
            background: var(--card-background);
            padding: 15px;
            margin-bottom: 10px;
            border-radius: var(--border-radius);
            cursor: pointer;
            border-left: 4px solid var(--primary-color);
            transition: var(--transition);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 2px solid var(--border-color);
        }

        .search-result-item:hover {
            transform: translateY(-2px);
            box-shadow: var(--box-shadow);
            border-color: var(--primary-color);
        }

        .search-result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .search-result-title {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 16px;
        }

        .search-result-code {
            background: var(--primary-color);
            color: white;
            padding: 4px 8px;
            border-radius: 8px;
            font-size: 11px;
            font-weight: 600;
        }

        .search-result-info {
            color: var(--text-secondary);
            font-size: 12px;
        }

        /* =================== Notification =================== */
        .notification {
            position: fixed;
            top: 90px;
            right: 20px;
            padding: 15px 25px;
            background: var(--accent-color);
            color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            opacity: 0;
            transform: translateX(350px);
            transition: var(--transition);
            z-index: 3000;
            max-width: 320px;
            font-size: 14px;
            font-weight: 500;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .notification.show {
            opacity: 1;
            transform: translateX(0);
        }

        .notification.error { background: var(--danger-color); }
        .notification.warning { background: var(--warning-color); color: #333; }
        .notification.info { background: var(--info-color); }

        /* =================== Hidden Elements =================== */
        .hidden {
            display: none !important;
        }

        /* =================== Responsive Design =================== */
        @media (min-width: 768px) {
            .container {
                max-width: 1200px;
                padding: 25px;
            }
            
            .quick-categories {
                grid-template-columns: repeat(4, 1fr);
            }

            .bottom-navigation {
                justify-content: center;
                gap: 40px;
                max-width: 600px;
                left: 50%;
                transform: translateX(-50%);
                border-radius: var(--border-radius) var(--border-radius) 0 0;
            }

            .nav-item {
                flex: none;
                min-width: 80px;
            }
        }
		
		@media (max-width: 480px) {
			.compact-info { gap: 5px; }
			.info-item { padding: 6px 8px; flex: 1; min-width: 0; }
			.info-label { font-size: 9px; margin-bottom: 1px; }
			.info-value { font-size: 11px; }
		}
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="header-top">
                <img class="school-logo" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='50' fill='%23667eea'/%3E%3Ctext x='50' y='60' text-anchor='middle' font-family='Arial' font-size='40' fill='white'%3E🏫%3C/text%3E%3C/svg%3E" alt="School Logo">
                
                <div class="header-title">
                    <h1 id="systemTitle">🏫 ระบบแผนที่โรงเรียนอัจฉริยะ</h1>
                    <p id="systemSubtitle">ค้นหาห้องเรียนและสถานที่ต่างๆ พร้อมระบบนำทางด้วยเสียง</p>
                </div>
                
                <button class="header-btn language-btn" onclick="toggleLanguage()">
                    <i class="fas fa-globe"></i>
                    <span id="languageText">TH</span>
                </button>
            </div>
        </div>

        <!-- ======================== Search Page ======================== -->
        <div class="page active" id="search-page">
            <div class="search-container">
                <h2><i class="fas fa-search"></i> <span data-translate="search_title">ค้นหาห้องเรียนและสถานที่</span></h2>
                
                <div class="search-box">
                    <input class="search-input" id="searchInput" 
                           onkeypress="handleSearchKeyPress(event)" 
                           oninput="liveSearch()" 
                           placeholder="🔍 พิมพ์ชื่อห้อง รหัส หรือตำแหน่ง..." 
                           data-placeholder-th="🔍 พิมพ์ชื่อห้อง รหัส หรือตำแหน่ง..."
                           data-placeholder-en="🔍 Search room, code, or location..."
                           type="text">
                    <button class="search-btn" onclick="searchRoom()">
                        <i class="fas fa-search"></i> <span data-translate="search_btn">ค้นหา</span>
                    </button>
                </div>
                
                <div class="live-results" id="liveResults"></div>
            </div>

            <div class="quick-categories">
                <div class="category-card" onclick="quickSearch('classroom')">
                    <i class="fas fa-graduation-cap"></i>
                    <h4 data-translate="category_classroom">ห้องเรียน</h4>
                    <p data-translate="category_classroom_desc">ห้องเรียนปกติทั้งหมด</p>
                </div>
                <div class="category-card" onclick="quickSearch('special')">
                    <i class="fas fa-flask"></i>
                    <h4 data-translate="category_special">ห้องพิเศษ</h4>
                    <p data-translate="category_special_desc">ห้องปฏิบัติการ</p>
                </div>
                <div class="category-card" onclick="quickSearch('facilities')">
                    <i class="fas fa-building"></i>
                    <h4 data-translate="category_facilities">สิ่งอำนวยความสะดวก</h4>
                    <p data-translate="category_facilities_desc">ห้องสมุด โรงอาหาร</p>
                </div>
                <div class="category-card" onclick="quickSearch('office')">
                    <i class="fas fa-briefcase"></i>
                    <h4 data-translate="category_office">ห้องสำนักงาน</h4>
                    <p data-translate="category_office_desc">ห้องผู้บริหาร</p>
                </div>
            </div>
        </div>

        <!-- ======================== Map Page ======================== -->
        <div class="page" id="map-page">
            <h2><i class="fas fa-map"></i> <span data-translate="map_title">แผนที่โรงเรียน</span></h2>
            
            <!-- FIX 5: Building Filter -->
            <div class="building-filter">
                <h4 data-translate="filter_building">🏢 กรองตามอาคาร</h4>
                <div class="building-buttons" id="buildingButtons">
                    <!-- Building buttons will be populated by JavaScript -->
                </div>
            </div>
            
            <!-- 1.1: Map controls with toggle -->
            <div class="map-controls" id="mapControls">
                <button class="map-control-btn toggle-btn" onclick="toggleMapControls()" id="toggleControlsBtn">
                    <i class="fas fa-eye-slash"></i> <span data-translate="hide_controls">ซ่อนปุ่ม</span>
                </button>
                <button class="map-control-btn" onclick="setMapLayout('floorplan')" id="floorplanBtn" data-layout="floorplan">
                    <i class="fas fa-th-large"></i> <span data-translate="floorplan">แผนผัง</span>
                </button>
                <button class="map-control-btn" onclick="setMapLayout('photo')" id="photoBtn" data-layout="photo">
                    <i class="fas fa-camera"></i> <span data-translate="real_photo">ภาพจริง</span>
                </button>
                <button class="map-control-btn" onclick="toggleFullscreen()" id="fullscreenBtn">
                    <i class="fas fa-expand"></i> <span data-translate="fullscreen">เต็มจอ</span>
                </button>
			 
            </div>
            
            <div class="map-container">
                <div class="map-area" id="mapArea">
                    <img id="mapImage" class="map-image" 
                         src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='800' height='600' viewBox='0 0 800 600'%3E%3Crect width='800' height='600' fill='%23f0f8ff'/%3E%3Ctext x='400' y='280' text-anchor='middle' font-family='Arial' font-size='28' fill='%23667eea' font-weight='bold'%3E🏫 แผนที่โรงเรียนอัจฉริยะ%3C/text%3E%3Ctext x='400' y='320' text-anchor='middle' font-family='Arial' font-size='16' fill='%23999'%3E(คลิกเพื่อกำหนดจุดเริ่มต้น)%3C/text%3E%3Ctext x='400' y='350' text-anchor='middle' font-family='Arial' font-size='14' fill='%23667eea'%3E📍 คลิกจุดบนแผนที่เพื่อดูข้อมูลห้อง%3C/text%3E%3C/svg%3E" 
                         alt="แผนที่โรงเรียน">
                    
                    <!-- Route Path SVG -->
                    <svg class="route-path" id="routePath" style="display: none;" viewBox="0 0 100 100" preserveAspectRatio="none">
                        <!-- Path elements will be created by JavaScript -->
                    </svg>
                    
                    <!-- 1.2: Room action selection overlay -->
                    <div class="room-action-overlay" id="roomActionOverlay">
                        <div class="room-action-header" id="roomActionHeader">เลือกการดำเนินการ</div>
                        <button class="room-action-btn" onclick="showRoomDetails()">
                            <i class="fas fa-info-circle"></i>
                            <span data-translate="view_details">ดูรายละเอียดห้อง</span>
                        </button>
                        <button class="room-action-btn" onclick="showRouteDirectly()">
                            <i class="fas fa-route"></i>
                            <span data-translate="show_route_direct">แสดงเส้นทาง</span>
                        </button>
                    </div>
                    
                    <div id="roomMarkers"></div>
                </div>
				<button class="show-controls-btn" id="showControlsBtn" onclick="showAllControls()">
				<i class="fas fa-eye"></i> <span data-translate="show_controls">แสดงปุ่ม</span>
			</button>
            </div>
            
            <!-- Route Controls moved outside map -->
            <div class="route-controls">
                <button class="route-control-btn" onclick="showRouteToSelected()" id="showRouteBtn" disabled>
                    <i class="fas fa-route"></i> <span data-translate="show_route">แสดงเส้นทาง</span>
                </button>
                <button class="route-control-btn clear-route-btn" onclick="clearRoute()" id="clearRouteBtn" style="display: none;">
                    <i class="fas fa-times"></i> <span data-translate="clear_route">ล้างเส้นทาง</span>
                </button>
                <button class="route-control-btn voice-btn" onclick="startContinuousVoiceNavigation()" id="voiceNavigationBtn" style="display: none;">
                    <i class="fas fa-volume-up"></i> <span data-translate="voice_nav">นำทางด้วยเสียง</span>
                </button>
            </div>
        </div>

        <!-- ======================== About Page ======================== -->
        <div class="page" id="about-page">
            <h2><i class="fas fa-info-circle"></i> <span data-translate="about_title">เกี่ยวกับระบบ</span></h2>
            
            <div style="background: linear-gradient(135deg, #f8f9ff, #e6f3ff); padding: 25px; border-radius: var(--border-radius); margin-bottom: 20px;">
                <h3 style="color: var(--primary-color); margin-bottom: 15px;">
                    <i class="fas fa-star"></i> <span data-translate="system_name">ระบบแผนที่โรงเรียนอัจฉริยะ v6</span>
                </h3>
                <p style="color: var(--text-secondary); line-height: 1.6; margin-bottom: 15px;" data-translate="system_desc">
                    ระบบนำทางและค้นหาห้องเรียนที่ทันสมัย ออกแบบมาสำหรับการใช้งานบนมือถือเป็นหลัก 
                    พร้อมระบบนำทางด้วยเสียงและการแสดงเส้นทางอย่างชัดเจน
                </p>
                
                <h4 style="color: var(--primary-color); margin: 20px 0 10px 0;">
                    <i class="fas fa-sparkles"></i> <span data-translate="features_title">ฟีเจอร์ใหม่ในเวอร์ชัน 6</span>
                </h4>
                <ul style="color: var(--text-secondary); line-height: 1.8; padding-left: 25px;" data-translate="features_list">
                    <li>🎯 กำหนดจุดเริ่มต้นได้ทุกตำแหน่งบนแผนที่</li>
                    <li>🛣️ แสดงเส้นทางแบบเชื่อมจุดต่อจุดอย่างชัดเจน</li>
                    <li>📱 UI ที่ปรับปรุงใหม่เหมาะกับมือถือ</li>
                    <li>🔊 ระบบนำทางด้วยเสียงที่ละเอียด</li>
                    <li>⚡ ประสิทธิภาพที่เร็วขึ้นและใช้หน่วยความจำน้อยลง</li>
                </ul>
            </div>

            <div style="background: var(--card-background); padding: 20px; border-radius: var(--border-radius); border: 2px solid var(--border-color);">
                <h4 style="color: var(--primary-color); margin-bottom: 15px;">
                    <i class="fas fa-question-circle"></i> <span data-translate="usage_title">วิธีการใช้งาน</span>
                </h4>
                
                <div style="margin-bottom: 15px;">
                    <strong style="color: var(--text-primary);" data-translate="step1_title">1. ค้นหาห้อง:</strong>
                    <p style="color: var(--text-secondary); margin: 5px 0;" data-translate="step1_desc">ใช้ช่องค้นหาหรือคลิกหมวดหมู่ด่วนเพื่อหาห้องที่ต้องการ</p>
                </div>
                
                <div style="margin-bottom: 15px;">
                    <strong style="color: var(--text-primary);" data-translate="step2_title">2. กำหนดจุดเริ่มต้น:</strong>
                    <p style="color: var(--text-secondary); margin: 5px 0;" data-translate="step2_desc">คลิกที่แผนที่เพื่อกำหนดจุดเริ่มต้นการนำทาง</p>
                </div>
                
                <div style="margin-bottom: 15px;">
                    <strong style="color: var(--text-primary);" data-translate="step3_title">3. ดูเส้นทาง:</strong>
                    <p style="color: var(--text-secondary); margin: 5px 0;" data-translate="step3_desc">เลือกห้องที่ต้องการไป คลิก "แสดงเส้นทาง" เพื่อดูเส้นทางและคำแนะนำ</p>
                </div>
                
                <div>
                    <strong style="color: var(--text-primary);" data-translate="step4_title">4. นำทางด้วยเสียง:</strong>
                    <p style="color: var(--text-secondary); margin: 5px 0;" data-translate="step4_desc">เปิดเสียงเพื่อฟังคำแนะนำการเดินทางแบบขั้นตอน</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Link (Hidden) - Removed from bottom left -->

    <!-- Bottom Navigation -->
    <div class="bottom-navigation">
        <div class="nav-item active" onclick="showPage('search')">
            <i class="fas fa-search"></i>
            <span data-translate="nav_search">ค้นหา</span>
        </div>
        <div class="nav-item" onclick="showPage('map')">
            <i class="fas fa-map"></i>
            <span data-translate="nav_map">แผนที่</span>
        </div>
        <div class="nav-item" onclick="showPage('about')">
            <i class="fas fa-info-circle"></i>
            <span data-translate="nav_about">เกี่ยวกับ</span>
        </div>
        <!-- 1.3: Admin button moved to bottom navigation -->
        <div class="nav-item" onclick="openAdminInterface()" title="Admin Panel">
            <i class="fas fa-cog"></i>
            <span data-translate="nav_admin">จัดการ</span>
        </div>
		  <div class="nav-item" onclick="openSystemPresentation()" title="พรีเซ้นท์ระบบ">
            <i class="fas fa-exclamation-triangle"></i>
            <span data-translate="nav_Present">อธิบายระบบ</span>
        </div>
		
    </div>

    <!-- Room Info Overlay -->
    <div class="room-info-overlay" id="roomInfoOverlay">
        <div class="room-info-content">
            <div class="room-info-header">
                <div class="room-title" id="overlayRoomName"></div>
                <div style="font-size: 16px; opacity: 0.9;" id="overlayRoomLocation"></div>
                <button class="room-info-close" onclick="closeRoomInfoOverlay()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="room-info-body">
                <!-- 1.3: Remove status info, enhanced room information display -->
                <div class="compact-info">
                    <div class="info-item">
                        <div class="info-label" data-translate="info_building">🏢 อาคาร</div>
                        <div class="info-value" id="overlayRoomBuilding"></div>
                    </div>
                    <div class="info-item">
                        <div class="info-label" data-translate="info_floor">📍 ชั้น</div>
                        <div class="info-value" id="overlayRoomFloor"></div>
                    </div>
                    <div class="info-item">
						<div class="info-label" data-translate="info_type">🏷️ ประเภทห้อง</div>
                        <div class="info-value" id="overlayRoomType"></div>
                    </div>
                </div>
 
                
                <div style="background: rgba(255,255,255,0.7); padding: 20px; border-radius: var(--border-radius); margin-bottom: 20px;">
                    <div style="font-size: 14px; color: var(--text-secondary); margin-bottom: 8px;" data-translate="info_description">รายละเอียด</div>
                    <div style="font-size: 16px;" id="overlayRoomDescription"></div>
                </div>
                
                <div id="overlayRoomGallery" style="display: none;">
                    <h4 style="font-size: 16px; color: var(--primary-color); margin-bottom: 15px;">
                        <i class="fas fa-images"></i> <span data-translate="room_images">รูปภาพห้อง</span>
                    </h4>
                    <div id="overlayImageGallery" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 20px;"></div>
                </div>
                
                <div class="navigation-controls">
                    <button class="nav-control-btn" onclick="generateCompleteRoute()" id="routeBtn">
                        <i class="fas fa-route"></i> <span data-translate="route_navigation">เส้นทางนำทาง</span>
                    </button>
                    <button class="nav-control-btn voice-btn" onclick="toggleVoiceNavigation()" id="overlayVoiceBtn">
                        <i class="fas fa-volume-up"></i> <span data-translate="voice">เสียง</span>
                    </button>
                </div>
                
                <div id="overlayRouteSteps"></div>
            </div>
        </div>
    </div>

    <!-- Notification -->
    <div class="notification" id="notification"></div>

    <script>
        // =================== Global Variables ===================
        let roomData = {};
        let selectedRoom = null;
        let startPoint = null;
        let voiceNavigationEnabled = false;
        let currentSpeech = null;
        let currentLanguage = 'th';
        let currentMapLayout = 'floorplan';
        let isFullscreen = false;
        let adminDataVersion = 'demo';
        
        // FIX 2: Route persistence variables
        let currentRoute = null;
        let routeDisplayed = false;
        
        // FIX 3: Voice navigation queue
        let voiceQueue = [];
        let isVoiceNavigating = false;
        let voiceTimeout = null;
        
        // FIX 5: Building filter
        let currentBuildingFilter = 'all';
        let buildingsList = [];

        // FIX 1: Language translations
        const translations = {
            th: {
                search_title: "ค้นหาห้องเรียนและสถานที่",
                search_btn: "ค้นหา",
                category_classroom: "ห้องเรียน",
                category_classroom_desc: "ห้องเรียนปกติทั้งหมด",
                category_special: "ห้องพิเศษ",
                category_special_desc: "ห้องปฏิบัติการ",
                category_facilities: "สิ่งอำนวยความสะดวก",
                category_facilities_desc: "ห้องสมุด โรงอาหาร",
                category_office: "ห้องสำนักงาน",
                category_office_desc: "ห้องผู้บริหาร",
                map_title: "แผนที่โรงเรียน",
                filter_building: "🏢 กรองตามอาคาร",
                hide_controls: "ซ่อนปุ่ม",
                show_controls: "แสดงปุ่ม",
                floorplan: "แผนผัง",
                real_photo: "ภาพจริง",
                fullscreen: "เต็มจอ",
                exit_fullscreen: "ออกจากเต็มจอ",
                show_route: "แสดงเส้นทาง",
                clear_route: "ล้างเส้นทาง",
                voice_nav: "นำทางด้วยเสียง",
                about_title: "เกี่ยวกับระบบ",
                system_name: "ระบบแผนที่โรงเรียนอัจฉริยะ v6",
                system_desc: "ระบบนำทางและค้นหาห้องเรียนที่ทันสมัย ออกแบบมาสำหรับการใช้งานบนมือถือเป็นหลัก พร้อมระบบนำทางด้วยเสียงและการแสดงเส้นทางอย่างชัดเจน",
                features_title: "ฟีเจอร์ใหม่ในเวอร์ชัน 6",
                usage_title: "วิธีการใช้งาน",
                step1_title: "1. ค้นหาห้อง:",
                step1_desc: "ใช้ช่องค้นหาหรือคลิกหมวดหมู่ด่วนเพื่อหาห้องที่ต้องการ",
                step2_title: "2. กำหนดจุดเริ่มต้น:",
                step2_desc: "คลิกที่แผนที่เพื่อกำหนดจุดเริ่มต้นการนำทาง",
                step3_title: "3. ดูเส้นทาง:",
                step3_desc: "เลือกห้องที่ต้องการไป คลิก \"แสดงเส้นทาง\" เพื่อดูเส้นทางและคำแนะนำ",
                step4_title: "4. นำทางด้วยเสียง:",
                step4_desc: "เปิดเสียงเพื่อฟังคำแนะนำการเดินทางแบบขั้นตอน",
                nav_search: "ค้นหา",
                nav_map: "แผนที่",
                nav_about: "เกี่ยวกับ",
                nav_admin: "จัดการ",
				nav_Present: "อธิบายระบบ",
                info_building: "อาคาร",
                info_floor: "ชั้น",
                info_type: "ประเภทห้อง",
                info_description: "รายละเอียด",
                room_images: "รูปภาพห้อง",
                route_navigation: "เส้นทางนำทาง",
                voice: "เสียง",
                view_details: "ดูรายละเอียดห้อง",
                show_route_direct: "แสดงเส้นทาง",
                select_action: "เลือกการดำเนินการ"
            },
            en: {
                search_title: "Search Classrooms and Places",
                search_btn: "Search",
                category_classroom: "Classrooms",
                category_classroom_desc: "All regular classrooms",
                category_special: "Special Rooms",
                category_special_desc: "Laboratories",
                category_facilities: "Facilities",
                category_facilities_desc: "Library, Cafeteria",
                category_office: "Offices",
                category_office_desc: "Administrative offices",
                map_title: "School Map",
                filter_building: "🏢 Filter by Building",
                hide_controls: "Hide Controls",
                show_controls: "Show Controls",
                floorplan: "Floor Plan",
                real_photo: "Real Photo",
                fullscreen: "Fullscreen",
                exit_fullscreen: "Exit Fullscreen",
                show_route: "Show Route",
                clear_route: "Clear Route",
                voice_nav: "Voice Navigation",
                about_title: "About System",
                system_name: "Smart School Map System v6",
                system_desc: "Modern classroom search and navigation system designed primarily for mobile use with voice navigation and clear route display.",
                features_title: "New Features in Version 6",
                usage_title: "How to Use",
                step1_title: "1. Search Rooms:",
                step1_desc: "Use search box or click quick categories to find desired rooms",
                step2_title: "2. Set Starting Point:",
                step2_desc: "Click on the map to set navigation starting point",
                step3_title: "3. View Route:",
                step3_desc: "Select destination room, click \"Show Route\" to see path and directions",
                step4_title: "4. Voice Navigation:",
                step4_desc: "Enable sound to hear step-by-step navigation instructions",
                nav_search: "Search",
                nav_map: "Map",
                nav_about: "About",
                nav_admin: "Admin",
				nav_Present: "อธิบายระบบ",
                info_building: "Building",
                info_floor: "Floor",
                info_type: "Room Type",
                info_description: "Description",
                room_images: "Room Images",
                route_navigation: "Route Navigation",
                voice: "Voice",
                view_details: "View Room Details",
                show_route_direct: "Show Route",
                select_action: "Select Action"
            }
        };

        // =================== Sample Data ===================
        const sampleRoomData = {
            'R001': {
                code: 'R001',
                name: 'ห้องเรียน ม.1/1',
                building: 'B001',
                location: 'ชั้น 1',
                description: 'ห้องเรียนปกติสำหรับนักเรียนชั้นมัธยมศึกษาปีที่ 1',
                hours: '08:00 - 16:30',
                status: 'active',
                x: 20, y: 30,
                images: ['https://picsum.photos/400/300?random=1']
            },
            'R002': {
                code: 'R002',
                name: 'ห้องเรียน ม.1/2',
                building: 'B001',
                location: 'ชั้น 1',
                description: 'ห้องเรียนปกติสำหรับนักเรียนชั้นมัธยมศึกษาปีที่ 1',
                hours: '08:00 - 16:30',
                status: 'active',
                x: 45, y: 30,
                images: ['https://picsum.photos/400/300?random=2']
            },
            'C001': {
                code: 'C001',
                name: 'ห้องคอมพิวเตอร์ 1',
                building: 'B002',
                location: 'ชั้น 2',
                description: 'ห้องปฏิบัติการคอมพิวเตอร์ มีเครื่องคอมพิวเตอร์ 30 เครื่อง',
                hours: '08:00 - 17:00',
                status: 'active',
                x: 25, y: 65,
                images: ['https://picsum.photos/400/300?random=3']
            },
            'L001': {
                code: 'L001',
                name: 'ห้องสมุดหลัก',
                building: 'B003',
                location: 'ชั้น 1',
                description: 'ห้องสมุดหลักของโรงเรียน มีหนังสือมากกว่า 15,000 เล่ม',
                hours: '07:30 - 18:00',
                status: 'active',
                x: 80, y: 70,
                images: ['https://picsum.photos/400/300?random=4']
            },
            'CAFE001': {
                code: 'CAFE001',
                name: 'โรงอาหารหลัก',
                building: 'B004',
                location: 'ชั้น 1',
                description: 'โรงอาหารหลักของโรงเรียน รองรับนักเรียน 500 คน',
                hours: '06:30 - 14:00',
                status: 'active',
                x: 85, y: 40,
                images: ['https://picsum.photos/400/300?random=5']
            }
        };

        const sampleBuildingsData = {
            'B001': { code: 'B001', name: 'อาคารเรียน 1' },
            'B002': { code: 'B002', name: 'อาคารเรียน 2' },
            'B003': { code: 'B003', name: 'อาคารสำนักงาน' },
            'B004': { code: 'B004', name: 'อาคารสิ่งอำนวยความสะดวก' }
        };

        // =================== FIX 1: Language System ===================
        
        function toggleLanguage() {
            currentLanguage = currentLanguage === 'th' ? 'en' : 'th';
            localStorage.setItem('preferredLanguage', currentLanguage);
            updateLanguageButton();
            updateAllTranslations();
            updateSearchPlaceholder();
            showNotification(
                currentLanguage === 'th' ? '🇹🇭 เปลี่ยนเป็นภาษาไทย' : '🇺🇸 Changed to English',
                'success'
            );
        }

        function updateLanguageButton() {
            const languageText = document.getElementById('languageText');
            if (languageText) {
                languageText.textContent = currentLanguage === 'th' ? 'TH' : 'EN';
            }
        }

        function updateAllTranslations() {
            const elementsToTranslate = document.querySelectorAll('[data-translate]');
            elementsToTranslate.forEach(element => {
                const key = element.getAttribute('data-translate');
                if (translations[currentLanguage] && translations[currentLanguage][key]) {
                    if (element.tagName === 'UL' && key === 'features_list') {
                        // Special handling for features list
                        if (currentLanguage === 'en') {
                            element.innerHTML = `
                                <li>🎯 Set starting point anywhere on the map</li>
                                <li>🛣️ Clear point-to-point route display</li>
                                <li>📱 Mobile-optimized UI</li>
                                <li>🔊 Detailed voice navigation system</li>
                                <li>⚡ Better performance and lower memory usage</li>
                            `;
                        } else {
                            element.innerHTML = `
                                <li>🎯 กำหนดจุดเริ่มต้นได้ทุกตำแหน่งบนแผนที่</li>
                                <li>🛣️ แสดงเส้นทางแบบเชื่อมจุดต่อจุดอย่างชัดเจน</li>
                                <li>📱 UI ที่ปรับปรุงใหม่เหมาะกับมือถือ</li>
                                <li>🔊 ระบบนำทางด้วยเสียงที่ละเอียด</li>
                                <li>⚡ ประสิทธิภาพที่เร็วขึ้นและใช้หน่วยความจำน้อยลง</li>
                            `;
                        }
                    } else {
                        element.textContent = translations[currentLanguage][key];
                    }
                }
            });
            
            // Update title and subtitle
            const systemTitle = document.getElementById('systemTitle');
            const systemSubtitle = document.getElementById('systemSubtitle');
            
            if (currentLanguage === 'en') {
                if (systemTitle) systemTitle.textContent = '🏫 Smart School Map System';
                if (systemSubtitle) systemSubtitle.textContent = 'Find classrooms and navigate with voice guidance';
            } else {
                if (systemTitle) systemTitle.textContent = '🏫 ระบบแผนที่โรงเรียนอัจฉริยะ';
                if (systemSubtitle) systemSubtitle.textContent = 'ค้นหาห้องเรียนและสถานที่ต่างๆ พร้อมระบบนำทางด้วยเสียง';
            }
        }

        function updateSearchPlaceholder() {
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                const placeholder = currentLanguage === 'th' 
                    ? searchInput.getAttribute('data-placeholder-th')
                    : searchInput.getAttribute('data-placeholder-en');
                searchInput.placeholder = placeholder;
            }
        }

        // =================== Data Management ===================
        
        function loadRoomDataFromAdmin() {
            try {
                const systemVersion = localStorage.getItem('systemVersion') || 'demo';
                adminDataVersion = systemVersion;
                
                if (systemVersion === 'demo') {
                    const adminRooms = localStorage.getItem('roomsData');
                    if (adminRooms) {
                        roomData = JSON.parse(adminRooms);
                    } else {
                        roomData = { ...sampleRoomData };
                    }
                } else {
                    const adminRooms = localStorage.getItem('roomsData');
                    if (adminRooms) {
                        roomData = JSON.parse(adminRooms);
                    } else {
                        roomData = { ...sampleRoomData };
                    }
                }
                
                // FIX 5: Extract buildings list
                extractBuildingsList();
                
                showDataSourceStatus();
                
            } catch (error) {
                console.error('❌ Error loading admin data:', error);
                roomData = { ...sampleRoomData };
                extractBuildingsList();
                showNotification('⚠️ ใช้ข้อมูลตัวอย่าง', 'warning');
            }
        }

        function showDataSourceStatus() {
            const statusMessage = adminDataVersion === 'demo' 
                ? '🎮 โหลดข้อมูลจาก Admin (Demo Mode)'
                : '🔴 เชื่อมต่อข้อมูล Live จาก Admin';
            
            setTimeout(() => {
                showNotification(statusMessage, 'info');
            }, 2000);
        }

        // =================== FIX 5: Building Filter System ===================
        
        function extractBuildingsList() {
            const buildings = new Set();
            Object.values(roomData).forEach(room => {
                if (room.building) {
                    buildings.add(room.building);
                }
            });
            buildingsList = Array.from(buildings).sort();
            updateBuildingFilter();
        }

        function updateBuildingFilter() {
            const container = document.getElementById('buildingButtons');
            if (!container) return;
            
            container.innerHTML = `
                <button class="building-btn ${currentBuildingFilter === 'all' ? 'active' : ''}" 
                        onclick="filterByBuilding('all')">
                    ${currentLanguage === 'th' ? 'ทั้งหมด' : 'All'}
                </button>
                ${buildingsList.map(building => {
                    // Get building name from admin data or use code
                    const buildingData = JSON.parse(localStorage.getItem('buildingsData') || '{}');
                    const buildingName = buildingData[building]?.name || building;
                    
                    return `
                        <button class="building-btn ${currentBuildingFilter === building ? 'active' : ''}" 
                                onclick="filterByBuilding('${building}')">
                            ${buildingName}
                        </button>
                    `;
                }).join('')}
            `;
        }

        function filterByBuilding(building) {
            currentBuildingFilter = building;
            updateBuildingFilter();
            updateRoomMarkers();
            
            const message = building === 'all' 
                ? (currentLanguage === 'th' ? '🏢 แสดงห้องทั้งหมด' : '🏢 Showing all rooms')
                : (currentLanguage === 'th' ? `🏢 กรองอาคาร: ${building}` : `🏢 Filtered: ${building}`);
            
            showNotification(message, 'info');
        }

        // =================== Utility Functions ===================
        
        function getRoomIcon(roomName) {
            const lowerName = roomName.toLowerCase();
            if (lowerName.includes('computer') || lowerName.includes('คอมพิวเตอร์')) return '💻';
            if (lowerName.includes('library') || lowerName.includes('สมุด')) return '📚';
            if (lowerName.includes('cafeteria') || lowerName.includes('อาหาร')) return '🍽️';
            if (lowerName.includes('music') || lowerName.includes('ดนตรี')) return '🎵';
            if (lowerName.includes('art') || lowerName.includes('ศิลปะ')) return '🎨';
            if (lowerName.includes('gym') || lowerName.includes('ยิม')) return '🏃';
            if (lowerName.includes('lab') || lowerName.includes('ปฏิบัติการ') || lowerName.includes('เคมี') || lowerName.includes('ฟิสิกส์')) return '🧪';
            if (lowerName.includes('office') || lowerName.includes('สำนักงาน') || lowerName.includes('ผู้อำนวยการ')) return '🏢';
            return '🎓';
        }

        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            if (!notification) return;
            
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        function openAdminInterface() {
            // Update this URL after deployment
            window.open('./admin.html', '_blank');
        }
		function openSystemPresentation() {
            // Update this URL after deployment
            window.open('./SystemPresentation.html', '_blank');
        }


        // =================== Page Management ===================
        
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            const targetPage = document.getElementById(pageId + '-page');
            if (targetPage) {
                targetPage.classList.add('active');
            }
            
            if (pageId === 'search') {
                document.querySelector('.nav-item:nth-child(1)').classList.add('active');
            } else if (pageId === 'map') {
                document.querySelector('.nav-item:nth-child(2)').classList.add('active');
                setTimeout(() => {
                    updateRoomMarkers();
                }, 100);
            } else if (pageId === 'about') {
                document.querySelector('.nav-item:nth-child(3)').classList.add('active');
            }
        }

        // =================== Search Functions ===================
        
        function handleSearchKeyPress(event) {
            if (event.key === 'Enter') {
                searchRoom();
            }
        }

        function liveSearch() {
            const searchInput = document.getElementById('searchInput');
            if (!searchInput) return;
            
            const searchTerm = searchInput.value.toLowerCase().trim();
            const resultsContainer = document.getElementById('liveResults');
            
            if (!resultsContainer) return;
            
            if (!searchTerm) {
                resultsContainer.innerHTML = '';
                return;
            }
            
            const results = searchRooms(searchTerm);
            displaySearchResults(results);
        }

        function searchRoom() {
            const searchInput = document.getElementById('searchInput');
            if (!searchInput) return;
            
            const searchTerm = searchInput.value.toLowerCase().trim();
            
            if (!searchTerm) {
                showNotification('❌ กรุณาใส่คำค้นหา', 'error');
                return;
            }
            
            const results = searchRooms(searchTerm);
            displaySearchResults(results);
        }

        function searchRooms(searchTerm) {
            const rooms = Object.values(roomData);
            return rooms.filter(room => {
                if (room.status !== 'active') return false;
                
                const searchFields = [
                    room.name.toLowerCase(),
                    room.code.toLowerCase(),
                    room.location.toLowerCase(),
                    room.building.toLowerCase(),
                    room.description.toLowerCase()
                ];
                return searchFields.some(field => field.includes(searchTerm));
            });
        }

        function displaySearchResults(results) {
            const resultsContainer = document.getElementById('liveResults');
            if (!resultsContainer) return;
            
            if (results.length > 0) {
                resultsContainer.innerHTML = results.map(room => {
                    // Get building name from admin data
                    const buildingData = JSON.parse(localStorage.getItem('buildingsData') || '{}');
                    const buildingName = buildingData[room.building]?.name || room.building;
                    
                    return `
                        <div class="search-result-item" onclick="viewOnMap('${room.code}')">
                            <div class="search-result-header">
                                <div class="search-result-title">
                                    ${getRoomIcon(room.name)} ${room.name}
                                </div>
                                <div class="search-result-code">${room.code}</div>
                            </div>
                            <div class="search-result-info">
                                ${buildingName} - ${room.location}
                            </div>
                        </div>
                    `;
                }).join('');
            } else {
                const noResultsText = currentLanguage === 'th' ? 'ไม่พบผลการค้นหา' : 'No results found';
                resultsContainer.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
                        <div style="font-size: 48px; margin-bottom: 15px; opacity: 0.7;">🔍</div>
                        <p>${noResultsText}</p>
                    </div>
                `;
            }
        }

        function quickSearch(category) {
            let searchResults = [];
            
            switch(category) {
                case 'classroom':
                    searchResults = Object.values(roomData).filter(room => 
                        room.status === 'active' && (
                        room.name.includes('ห้องเรียน') || room.name.includes('Classroom') || room.name.includes('ม.'))
                    );
                    break;
                case 'special':
                    searchResults = Object.values(roomData).filter(room => 
                        room.status === 'active' && (
                        room.name.includes('คอมพิวเตอร์') || room.name.includes('Computer') ||
                        room.name.includes('ปฏิบัติการ') || room.name.includes('Lab'))
                    );
                    break;
                case 'facilities':
                    searchResults = Object.values(roomData).filter(room => 
                        room.status === 'active' && (
                        room.name.includes('สมุด') || room.name.includes('Library') ||
                        room.name.includes('อาหาร') || room.name.includes('Cafeteria'))
                    );
                    break;
                case 'office':
                    searchResults = Object.values(roomData).filter(room => 
                        room.status === 'active' && (
                        room.name.includes('สำนักงาน') || room.name.includes('Office'))
                    );
                    break;
            }
            
            displaySearchResults(searchResults);
        }

        // =================== Map Functions ===================
        
        function viewOnMap(roomCode) {
            showPage('map');
            setTimeout(() => {
                highlightRoom(roomCode);
                showRoomInfoOverlay(roomCode);
            }, 300);
        }

        function highlightRoom(roomCode) {
            document.querySelectorAll('.room-marker').forEach(marker => {
                marker.classList.remove('highlighted');
            });
            
            const targetMarker = document.querySelector(`[data-room="${roomCode}"]`);
            if (targetMarker) {
                targetMarker.classList.add('highlighted');
                selectedRoom = roomCode;
                
                setTimeout(() => {
                    targetMarker.classList.remove('highlighted');
                }, 3000);
            }
        }

        // 1.1: Toggle map controls visibility
        function toggleMapControls() {
			const mapControls = document.getElementById('mapControls');
			const toggleBtn = document.getElementById('toggleControlsBtn');
			const showControlsBtn = document.getElementById('showControlsBtn');
			
			if (!mapControls || !toggleBtn) return;
			
			const isHidden = mapControls.classList.contains('hidden');
			
			if (isHidden) {
				// Show controls
				mapControls.classList.remove('hidden');
				toggleBtn.innerHTML = `<i class="fas fa-eye-slash"></i> <span data-translate="hide_controls">${currentLanguage === 'th' ? 'ซ่อนปุ่ม' : 'Hide Controls'}</span>`;
				if (showControlsBtn) {
					showControlsBtn.style.display = 'none';
				}
				showNotification(
					currentLanguage === 'th' ? '👁️ แสดงปุ่มควบคุม' : '👁️ Controls shown',
					'info'
				);
			} else {
				// Hide controls
				mapControls.classList.add('hidden');
				toggleBtn.innerHTML = `<i class="fas fa-eye"></i> <span data-translate="show_controls">${currentLanguage === 'th' ? 'แสดงปุ่ม' : 'Show Controls'}</span>`;
				if (showControlsBtn) {
					showControlsBtn.style.display = 'block';
				}
				showNotification(
					currentLanguage === 'th' ? '🙈 ซ่อนปุ่มควบคุม' : '🙈 Controls hidden',
					'info'
				);
			}
		}
		
		function showAllControls() {
			const mapControls = document.getElementById('mapControls');
			const toggleBtn = document.getElementById('toggleControlsBtn');
			const showControlsBtn = document.getElementById('showControlsBtn');
			
			if (!mapControls || !toggleBtn) return;
			
			mapControls.classList.remove('hidden');
			toggleBtn.innerHTML = `<i class="fas fa-eye-slash"></i> <span data-translate="hide_controls">${currentLanguage === 'th' ? 'ซ่อนปุ่ม' : 'Hide Controls'}</span>`;
			if (showControlsBtn) {
				showControlsBtn.style.display = 'none';
			}
			showNotification(
				currentLanguage === 'th' ? '👁️ แสดงปุ่มควบคุมทั้งหมด' : '👁️ All controls shown',
				'info'
			);
		}



        // 1.1: Set map layout (floorplan/photo)
        function setMapLayout(layout) {
            currentMapLayout = layout;
            
            document.querySelectorAll('.map-control-btn[data-layout]').forEach(btn => {
                btn.classList.remove('active');
            });
            
            const targetBtn = document.querySelector(`[data-layout="${layout}"]`);
            if (targetBtn) {
                targetBtn.classList.add('active');
            }
            
            // In real implementation, would switch between different map images
            const mapImage = document.getElementById('mapImage');
            if (mapImage) {
                if (layout === 'photo') {
                    // Replace with actual photo map
                    showNotification(
                        currentLanguage === 'th' ? '📸 เปลี่ยนเป็นภาพจริง' : '📸 Switched to photo view',
                        'success'
                    );
                } else {
                    // Use floorplan
                    showNotification(
                        currentLanguage === 'th' ? '📐 เปลี่ยนเป็นแผnผัง' : '📐 Switched to floor plan',
                        'success'
                    );
                }
            }
        }

        // 1.1: Toggle fullscreen mode
		// หาฟังก์ชันนี้และแทนที่ทั้งหมด
		 function toggleFullscreen() {
			const mapArea = document.getElementById('mapArea');
			const fullscreenBtn = document.getElementById('fullscreenBtn');
			const mapControls = document.getElementById('mapControls');
			const showControlsBtn = document.getElementById('showControlsBtn');
			
			if (!mapArea || !fullscreenBtn) return;
			
			if (isFullscreen) {
				// Exit fullscreen
				mapArea.classList.remove('fullscreen');
				if (mapControls) {
					mapControls.classList.remove('fullscreen-controls');
				}
				if (showControlsBtn) {
					showControlsBtn.style.display = 'none';
				}
				fullscreenBtn.innerHTML = `<i class="fas fa-expand"></i> <span data-translate="fullscreen">${currentLanguage === 'th' ? 'เต็มจอ' : 'Fullscreen'}</span>`;
				isFullscreen = false;
				showNotification(
					currentLanguage === 'th' ? '📱 ออกจากโหมดเต็มจอ' : '📱 Exited fullscreen mode',
					'info'
				);
			} else {
				// Enter fullscreen
				mapArea.classList.add('fullscreen');
				if (mapControls) {
					mapControls.classList.add('fullscreen-controls');
					mapControls.classList.remove('hidden');
				}
				if (showControlsBtn) {
					showControlsBtn.style.display = 'none';
				}
				fullscreenBtn.innerHTML = `<i class="fas fa-compress"></i> <span data-translate="exit_fullscreen">${currentLanguage === 'th' ? 'ออกจากเต็มจอ' : 'Exit Fullscreen'}</span>`;
				isFullscreen = true;
				showNotification(
					currentLanguage === 'th' ? '🖥️ เข้าโหมดเต็มจอ' : '🖥️ Entered fullscreen mode',
					'info'
				);
			}
		}
        // =================== FIX 2: Route Persistence Functions ===================
        
        function showRouteToSelected() {
            if (!selectedRoom || !roomData[selectedRoom]) {
                const message = currentLanguage === 'th' 
                    ? '❌ กรุณาเลือกห้องที่ต้องการนำทางก่อน' 
                    : '❌ Please select a destination room first';
                showNotification(message, 'error');
                return;
            }
            
            if (!startPoint) {
                const message = currentLanguage === 'th' 
                    ? '💡 คลิกที่แผนที่เพื่อตั้งจุดเริ่มต้นก่อน' 
                    : '💡 Click on map to set starting point first';
                showNotification(message, 'info');
                return;
            }
            
            const room = roomData[selectedRoom];
            currentRoute = { start: startPoint, destination: room };
            
            // 1.1: Ensure route displays properly
            showStraightRoutePath(startPoint, room);
            routeDisplayed = true;
            updateRouteControls(true);
            
            const message = currentLanguage === 'th' 
                ? `🧭 แสดงเส้นทางไปยัง ${room.name}` 
                : `🧭 Route to ${room.name}`;
            showNotification(message, 'success');
            
            // Show voice navigation button
            const voiceBtn = document.getElementById('voiceNavigationBtn');
            if (voiceBtn) {
                voiceBtn.style.display = 'block';
            }
        }

        // 1.1: Fix route display - create straight path and ensure it shows
        function showStraightRoutePath(start, destination) {
            const routePath = document.getElementById('routePath');
            if (!routePath) {
                console.error('Route path element not found');
                return;
            }
            
            // Clear any existing path
            routePath.innerHTML = '';
            
            // 1.1: Create straight line path connecting center points
            const startX = parseFloat(start.x);
            const startY = parseFloat(start.y);
            const endX = parseFloat(destination.x);
            const endY = parseFloat(destination.y);
            
            const path = `M ${startX} ${startY} L ${endX} ${endY}`;
            
            console.log('Creating route path:', path, 'from', {startX, startY}, 'to', {endX, endY});
            
            // Create glow effect (background line)
            const glowLine = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            glowLine.setAttribute('d', path);
            glowLine.setAttribute('stroke', 'rgba(220, 53, 69, 0.3)');
            glowLine.setAttribute('stroke-width', '12');
            glowLine.setAttribute('fill', 'none');
            glowLine.setAttribute('opacity', '0.6');
            routePath.appendChild(glowLine);
            
            // Create main line
            const mainLine = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            mainLine.setAttribute('d', path);
            mainLine.setAttribute('stroke', '#dc3545');
            mainLine.setAttribute('stroke-width', '5');
            mainLine.setAttribute('fill', 'none');
            mainLine.setAttribute('stroke-dasharray', '15, 10');
            mainLine.style.filter = 'drop-shadow(0 0 8px rgba(220, 53, 69, 0.5))';
            mainLine.style.animation = 'dash 3s linear infinite';
            routePath.appendChild(mainLine);
            
            // Set viewBox to match the map coordinates
            routePath.setAttribute('viewBox', '0 0 100 100');
            routePath.style.display = 'block';
            
            console.log('Route path created and displayed');
            
            // Animate path drawing
            try {
                const pathLength = mainLine.getTotalLength();
                mainLine.style.strokeDasharray = pathLength + ' ' + pathLength;
                mainLine.style.strokeDashoffset = pathLength;
                
                setTimeout(() => {
                    mainLine.style.transition = 'stroke-dashoffset 1.5s ease-in-out';
                    mainLine.style.strokeDashoffset = '0';
                    
                    setTimeout(() => {
                        mainLine.style.transition = '';
                        mainLine.style.strokeDasharray = '15, 10';
                        mainLine.style.strokeDashoffset = '0';
                        mainLine.style.animation = 'dash 3s linear infinite';
                    }, 1500);
                }, 100);
            } catch (error) {
                console.warn('Path animation failed:', error);
                // Continue without animation
            }
        }

        function clearRoute() {
            hideRoutePath();
            currentRoute = null;
            routeDisplayed = false;
            updateRouteControls(false);
            
            const voiceBtn = document.getElementById('voiceNavigationBtn');
            if (voiceBtn) {
                voiceBtn.style.display = 'none';
            }
            
            // Stop voice navigation if active
            stopVoiceNavigation();
            
            const message = currentLanguage === 'th' ? '🗑️ ล้างเส้นทางเรียบร้อย' : '🗑️ Route cleared';
            showNotification(message, 'success');
        }

        function updateRouteControls(showRoute) {
            const showRouteBtn = document.getElementById('showRouteBtn');
            const clearRouteBtn = document.getElementById('clearRouteBtn');
            
            if (showRouteBtn) {
                showRouteBtn.disabled = !startPoint || !selectedRoom;
            }
            
            if (clearRouteBtn) {
                clearRouteBtn.style.display = showRoute ? 'block' : 'none';
            }
        }

        function generateCompleteRoute() {
            showRouteToSelected();
        }

        // Remove old curved path and replace with simple straight line
        function showModernRoutePath(start, destination) {
            // Use the new straight path function
            showStraightRoutePath(start, destination);
        }

        function hideRoutePath() {
            const routePath = document.getElementById('routePath');
            if (routePath) {
                routePath.style.display = 'none';
                routePath.innerHTML = '';
            }
        }

        // =================== FIX 3: Continuous Voice Navigation ===================
        
        function startContinuousVoiceNavigation() {
            if (!currentRoute) {
                const message = currentLanguage === 'th' 
                    ? '❌ ยังไม่มีเส้นทางสำหรับการนำทาง' 
                    : '❌ No route available for navigation';
                showNotification(message, 'error');
                return;
            }
            
            if (isVoiceNavigating) {
                stopVoiceNavigation();
                return;
            }
            
            if (!('speechSynthesis' in window)) {
                const message = currentLanguage === 'th' 
                    ? '❌ เบราว์เซอร์ไม่รองรับการอ่านเสียง' 
                    : '❌ Browser does not support speech synthesis';
                showNotification(message, 'error');
                return;
            }
            
            generateVoiceQueue();
            startVoiceSequence();
        }

        function generateVoiceQueue() {
            voiceQueue = [];
            
            if (!currentRoute) return;
            
            const { start, destination } = currentRoute;
            const deltaX = destination.x - start.x;
            const deltaY = destination.y - start.y;
            const distance = Math.round(Math.sqrt(deltaX * deltaX + deltaY * deltaY) * 2);
            
            let direction = '';
            if (Math.abs(deltaX) > Math.abs(deltaY)) {
                direction = deltaX > 0 
                    ? (currentLanguage === 'th' ? 'ทางขวา' : 'to the right')
                    : (currentLanguage === 'th' ? 'ทางซ้าย' : 'to the left');
            } else {
                direction = deltaY > 0 
                    ? (currentLanguage === 'th' ? 'ด้านล่าง' : 'downward')
                    : (currentLanguage === 'th' ? 'ด้านบน' : 'upward');
            }
            
            if (currentLanguage === 'th') {
                voiceQueue = [
                    'เริ่มต้นการนำทาง',
                    `เดินไป${direction} ประมาณ ${distance} เมตร`,
                    `มองหาอาคาร ${destination.building}`,
                    `เข้าสู่ ${destination.name}`,
                    'ถึงจุดหมายแล้ว การนำทางเสร็จสิ้น'
                ];
            } else {
                voiceQueue = [
                    'Starting navigation',
                    `Walk ${direction} approximately ${distance} meters`,
                    `Look for building ${destination.building}`,
                    `Enter ${destination.name}`,
                    'Destination reached. Navigation complete'
                ];
            }
        }

        function startVoiceSequence() {
            if (voiceQueue.length === 0) return;
            
            isVoiceNavigating = true;
            updateVoiceButton(true);
            
            const message = currentLanguage === 'th' 
                ? '🔊 เริ่มการนำทางด้วยเสียง' 
                : '🔊 Starting voice navigation';
            showNotification(message, 'success');
            
            speakNextInQueue();
        }

        function speakNextInQueue() {
            if (voiceQueue.length === 0 || !isVoiceNavigating) {
                finishVoiceNavigation();
                return;
            }
            
            const text = voiceQueue.shift();
            
            if (currentSpeech) {
                speechSynthesis.cancel();
            }
            
            currentSpeech = new SpeechSynthesisUtterance(text);
            currentSpeech.lang = currentLanguage === 'th' ? 'th-TH' : 'en-US';
            currentSpeech.rate = 0.8;
            currentSpeech.pitch = 1.0;
            
            currentSpeech.onend = () => {
                if (isVoiceNavigating) {
                    // Wait 2 seconds before next instruction
                    voiceTimeout = setTimeout(() => {
                        speakNextInQueue();
                    }, 2000);
                }
            };
            
            currentSpeech.onerror = () => {
                finishVoiceNavigation();
            };
            
            speechSynthesis.speak(currentSpeech);
        }

        function stopVoiceNavigation() {
            isVoiceNavigating = false;
            voiceQueue = [];
            
            if (voiceTimeout) {
                clearTimeout(voiceTimeout);
                voiceTimeout = null;
            }
            
            if (currentSpeech) {
                speechSynthesis.cancel();
                currentSpeech = null;
            }
            
            updateVoiceButton(false);
            
            const message = currentLanguage === 'th' 
                ? '🔇 หยุดการนำทางด้วยเสียง' 
                : '🔇 Voice navigation stopped';
            showNotification(message, 'warning');
        }

        function finishVoiceNavigation() {
            isVoiceNavigating = false;
            updateVoiceButton(false);
            
            const message = currentLanguage === 'th' 
                ? '✅ การนำทางด้วยเสียงเสร็จสิ้น' 
                : '✅ Voice navigation completed';
            showNotification(message, 'success');
        }

        function updateVoiceButton(isActive) {
            const voiceBtn = document.getElementById('voiceNavigationBtn');
            if (!voiceBtn) return;
            
            if (isActive) {
                voiceBtn.classList.add('speaking');
                voiceBtn.innerHTML = `
                    <i class="fas fa-stop"></i> 
                    <span>${currentLanguage === 'th' ? 'หยุดเสียง' : 'Stop Voice'}</span>
                `;
            } else {
                voiceBtn.classList.remove('speaking');
                voiceBtn.innerHTML = `
                    <i class="fas fa-volume-up"></i> 
                    <span data-translate="voice_nav">${currentLanguage === 'th' ? 'นำทางด้วยเสียง' : 'Voice Navigation'}</span>
                `;
            }
        }

        // Legacy voice functions for compatibility
        function toggleVoiceNavigation() {
            if (isVoiceNavigating) {
                stopVoiceNavigation();
            } else {
                startContinuousVoiceNavigation();
            }
        }

        function speakStep(text) {
            if (!('speechSynthesis' in window)) {
                const message = currentLanguage === 'th' 
                    ? '❌ เบราว์เซอร์ไม่รองรับการอ่านเสียง' 
                    : '❌ Browser does not support speech synthesis';
                showNotification(message, 'error');
                return;
            }
            
            if (currentSpeech) {
                speechSynthesis.cancel();
            }
            
            currentSpeech = new SpeechSynthesisUtterance(text);
            currentSpeech.lang = currentLanguage === 'th' ? 'th-TH' : 'en-US';
            currentSpeech.rate = 0.8;
            currentSpeech.pitch = 1.0;
            
            speechSynthesis.speak(currentSpeech);
        }

        function speakText(text) {
            speakStep(text);
        }

        // =================== Room Markers ===================
        
        let selectedRoomForAction = null;
        
        function updateRoomMarkers() {
            const markersContainer = document.getElementById('roomMarkers');
            if (!markersContainer) return;
            
            let activeRooms = Object.values(roomData).filter(room => room.status === 'active');
            
            // FIX 5: Apply building filter
            if (currentBuildingFilter !== 'all') {
                activeRooms = activeRooms.filter(room => room.building === currentBuildingFilter);
            }
            
            markersContainer.innerHTML = activeRooms.map(room => {
                return `
                    <div class="room-marker" 
                         data-room="${room.code}" 
                         onclick="showRoomActionOverlay('${room.code}', event)" 
                         style="top: ${room.y}%; left: ${room.x}%;"
                         title="${room.name}">
                        ${getRoomIcon(room.name)}
                    </div>
                `;
            }).join('') + (startPoint ? `
                <div class="room-marker start-point-marker" 
                     style="top: ${startPoint.y}%; left: ${startPoint.x}%;"
                     title="${currentLanguage === 'th' ? 'จุดเริ่มต้น' : 'Starting Point'}"
                     onclick="showStartPointInfo()">
                    🚩
                </div>
            ` : '');
        }

        // 1.2: Show action overlay when clicking room marker
        function showRoomActionOverlay(roomCode, event) {
            const room = roomData[roomCode];
            if (!room) return;
            
            selectedRoomForAction = roomCode;
            selectedRoom = roomCode; // Also set for compatibility
            
            const overlay = document.getElementById('roomActionOverlay');
            const header = document.getElementById('roomActionHeader');
            
            if (!overlay || !header) return;
            
            // Update header with room name
            header.textContent = `${room.name} - ${currentLanguage === 'th' ? 'เลือกการดำเนินการ' : 'Select Action'}`;
            
            // Position overlay near the clicked marker
           // const mapArea = document.getElementById('mapArea');
           // const rect = mapArea.getBoundingClientRect();
            
            // Calculate position relative to map area
            // const overlayX = Math.min(room.x, 70); // Keep within bounds
            // const overlayY = Math.max(room.y - 10, 5); // Keep within bounds
  
            //overlay.style.left = `${overlayX}%`;
            //overlay.style.top = `${overlayY}%`;
			
            overlay.style.display = 'block';
            
            // Update translations for overlay buttons
            updateActionOverlayTranslations();
            
            // Hide overlay when clicking outside
            setTimeout(() => {
                document.addEventListener('click', hideRoomActionOverlayOnClickOutside, { once: true });
            }, 100);
        }

        function hideRoomActionOverlayOnClickOutside(event) {
            const overlay = document.getElementById('roomActionOverlay');
            if (overlay && !overlay.contains(event.target) && !event.target.classList.contains('room-marker')) {
                overlay.style.display = 'none';
            }
        }

        function updateActionOverlayTranslations() {
            const buttons = document.querySelectorAll('#roomActionOverlay [data-translate]');
            buttons.forEach(button => {
                const key = button.getAttribute('data-translate');
                if (translations[currentLanguage] && translations[currentLanguage][key]) {
                    button.textContent = translations[currentLanguage][key];
                }
            });
        }

        // 1.2: Action functions
        function showRoomDetails() {
            if (!selectedRoomForAction) return;
            
            // Hide action overlay
            const overlay = document.getElementById('roomActionOverlay');
            if (overlay) overlay.style.display = 'none';
            
            // Show room info overlay
            showRoomInfoOverlay(selectedRoomForAction);
        }

        function showRouteDirectly() {
            if (!selectedRoomForAction) return;
            
            // Hide action overlay
            const overlay = document.getElementById('roomActionOverlay');
            if (overlay) overlay.style.display = 'none';
            
            selectedRoom = selectedRoomForAction;
            
            if (!startPoint) {
                const message = currentLanguage === 'th' 
                    ? '💡 คลิกที่แผนที่เพื่อตั้งจุดเริ่มต้นก่อน' 
                    : '💡 Click on map to set starting point first';
                showNotification(message, 'info');
                return;
            }
            
            // Show route directly
            showRouteToSelected();
        }

        function showStartPointInfo() {
            if (!startPoint) return;
            const message = currentLanguage === 'th' 
                ? `🚩 จุดเริ่มต้นการนำทาง` 
                : `🚩 Navigation starting point`;
            showNotification(message, 'info');
        }

        // =================== Room Info Functions ===================
        
        function getRoomTypeText(type) {
            const types = {
                'classroom': currentLanguage === 'th' ? 'ห้องเรียน' : 'Classroom',
                'computer': currentLanguage === 'th' ? 'ห้องคอมพิวเตอร์' : 'Computer Lab',
                'lab': currentLanguage === 'th' ? 'ห้องปฏิบัติการ' : 'Laboratory',
                'library': currentLanguage === 'th' ? 'ห้องสมุด' : 'Library',
                'office': currentLanguage === 'th' ? 'ห้องสำนักงาน' : 'Office',
                'facility': currentLanguage === 'th' ? 'สิ่งอำนวยความสะดวก' : 'Facility',
                'special': currentLanguage === 'th' ? 'ห้องพิเศษ' : 'Special Room'
            };
            return types[type] || type;
        }
        
        function showRoomInfoOverlay(roomCode) {
            const room = roomData[roomCode];
            if (!room) return;

            selectedRoom = roomCode;
            updateRouteControls(false);
            
            const overlay = document.getElementById('roomInfoOverlay');
            if (!overlay) return;
            
            const roomName = document.getElementById('overlayRoomName');
            const roomLocation = document.getElementById('overlayRoomLocation');
            const roomBuilding = document.getElementById('overlayRoomBuilding');
            const roomFloor = document.getElementById('overlayRoomFloor');
            const roomType = document.getElementById('overlayRoomType');
            const roomDescription = document.getElementById('overlayRoomDescription');
            const routeBtn = document.getElementById('routeBtn');
            
            if (roomName) roomName.innerHTML = `${getRoomIcon(room.name)} ${room.name}`;
            if (roomLocation) roomLocation.textContent = room.location || room.floor || 'N/A';
            
            // 1.3: Enhanced room information display (removed status)
            // Get building name from admin data
            const buildingData = JSON.parse(localStorage.getItem('buildingsData') || '{}');
            const buildingName = buildingData[room.building]?.name || room.building;
            if (roomBuilding) roomBuilding.textContent = buildingName;
            
            // Display floor information
            if (roomFloor) {
                const floorText = room.floor 
                    ? (currentLanguage === 'th' ? `ชั้น ${room.floor}` : `Floor ${room.floor}`)
                    : (currentLanguage === 'th' ? 'ไม่ระบุ' : 'Not specified');
                roomFloor.textContent = floorText;
            }
            
            // Display room type
            if (roomType) roomType.textContent = getRoomTypeText(room.type || 'classroom');
            
            // 1.3: Remove status display - no longer shown
            
            if (roomDescription) roomDescription.textContent = room.description || (currentLanguage === 'th' ? 'ไม่มีรายละเอียด' : 'No description available');
            
            // Update route button state
            if (routeBtn) {
                if (!startPoint) {
                    routeBtn.disabled = true;
                    routeBtn.innerHTML = `<i class="fas fa-exclamation-triangle"></i> <span>${currentLanguage === 'th' ? 'ตั้งจุดเริ่มต้นก่อน' : 'Set start point first'}</span>`;
                } else {
                    routeBtn.disabled = false;
                    routeBtn.innerHTML = `<i class="fas fa-route"></i> <span data-translate="route_navigation">${currentLanguage === 'th' ? 'เส้นทางนำทาง' : 'Route Navigation'}</span>`;
                }
            }
            
            // Display all images
            updateOverlayImageGallery(room.images);
            generateOverlayNavigationSteps(room);
            
            overlay.style.display = 'flex';
        }

        function closeRoomInfoOverlay() {
            const overlay = document.getElementById('roomInfoOverlay');
            if (overlay) {
                overlay.style.display = 'none';
            }
            selectedRoom = null;
            updateRouteControls(false);
        }

        function generateOverlayNavigationSteps(room) {
            const routeSteps = document.getElementById('overlayRouteSteps');
            if (!routeSteps) return;
            
            if (!startPoint) {
                const noStartText = currentLanguage === 'th' 
                    ? 'คลิกที่แผนที่เพื่อตั้งจุดเริ่มต้นก่อน'
                    : 'Click on map to set starting point first';
                    
                routeSteps.innerHTML = `
                    <div style="text-align: center; padding: 20px; background: #fff3cd; border-radius: var(--border-radius); color: #856404;">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p style="margin: 8px 0 0 0; font-size: 14px;">
                            ${noStartText}
                        </p>
                    </div>
                `;
                return;
            }
            
            const deltaX = room.x - startPoint.x;
            const deltaY = room.y - startPoint.y;
            const distance = Math.round(Math.sqrt(deltaX * deltaX + deltaY * deltaY) * 2);
            
            let direction = '';
            if (Math.abs(deltaX) > Math.abs(deltaY)) {
                direction = deltaX > 0 
                    ? (currentLanguage === 'th' ? 'ทางขวา' : 'to the right')
                    : (currentLanguage === 'th' ? 'ทางซ้าย' : 'to the left');
            } else {
                direction = deltaY > 0 
                    ? (currentLanguage === 'th' ? 'ด้านล่าง' : 'downward')
                    : (currentLanguage === 'th' ? 'ด้านบน' : 'upward');
            }
            
            const steps = currentLanguage === 'th' ? [
                {
                    step: 1,
                    text: 'เริ่มต้นจากจุดเริ่มต้น',
                    distance: '0m'
                },
                {
                    step: 2,
                    text: `เดินไป${direction} ประมาณ ${distance} เมตร`,
                    distance: `${distance}m`
                },
                {
                    step: 3,
                    text: `มองหา ${room.building}`,
                    distance: '10m'
                },
                {
                    step: 4,
                    text: `เข้าสู่ ${room.name}`,
                    distance: '0m'
                }
            ] : [
                {
                    step: 1,
                    text: 'Start from starting point',
                    distance: '0m'
                },
                {
                    step: 2,
                    text: `Walk ${direction} approximately ${distance} meters`,
                    distance: `${distance}m`
                },
                {
                    step: 3,
                    text: `Look for ${room.building}`,
                    distance: '10m'
                },
                {
                    step: 4,
                    text: `Enter ${room.name}`,
                    distance: '0m'
                }
            ];
            
            const stepsTitle = currentLanguage === 'th' ? 'ขั้นตอนการเดินทาง' : 'Navigation Steps';
            
            routeSteps.innerHTML = `
                <div class="route-steps">
                    <h4 style="margin: 0 0 15px 0; font-size: 16px; color: var(--primary-color);">
                        <i class="fas fa-route"></i> ${stepsTitle}
                    </h4>
                    ${steps.map(step => `
                        <div class="route-step">
                            <div class="step-number">${step.step}</div>
                            <div class="step-content">${step.text}</div>
                            <div class="step-distance">${step.distance}</div>
                            <button class="step-voice-btn" onclick="speakStep('${step.text}')">
                                <i class="fas fa-volume-up"></i>
                            </button>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function updateOverlayImageGallery(images) {
            const galleryContainer = document.getElementById('overlayImageGallery');
            const gallerySection = document.getElementById('overlayRoomGallery');
            
			gallerySection.style.display = 'block';
            if (!galleryContainer || !gallerySection) return;
            
            if (images && images.length > 0) {
                gallerySection.style.display = 'block';
                galleryContainer.innerHTML = images.map((url, index) => `
                    <img src="${url}" 
                         alt="รูปห้อง ${index + 1}" 
                         style="width: 100%; height: 120px; object-fit: cover; border-radius: var(--border-radius); cursor: pointer; transition: var(--transition);" 
                         onclick="openImageModal('${url}')" 
                         onerror="this.style.display='none'">
                `).join('');
            } else {
                gallerySection.style.display = 'none';
				galleryContainer.innerHTML = `<div style="...">ไม่มีรูปภาพ</div>`;
            }
        }

        function openImageModal(imageUrl) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.9);
                z-index: 3000;
                display: flex;
                align-items: center;
                justify-content: center;
                backdrop-filter: blur(5px);
                -webkit-backdrop-filter: blur(5px);
            `;
            modal.innerHTML = `
                <img src="${imageUrl}" alt="Room Image" style="max-width: 90%; max-height: 90%; border-radius: var(--border-radius); box-shadow: 0 25px 50px rgba(0,0,0,0.5);">
                <button onclick="this.parentElement.remove()" style="position: absolute; top: 30px; right: 30px; background: white; color: black; border: none; border-radius: 50%; width: 50px; height: 50px; cursor: pointer; font-size: 20px; display: flex; align-items: center; justify-content: center; box-shadow: 0 8px 20px rgba(0,0,0,0.3);">×</button>
            `;
            modal.onclick = (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            };
            document.body.appendChild(modal);
        }

        // =================== Event Setup ===================
        
        function setupMapEvents() {
            const mapArea = document.getElementById('mapArea');
            if (!mapArea) return;
            
            mapArea.addEventListener('click', function(event) {
                // Don't set start point when clicking room markers
               // if (event.target.classList.contains('room-marker')) {
			   if (event.target.classList.contains('room-marker') || event.target.closest('.room-action-overlay')) {
                    return;
                }
                
                // Calculate position on map
                const rect = mapArea.getBoundingClientRect();
                const x = ((event.clientX - rect.left) / rect.width) * 100;
                const y = ((event.clientY - rect.top) / rect.height) * 100;
                
                // Check if position is within bounds
                if (x >= 0 && x <= 100 && y >= 0 && y <= 100) {
                    // Clear existing route if start point changes
                   // if (startPoint && routeDisplayed) {
				   if (routeDisplayed) {
                        clearRoute();
                    }
                    
                    // Set start point
                    startPoint = {
                        name: currentLanguage === 'th' ? 'จุดเริ่มต้น' : 'Starting Point',
                        x: x,
                        y: y
                    };
                    
                    localStorage.setItem('startPoint', JSON.stringify(startPoint));
                    updateRoomMarkers();
                    updateRouteControls(false);
                    
                    const message = currentLanguage === 'th' 
                        ? `🎯 ตั้งจุดเริ่มต้นที่ตำแหน่ง (${Math.round(x)}, ${Math.round(y)})`
                        : `🎯 Start point set at position (${Math.round(x)}, ${Math.round(y)})`;
                    showNotification(message, 'success');
                    
                    // Auto-show route if there's a selected room
                    if (selectedRoom && roomData[selectedRoom]) {
                        setTimeout(() => {
                            showRouteToSelected();
                        }, 500);
                    }
                }
            });
        }

        function setupWindowEvents() {
            window.addEventListener('orientationchange', function() {
                setTimeout(() => {
                    updateRoomMarkers();
                }, 500);
            });

            let resizeTimeout;
            window.addEventListener('resize', function() {
                clearTimeout(resizeTimeout);
                resizeTimeout = setTimeout(() => {
                    updateRoomMarkers();
                }, 250);
            });

            window.addEventListener('beforeunload', function(e) {
                if (startPoint) {
                    localStorage.setItem('startPoint', JSON.stringify(startPoint));
                }
            });

            document.addEventListener('keydown', function(e) {
                if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                    e.preventDefault();
                    const searchInput = document.getElementById('searchInput');
                    if (searchInput) {
                        searchInput.focus();
                    }
                }
                
                if (e.key === 'Escape') {
                    closeRoomInfoOverlay();
                    
                    const imageModal = document.querySelector('div[style*="position: fixed"][style*="background: rgba(0,0,0,0.9)"]');
                    if (imageModal) {
                        imageModal.remove();
                    }
                    
                    if (isVoiceNavigating) {
                        stopVoiceNavigation();
                    }
                }
                
                if (e.key === ' ' && isVoiceNavigating) {
                    e.preventDefault();
                    stopVoiceNavigation();
                }
            });
        }

        // =================== Initialization ===================
        
        function loadInitialData() {
            const savedLang = localStorage.getItem('preferredLanguage') || 'th';
            currentLanguage = savedLang;
            updateLanguageButton();
            
            loadRoomDataFromAdmin();
            
            const savedStartPoint = localStorage.getItem('startPoint');
            if (savedStartPoint) {
                try {
                    startPoint = JSON.parse(savedStartPoint);
                } catch (error) {
                    console.error('Error loading start point:', error);
                }
            }
            
            updateRoomMarkers();
            updateRouteControls(false);
            updateAllTranslations();
            updateSearchPlaceholder();
        }

        function initializeSystem() {
            try {
                loadInitialData();
                setupMapEvents();
                setupWindowEvents();
                
                // Initialize map controls
                setMapLayout('floorplan'); // Set default layout
                
                setTimeout(() => {
                    const welcomeMessage = currentLanguage === 'th' 
                        ? '🎉 ยินดีต้อนรับสู่ระบบแผนที่โรงเรียนอัจฉริยะ v6!' 
                        : '🎉 Welcome to Smart School Map System v6!';
                    showNotification(welcomeMessage, 'info');
                }, 1500);
                
                console.log('🏫 School Map System v6 Ready');
                console.log('✅ All critical fixes + latest modifications implemented:');
                console.log('1. ✅ Language toggle system working');
                console.log('2. ✅ Route persistence implemented');
                console.log('3. ✅ Continuous voice navigation added');
                console.log('4. ✅ Map controls moved outside map area');
                console.log('5. ✅ Building filter for pin clustering');
                console.log('1.1 ✅ Map view controls (floorplan/photo/fullscreen) with toggle');
                console.log('1.2 ✅ Removed help and center buttons');
                console.log('1.3 ✅ Admin button moved to bottom navigation');
                console.log('1.4 ✅ Enhanced room information display');
                console.log('1.5 ✅ Straight line route paths');
                console.log('NEW 1.1 ✅ Fixed route display with straight lines');
                console.log('NEW 1.2 ✅ Room action overlay (details vs route)');
                console.log('NEW 1.3 ✅ Removed status from room details');
                
            } catch (error) {
                console.error('Initialization error:', error);
                const errorMessage = currentLanguage === 'th' 
                    ? '❌ ไม่สามารถเริ่มต้นระบบได้' 
                    : '❌ System initialization failed';
                showNotification(errorMessage, 'error');
            }
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            initializeSystem();
        });

        // Performance monitoring
        function getMemoryUsage() {
            if (performance.memory) {
                const used = Math.round(performance.memory.usedJSHeapSize / 1024 / 1024);
                const limit = Math.round(performance.memory.jsHeapSizeLimit / 1024 / 1024);
                console.log(`Memory: ${used}MB / ${limit}MB`);
                
                if (used > limit * 0.8) {
                    console.warn('⚠️ Memory usage high, consider optimization');
                }
            }
        }

        // Check memory every 30 seconds
        setInterval(getMemoryUsage, 30000);

        console.log('🎉 ระบบแผนที่โรงเรียนอัจฉริยะ v6 - User Interface LATEST UPDATE!');
        console.log('✅ Original 5 fixes + Previous modifications + NEW fixes completed:');
        console.log('✅ FIX 1: Language toggle system implemented');
        console.log('✅ FIX 2: Route persistence - routes stay until cleared');
        console.log('✅ FIX 3: Continuous voice navigation with queue system');
        console.log('✅ FIX 4: Map controls moved outside map area');
        console.log('✅ FIX 5: Building filter for pin clustering/filtering');
        console.log('✅ MOD 1.1: Map view controls (floorplan/photo/fullscreen) with toggle');
        console.log('✅ MOD 1.2: Help and center buttons removed');
        console.log('✅ MOD 1.3: Admin button moved to bottom navigation');
        console.log('✅ MOD 1.4: Enhanced room information (no hours)');
        console.log('✅ MOD 1.5: Straight line route paths');
        console.log('✅ NEW 1.1: Fixed route display with proper straight lines');
        console.log('✅ NEW 1.2: Room action overlay (choose details or show route)');
        console.log('✅ NEW 1.3: Removed status info from room details');
        console.log('🔗 Fully compatible with Admin Interface v6.1');
        console.log('🚀 Ready for production deployment!');
        console.log('📝 Remember to update cross-reference URLs after deployment!');
    </script>
</body>
</html>